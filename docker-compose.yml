services:
  pipeline:
    build:
      context: .
      dockerfile: pipeline/Dockerfile
    command: /app/pipeline/compose_entrypoint.sh
    environment:
      PIPELINE_OUTPUT_DIR: /shared/api-data
      PIPELINE_REFRESH_INTERVAL_SECONDS: "900"
      PIPELINE_HEALTH_FILE: /tmp/pipeline-refresh.ok
    volumes:
      - shared_api_data:/shared/api-data
      - ./pipeline:/app/pipeline
      - ./analysis:/app/analysis
      - ./config:/app/config
      - ./data:/app/data
      - ./reports:/app/reports
      - ./api:/app/api
    healthcheck:
      test: ["CMD-SHELL", "test -f /shared/api-data/metadata.json && test -f /tmp/pipeline-refresh.ok"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s
    cpus: "${PIPELINE_CPU_LIMIT:-1.00}"
    mem_limit: "${PIPELINE_MEM_LIMIT:-1536m}"

  pipeline-refresh-once:
    profiles: ["refresh"]
    build:
      context: .
      dockerfile: pipeline/Dockerfile
    command: python -m pipeline.refresh_data run --output-dir /shared/api-data
    environment:
      PIPELINE_OUTPUT_DIR: /shared/api-data
    volumes:
      - shared_api_data:/shared/api-data
      - ./pipeline:/app/pipeline
      - ./analysis:/app/analysis
      - ./config:/app/config
      - ./data:/app/data
      - ./reports:/app/reports
      - ./api:/app/api
    restart: "no"

  api:
    build:
      context: .
      dockerfile: api/Dockerfile
    command: uvicorn api.main:app --host 0.0.0.0 --port 8080 --reload
    ports:
      - "8080:8080"
    environment:
      # SECURITY: These must be set externally (e.g., in a local .env file that is gitignored) before production deployment.
      ADMIN_PASSWORD: "${ADMIN_PASSWORD:?ADMIN_PASSWORD must be set before production deployment}"
      ADMIN_TOKEN_SECRET: "${ADMIN_TOKEN_SECRET:?ADMIN_TOKEN_SECRET must be set before production deployment}"
      FIRESTORE_COLLECTION_QUESTIONS: questions
      GOOGLE_CLOUD_PROJECT: local-dev
      API_DATA_DIR: /app/api/data
    depends_on:
      pipeline:
        condition: service_healthy
    volumes:
      - ./api:/app/api
      - shared_api_data:/app/api/data
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import json,sys,urllib.request; d=json.load(urllib.request.urlopen('http://127.0.0.1:8080/api/health', timeout=3)); sys.exit(0 if d.get('ok') else 1)",
        ]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 30s
    cpus: "${API_CPU_LIMIT:-1.00}"
    mem_limit: "${API_MEM_LIMIT:-1024m}"

  web:
    build:
      context: .
      dockerfile: web/Dockerfile
    command: npm run dev -- --hostname 0.0.0.0 --port 3000
    ports:
      - "${WEB_PORT:-3001}:3000"
    environment:
      NEXT_PUBLIC_API_BASE: http://localhost:8080
    depends_on:
      api:
        condition: service_healthy
    volumes:
      - ./web:/app
      - web_node_modules:/app/node_modules
    healthcheck:
      test: ["CMD", "node", "-e", "fetch('http://127.0.0.1:3000').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 30s
    cpus: "${WEB_CPU_LIMIT:-1.00}"
    mem_limit: "${WEB_MEM_LIMIT:-1024m}"

volumes:
  shared_api_data:
  web_node_modules:
