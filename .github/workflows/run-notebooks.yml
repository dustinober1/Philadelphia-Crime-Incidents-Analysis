name: Run and Export Notebooks

on:
  push:
    paths:
      - 'notebooks/**'
      - 'environment.yml'
  workflow_dispatch:

jobs:
  run-notebooks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Miniconda
        uses: conda-incubator/setup-miniconda@v2
        with:
          auto-update-conda: true
          python-version: 3.10
          activate-environment: crime
          environment-file: environment.yml
          environment-name: crime

      - name: Install nbconvert
        run: |
          conda run -n crime pip install --no-input nbconvert nbformat

      - name: Execute notebooks and export to Markdown
        run: |
          mkdir -p docs/notebook_summaries
          for nb in notebooks/*.ipynb; do
            echo "Processing $nb"
            # Execute notebook in-place (timeout 600s)
            conda run -n crime jupyter nbconvert --to notebook --execute "$nb" --ExecutePreprocessor.timeout=600 --output "$nb"
            # Convert executed notebook to markdown summary
            base=$(basename "$nb" .ipynb)
            conda run -n crime jupyter nbconvert --to markdown "$nb" --output "docs/notebook_summaries/${base}"
          done

      - name: Commit executed notebooks and summaries
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add notebooks docs/notebook_summaries || true
          git commit -m "ci: execute notebooks and generate markdown summaries [skip ci]" || echo "No changes to commit"
          git push
