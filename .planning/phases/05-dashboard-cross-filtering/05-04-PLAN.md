---
phase: 05-dashboard-cross-filtering
plan: 04
type: execute
wave: 2
depends_on: [01, 02, 03]
files_modified:
  - dashboard/pages/overview.py
  - dashboard/pages/temporal.py
  - dashboard/pages/spatial.py
  - dashboard/pages/correlations.py
  - dashboard/pages/advanced.py
autonomous: false

must_haves:
  truths:
    - "Clicking crime category/district in overview page filters other views to that selection"
    - "Clicking time range in temporal page filters spatial/correlations views to that period"
    - "Clicking district on spatial map filters temporal/correlations views to that district"
    - "Filtered-out data appears dimmed (30% opacity) in all views"
    - "Selection persists across tab changes until new selection made or sidebar filter changed"
  artifacts:
    - path: "dashboard/pages/overview.py"
      provides: "Overview page with selectable crime categories and districts"
      contains: "st.plotly_chart with on_select='rerun'"
    - path: "dashboard/pages/temporal.py"
      provides: "Temporal page with selectable time ranges"
      contains: "st.plotly_chart with on_select='rerun'"
    - path: "dashboard/pages/spatial.py"
      provides: "Spatial page with selectable districts"
      contains: "st.plotly_chart with on_select='rerun'"
    - path: "dashboard/pages/correlations.py"
      provides: "Correlations page accepting cross-filters from other views"
      contains: "filter_kwargs from get_active_filter_kwargs"
    - path: "dashboard/pages/advanced.py"
      provides: "Advanced page accepting cross-filters from other views"
      contains: "filter_kwargs from get_active_filter_kwargs"
  key_links:
    - from: "dashboard/pages/*.py"
      to: "dashboard/components/plotly_interactions.py"
      via: "import register_plotly_selection, update_selection_from_event"
      pattern: "from dashboard.components.plotly_interactions import"
    - from: "dashboard/pages/*.py"
      to: "dashboard/components/state.py"
      via: "import get_active_filter_kwargs"
      pattern: "from dashboard.components.state import"
    - from: "dashboard/pages/*.py"
      to: "dashboard/config.py"
      via: "import PLOTLY_CONFIG"
      pattern: "from dashboard.config import PLOTLY_CONFIG"
---

<objective>
Implement view-to-view cross-filtering with opacity dimming for filtered-out data across all dashboard pages.

Purpose: Users can click/select in any view to instantly filter all other views (exploratory interaction), with visual feedback showing what's filtered out via 30% opacity.

Output: All pages support selection events and respond to cross-filters from other views with dimmed data visualization.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/05-dashboard-cross-filtering/05-CONTEXT.md
@.planning/phases/05-dashboard-cross-filtering/05-RESEARCH.md
@.planning/phases/04-dashboard-foundation/04-06-SUMMARY.md

# State management and plotly interactions from plans 01-03
@dashboard/components/state.py
@dashboard/components/plotly_interactions.py
@dashboard/config.py

# Existing page renderers to modify
@dashboard/pages/overview.py
@dashboard/pages/temporal.py
@dashboard/pages/spatial.py
@dashboard/pages/correlations.py
@dashboard/pages/advanced.py
</context>

<tasks>

<task type="auto">
  <name>Add cross-filtering to overview page</name>
  <files>dashboard/pages/overview.py</files>
  <action>
Modify `dashboard/pages/overview.py` to support cross-filtering:

1. Add imports at top:
```python
from dashboard.components import (
    register_plotly_selection,
    update_selection_from_event,
    get_selection_state,
    get_active_filter_kwargs,
    ViewSelectionState,
)
from dashboard.config import PLOTLY_CONFIG
```

2. Update `render_overview_page(full_df, filtered_df)`:
   - Get current view selection state at start: `selection_state = get_selection_state()`
   - Check if view has active selection affecting this page: `selection_state.active_view == "overview"`
   - If active selection exists, apply additional filtering to filtered_df

3. Add on_select="rerun" to all st.plotly_chart calls:
```python
# Crime category chart
fig = px.bar(...)
fig = register_plotly_selection(fig, key="overview_category")
selection_event = st.plotly_chart(fig, on_select="rerun", key="overview_category_chart")

if selection_event.selection["points"]:
    update_selection_from_event(selection_event, source_view="overview")
```

4. Implement opacity dimming for filtered-out data:
   - Check if cross-filter active (e.g., district selected from spatial view)
   - For each chart, create two datasets: selected (opacity=1.0) and unselected (opacity=0.3)
   - Use Plotly's RGBA colors or fig.update_traces(marker=dict(opacity=...))
   - Example for district chart:
```python
if selection_state.active_districts:
    # Dim districts not in selection
    district_counts["opacity"] = district_counts["dc_dist"].apply(
        lambda d: PLOTLY_CONFIG["selected_opacity"] if d in selection_state.active_districts
        else PLOTLY_CONFIG["unselected_opacity"]
    )
    fig.update_traces(marker=dict(opacity=district_counts["opacity"].tolist()))
```

5. Add selection clearing hint at top of page:
```python
if get_selection_state().active_view:
    st.info(":link: **Active cross-filter**: Click chart or change sidebar filters to reset selection")
```

DO NOT:
- Change chart types or data analysis logic (only add selection handling)
- Remove existing dimming logic for sidebar filters (integrate with it)
- Break pre-generated report display in temporal page (handle separately)
  </action>
  <verify>
1. Check imports added: `grep "from dashboard.components import" dashboard/pages/overview.py | grep -E "register_plotly_selection|get_selection_state"`
2. Verify on_select in charts: `grep -c "on_select.*rerun" dashboard/pages/overview.py`
3. Check opacity logic: `grep -c "opacity\|0\.3\|selected_opacity\|unselected_opacity" dashboard/pages/overview.py`
4. Verify selection state usage: `grep "get_selection_state\|update_selection_from_event" dashboard/pages/overview.py`
  </verify>
  <done>
Overview page has 3+ charts with on_select="rerun". Selection events trigger update_selection_from_event(). Filtered-out data dimmed to 30% opacity. Active selection hint displayed when cross-filter active.
  </done>
</task>

<task type="auto">
  <name>Add cross-filtering to temporal page</name>
  <files>dashboard/pages/temporal.py</files>
  <action>
Modify `dashboard/pages/temporal.py` to support cross-filtering:

1. Add imports:
```python
from dashboard.components import (
    register_plotly_selection,
    update_selection_from_event,
    get_selection_state,
    get_active_filter_kwargs,
)
from dashboard.config import PLOTLY_CONFIG
import plotly.express as px
import plotly.graph_objects as go
```

2. Update `render_temporal_page(full_df, filtered_df)`:
   - Get selection state at start
   - Apply cross-filter kwargs if active selection from other views
   - Use filtered_df for pre-generated report path (no change)

3. For "Use filtered data" mode (checkbox checked):
   - Create Plotly charts instead of st.line_chart/st.bar_chart
   - Add on_select="rerun" to enable time range selection
   - Implement opacity dimming for non-selected time periods

Example time range selection chart:
```python
# Yearly trend
year_counts = df_sample["year"].value_counts().sort_index().reset_index()
year_counts.columns = ["year", "count"]

fig = px.line(year_counts, x="year", y="count", title="Yearly Trend")
fig = register_plotly_selection(fig, key="temporal_years")
selection_event = st.plotly_chart(fig, on_select="rerun", key="temporal_years_chart")

if selection_event.selection["points"]:
    update_selection_from_event(selection_event, source_view="temporal")
```

4. Handle cross-filter from other views (e.g., district selected):
   - If selection_state.active_districts: Filter df_sample to those districts
   - If selection_state.active_crime_types: Filter to those types
   - Charts show only data matching active selection
   - Dim non-matching time periods (opacity=0.3)

5. Keep pre-generated report display unchanged (no cross-filter on embedded markdown)

DO NOT:
- Modify pre-generated report embedding logic
- Break existing checkbox toggle behavior
- Change sampling logic (df_sample calculation)
  </action>
  <verify>
1. Check imports: `grep "from dashboard.components import" dashboard/pages/temporal.py | grep -E "plotly_interactions"`
2. Verify on_select in temporal charts: `grep -c "on_select.*rerun" dashboard/pages/temporal.py`
3. Check plotly usage: `grep -c "px\.\|go\.\|plotly" dashboard/pages/temporal.py`
4. Verify cross-filter logic: `grep "selection_state\|active_districts\|active_crime_types" dashboard/pages/temporal.py`
  </verify>
  <done>
Temporal page creates Plotly charts in "Use filtered data" mode with on_select="rerun". Time range selections trigger cross-filter. Charts dim non-selected periods (30% opacity). Pre-generated report unchanged.
  </done>
</task>

<task type="auto">
  <name>Add cross-filtering to spatial page</name>
  <files>dashboard/pages/spatial.py</files>
  <action>
Modify `dashboard/pages/spatial.py` to support cross-filtering:

1. Add imports:
```python
from dashboard.components import (
    register_plotly_selection,
    update_selection_from_event,
    get_selection_state,
)
from dashboard.config import PLOTLY_CONFIG
import plotly.express as px
```

2. Update `render_spatial_page(full_df, filtered_df)`:
   - Get selection state at start
   - Apply cross-filter kwargs (e.g., crime type selected from overview)
   - Use filtered_df for spatial visualizations

3. Add on_select="rerun" to spatial charts:
   - District bar chart: Selecting bars filters other views to those districts
   - Coordinate scatter plot (if exists): Selecting points filters to that area
   - Any map visualizations: Selecting regions filters to that area

Example district selection:
```python
# District bar chart
district_counts = filtered_df["dc_dist"].value_counts().sort_index().reset_index()
district_counts.columns = ["district", "count"]

fig = px.bar(district_counts, x="district", y="count", title="Incidents by District")
fig = register_plotly_selection(fig, key="spatial_district")
selection_event = st.plotly_chart(fig, on_select="rerun", key="spatial_district_chart")

if selection_event.selection["points"]:
    update_selection_from_event(selection_event, source_view="spatial")
```

4. Implement opacity dimming:
   - If selection_state.active_crime_types from overview: Dim non-selected crime types
   - If selection_state.active_time_range from temporal: Dim non-selected time periods
   - Use conditional opacity based on selection state

5. Add selection clearing hint

DO NOT:
- Change spatial analysis logic or coordinate validation
- Remove existing coordinate statistics display
- Modify district list generation logic
  </action>
  <verify>
1. Check imports: `grep "from dashboard.components import" dashboard/pages/spatial.py | grep -E "plotly_interactions"`
2. Verify on_select: `grep -c "on_select.*rerun" dashboard/pages/spatial.py`
3. Check district selection logic: `grep "spatial.*district\|update_selection_from_event" dashboard/pages/spatial.py`
4. Verify opacity handling: `grep "opacity\|0\.3" dashboard/pages/spatial.py`
  </verify>
  <done>
Spatial page district chart has on_select="rerun". District selection triggers cross-filter to other views. Charts dim filtered-out data (30% opacity). Spatial analysis logic unchanged.
  </done>
</task>

<task type="auto">
  <name>Add cross-filtering to correlations page</name>
  <files>dashboard/pages/correlations.py</files>
  <action>
Modify `dashboard/pages/correlations.py` to accept cross-filters:

1. Add imports:
```python
from dashboard.components import (
    get_selection_state,
    get_active_filter_kwargs,
    clear_selection_state,
)
from dashboard.components.cache import apply_filters
```

2. Update `render_correlations_page(full_df, filtered_df)`:
   - Get selection state at start
   - Check if active selection exists
   - If yes, apply cross-filter to filtered_df:
```python
selection_state = get_selection_state()
if selection_state and has_active_selection():
    # Apply cross-filter on top of sidebar filters
    filter_kwargs = get_active_filter_kwargs()
    cross_filtered_df = apply_filters(filtered_df, **filter_kwargs)
else:
    cross_filtered_df = filtered_df
```

3. Display which cross-filter is active:
```python
if selection_state.active_view:
    st.info(f":link: **Filtered by {selection_state.active_view} view**: {format_selection(selection_state)}")
```

4. Use cross_filtered_df for:
   - Correlation calculations
   - Chart data
   - Statistical summaries

5. Add "Reset selection" button:
```python
if selection_state.active_view:
    if st.button(":x: Clear cross-filter"):
        clear_selection_state()
        st.rerun()
```

6. Keep pre-generated report embedding (if exists) - display note that cross-filter doesn't apply to embedded reports

DO NOT:
- Modify correlation analysis logic (just change input df)
- Break existing report embedding
- Change chart types (only filter input data)
  </action>
  <verify>
1. Check imports: `grep "from dashboard.components import" dashboard/pages/correlations.py | grep -E "get_selection_state|get_active_filter_kwargs"`
2. Verify cross-filter logic: `grep "cross_filtered_df\|get_active_filter_kwargs" dashboard/pages/correlations.py`
3. Check selection display: `grep "active_view\|Filtered by" dashboard/pages/correlations.py`
4. Verify clear button: `grep "Clear cross-filter\|clear_selection_state" dashboard/pages/correlations.py`
  </verify>
  <done>
Correlations page applies cross-filter kwargs to filtered_df. Active selection displayed with info message. Clear button resets view selections. Correlation analysis logic unchanged (different input df).
  </done>
</task>

<task type="auto">
  <name>Add cross-filtering to advanced page</name>
  <files>dashboard/pages/advanced.py</files>
  <action>
Modify `dashboard/pages/advanced.py` to accept cross-filters:

1. Add imports:
```python
from dashboard.components import (
    get_selection_state,
    get_active_filter_kwargs,
    clear_selection_state,
)
from dashboard.components.cache import apply_filters
```

2. Update `render_advanced_page(full_df, filtered_df)`:
   - Same pattern as correlations page
   - Get selection state, apply cross-filter if active
   - Display active selection info
   - Add clear selection button

3. Use cross_filtered_df for:
   - Holiday effects charts
   - Crime type profiles
   - Shift analysis visualizations

4. Keep pre-generated report embedding logic (if exists)

5. Handle case where cross-filter reduces data too much:
```python
if len(cross_filtered_df) < 100:
    st.warning(f":warning: Cross-filter resulted in only {len(cross_filtered_df)} records. Analysis may be unreliable.")
```

DO NOT:
- Modify advanced temporal analysis logic
- Break existing report embedding
- Change holiday/crime type/shift calculations
  </action>
  <verify>
1. Check imports: `grep "from dashboard.components import" dashboard/pages/advanced.py | grep -E "get_selection_state|get_active_filter_kwargs"`
2. Verify cross-filter: `grep "cross_filtered_df\|get_active_filter_kwargs" dashboard/pages/advanced.py`
3. Check warning for small data: `grep "len.*< 100\|unreliable" dashboard/pages/advanced.py`
4. Verify clear button: `grep "Clear.*filter\|clear_selection_state" dashboard/pages/advanced.py`
  </verify>
  <done>
Advanced page applies cross-filter to advanced temporal analysis. Active selection displayed. Warning shown if <100 records after cross-filter. Clear button resets selections. Analysis logic unchanged.
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. All 5 pages support view-to-view cross-filtering
2. Overview page: Crime category/district selections trigger cross-filter
3. Temporal page: Time range selections trigger cross-filter
4. Spatial page: District selections trigger cross-filter
5. Correlations/advanced pages: Accept cross-filters from other views
6. Filtered-out data dimmed to 30% opacity in all views
7. Active selections persist across tab changes
8. Clear selection button resets cross-filters

Verification commands:
```bash
# Check all pages have on_select="rerun"
grep -c "on_select.*rerun" dashboard/pages/*.py

# Verify opacity dimming in pages
grep -c "opacity.*0\.3\|unselected_opacity" dashboard/pages/*.py

# Check selection state usage
grep -l "get_selection_state\|get_active_filter_kwargs" dashboard/pages/*.py

# Verify clear buttons
grep -l "clear_selection_state" dashboard/pages/*.py
```
</verification>

<success_criteria>
1. Overview page has 3+ selectable charts with on_select="rerun"
2. Temporal page uses Plotly charts with on_select in filtered data mode
3. Spatial page district chart supports selection events
4. Correlations page accepts and displays active cross-filters
5. Advanced page accepts cross-filters with small data warning
6. All pages dim filtered-out data to 30% opacity
7. Active selection hints displayed on all pages
8. Clear selection buttons on correlations/advanced pages
9. Pre-generated report embedding unchanged
10. All pages use get_selection_state() and get_active_filter_kwargs()
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-cross-filtering/05-04-SUMMARY.md`
</output>
