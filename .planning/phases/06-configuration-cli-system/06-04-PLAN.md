---
phase: 06-configuration-cli-system
plan: 04
type: execute
wave: 3
depends_on: ["06-03"]
files_modified:
  - analysis/cli/chief.py
autonomous: true

must_haves:
  truths:
    - "User can run `python -m analysis.cli chief trends` and see progress bars"
    - "User can run `python -m analysis.cli chief trends --fast` and complete in under 1 minute"
    - "Trends command loads data, runs analysis, and saves outputs to reports/"
    - "All 3 Chief commands have Rich progress feedback"
  artifacts:
    - path: "analysis/cli/chief.py"
      provides: "Chief command implementations with analysis logic"
      exports: ["trends", "seasonality", "covid"]
  key_links:
    - from: "analysis/cli/chief.py"
      to: "analysis/data/loading.py"
      via: "load_crime_data() import"
      pattern: "from.*loading.*import.*load_crime_data"
    - from: "analysis/cli/chief.py"
      to: "analysis/utils/classification.py"
      via: "classify_crime_category() import"
      pattern: "from.*classification.*import"
---

<objective>
Implement Chief command group analysis logic (trends, seasonality, covid) with Rich progress bars and data loading.

Purpose: Complete the Chief commands with actual analysis logic, data loading from the Phase 5 data layer, and Rich progress feedback. This creates the first fully functional CLI commands.

Output: Working Chief commands that load data, run analyses, generate outputs, and show progress bars.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/06-configuration-cli-system/06-RESEARCH.md
@.planning/phases/06-configuration-cli-system/06-03-SUMMARY.md

# Data layer modules (from Phase 5)
@analysis/data/loading.py
@analysis/data/validation.py
@analysis/data/preprocessing.py
@analysis/utils/classification.py
@analysis/utils/temporal.py

# Existing orchestration patterns
@analysis/orchestrate_phase1.py

# Config schemas
@analysis/config/schemas/chief.py
@config/chief.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Chief trends command with analysis logic</name>
  <files>analysis/cli/chief.py</files>
  <action>
    Update the `trends` command in `analysis/cli/chief.py` to implement full analysis logic:

    Replace the placeholder TODO section with:

    ```python
    @app.command()
    def trends(
        start_year: int = typer.Option(2015, help="Start year for analysis", min=2006, max=2026),
        end_year: int = typer.Option(2024, help="End year for analysis", min=2006, max=2026),
        version: str = typer.Option("v1.0", help="Output version tag"),
        fast: bool = typer.Option(False, "--fast", help="Fast mode with 10%% sample"),
    ) -> None:
        """Generate annual crime trends analysis."""
        from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TaskProgressColumn, TimeRemainingColumn
        from analysis.data.loading import load_crime_data
        from analysis.data.preprocessing import filter_by_date_range, aggregate_by_period
        from analysis.utils.classification import classify_crime_category
        from analysis.utils.temporal import extract_temporal_features
        from pathlib import Path

        # Load config
        config = TrendsConfig(start_year=start_year, end_year=end_year, version=version, fast_mode=fast)

        console.print(f"[bold blue]Annual Trends Analysis[/bold blue]")
        console.print(f"  Period: {config.start_year}-{config.end_year}")
        console.print(f"  Version: {config.version}")
        console.print(f"  Fast mode: {config.fast_mode}")
        console.print()

        # Progress bar for multi-stage workflow
        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(),
            TaskProgressColumn(),
            TimeRemainingColumn(),
        ) as progress:
            # Stage 1: Load data
            load_task = progress.add_task("Loading crime data...", total=100)

            df = load_crime_data(use_cache=config.cache_enabled)
            if config.fast_mode:
                df = df.sample(frac=config.fast_sample_frac, random_state=42)
                console.print(f"[yellow]Fast mode: Using {len(df)} rows ({config.fast_sample_frac:.0%%} sample)[/yellow]")

            progress.update(load_task, advance=100, description="Data loaded")

            # Stage 2: Preprocess data
            prep_task = progress.add_task("Preprocessing data...", total=100)

            # Add temporal features
            df = extract_temporal_features(df)

            # Filter by date range
            start_date = f"{config.start_year}-01-01"
            end_date = f"{config.end_year}-12-31"
            df = filter_by_date_range(df, "dispatch_date", start_date, end_date)

            # Classify crimes
            df = classify_crime_category(df)

            progress.update(prep_task, advance=100, description="Preprocessing complete")

            # Stage 3: Generate analysis
            analyze_task = progress.add_task("Analyzing trends...", total=100)

            # Aggregate by year
            annual_df = aggregate_by_period(df, "YE", "dispatch_date", {"objectid": "count"})

            progress.update(analyze_task, advance=100, description="Analysis complete")

            # Stage 4: Save outputs
            output_task = progress.add_task("Saving outputs...", total=100)

            # Create output directory
            output_path = Path(config.output_dir) / config.version / "chief"
            output_path.mkdir(parents=True, exist_ok=True)

            # Save summary statistics
            summary_file = output_path / f"{config.report_name}_summary.txt"
            with open(summary_file, "w") as f:
                f.write(f"Annual Trends Analysis Summary\n")
                f.write(f"=" * 40 + "\n")
                f.write(f"Period: {config.start_year}-{config.end_year}\n")
                f.write(f"Total incidents: {len(df)}\n")
                f.write(f"\nAnnual totals:\n")
                for year, count in annual_df.sort_values("dispatch_date")["objectid"].items():
                    f.write(f"  {year}: {count:,.0f}\n")

            progress.update(output_task, advance=100, description="Outputs saved")

        console.print()
        console.print("[green]:heavy_check_mark:[/green] [bold green]Analysis complete[/bold green]")
        console.print(f"  Total incidents analyzed: [cyan]{len(df):,.0f}[/cyan]")
        console.print(f"  Output directory: [cyan]{output_path}[/cyan]")
        console.print(f"  Summary file: [cyan]{summary_file.name}[/cyan]")
    ```

    Use the Phase 5 data layer modules (load_crime_data, filter_by_date_range, aggregate_by_period, classify_crime_category) for data operations.
  </action>
  <verify>
    - `python -m analysis.cli chief trends --fast` executes and shows progress bars
    - `ls reports/v1.0/chief/` contains annual_trends_report_summary.txt (or appropriate output file)
    - Progress bars complete all stages (loading, preprocessing, analysis, output)
  </verify>
  <done>
    Trends command loads data, processes with data layer utilities, shows Rich progress, and saves output to reports/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Chief seasonality command</name>
  <files>analysis/cli/chief.py</files>
  <action>
    Update the `seasonality` command in `analysis/cli/chief.py` with full analysis logic:

    ```python
    @app.command()
    def seasonality(
        summer_months: list[int] = typer.Option([6, 7, 8], help="Summer months"),
        winter_months: list[int] = typer.Option([12, 1, 2], help="Winter months"),
        version: str = typer.Option("v1.0", help="Output version tag"),
        fast: bool = typer.Option(False, "--fast", help="Fast mode with 10%% sample"),
    ) -> None:
        """Analyze seasonal crime patterns."""
        from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TaskProgressColumn, TimeRemainingColumn
        from analysis.data.loading import load_crime_data
        from analysis.data.preprocessing import filter_by_date_range
        from analysis.utils.classification import classify_crime_category
        from analysis.utils.temporal import extract_temporal_features
        from pathlib import Path
        import pandas as pd

        config = SeasonalityConfig(
            summer_months=summer_months,
            winter_months=winter_months,
            version=version,
            fast_mode=fast,
        )

        console.print(f"[bold blue]Seasonality Analysis[/bold blue]")
        console.print(f"  Summer months: {config.summer_months}")
        console.print(f"  Winter months: {config.winter_months}")
        console.print()

        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(),
            TaskProgressColumn(),
            TimeRemainingColumn(),
        ) as progress:
            load_task = progress.add_task("Loading data...", total=100)
            df = load_crime_data(use_cache=config.cache_enabled)
            if config.fast_mode:
                df = df.sample(frac=config.fast_sample_frac, random_state=42)
            progress.update(load_task, advance=100)

            prep_task = progress.add_task("Processing data...", total=100)
            df = extract_temporal_features(df)
            df = classify_crime_category(df)
            progress.update(prep_task, advance=100)

            analyze_task = progress.add_task("Analyzing seasonality...", total=100)

            # Filter for complete years
            df_filtered = filter_by_date_range(df, "dispatch_date", "2018-01-01", "2023-12-31")

            # Calculate seasonal averages
            df_filtered["season"] = df_filtered["month"].apply(
                lambda m: "summer" if m in config.summer_months else ("winter" if m in config.winter_months else "other")
            )
            seasonal_counts = df_filtered.groupby("season")["objectid"].count()

            progress.update(analyze_task, advance=100)

            output_task = progress.add_task("Saving outputs...", total=100)
            output_path = Path(config.output_dir) / config.version / "chief"
            output_path.mkdir(parents=True, exist_ok=True)

            summary_file = output_path / f"{config.report_name}_summary.txt"
            with open(summary_file, "w") as f:
                f.write(f"Seasonality Analysis Summary\n")
                f.write(f"=" * 40 + "\n")
                f.write(f"Summer months: {config.summer_months}\n")
                f.write(f"Winter months: {config.winter_months}\n")
                f.write(f"\nSeasonal averages:\n")
                for season, count in seasonal_counts.items():
                    f.write(f"  {season.capitalize()}: {count:,.0f} incidents\n")

            progress.update(output_task, advance=100)

        console.print()
        console.print("[green]:heavy_check_mark:[/green] [bold green]Analysis complete[/bold green]")
        console.print(f"  Output directory: [cyan]{output_path}[/cyan]")
    ```

    Reference the trends command structure for consistency. Use the same data loading and preprocessing pattern.
  </action>
  <verify>
    - `python -m analysis.cli chief seasonality --fast` executes with progress bars
    - `ls reports/v1.0/chief/` contains seasonality_report_summary.txt
    - Progress bars show all stages completing
  </verify>
  <done>
    Seasonality command loads data, calculates seasonal patterns, shows progress, and saves output.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement Chief covid command</name>
  <files>analysis/cli/chief.py</files>
  <action>
    Update the `covid` command in `analysis/cli/chief.py` with full analysis logic:

    ```python
    @app.command()
    def covid(
        lockdown_date: str = typer.Option("2020-03-01", help="COVID lockdown date"),
        before_years: list[int] = typer.Option([2018, 2019], help="Pre-COVID years for comparison"),
        version: str = typer.Option("v1.0", help="Output version tag"),
        fast: bool = typer.Option(False, "--fast", help="Fast mode with 10%% sample"),
    ) -> None:
        """Analyze COVID impact on crime patterns."""
        from rich.progress import Progress, SpinnerColumn, TextColumn, BarColumn, TaskProgressColumn, TimeRemainingColumn
        from analysis.data.loading import load_crime_data
        from analysis.data.preprocessing import filter_by_date_range
        from analysis.utils.classification import classify_crime_category
        from analysis.utils.temporal import extract_temporal_features
        from pathlib import Path
        import pandas as pd

        config = COVIDConfig(
            lockdown_date=lockdown_date,
            before_years=before_years,
            version=version,
            fast_mode=fast,
        )

        console.print(f"[bold blue]COVID Impact Analysis[/bold blue]")
        console.print(f"  Lockdown date: {config.lockdown_date}")
        console.print(f"  Before years: {config.before_years}")
        console.print()

        with Progress(
            SpinnerColumn(),
            TextColumn("[progress.description]{task.description}"),
            BarColumn(),
            TaskProgressColumn(),
            TimeRemainingColumn(),
        ) as progress:
            load_task = progress.add_task("Loading data...", total=100)
            df = load_crime_data(use_cache=config.cache_enabled)
            if config.fast_mode:
                df = df.sample(frac=config.fast_sample_frac, random_state=42)
            progress.update(load_task, advance=100)

            prep_task = progress.add_task("Processing data...", total=100)
            df = extract_temporal_features(df)
            df = classify_crime_category(df)
            progress.update(prep_task, advance=100)

            analyze_task = progress.add_task("Comparing periods...", total=100)

            # Get pre-COVID baseline
            before_periods = []
            for year in config.before_years:
                year_data = filter_by_date_range(df, "dispatch_date", f"{year}-01-01", f"{year}-12-31")
                before_periods.append(year_data)

            baseline_df = pd.concat(before_periods, ignore_index=True)
            baseline_avg = len(baseline_df) / len(config.before_years)

            # Get post-COVID period (2021-2022)
            after_df = filter_by_date_range(df, "dispatch_date", "2021-01-01", "2022-12-31")

            progress.update(analyze_task, advance=100)

            output_task = progress.add_task("Saving outputs...", total=100)
            output_path = Path(config.output_dir) / config.version / "chief"
            output_path.mkdir(parents=True, exist_ok=True)

            summary_file = output_path / f"{config.report_name}_summary.txt"
            with open(summary_file, "w") as f:
                f.write(f"COVID Impact Analysis Summary\n")
                f.write(f"=" * 40 + "\n")
                f.write(f"Lockdown date: {config.lockdown_date}\n")
                f.write(f"Before years: {config.before_years}\n")
                f.write(f"\nAverage incidents (before): {baseline_avg:,.0f}\n")
                f.write(f"Incidents (after): {len(after_df):,.0f}\n")
                f.write(f"Change: {(len(after_df) - baseline_avg) / baseline_avg * 100:+.1f}%%\n")

            progress.update(output_task, advance=100)

        console.print()
        console.print("[green]:heavy_check_mark:[/green] [bold green]Analysis complete[/bold green]")
        console.print(f"  Output directory: [cyan]{output_path}[/cyan]")
    ```

    Follow the same pattern as trends and seasonality commands. Ensure progress bars show for all stages.
  </action>
  <verify>
    - `python -m analysis.cli chief covid --fast` executes with progress bars
    - `ls reports/v1.0/chief/` contains covid_impact_report_summary.txt
    - Summary file shows baseline comparison with percentage change
  </verify>
  <done>
    COVID command loads data, compares pre/post periods, shows progress, and saves output with comparison statistics.
  </done>
</task>

</tasks>

<verification>
After completing this plan:

1. Run all three Chief commands in fast mode:
   - `python -m analysis.cli chief trends --fast`
   - `python -m analysis.cli chief seasonality --fast`
   - `python -m analysis.cli chief covid --fast`

2. Verify progress bars appear and complete for all stages (loading, preprocessing, analysis, output)

3. Verify output files created:
   - `ls reports/v1.0/chief/` should show 3 summary files

4. Test with custom arguments:
   - `python -m analysis.cli chief trends --start-year 2020 --end-year 2022 --fast`
   - Verify custom date range is respected

Expected outcome: All 3 Chief commands working with Rich progress bars, data loading from Phase 5 modules, outputs saved to reports/.
</verification>

<success_criteria>
1. All 3 Chief commands execute successfully with progress feedback
2. Progress bars show 4 stages: loading, preprocessing, analysis, output
3. Data is loaded via analysis.data.load_crime_data()
4. Outputs are saved to reports/{version}/chief/ directory
5. Fast mode completes in under 60 seconds per command
</success_criteria>

<output>
After completion, create `.planning/phases/06-configuration-cli-system/06-04-SUMMARY.md` with:
- Commands implemented (trends, seasonality, covid)
- Progress bar stages defined
- Output files created
- Performance metrics (fast mode timing)
- Any issues with data layer integration
</output>
