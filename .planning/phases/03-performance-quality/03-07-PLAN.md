---
phase: 03-performance-quality
plan: "07"
type: execute
wave: 2
depends_on: ["06"]
files_modified:
  - web/src/lib/api.ts
  - web/src/hooks/useFilteredData.ts
  - web/src/app/trends/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can filter by police district (all 23 PPD districts)"
    - "District filter changes annual/monthly trend charts to show district-specific data"
    - "COVID and seasonality charts show citywide data with appropriate UI messaging"
    - "Filters work together on annual/monthly trends (all three can be active simultaneously)"
  artifacts:
    - path: "web/src/lib/api.ts"
      provides: "TrendRow type with optional district field"
      contains: "district.*number"
    - path: "web/src/hooks/useFilteredData.ts"
      provides: "Hook that refetches by district filter"
    - path: "web/src/app/trends/page.tsx"
      provides: "Trend charts that update when district changes"
      contains: "district.*filters"
  key_links:
    - from: "web/src/app/trends/page.tsx"
      to: "/api/v1/trends/annual?district=X"
      via: "useFilteredData with district param"
      pattern: "district.*useFilteredData"
---

<objective>
Wire the district filter to trend charts by refetching district-scoped data from the API when districts are selected.

Purpose: The frontend currently fetches citywide trend data regardless of district filter selection. This plan updates the data fetching to request district-filtered data from the API when one or more districts are selected.

Output: Trend charts that update to show district-specific data when district filter is active.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key existing files (understand before modifying)
@web/src/lib/api.ts
@web/src/hooks/useFilteredData.ts
@web/src/app/trends/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update TrendRow type and API hooks to support district filtering</name>
  <files>web/src/lib/api.ts, web/src/hooks/useFilteredData.ts</files>
  <action>
    Update the frontend to request district-filtered data from the API.

    1. In `web/src/lib/api.ts`, add optional `dc_dist` field to TrendRow:

    ```typescript
    export interface TrendRow {
      year?: number;
      month?: string;
      crime_category?: "Violent" | "Property" | "Other" | string;
      count: number;
      dc_dist?: number; // PPD district number (1-23), present in district-scoped responses
    }
    ```

    2. In `web/src/hooks/useFilteredData.ts`, modify the hook to include district in the SWR key and fetch URL. The hook already uses correct import paths (`@/lib/types` for TrendRow, `@/lib/filters` for applyFilters):

    ```typescript
    "use client";

    import { useMemo } from "react";
    import useSWR from "swr";

    import { fetcher } from "@/lib/api";
    import type { FilterState, TrendRow } from "@/lib/types";
    import { applyFilters } from "@/lib/filters";

    export function useFilteredData(endpoint: string, filters: FilterState) {
      // Build query params for district filtering
      const params = new URLSearchParams();
      const selectedDistrict = filters.districts.length === 1 ? filters.districts[0] : null;

      if (selectedDistrict !== null) {
        params.set("district", String(selectedDistrict));
      }

      const queryString = params.toString();
      const url = queryString ? `${endpoint}?${queryString}` : endpoint;

      // SWR key includes district so changing district triggers refetch
      const swrKey = url;

      const { data, error, isLoading } = useSWR<TrendRow[]>(swrKey, fetcher);

      const filteredData = useMemo(() => {
        if (!data) return [];
        return applyFilters(data, filters);
      }, [data, filters]);

      return {
        data: filteredData,
        allData: data,
        isLoading,
        error,
        filteredCount: filteredData.length,
        totalCount: data?.length ?? 0,
      };
    }
    ```

    3. Key design decisions:
       - When exactly 1 district is selected, fetch district-scoped data from API
       - When 0 districts selected, fetch citywide data (current behavior)
       - When 2+ districts selected, fetch citywide data and filter client-side (acceptable for small numbers)
       - This keeps the API simple and handles the most common case (single district) efficiently
  </action>
  <verify>
    ```bash
    cd /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web

    # Type check
    npm run typecheck

    # Build
    npm run build

    echo "OK: API hooks updated for district filtering"
    ```
  </verify>
  <done>useFilteredData hook refetches district-scoped data when single district is selected</done>
</task>

<task type="auto">
  <name>Task 2: Update Trends page to use district-aware data fetching</name>
  <files>web/src/app/trends/page.tsx</files>
  <action>
    Update the Trends page to properly handle district filtering in the data display and add UI messaging for analyses that are inherently citywide.

    1. The page already uses `useFilteredData` for annual and monthly data. Since the hook now accepts district in the filters, no code changes should be needed to the hook calls themselves.

    2. Update the `filterInsights` useMemo to reflect that district filtering affects annual/monthly trends, and add messaging when COVID/seasonality analyses remain citywide:

    ```typescript
    const filterInsights: Insight[] = useMemo(() => {
      const insights: Insight[] = [];

      const districtCount = filters.districts.length;
      if (districtCount === 1) {
        insights.push({
          icon: "stable",
          type: "neutral",
          text: `Showing District ${filters.districts[0]} data. Charts reflect district-specific trends.`,
        });
        // Note: COVID and seasonality charts remain citywide (inherently citywide analyses)
        insights.push({
          icon: "info",
          type: "neutral",
          text: "COVID comparison and seasonality charts show citywide patterns (inherently citywide analyses).",
        });
      } else if (districtCount > 1) {
        insights.push({
          icon: "stable",
          type: "neutral",
          text: `${districtCount} districts selected. Showing citywide data filtered client-side.`,
        });
      }

      // ... rest of existing insights
    }, [annualSeries.length, filters.categories.length, filters.districts]);
    ```

    3. Ensure the annualSeries and monthlySeries computations properly handle the new dc_dist field if present (it should be transparent since they group by year/month and category).

    4. DO NOT change the chart rendering logic - it should work the same way with district-scoped or citywide data.

    5. IMPORTANT: COVID comparison and seasonality analyses are inherently citywide analyses that compare pandemic periods and temporal patterns across the entire city. They do not support district filtering because:
       - COVID comparison: Compares pre/during/post pandemic periods at citywide level
       - Seasonality: Shows citywide temporal patterns by month/day-of-week/hour
       - The robbery heatmap shows temporal patterns and does not currently include district dimension

       Add a small info note below these charts indicating they show citywide patterns.
  </action>
  <verify>
    ```bash
    cd /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web

    # Type check
    npm run typecheck

    # Build
    npm run build

    # Verify the trends page renders
    npm run dev &
    sleep 5
    curl -s http://localhost:3000/trends | grep -o "Annual trends" | head -1

    echo "OK: Trends page uses district-aware data fetching"
    ```
  </verify>
  <done>Trends page shows district-specific data when district filter is set to a single district</done>
</task>

</tasks>

<verification>
1. Selecting a single district in the filter causes annual/monthly trend charts to update with district-specific data
2. Selecting multiple districts shows a message explaining client-side filtering
3. Clearing district filter returns to citywide view
4. District filter works together with date range and category filters on annual/monthly trends
5. COVID and seasonality charts display messaging that they are citywide analyses (not affected by district filter)
</verification>

<success_criteria>
- When 1 district selected: annual/monthly charts show district-specific data (API refetch)
- When 0 districts selected: annual/monthly charts show citywide data (current behavior)
- When 2+ districts selected: annual/monthly charts show citywide data with message about client-side filtering
- All three filters (date, district, category) can be active simultaneously on annual/monthly trends
- COVID/seasonality/robbery charts have UI note indicating citywide scope
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-quality/03-07-SUMMARY.md`
</output>
