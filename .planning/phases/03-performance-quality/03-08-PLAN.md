---
phase: 03-performance-quality
plan: "08"
type: execute
wave: 3
depends_on: ["06", "07"]
files_modified:
  - web/src/app/trends/page.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Trends page displays narrative insights below each chart"
    - "Narratives update dynamically when filter state changes"
  artifacts:
    - path: "web/src/app/trends/page.tsx"
      provides: "NarrativeCard/InsightBox for Monthly, COVID, Seasonality, Robbery charts"
      contains: "NarrativeCard.*Monthly|InsightBox.*COVID"
  key_links:
    - from: "web/src/app/trends/page.tsx"
      to: "NarrativeCard component"
      via: "import and render after each chart"
      pattern: "NarrativeCard"
---

<objective>
Add NarrativeCard and/or InsightBox components to each chart card on the Trends page (Monthly, COVID, Seasonality, Robbery) so users get narrative insights below every visualization, not just Annual.

Purpose: Currently only the Annual trends chart has a NarrativeCard with year-over-year analysis. The other four charts have static text strings. This plan adds proper narrative/insight components to each chart.

Output: All trend charts have narrative insights that update with the data and filters.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Key existing files
@web/src/app/trends/page.tsx
@web/src/lib/narratives.ts
@web/src/components/data-story/NarrativeCard.tsx
@web/src/components/data-story/InsightBox.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add narrative insights to Monthly trends chart</name>
  <files>web/src/app/trends/page.tsx</files>
  <action>
    Replace the static text below the Monthly trends chart with a dynamic InsightBox that derives insights from the filtered monthly series.

    1. Add a useMemo to compute monthly insights after the monthlySeries computation:

    ```typescript
    const monthlyInsights: Insight[] = useMemo(() => {
      const insights: Insight[] = [];

      if (monthlySeries.length === 0) {
        insights.push({
          icon: "stable",
          type: "neutral",
          text: "No monthly data available for the selected filters.",
        });
        return insights;
      }

      // Find the most recent month
      const latest = monthlySeries[monthlySeries.length - 1];
      const previous = monthlySeries.length > 1 ? monthlySeries[monthlySeries.length - 2] : null;

      if (previous) {
        const latestTotal = (latest.Violent ?? 0) + (latest.Property ?? 0) + (latest.Other ?? 0);
        const prevTotal = (previous.Violent ?? 0) + (previous.Property ?? 0) + (previous.Other ?? 0);
        const change = latestTotal - prevTotal;
        const pctChange = prevTotal > 0 ? (change / prevTotal) * 100 : 0;

        if (Math.abs(pctChange) > 10) {
          insights.push({
            icon: change > 0 ? "up" : "down",
            type: change > 0 ? "concern" : "positive",
            text: `${latest.month}: ${Math.abs(pctChange).toFixed(1)}% ${change > 0 ? "increase" : "decrease"} vs prior month (${Math.abs(change)} incidents).`,
          });
        } else {
          insights.push({
            icon: "stable",
            type: "neutral",
            text: `${latest.month}: Stable month-over-month trend with ${pctChange.toFixed(1)}% change.`,
          });
        }
      }

      // Seasonality insight
      insights.push({
        icon: "stable",
        type: "neutral",
        text: "Monthly totals show seasonal patterns with mid-summer and late-fall peaks typical of urban crime cycles.",
      });

      return insights;
    }, [monthlySeries]);
    ```

    2. Replace the static `<p className="text-sm text-slate-600">Insight: Seasonal variability...` with:

    ```tsx
    <div className="mt-4">
      <InsightBox title="Monthly Insights" insights={monthlyInsights} />
    </div>
    ```
  </action>
  <verify>
    ```bash
    cd /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web
    npm run typecheck
    npm run build
    echo "OK: Monthly insights added"
    ```
  </verify>
  <done>Monthly trends chart has InsightBox with dynamic insights derived from filtered data</done>
</task>

<task type="auto">
  <name>Task 2: Add narrative insights to COVID comparison chart</name>
  <files>web/src/app/trends/page.tsx</files>
  <action>
    Replace the static text below the COVID comparison chart with a NarrativeCard that compares periods.

    1. Add a useMemo to compute COVID narrative:

    ```typescript
    const covidNarrative: Narrative | null = useMemo(() => {
      if (!covid || covid.length < 3) return null;

      const pre = covid.find(p => p.period === "Pre");
      const during = covid.find(p => p.period === "During");
      const post = covid.find(p => p.period === "Post");

      if (!pre || !during || !post) return null;

      // Compare pre to during (pandemic impact)
      const preToDuring = during.count - pre.count;
      const preToDuringPct = pre.count > 0 ? (preToDuring / pre.count) * 100 : 0;

      // Compare during to post (recovery)
      const duringToPost = post.count - during.count;
      const duringToPostPct = during.count > 0 ? (duringToPost / during.count) * 100 : 0;

      // Generate narrative based on the largest change
      if (Math.abs(preToDuringPct) > Math.abs(duringToPostPct)) {
        return generateNarrative({
          current: during.count,
          previous: pre.count,
          label: "Pandemic period crime",
        });
      } else {
        return generateNarrative({
          current: post.count,
          previous: during.count,
          label: "Post-pandemic crime",
        });
      }
    }, [covid]);

    const covidInsights: Insight[] = useMemo(() => {
      if (!covid || covid.length < 3) return [];

      const pre = covid.find(p => p.period === "Pre")?.count ?? 0;
      const during = covid.find(p => p.period === "During")?.count ?? 0;
      const post = covid.find(p => p.period === "Post")?.count ?? 0;

      return [
        {
          icon: "stable",
          type: "neutral",
          text: `Pre-pandemic: ${pre.toLocaleString()} incidents (${covid.find(p => p.period === "Pre")?.start} to ${covid.find(p => p.period === "Pre")?.end})`,
        },
        {
          icon: "stable",
          type: "neutral",
          text: `During pandemic: ${during.toLocaleString()} incidents`,
        },
        {
          icon: "stable",
          type: "neutral",
          text: `Post-pandemic: ${post.toLocaleString()} incidents (2022 onward)`,
        },
      ];
    }, [covid]);
    ```

    2. Replace the static text below COVID chart with:

    ```tsx
    <div className="mt-4 space-y-3">
      {covidNarrative && <NarrativeCard narrative={covidNarrative} title="COVID Impact Analysis" />}
      <InsightBox title="Period Breakdown" insights={covidInsights} />
    </div>
    ```
  </action>
  <verify>
    ```bash
    cd /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web
    npm run typecheck
    npm run build
    echo "OK: COVID insights added"
    ```
  </verify>
  <done>COVID comparison chart has NarrativeCard and InsightBox with period comparison insights</done>
</task>

<task type="auto">
  <name>Task 3: Add narrative insights to Seasonality and Robbery heatmap charts</name>
  <files>web/src/app/trends/page.tsx</files>
  <action>
    Add InsightBox components to the Seasonality and Robbery heatmap charts with derived insights.

    1. Add useMemo for seasonality insights:

    ```typescript
    const seasonalityInsights: Insight[] = useMemo(() => {
      const insights: Insight[] = [];

      if (!seasonality) {
        insights.push({
          icon: "stable",
          type: "neutral",
          text: "Seasonality data not available.",
        });
        return insights;
      }

      // Peak month analysis
      const byMonth = seasonality.by_month ?? [];
      if (byMonth.length > 0) {
        const peakMonth = byMonth.reduce((a: { month: number; count: number }, b: { month: number; count: number }) =>
          a.count >= b.count ? a : b
        );
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        insights.push({
          icon: peakMonth.count > byMonth.reduce((s: number, r: { count: number }) => s + r.count, 0) / byMonth.length ? "up" : "stable",
          type: "neutral",
          text: `Peak month: ${monthNames[peakMonth.month - 1] ?? peakMonth.month} with ${peakMonth.count.toLocaleString()} incidents.`,
        });
      }

      // Peak hour analysis
      const byHour = seasonality.by_hour ?? [];
      if (byHour.length > 0) {
        const peakHour = byHour.reduce((a: { hour: number; count: number }, b: { hour: number; count: number }) =>
          a.count >= b.count ? a : b
        );
        insights.push({
          icon: "stable",
          type: "neutral",
          text: `Peak hour: ${peakHour.hour}:00 with ${peakHour.count.toLocaleString()} incidents.`,
        });
      }

      // Peak day analysis
      const byDow = seasonality.by_day_of_week ?? [];
      if (byDow.length > 0) {
        const peakDay = byDow.reduce((a: { day_of_week: number; count: number }, b: { day_of_week: number; count: number }) =>
          a.count >= b.count ? a : b
        );
        const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
        insights.push({
          icon: "stable",
          type: "neutral",
          text: `Peak day: ${dayNames[peakDay.day_of_week] ?? peakDay.day_of_week} with ${peakDay.count.toLocaleString()} incidents.`,
        });
      }

      return insights;
    }, [seasonality]);
    ```

    2. Add useMemo for robbery heatmap insights:

    ```typescript
    const robberyInsights: Insight[] = useMemo(() => {
      const insights: Insight[] = [];

      if (!robberyHeat || robberyHeat.length === 0) {
        insights.push({
          icon: "stable",
          type: "neutral",
          text: "Robbery heatmap data not available.",
        });
        return insights;
      }

      // Find peak hour/day combination
      const peak = robberyHeat.reduce((a: RobberyCell, b: RobberyCell) =>
        a.count >= b.count ? a : b
      );

      const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      insights.push({
        icon: peak.count > 50 ? "up" : "stable",
        type: peak.count > 50 ? "concern" : "neutral",
        text: `Peak robbery time: ${dayNames[peak.day_of_week] ?? peak.day_of_week} ${peak.hour}:00 with ${peak.count.toLocaleString()} incidents.`,
      });

      // Evening concentration
      const eveningHours = robberyHeat.filter((c: RobberyCell) => c.hour >= 18 && c.hour <= 23);
      const eveningTotal = eveningHours.reduce((s: number, c: RobberyCell) => s + c.count, 0);
      const total = robberyHeat.reduce((s: number, c: RobberyCell) => s + c.count, 0);
      const eveningPct = total > 0 ? (eveningTotal / total) * 100 : 0;

      if (eveningPct > 25) {
        insights.push({
          icon: "stable",
          type: "neutral",
          text: `${eveningPct.toFixed(0)}% of robberies occur during evening hours (6 PM - midnight).`,
        });
      }

      return insights;
    }, [robberyHeat]);
    ```

    3. Replace the static text below Seasonality chart with:

    ```tsx
    <div className="mt-4">
      <InsightBox title="Seasonality Insights" insights={seasonalityInsights} />
    </div>
    ```

    4. Replace the static text below Robbery heatmap with:

    ```tsx
    <div className="mt-4">
      <InsightBox title="Robbery Pattern Insights" insights={robberyInsights} />
    </div>
    ```
  </action>
  <verify>
    ```bash
    cd /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web
    npm run typecheck
    npm run build
    echo "OK: Seasonality and Robbery insights added"
    ```
  </verify>
  <done>Seasonality and Robbery heatmap charts have InsightBox with derived pattern insights</done>
</task>

</tasks>

<verification>
1. Each chart card on Trends page has a narrative/insight section below the visualization
2. Insights are derived from the actual data (not static text)
3. TypeScript compiles without errors
4. Build succeeds
</verification>

<success_criteria>
- Annual trends: NarrativeCard + InsightBox (already exists)
- Monthly trends: InsightBox with dynamic insights
- COVID comparison: NarrativeCard + InsightBox
- Seasonality: InsightBox with peak period insights
- Robbery heatmap: InsightBox with pattern insights
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-quality/03-08-SUMMARY.md`
</output>
