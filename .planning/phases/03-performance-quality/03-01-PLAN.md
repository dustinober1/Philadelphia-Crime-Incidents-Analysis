---
phase: 03-performance-quality
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - web/package.json
  - web/next.config.ts
  - web/src/app/layout.tsx
autonomous: true

must_haves:
  truths:
    - "Next.js version is 15.5.7 or higher (CVE-2025-66478 patched)"
    - "Static pages render to HTML with progressive loading for data-fetching pages"
    - "Code splitting is enabled for heavy chart and map components"
    - "Root layout includes Suspense boundaries for streaming"
  artifacts:
    - path: "web/package.json"
      provides: "Dependency versions"
      contains: "\"next\": \"15.5."
    - path: "web/src/app/layout.tsx"
      provides: "Root layout with Suspense"
      exports: ["default"]
    - path: "web/next.config.ts"
      provides: "Next.js configuration for performance"
      min_lines: 10
  key_links:
    - from: "web/src/app/layout.tsx"
      to: "React Suspense"
      via: "import { Suspense } from 'react'"
      pattern: "import.*Suspense.*from.*react"
    - from: "web/package.json"
      to: "npm registry"
      via: "npm install next@15.5.7 or higher"
      pattern: "\"next\".*15\\.5\\.[7-9]"

---

<objective>
Upgrade Next.js and enable streaming SSR with code splitting to achieve sub-3-second initial load times.

**Purpose:** Address CVE-2025-66478 security vulnerability and implement streaming SSR for faster initial page loads.

**Output:**
- Next.js upgraded to 15.5.7+ (patched for CVE-2025-66478)
- Streaming SSR enabled with Suspense boundaries in root layout
- Dynamic imports configured for heavy components (maps, charts)
- Build configuration optimized for static generation
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-performance-quality/03-RESEARCH.md
@.planning/ROADMAP.md
@.planning/codebase/STRUCTURE.md

@web/package.json
@web/next.config.ts
@web/src/app/layout.tsx
@web/src/components/MapContainer.tsx
@web/src/components/charts/TrendChart.tsx
</context>

<tasks>

<task type="auto">
  <name>Upgrade Next.js to patched version</name>
  <files>web/package.json</files>
  <action>
    1. In web/package.json, change "next": "15.5.2" to "next": "15.5.9"
    2. Also update "eslint-config-next": "15.5.2" to "15.5.9"
    3. Run `cd /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web && npm install`
    4. Verify no breaking changes with `npm run build`

    Rationale: Next.js 15.5.7+ patches CVE-2025-66478 (RCE in React Server Components). Version 15.5.9 is the latest stable in the 15.5.x series.
  </action>
  <verify>
    grep '"next": "15.5.' web/package.json && cd web && npm run build 2>&1 | grep -E '(Compiled|error)'
  </verify>
  <done>
    Next.js version is 15.5.9 and build completes without errors
  </done>
</task>

<task type="auto">
  <name>Add Suspense boundaries to root layout</name>
  <files>web/src/app/layout.tsx</files>
  <action>
    1. Import Suspense from React
    2. Wrap the children in a Suspense boundary with a loading fallback
    3. Create a simple loading component (inline or separate) that shows skeleton UI

    Pattern:
    ```tsx
    import { Suspense } from "react";

    function LoadingFallback() {
      return (
        <div className="animate-pulse">
          <div className="h-8 bg-slate-200 rounded w-1/3 mb-4" />
          <div className="h-64 bg-slate-200 rounded" />
        </div>
      );
    }

    export default function RootLayout({ children }: { children: React.ReactNode }) {
      return (
        <html lang="en">
          <body className="flex min-h-screen flex-col">
            <Navbar />
            <main className="mx-auto w-full max-w-7xl flex-1 px-4 py-6 sm:px-6 lg:px-8">
              <Suspense fallback={<LoadingFallback />}>
                {children}
              </Suspense>
            </main>
            <Footer />
          </body>
        </html>
      );
    }
    ```

    Rationale: Suspense boundaries enable streaming SSR, allowing the page to render incrementally as data loads.
  </action>
  <verify>
    grep -A 5 "Suspense" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/app/layout.tsx
  </verify>
  <done>
    Root layout includes Suspense boundary with loading fallback skeleton
  </done>
</task>

<task type="auto">
  <name>Enable dynamic imports for heavy components</name>
  <files>web/src/app/trends/page.tsx</files>
  <action>
    1. Convert TrendChart to use dynamic import with loading state
    2. Convert MapContainer to use dynamic import on map page
    3. Add loading fallback components

    For trends page, add at top:
    ```tsx
    import dynamic from 'next/dynamic';

    const TrendChart = dynamic(() => import('@/components/charts/TrendChart').then(mod => ({ default: mod.TrendChart })), {
      loading: () => <div className="h-72 bg-slate-100 animate-pulse rounded" />,
      ssr: false
    });
    ```

    For map page, add similar pattern for MapContainer.

    Rationale: Dynamic imports reduce initial bundle size by code-splitting heavy chart and map components, loading them only when needed.
  </action>
  <verify>
    grep -n "dynamic.*import" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/app/trends/page.tsx
  </verify>
  <done>
    Heavy chart and map components use dynamic imports with loading fallbacks
  </done>
</task>

</tasks>

<verification>
1. Check Next.js version: `grep '"next"' web/package.json`
2. Verify build succeeds: `cd web && npm run build`
3. Verify Suspense exists: `grep "Suspense" web/src/app/layout.tsx`
4. Verify dynamic imports: `grep -r "dynamic.*import" web/src/app/`
5. Test page loads: `cd web && npm run build && npm start` (verify homepage loads in browser)
</verification>

<success_criteria>
- Next.js upgraded to 15.5.9 (CVE-2025-66478 patched)
- Root layout uses Suspense for streaming
- Heavy components use dynamic imports
- Build completes without errors
- Initial page HTML renders immediately (verify with `curl -I` or browser DevTools Network tab)
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-quality/03-01-SUMMARY.md` with:
- Actual Next.js version installed
- List of components converted to dynamic imports
- Any breaking changes encountered and resolved
- Bundle size comparison (before/after) if available via Next.js build output
</output>
