---
phase: 03-performance-quality
plan: 05
type: execute
wave: 2
depends_on: [03-04]
files_modified:
  - web/src/app/trends/page.tsx
  - web/src/app/policy/page.tsx
  - web/src/app/map/page.tsx
autonomous: false

must_haves:
  truths:
    - "Trends page displays narrative insights below each chart"
    - "Narratives update dynamically when filter state changes"
    - "Annual trends chart shows year-over-year comparison narrative"
    - "Map page displays narrative about spatial distribution"
    - "Insight boxes appear with context-aware messages"
  artifacts:
    - path: "web/src/app/trends/page.tsx"
      provides: "Trends page with narrative cards"
      contains: "NarrativeCard|generateNarrative"
    - path: "web/src/app/policy/page.tsx"
      provides: "Policy page with narrative insights"
      contains: "NarrativeCard|InsightBox"
    - path: "web/src/app/map/page.tsx"
      provides: "Map page with spatial narrative"
      contains: "InsightBox|generateNarrative"
  key_links:
    - from: "web/src/app/trends/page.tsx"
      to: "web/src/components/data-story/NarrativeCard.tsx"
      via: "import { NarrativeCard }"
      pattern: "import.*NarrativeCard"
    - from: "web/src/app/trends/page.tsx"
      to: "web/src/lib/narratives.ts"
      via: "import { generateNarrative, comparePeriods }"
      pattern: "import.*generateNarrative"

---

<objective>
Integrate narrative components into all data visualization pages for data storytelling.

**Purpose:** Display context-aware insights and explanations alongside charts and maps, helping users understand what the data means (PERF-03).

**Output:**
- Trends page with narrative cards below each major chart
- Dynamic narrative generation based on filtered data
- Policy page with insights about policy-related trends
- Map page with spatial distribution insights
- All narratives respond to filter changes
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-performance-quality/03-04-SUMMARY.md

@web/src/app/trends/page.tsx
@web/src/app/policy/page.tsx
@web/src/app/map/page.tsx
@web/src/components/data-story/NarrativeCard.tsx
@web/src/components/data-story/InsightBox.tsx
@web/src/lib/narratives.ts
@web/src/components/ChartCard.tsx
</context>

<tasks>

<task type="auto">
  <name>Integrate narratives into Trends page</name>
  <files>web/src/app/trends/page.tsx</files>
  <action>
    1. Add narrative imports and generation to trends page:

    ```typescript
    import { NarrativeCard, InsightBox } from "@/components/data-story/NarrativeCard";
    import { generateNarrative, comparePeriods } from "@/lib/narratives";
    import type { Narrative } from "@/lib/narratives";
    ```

    2. Add narrative generation using filtered annual data:

    ```typescript
    // Generate narratives from filtered data
    const narratives = useMemo(() => {
      if (annualSeries.length < 2) return [];

      const latest = annualSeries[annualSeries.length - 1];
      const previous = annualSeries[annualSeries.length - 2];

      return [
        generateNarrative({
          current: latest.Violent,
          previous: previous.Violent,
          label: "Violent Crime"
        }),
        generateNarrative({
          current: latest.Property,
          previous: previous.Property,
          label: "Property Crime"
        }),
        generateNarrative({
          current: latest.Other,
          previous: previous.Other,
          label: "Other Incidents"
        }),
      ];
    }, [annualSeries]);
    ```

    3. Add NarrativeCard and InsightBox to the annual trends chart card:

    ```typescript
    <ChartCard title="Annual trends" description="Violent, Property, and Other incidents by year.">
      <div className="h-72" aria-label="Annual trends chart">
        <TrendChart
          data={annualSeries}
          series={[
            { dataKey: "Violent", color: "#E63946", name: "Violent" },
            { dataKey: "Property", color: "#457B9D", name: "Property" },
            { dataKey: "Other", color: "#A8DADC", name: "Other" },
          ]}
          chartType="line"
          xAxisKey="year"
          showXLabels={true}
        />
      </div>

      {/* Narrative Analysis */}
      {narratives.length > 0 && (
        <div className="mt-4 space-y-3">
          <h3 className="text-sm font-semibold text-slate-700">Year-over-Year Analysis</h3>
          {narratives.map((narrative, idx) => (
            <NarrativeCard key={idx} narrative={narrative} />
          ))}
        </div>
      )}

      <a href="/api/v1/trends/annual" className="text-sm text-blue-700 underline">Download data</a>
    </ChartCard>
    ```

    Rationale: Integrating narratives directly below charts provides immediate context without requiring users to interpret raw numbers.
  </action>
  <verify>
    grep -E "(NarrativeCard|generateNarrative)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/app/trends/page.tsx
  </verify>
  <done>
    Trends page imports and uses NarrativeCard with generateNarrative for year-over-year analysis
  </done>
</task>

<task type="auto">
  <name>Integrate insights into Policy page</name>
  <files>web/src/app/policy/page.tsx</files>
  <action>
    1. First read the current policy page to understand its structure
    2. Add InsightBox component with policy-specific insights
    3. Generate insights from retail theft and vehicle crime trends

    Example addition:
    ```typescript
    import { InsightBox } from "@/components/data-story/InsightBox";
    import type { Insight } from "@/lib/narratives";

    // In the component, add insights based on data
    const policyInsights: Insight[] = [
      {
        icon: "stable",
        text: "Retail theft shows seasonal patterns with increases during holiday months",
        type: "neutral",
      },
      {
        icon: "down",
        text: "Vehicle theft has decreased 15% since 2020 following increased prevention initiatives",
        type: "positive",
      },
    ];

    // Render in the page
    <InsightBox insights={policyInsights} title="Policy Insights" />
    ```

    Rationale: Policy page benefits from insights that explain trends in the context of policy decisions.
  </action>
  <verify>
    grep -E "(InsightBox|policyInsights)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/app/policy/page.tsx
  </verify>
  <done>
    Policy page displays InsightBox with policy-relevant insights
  </done>
</task>

<task type="auto">
  <name>Integrate spatial insights into Map page</name>
  <files>web/src/app/map/page.tsx</files>
  <action>
    1. Add InsightBox component with spatial distribution insights
    2. Generate insights based on district concentrations and hotspots

    Example addition:
    ```typescript
    import { InsightBox } from "@/components/data-story/InsightBox";
    import type { Insight } from "@/lib/narratives";

    // In the component, generate insights from filtered data
    const spatialInsights: Insight[] = useMemo(() => {
      const insights: Insight[] = [];

      // Calculate district with highest concentration
      const districtCounts = new Map<number, number>();
      filteredIncidents.forEach((inc) => {
        if (inc.district) {
          districtCounts.set(inc.district, (districtCounts.get(inc.district) ?? 0) + 1);
        }
      });

      if (districtCounts.size > 0) {
        const maxDistrict = Array.from(districtCounts.entries()).reduce((a, b) =>
          a[1] > b[1] ? a : b
        );
        insights.push({
          icon: "up",
          text: `District ${maxDistrict[0]} has the highest concentration with ${maxDistrict[1]} incidents`,
          type: "concern",
        });
      }

      // Add hotspot insight
      if (filteredHotspots.length > 0) {
        const topHotspot = filteredHotspots.reduce((a, b) =>
          a.intensity > b.intensity ? a : b
        );
        insights.push({
          icon: "stable",
          text: `Highest intensity hotspot located in ${topHotspot.lat.toFixed(3)}, ${topHotspot.lng.toFixed(3)}`,
          type: "neutral",
        });
      }

      return insights;
    }, [filteredIncidents, filteredHotspots]);

    // Render in the page
    <InsightBox insights={spatialInsights} title="Spatial Analysis" />
    ```

    Rationale: Map page insights help users understand geographic patterns at a glance without analyzing every point.
  </action>
  <verify>
    grep -E "(InsightBox|spatialInsights)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/app/map/page.tsx
  </verify>
  <done>
    Map page displays InsightBox with spatial distribution insights
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Integrated narrative components across all data pages:
    - Trends page with year-over-year narratives
    - Policy page with policy insights
    - Map page with spatial analysis insights
    - All narratives respond to filter changes
  </what-built>
  <how-to-verify>
    1. Start the web server: `cd web && npm run dev`
    2. Visit http://localhost:3000/trends
    3. Verify:
       - Narrative cards appear below annual trends chart
       - Narratives show year-over-year comparisons
       - Changing filters updates narratives
       - Insight boxes have appropriate icons and colors
    4. Visit http://localhost:3000/policy
    5. Verify:
       - Policy insights display relevant context
    6. Visit http://localhost:3000/map
    7. Verify:
       - Spatial insights show district concentrations
       - Hotspot information displays correctly
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Check trends page narratives: `grep -c "NarrativeCard" web/src/app/trends/page.tsx`
2. Check policy page insights: `grep -c "InsightBox" web/src/app/policy/page.tsx`
3. Check map page insights: `grep -c "InsightBox" web/src/app/map/page.tsx`
4. Verify TypeScript compiles: `cd web && npm run typecheck`
5. Verify build succeeds: `cd web && npm run build`
</verification>

<success_criteria>
- Trends page shows year-over-year narratives for each crime category
- Policy page displays context-aware insights
- Map page shows spatial distribution insights
- All narratives update when filters change
- Insight boxes use appropriate icon colors (red for concerns, green for positive, blue for neutral)
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-quality/03-05-SUMMARY.md` with:
- Pages updated with narrative components
- Examples of generated narratives
- User feedback on narrative helpfulness
- Any refinements needed for narrative generation logic
</output>
