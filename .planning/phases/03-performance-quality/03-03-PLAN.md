---
phase: 03-performance-quality
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - web/src/app/trends/page.tsx
  - web/src/app/map/page.tsx
  - web/src/lib/api.ts
autonomous: false

must_haves:
  truths:
    - "Trends page uses AdvancedFilters component"
    - "Trends page charts update when filters change"
    - "Map page filters data by district when districts selected"
    - "Filter state persists across page navigation via URL params"
    - "Clear filters button resets all filters to default state"
  artifacts:
    - path: "web/src/app/trends/page.tsx"
      provides: "Trends page with integrated filtering"
      contains: "AdvancedFilters|useFilteredData"
    - path: "web/src/app/map/page.tsx"
      provides: "Map page with district filtering"
      contains: "AdvancedFilters|useFilteredData"
    - path: "web/src/lib/api.ts"
      provides: "API client with spatial data endpoints"
      exports: ["useSpatialData", "useHotspots"]
  key_links:
    - from: "web/src/app/trends/page.tsx"
      to: "web/src/components/filters/AdvancedFilters.tsx"
      via: "import { AdvancedFilters }"
      pattern: "import.*AdvancedFilters"
    - from: "web/src/app/trends/page.tsx"
      to: "web/src/hooks/useFilteredData.ts"
      via: "import { useFilteredData }"
      pattern: "import.*useFilteredData"
    - from: "web/src/app/trends/page.tsx"
      to: "URL search params"
      via: "useSearchParams hook"
      pattern: "useSearchParams"

---

<objective>
Integrate advanced filtering into Trends and Map pages with URL state synchronization.

**Purpose:** Apply the filtering infrastructure to actual pages, allowing users to filter data by date, district, and category with shareable URLs (PERF-02).

**Output:**
- Trends page with AdvancedFilters and live chart updates
- Map page with district-based filtering
- URL state synchronization for shareable filtered views
- Clear filters functionality
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-performance-quality/03-01-SUMMARY.md
@.planning/phases/03-performance-quality/03-02-SUMMARY.md

@web/src/app/trends/page.tsx
@web/src/app/map/page.tsx
@web/src/lib/api.ts
@web/src/components/filters/AdvancedFilters.tsx
@web/src/hooks/useFilteredData.ts
@web/src/lib/filters.ts
</context>

<tasks>

<task type="auto">
  <name>Add spatial data endpoints to API client</name>
  <files>web/src/lib/api.ts</files>
  <action>
    1. Add new SWR hooks for spatial data with district information:

    ```typescript
    export interface SpatialPoint {
      lat: number;
      lng: number;
      district?: number;
      crime_category?: string;
      dispatch_date?: string;
      text_general_code?: string;
    }

    export interface HotspotData {
      lat: number;
      lng: number;
      intensity: number;
    }

    export function useSpatialData() {
      return useSWR<SpatialPoint[]>("/api/v1/spatial/incidents", fetcher);
    }

    export function useHotspots() {
      return useSWR<HotspotData[]>("/api/v1/spatial/hotspots", fetcher);
    }

    export interface DistrictData {
      district: number;
      count: number;
      violent: number;
      property: number;
      other: number;
    }

    export function useDistrictStats() {
      return useSWR<DistrictData[]>("/api/v1/spatial/districts", fetcher);
    }
    ```

    Rationale: Spatial data endpoints provide the district and location information needed for map filtering.
  </action>
  <verify>
    grep -E "(useSpatialData|useHotspots|useDistrictStats)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/lib/api.ts
  </verify>
  <done>
    API client exports useSpatialData, useHotspots, and useDistrictStats hooks
  </done>
</task>

<task type="auto">
  <name>Integrate AdvancedFilters into Trends page</name>
  <files>web/src/app/trends/page.tsx</files>
  <action>
    1. Refactor trends page to use AdvancedFilters and URL state:

    ```typescript
    "use client";

    import { useMemo, useState } from "react";
    import { useSearchParams } from "next/navigation";
    import useSWR from "swr";

    import { AdvancedFilters } from "@/components/filters/AdvancedFilters";
    import { ChartCard } from "@/components/ChartCard";
    import { TrendChart } from "@/components/charts/TrendChart";
    import { fetcher, useAnnualTrends, useMonthlyTrends } from "@/lib/api";
    import type { FilterState } from "@/lib/types";
    import { applyFilters } from "@/lib/filters";

    // Initialize filter state from URL params
    function getInitialFilters(searchParams: URLSearchParams): FilterState {
      const start = searchParams.get("start");
      const end = searchParams.get("end");
      const districts = searchParams.get("districts")?.split(",").map(Number).filter(Boolean) ?? [];
      const categories = searchParams.get("categories")?.split(",").filter(Boolean) as ("Violent" | "Property" | "Other")[] ?? [];

      return {
        dateRange: start && end ? { start, end } : null,
        districts,
        categories,
      };
    }

    export default function TrendsPage() {
      const searchParams = useSearchParams();
      const [filters, setFilters] = useState<FilterState>(() => getInitialFilters(searchParams));

      const { data: annual = [] } = useAnnualTrends();
      const { data: monthly = [] } = useMonthlyTrends();
      const { data: covid = [] } = useSWR("/api/v1/trends/covid", fetcher);
      const { data: seasonality } = useSWR("/api/v1/trends/seasonality", fetcher);
      const { data: robberyHeat = [] } = useSWR("/api/v1/trends/robbery-heatmap", fetcher);

      // Apply filters to data
      const filteredAnnual = useMemo(() => applyFilters(annual, filters), [annual, filters]);
      const filteredMonthly = useMemo(() => applyFilters(monthly, filters), [monthly, filters]);

      // Transform to series format
      const annualSeries = useMemo(() => {
        const byYear = new Map<number, { year: number; Violent: number; Property: number; Other: number }>();
        filteredAnnual.forEach((row) => {
          const year = Number(row.year);
          if (!byYear.has(year)) {
            byYear.set(year, { year, Violent: 0, Property: 0, Other: 0 });
          }
          const bucket = byYear.get(year);
          if (!bucket) return;
          const category = row.crime_category;
          if (category === "Violent" || category === "Property" || category === "Other") {
            bucket[category] = row.count;
          } else {
            bucket.Other = row.count;
          }
        });
        return Array.from(byYear.values()).sort((a, b) => a.year - b.year);
      }, [filteredAnnual]);

      const monthlySeries = useMemo(() => {
        const byMonth = new Map<string, { month: string; Violent: number; Property: number; Other: number }>();
        filteredMonthly.forEach((row) => {
          const month = String(row.month).slice(0, 7);
          if (!byMonth.has(month)) {
            byMonth.set(month, { month, Violent: 0, Property: 0, Other: 0 });
          }
          const bucket = byMonth.get(month);
          if (!bucket) return;
          const category = row.crime_category;
          if (category === "Violent" || category === "Property" || category === "Other") {
            bucket[category] = row.count;
          } else {
            bucket.Other = row.count;
          }
        });
        return Array.from(byMonth.values());
      }, [filteredMonthly]);

      return (
        <div className="space-y-6">
          <h1 className="text-3xl font-bold">Crime Trends</h1>

          <AdvancedFilters
            filters={filters}
            onChange={setFilters}
            resultCount={filteredAnnual.length}
            totalCount={annual.length}
          />

          <ChartCard title="Annual trends" description="Violent, Property, and Other incidents by year.">
            <div className="h-72" aria-label="Annual trends chart">
              <TrendChart
                data={annualSeries}
                series={[
                  { dataKey: "Violent", color: "#E63946", name: "Violent" },
                  { dataKey: "Property", color: "#457B9D", name: "Property" },
                  { dataKey: "Other", color: "#A8DADC", name: "Other" },
                ]}
                chartType="line"
                xAxisKey="year"
                showXLabels={true}
              />
            </div>
            {annualSeries.length > 0 && annualSeries.length < annual.length && (
              <p className="text-sm text-slate-600">
                Showing {annualSeries.length} of {annual.length} years due to active filters.
              </p>
            )}
            <a href="/api/v1/trends/annual" className="text-sm text-blue-700 underline">Download data</a>
          </ChartCard>

          {/* Additional cards... */}
        </div>
      );
    }
    ```

    Rationale: Integrating AdvancedFilters makes filtering visible and functional. URL state initialization enables shareable filtered views.
  </action>
  <verify>
    grep -E "(AdvancedFilters|useSearchParams|getInitialFilters)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/app/trends/page.tsx
  </verify>
  <done>
    Trends page imports and renders AdvancedFilters component with filter state
  </done>
</task>

<task type="auto">
  <name>Integrate AdvancedFilters into Map page</name>
  <files>web/src/app/map/page.tsx</files>
  <action>
    1. Refactor map page to use district filtering:

    ```typescript
    "use client";

    import { useMemo, useState } from "react";
    import { useSearchParams } from "next/navigation";
    import { MapContainer } from "@/components/MapContainer";
    import { AdvancedFilters } from "@/components/filters/AdvancedFilters";
    import { useSpatialData, useHotspots } from "@/lib/api";
    import type { FilterState } from "@/lib/types";
    import { applyFilters } from "@/lib/filters";

    function getInitialFilters(searchParams: URLSearchParams): FilterState {
      const start = searchParams.get("start");
      const end = searchParams.get("end");
      const districts = searchParams.get("districts")?.split(",").map(Number).filter(Boolean) ?? [];
      const categories = searchParams.get("categories")?.split(",").filter(Boolean) ?? [];

      return {
        dateRange: start && end ? { start, end } : null,
        districts,
        categories,
      };
    }

    export default function MapPage() {
      const searchParams = useSearchParams();
      const [filters, setFilters] = useState<FilterState>(() => getInitialFilters(searchParams));
      const { data: incidents = [] } = useSpatialData();
      const { data: hotspots = [] } = useHotspots();

      // Filter incidents
      const filteredIncidents = useMemo(() => applyFilters(incidents, filters), [incidents, filters]);

      // Filter hotspots by district
      const filteredHotspots = useMemo(() => {
        if (filters.districts.length === 0) return hotspots;
        // Hotspots don't have district info, so we'd need backend support
        // For now, return all hotspots if any filter is active
        return hotspots;
      }, [hotspots, filters.districts]);

      return (
        <div className="space-y-6">
          <h1 className="text-3xl font-bold">Crime Map</h1>

          <AdvancedFilters
            filters={filters}
            onChange={setFilters}
            resultCount={filteredIncidents.length}
            totalCount={incidents.length}
          />

          <div className="rounded-lg border border-slate-200 bg-white p-4">
            <MapContainer
              incidents={filteredIncidents}
              hotspots={filteredHotspots}
            />
            {filteredIncidents.length < incidents.length && (
              <p className="mt-2 text-sm text-slate-600">
                Showing {filteredIncidents.length} of {incidents.length} incidents in selected area.
              </p>
            )}
          </div>
        </div>
      );
    }
    ```

    Rationale: Map page filtering enables users to focus on specific districts and time periods.
  </action>
  <verify>
    grep -E "(AdvancedFilters|useSpatialData|applyFilters)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/app/map/page.tsx
  </verify>
  <done>
    Map page imports and uses AdvancedFilters with filtered data passed to MapContainer
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Integrated AdvancedFilters into Trends and Map pages with:
    - URL state initialization from query params
    - Live chart/map updates when filters change
    - Result count display showing filtered vs total records
  </what-built>
  <how-to-verify>
    1. Start the web server: `cd web && npm run dev`
    2. Visit http://localhost:3000/trends
    3. Verify:
       - AdvancedFilters component renders above charts
       - Selecting districts updates charts
       - Selecting crime categories updates charts
       - Result count shows "X of Y records"
       - Clear all button resets filters
    4. Visit http://localhost:3000/map
    5. Verify:
       - AdvancedFilters renders above map
       - Selecting districts filters map incidents
       - Map shows fewer points when filters active
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. Check trends page integration: `grep -c "AdvancedFilters" web/src/app/trends/page.tsx`
2. Check map page integration: `grep -c "AdvancedFilters" web/src/app/map/page.tsx`
3. Verify TypeScript compiles: `cd web && npm run typecheck`
4. Verify build succeeds: `cd web && npm run build`
</verification>

<success_criteria>
- Trends page renders AdvancedFilters with live chart updates
- Map page renders AdvancedFilters with filtered incident display
- Filter state initializes from URL query params
- Clear filters button resets all filters
- Result count displays filtered vs total records
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-quality/03-03-SUMMARY.md` with:
- Pages modified with filter integration
- Filter state synchronization approach
- User feedback on filter UI/UX
- Any issues with map filtering (hotspots lack district info)
</output>
