---
phase: 03-performance-quality
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - web/src/components/data-story/InsightBox.tsx
  - web/src/components/data-story/NarrativeCard.tsx
  - web/src/lib/narratives.ts
autonomous: true

must_haves:
  truths:
    - "InsightBox component displays bullet-point insights with icons"
    - "NarrativeCard component displays explanatory text with data context"
    - "generateNarrative function creates text from trend data"
    - "Narratives respond to data changes (increases, decreases, stability)"
  artifacts:
    - path: "web/src/components/data-story/InsightBox.tsx"
      provides: "Insight display component with icons"
      min_lines: 40
    - path: "web/src/components/data-story/NarrativeCard.tsx"
      provides: "Narrative explanation component"
      min_lines: 40
    - path: "web/src/lib/narratives.ts"
      provides: "Narrative generation utilities"
      exports: ["generateNarrative", "Insight", "Narrative"]
  key_links:
    - from: "web/src/components/data-story/NarrativeCard.tsx"
      to: "web/src/lib/narratives.ts"
      via: "import { generateNarrative }"
      pattern: "import.*generateNarrative"

---

<objective>
Create data storytelling components for narrative explanations and insights alongside visualizations.

**Purpose:** Present data-driven insights and explanations that help users understand crime trends beyond raw charts (PERF-03).

**Output:**
- InsightBox component for bullet-point insights with icons
- NarrativeCard component for explanatory narrative text
- generateNarrative utility for rule-based narrative generation from trend data
- Styled components matching existing design system
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/03-performance-quality/03-RESEARCH.md

@web/src/components/ChartCard.tsx
@web/src/components/StatCard.tsx
@web/src/app/trends/page.tsx
@web/src/lib/types.ts
</context>

<tasks>

<task type="auto">
  <name>Create narrative generation utilities</name>
  <files>web/src/lib/narratives.ts</files>
  <action>
    1. Create web/src/lib/narratives.ts:

    ```typescript
    import { TrendingUp, TrendingDown, Minus } from "lucide-react";

    export interface TrendData {
      current: number;
      previous: number;
      label: string;
    }

    export interface Insight {
      icon: "up" | "down" | "stable";
      text: string;
      type: "concern" | "positive" | "neutral";
    }

    export interface Narrative {
      summary: string;
      explanation: string;
      insights: Insight[];
      context?: string;
    }

    export function generateNarrative(data: TrendData): Narrative {
      const change = data.current - data.previous;
      const percentChange = data.previous > 0 ? (change / data.previous) * 100 : 0;
      const isIncrease = change > 0;
      const magnitude = Math.abs(percentChange);

      let summary: string;
      let explanation: string;
      const insights: Insight[] = [];

      if (magnitude > 20) {
        // Significant change
        summary = isIncrease
          ? `Sharp ${increaseVerb(data.label)}: ${formatNumber(change)} more incidents`
          : `Major ${decreaseVerb(data.label)}: ${formatNumber(Math.abs(change))} fewer incidents`;
        explanation = isIncrease
          ? `${data.label} increased by ${percentChange.toFixed(1)}%, marking a significant shift that may warrant attention from community stakeholders.`
          : `${data.label} decreased by ${percentChange.toFixed(1)}%, representing substantial progress in crime reduction efforts.`;
        insights.push({
          icon: isIncrease ? "up" : "down",
          text: `${percentChange.toFixed(1)}% ${isIncrease ? "increase" : "decrease"} compared to previous period`,
          type: isIncrease ? "concern" : "positive",
        });
      } else if (magnitude > 5) {
        // Moderate change
        summary = isIncrease
          ? `${data.label} ${increaseVerb(data.label)}: ${formatNumber(change)} more incidents`
          : `${data.label} ${decreaseVerb(data.label)}: ${formatNumber(Math.abs(change))} fewer incidents`;
        explanation = `${data.label} changed by ${percentChange.toFixed(1)}%, reflecting ${isIncrease ? "an upward" : "a downward"} trend that warrants monitoring.`;
        insights.push({
          icon: isIncrease ? "up" : "down",
          text: `${percentChange.toFixed(1)}% ${isIncrease ? "increase" : "decrease"} year-over-year`,
          type: "neutral",
        });
      } else {
        // Stable
        summary = `${data.label} remains stable: ${formatNumber(data.current)} incidents`;
        explanation = `${data.label} showed minimal change (${percentChange.toFixed(1)}%), indicating stable conditions in this category.`;
        insights.push({
          icon: "stable",
          text: `Stable trend with ${percentChange.toFixed(1)}% variation`,
          type: "neutral",
        });
      }

      // Add contextual insight based on category
      if (data.label.toLowerCase().includes("violent")) {
        insights.push({
          icon: magnitude > 10 && isIncrease ? "up" : "stable",
          text: "Violent crime typically correlates with community resources and policing strategies",
          type: "neutral",
        });
      } else if (data.label.toLowerCase().includes("property")) {
        insights.push({
          icon: magnitude > 10 && isIncrease ? "up" : "stable",
          text: "Property crime often follows economic cycles and seasonal patterns",
          type: "neutral",
        });
      }

      return { summary, explanation, insights };
    }

    function increaseVerb(label: string): string {
      const lower = label.toLowerCase();
      if (lower.includes("crime")) return "increase in crime";
      if (lower.includes("incident")) return "rise in incidents";
      return "increase";
    }

    function decreaseVerb(label: string): string {
      const lower = label.toLowerCase();
      if (lower.includes("crime")) return "decrease in crime";
      if (lower.includes("incident")) return "drop in incidents";
      return "decrease";
    }

    function formatNumber(n: number): string {
      return Math.abs(n).toLocaleString();
    }

    export function comparePeriods(
      currentData: { [key: string]: number },
      previousData: { [key: string]: number }
    ): Narrative[] {
      const narratives: Narrative[] = [];

      for (const key of Object.keys(currentData)) {
        const current = currentData[key];
        const previous = previousData[key] ?? 0;
        narratives.push(generateNarrative({ current, previous, label: key }));
      }

      return narratives;
    }
    ```

    Rationale: Centralized narrative generation ensures consistent insight language and makes it easy to add narratives to any chart.
  </action>
  <verify>
    grep -E "(export.*generateNarrative|export.*comparePeriods)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/lib/narratives.ts
  </verify>
  <done>
    narratives.ts exports generateNarrative, comparePeriods, and related types
  </done>
</task>

<task type="auto">
  <name>Create InsightBox component</name>
  <files>web/src/components/data-story/InsightBox.tsx</files>
  <action>
    1. Create web/src/components/data-story/InsightBox.tsx:

    ```typescript
    import { AlertTriangle, CheckCircle, Info, TrendingUp, TrendingDown, Minus } from "lucide-react";
    import type { Insight } from "@/lib/narratives";

    interface InsightBoxProps {
      insights: Insight[];
      title?: string;
    }

    const iconMap = {
      up: TrendingUp,
      down: TrendingDown,
      stable: Minus,
    };

    const typeConfig = {
      concern: {
        icon: AlertTriangle,
        bgColor: "bg-amber-50",
        borderColor: "border-amber-200",
        textColor: "text-amber-900",
      },
      positive: {
        icon: CheckCircle,
        bgColor: "bg-emerald-50",
        borderColor: "border-emerald-200",
        textColor: "text-emerald-900",
      },
      neutral: {
        icon: Info,
        bgColor: "bg-blue-50",
        borderColor: "border-blue-200",
        textColor: "text-blue-900",
      },
    };

    export function InsightBox({ insights, title = "Key Insights" }: InsightBoxProps) {
      if (insights.length === 0) return null;

      return (
        <div className="rounded-lg border border-slate-200 bg-white p-4">
          <h4 className="mb-3 flex items-center gap-2 font-semibold text-slate-900">
            <Info className="h-5 w-5 text-blue-500" />
            {title}
          </h4>
          <ul className="space-y-2">
            {insights.map((insight, index) => {
              const config = typeConfig[insight.type];
              const TrendIcon = iconMap[insight.icon];
              const TypeIcon = config.icon;

              return (
                <li
                  key={index}
                  className={`flex items-start gap-3 rounded-md border ${config.borderColor} ${config.bgColor} px-3 py-2`}
                >
                  <TypeIcon className={`h-4 w-4 mt-0.5 flex-shrink-0 ${config.textColor}`} />
                  <TrendIcon className={`h-4 w-4 mt-0.5 flex-shrink-0 ${insight.icon === "up" ? "text-red-500" : insight.icon === "down" ? "text-emerald-500" : "text-slate-400"}`} />
                  <span className={`text-sm ${config.textColor}`}>{insight.text}</span>
                </li>
              );
            })}
          </ul>
        </div>
      );
    }
    ```

    Rationale: InsightBox provides consistent visual presentation for bullet-point insights with appropriate icons and color coding.
  </action>
  <verify>
    grep -E "(export.*InsightBox|InsightBoxProps)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/components/data-story/InsightBox.tsx
  </verify>
  <done>
    InsightBox component renders insights with appropriate icons and styling
  </done>
</task>

<task type="auto">
  <name>Create NarrativeCard component</name>
  <files>web/src/components/data-story/NarrativeCard.tsx</files>
  <action>
    1. Create web/src/components/data-story/NarrativeCard.tsx:

    ```typescript
    import { BookOpen } from "lucide-react";
    import type { Narrative } from "@/lib/narratives";
    import { InsightBox } from "./InsightBox";

    interface NarrativeCardProps {
      narrative: Narrative;
      title?: string;
    }

    export function NarrativeCard({ narrative, title = "Analysis" }: NarrativeCardProps) {
      return (
        <div className="rounded-lg border border-slate-200 bg-white p-5">
          <h4 className="mb-3 flex items-center gap-2 font-semibold text-slate-900">
            <BookOpen className="h-5 w-5 text-blue-500" />
            {title}
          </h4>

          <div className="space-y-3">
            {/* Summary */}
            <div>
              <h5 className="text-sm font-medium text-slate-700">Summary</h5>
              <p className="mt-1 text-sm text-slate-900">{narrative.summary}</p>
            </div>

            {/* Explanation */}
            <div>
              <h5 className="text-sm font-medium text-slate-700">Explanation</h5>
              <p className="mt-1 text-sm text-slate-600">{narrative.explanation}</p>
            </div>

            {/* Context (optional) */}
            {narrative.context && (
              <div>
                <h5 className="text-sm font-medium text-slate-700">Context</h5>
                <p className="mt-1 text-sm text-slate-600">{narrative.context}</p>
              </div>
            )}

            {/* Insights */}
            {narrative.insights.length > 0 && (
              <InsightBox insights={narrative.insights} title="Key Insights" />
            )}
          </div>
        </div>
      );
    }
    ```

    Rationale: NarrativeCard combines narrative text with insights in a card component matching the existing ChartCard design pattern.
  </action>
  <verify>
    grep -E "(export.*NarrativeCard|NarrativeCardProps)" /Users/dustinober/Projects/Philadelphia-Crime-Incidents-Analysis/web/src/components/data-story/NarrativeCard.tsx
  </verify>
  <done>
    NarrativeCard component renders narrative with summary, explanation, and insights
  </done>
</task>

</tasks>

<verification>
1. Check narratives.ts exports: `grep "export" web/src/lib/narratives.ts`
2. Check InsightBox exports: `grep "export" web/src/components/data-story/InsightBox.tsx`
3. Check NarrativeCard exports: `grep "export" web/src/components/data-story/NarrativeCard.tsx`
4. Verify TypeScript compiles: `cd web && npm run typecheck`
</verification>

<success_criteria>
- narratives.ts exports generateNarrative function with TrendData input
- InsightBox renders insights list with color-coded icons
- NarrativeCard renders full narrative with sections
- All components use existing design tokens (colors, spacing)
- TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance-quality/03-04-SUMMARY.md` with:
- Narrative generation logic implemented
- Component props and usage patterns
- Example narrative outputs for different trend scenarios
</output>
