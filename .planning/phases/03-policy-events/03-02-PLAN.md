# Plan 03-02: Retail Theft Trend Analysis

**Phase:** 3 — Policy Deep Dives & Event Impacts
**Wave:** 2 (Core Analysis)
**Requirement:** POLICY-01
**Depends on:** 03-01 (Infrastructure & External Data)

## Goal

Create a notebook that analyzes 5-year retail theft trends, validates or refutes the media narrative of a "retail theft crisis," and provides evidence-based verdict with visualizations.

## Context

From 03-01, this plan will use:
- `config/phase3_config.yaml` for analysis parameters
- `analysis/phase3_config_loader.py` for config access

Implementation decisions from 03-CONTEXT.md:
- Focus on "Thefts" category (UCR 600) as proxy for retail theft (no separate retail code)
- 5-year analysis window: 2019-2024
- Baseline: 2018-2019 average
- Verdict threshold: >25% increase = "supported"

Data exploration revealed:
- `text_general_code` = "Thefts" is the relevant category
- Recent trend: 22,870 (2017) → 40,423 (2024) shows significant increase
- COVID dip visible in 2020 data

## Tasks

### 1. Create Notebook Structure

**1.1 Create `notebooks/retail_theft_trend.ipynb`**

Standard notebook structure per AGENTS.md:
- Title: "Retail Theft Trend Analysis (POLICY-01)"
- Overview: Evaluate the retail theft trend and provide evidence-based verdict
- Reproducibility cell with version info
- Imports: pandas, numpy, matplotlib, seaborn

### 2. Data Loading and Filtering

**2.1 Load Data and Filter to Thefts**
```python
from analysis.utils import load_data
from analysis.phase3_config_loader import Phase3Config

df = load_data(clean=True)
config = Phase3Config()

# Filter to theft incidents
theft_codes = config.retail_theft['text_codes']
df_theft = df[df['text_general_code'].isin(theft_codes)].copy()

# Extract year
df_theft['year'] = df_theft['dispatch_date'].dt.year

print(f"Total theft incidents: {len(df_theft):,}")
print(f"Year range: {df_theft['year'].min()} - {df_theft['year'].max()}")
```

### 3. Annual Trend Analysis

**3.1 Calculate Annual Counts**
```python
analysis_years = config.retail_theft['analysis_years']
baseline_years = config.retail_theft['baseline_years']

# Annual theft counts
annual_counts = df_theft[df_theft['year'].isin(analysis_years + baseline_years)]\
    .groupby('year').size().reset_index(name='count')

# Calculate baseline
baseline = annual_counts[annual_counts['year'].isin(baseline_years)]['count'].mean()
print(f"Baseline ({baseline_years[0]}-{baseline_years[1]} avg): {baseline:,.0f} thefts/year")
```

**3.2 Calculate Year-over-Year Changes**
```python
annual_counts['yoy_change'] = annual_counts['count'].pct_change() * 100
annual_counts['vs_baseline'] = (annual_counts['count'] / baseline - 1) * 100

# Get most recent complete year
latest_year = max([y for y in analysis_years if y < 2026])
latest_count = annual_counts[annual_counts['year'] == latest_year]['count'].values[0]
latest_vs_baseline = (latest_count / baseline - 1) * 100

print(f"\n{latest_year} vs baseline: {latest_vs_baseline:+.1f}%")
```

### 4. Trend Visualization

**4.1 Create Trend Line Chart**
```python
import matplotlib.pyplot as plt
import seaborn as sns

fig, ax = plt.subplots(figsize=(12, 6))

# Plot trend line
years = annual_counts['year']
counts = annual_counts['count']

ax.plot(years, counts, marker='o', markersize=8, linewidth=2, color='#E63946')
ax.axhline(y=baseline, color='#457B9D', linestyle='--', linewidth=1.5,
           label=f'Baseline ({baseline_years[0]}-{baseline_years[1]} avg)')

# Shade COVID period
ax.axvspan(2020, 2021, alpha=0.2, color='gray', label='COVID Period')

# Annotations
for i, row in annual_counts.iterrows():
    if row['year'] in [baseline_years[0], latest_year]:
        ax.annotate(f"{row['count']:,.0f}",
                   (row['year'], row['count']),
                   textcoords="offset points", xytext=(0, 10),
                   ha='center', fontsize=9)

ax.set_xlabel('Year', fontsize=12)
ax.set_ylabel('Theft Incidents', fontsize=12)
ax.set_title('Philadelphia Theft Incidents: 5-Year Trend', fontsize=14)
ax.legend(loc='upper left')
ax.grid(True, alpha=0.3)

# Format y-axis with commas
ax.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{x:,.0f}'))

plt.tight_layout()
plt.savefig(REPORTS_DIR / 'retail_theft_trend.png', dpi=300, bbox_inches='tight')
artifacts.append(('retail_theft_trend.png', 'Theft trend visualization'))
plt.show()
```

### 5. Monthly Pattern Analysis

**5.1 Create Monthly Breakdown**
```python
# Monthly patterns to identify seasonal effects
df_theft['month'] = df_theft['dispatch_date'].dt.month
df_theft['year_month'] = df_theft['dispatch_date'].dt.to_period('M')

monthly_counts = df_theft[df_theft['year'].isin(analysis_years)]\
    .groupby(['year', 'month']).size().unstack(fill_value=0)

# Heatmap of monthly patterns
fig, ax = plt.subplots(figsize=(14, 6))
sns.heatmap(monthly_counts, annot=True, fmt='d', cmap='YlOrRd',
            xticklabels=['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun',
                        'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
            ax=ax)
ax.set_xlabel('Month', fontsize=12)
ax.set_ylabel('Year', fontsize=12)
ax.set_title('Monthly Theft Counts by Year', fontsize=14)

plt.tight_layout()
plt.savefig(REPORTS_DIR / 'retail_theft_monthly_heatmap.png', dpi=300, bbox_inches='tight')
artifacts.append(('retail_theft_monthly_heatmap.png', 'Monthly theft heatmap'))
plt.show()
```

**5.2 Identify Peak Months**
```python
# Average by month across analysis years
monthly_avg = df_theft[df_theft['year'].isin(analysis_years)]\
    .groupby('month').size() / len(analysis_years)

# Holiday shopping season (Nov-Dec) vs rest of year
holiday_avg = monthly_avg.loc[[11, 12]].mean()
non_holiday_avg = monthly_avg.drop([11, 12]).mean()
holiday_premium = (holiday_avg / non_holiday_avg - 1) * 100

print(f"Holiday season (Nov-Dec) premium: {holiday_premium:+.1f}%")
```

### 6. Verdict Determination

**6.1 Calculate Verdict**
```python
verdict_threshold = config.retail_theft['verdict_threshold']
pct_increase = latest_vs_baseline / 100

if pct_increase > verdict_threshold:
    verdict = "SUPPORTED"
    verdict_text = f"The data supports a significant increase in theft incidents."
else:
    verdict = "NOT SUPPORTED"
    verdict_text = f"The data does not support a significant increase in theft incidents."

print("\n" + "="*60)
print(f"VERDICT: {verdict}")
print("="*60)
print(f"\nBaseline ({baseline_years[0]}-{baseline_years[1]}): {baseline:,.0f} thefts/year")
print(f"Latest year ({latest_year}): {latest_count:,.0f} thefts/year")
print(f"Change from baseline: {latest_vs_baseline:+.1f}%")
print(f"Threshold for 'supported': >{verdict_threshold*100:.0f}%")
print(f"\n{verdict_text}")
```

### 7. Export Summary Report

**7.1 Create Markdown Report**
```python
report_content = f"""# Retail Theft Trend Analysis Report

## Executive Summary

**Verdict: {verdict}**

{verdict_text}

## Key Findings

### 5-Year Trend
- Baseline average ({baseline_years[0]}-{baseline_years[1]}): **{baseline:,.0f}** thefts/year
- Latest complete year ({latest_year}): **{latest_count:,.0f}** thefts/year
- Change from baseline: **{latest_vs_baseline:+.1f}%**

### Year-by-Year Breakdown

| Year | Count | YoY Change | vs Baseline |
|------|-------|------------|-------------|
"""

for _, row in annual_counts.iterrows():
    yoy = f"{row['yoy_change']:+.1f}%" if pd.notna(row['yoy_change']) else "—"
    vsb = f"{row['vs_baseline']:+.1f}%" if pd.notna(row['vs_baseline']) else "—"
    report_content += f"| {int(row['year'])} | {row['count']:,} | {yoy} | {vsb} |\n"

report_content += f"""

### Seasonal Patterns
- Holiday shopping season (Nov-Dec) shows {holiday_premium:+.1f}% premium over other months
- Peak month: {monthly_avg.idxmax()} with average {monthly_avg.max():,.0f} incidents

## Methodology

- **Data source**: Philadelphia Police Department crime incident data
- **Category**: "Thefts" (UCR code 600)
- **Analysis period**: {analysis_years[0]}-{analysis_years[-1]}
- **Baseline period**: {baseline_years[0]}-{baseline_years[1]}
- **Verdict threshold**: >{verdict_threshold*100:.0f}% increase from baseline

## Caveats

1. This analysis uses "Thefts" as a proxy for retail theft. The data does not distinguish between retail theft and other theft categories.
2. Changes in reporting practices may affect year-over-year comparisons.
3. COVID-19 pandemic (2020-2021) created abnormal conditions that may distort trend analysis.

---
*Generated: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M')}*
*Notebook: retail_theft_trend.ipynb*
"""

with open(REPORTS_DIR / 'retail_theft_report.md', 'w') as f:
    f.write(report_content)

artifacts.append(('retail_theft_report.md', 'Summary report with verdict'))
```

### 8. Export Data

**8.1 Save Annual Counts**
```python
annual_counts.to_csv(REPORTS_DIR / 'retail_theft_annual.csv', index=False)
artifacts.append(('retail_theft_annual.csv', 'Annual theft counts'))
```

### 9. Notebook Completion

**9.1 Artifact Summary Cell**
```python
print("\n" + "="*60)
print("NOTEBOOK COMPLETE: Retail Theft Trend Analysis (POLICY-01)")
print("="*60)
print(f"\nVerdict: {verdict}")
print(f"\nArtifacts generated:")
for name, desc in artifacts:
    print(f"  - {name}: {desc}")
print(f"\nRuntime: {time.time() - RUNTIME_START:.1f} seconds")
```

## Validation Criteria

- [ ] Notebook executes end-to-end without errors
- [ ] Reproducibility cell present with version info
- [ ] `reports/retail_theft_trend.png` exists at 300 DPI
- [ ] `reports/retail_theft_monthly_heatmap.png` shows clear seasonal pattern
- [ ] `reports/retail_theft_report.md` contains verdict and data table
- [ ] `reports/retail_theft_annual.csv` contains year, count, and change columns
- [ ] Verdict is clearly stated as SUPPORTED or NOT SUPPORTED
- [ ] COVID period is noted in analysis

## Dependencies

- matplotlib, seaborn (for visualizations)
- pandas (for data manipulation)
- 03-01 infrastructure: phase3_config_loader.py

## Estimated Time

- Notebook structure: 10 min
- Data loading and filtering: 10 min
- Annual trend analysis: 15 min
- Monthly analysis: 15 min
- Report generation: 15 min
- Testing & validation: 10 min
- **Total: ~75 min**

---
*Plan created: 2026-02-03*
