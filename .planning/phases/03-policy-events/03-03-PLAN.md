# Plan 03-03: Vehicle Crimes Corridor Analysis

**Phase:** 3 â€” Policy Deep Dives & Event Impacts
**Wave:** 2 (Core Analysis)
**Requirement:** POLICY-02
**Depends on:** 03-01 (Infrastructure & External Data)

## Goal

Create a geospatial analysis notebook that maps vehicle-related crimes, overlays major transit/highway corridors, and quantifies the proportion of incidents occurring within corridor buffer zones.

## Context

From 03-01, this plan will use:
- `config/phase3_config.yaml` for corridor buffer parameters
- `data/boundaries/corridors.geojson` for highway and SEPTA geometries
- `analysis/spatial_utils.py` for coordinate operations
- `analysis/phase3_config_loader.py` for config access

Implementation decisions from 03-CONTEXT.md:
- Vehicle crimes: "Theft from Vehicle" + "Motor Vehicle Theft"
- Buffer distance: 500m (~5 city blocks)
- Corridors: I-95, I-76, I-676, US-1, Market-Frankford Line, Broad Street Line
- Output: % of incidents within each corridor buffer

Data exploration revealed:
- "Theft from Vehicle": 283,814 incidents
- "Motor Vehicle Theft": 125,639 incidents
- Total vehicle crimes: ~409,000 incidents

## Tasks

### 1. Create Notebook Structure

**1.1 Create `notebooks/vehicle_crimes_corridors.ipynb`**

Standard notebook structure per AGENTS.md:
- Title: "Vehicle Crimes Corridor Analysis (POLICY-02)"
- Overview: Analyze spatial relationship between vehicle crimes and transit/highway corridors
- Reproducibility cell with version info
- Imports: pandas, geopandas, folium, matplotlib, shapely

### 2. Data Loading

**2.1 Load Crime Data and Filter to Vehicle Crimes**
```python
from analysis.utils import load_data
from analysis.spatial_utils import clean_coordinates
from analysis.phase3_config_loader import Phase3Config
import geopandas as gpd

df = load_data(clean=True)
config = Phase3Config()

# Filter to vehicle crimes
vehicle_codes = config.vehicle_crimes['text_codes']
df_vehicle = df[df['text_general_code'].isin(vehicle_codes)].copy()

# Clean coordinates
df_vehicle = clean_coordinates(df_vehicle, x_col='point_x', y_col='point_y')

print(f"Total vehicle crime incidents: {len(df_vehicle):,}")
print(f"Crime types: {df_vehicle['text_general_code'].value_counts().to_dict()}")
```

**2.2 Load Corridor Data**
```python
repo_root = Path(__file__).resolve().parent.parent
corridors = gpd.read_file(repo_root / 'data' / 'boundaries' / 'corridors.geojson')

print(f"Loaded {len(corridors)} corridor segments")
print(corridors[['name', 'type']].drop_duplicates())
```

### 3. Create Corridor Buffers

**3.1 Project and Buffer Corridors**
```python
# Buffer distance from config
buffer_meters = config.vehicle_crimes['buffer_meters']

# Project to UTM (meters) for accurate buffering
corridors_utm = corridors.to_crs(epsg=32618)  # UTM 18N for Philadelphia
corridors_buffered = corridors_utm.copy()
corridors_buffered['geometry'] = corridors_utm.buffer(buffer_meters)

# Convert back to WGS84
corridors_buffered = corridors_buffered.to_crs(epsg=4326)

print(f"Created {buffer_meters}m buffers around corridors")
```

**3.2 Create Combined Corridor Buffer**
```python
from shapely.ops import unary_union

# Union of all corridor buffers
all_corridors_buffer = corridors_buffered.union_all()

# Separate buffers by type
highway_buffer = corridors_buffered[corridors_buffered['type'] == 'highway'].union_all()
transit_buffer = corridors_buffered[corridors_buffered['type'] == 'subway'].union_all()

print("Created combined corridor buffers")
```

### 4. Spatial Join Analysis

**4.1 Create Crime GeoDataFrame**
```python
from shapely.geometry import Point

# Create GeoDataFrame from vehicle crimes
geometry = [Point(xy) for xy in zip(df_vehicle['point_x'], df_vehicle['point_y'])]
gdf_vehicle = gpd.GeoDataFrame(df_vehicle, geometry=geometry, crs="EPSG:4326")

print(f"Created GeoDataFrame with {len(gdf_vehicle):,} vehicle crimes")
```

**4.2 Identify Crimes Within Corridors**
```python
# Check which crimes fall within each corridor type
gdf_vehicle['in_highway_buffer'] = gdf_vehicle.geometry.within(highway_buffer)
gdf_vehicle['in_transit_buffer'] = gdf_vehicle.geometry.within(transit_buffer)
gdf_vehicle['in_any_corridor'] = gdf_vehicle.geometry.within(all_corridors_buffer)

# Calculate percentages
pct_highway = gdf_vehicle['in_highway_buffer'].mean() * 100
pct_transit = gdf_vehicle['in_transit_buffer'].mean() * 100
pct_any = gdf_vehicle['in_any_corridor'].mean() * 100

print(f"\nVehicle crimes within corridor buffers ({buffer_meters}m):")
print(f"  Highway corridors: {pct_highway:.1f}%")
print(f"  Transit corridors: {pct_transit:.1f}%")
print(f"  Any corridor: {pct_any:.1f}%")
```

**4.3 Per-Corridor Breakdown**
```python
# Join crimes to individual corridors
gdf_corridors = gpd.GeoDataFrame(corridors_buffered, geometry='geometry')
corridor_counts = gpd.sjoin(gdf_vehicle, gdf_corridors, how='left', predicate='within')

per_corridor = corridor_counts.groupby('name').size().reset_index(name='incident_count')
per_corridor['pct_of_total'] = per_corridor['incident_count'] / len(gdf_vehicle) * 100
per_corridor = per_corridor.sort_values('incident_count', ascending=False)

print("\nIncidents per corridor:")
print(per_corridor.to_string(index=False))
```

### 5. Static Map Visualization

**5.1 Create Corridor Overlay Map**
```python
import matplotlib.pyplot as plt
from matplotlib.patches import Patch

fig, ax = plt.subplots(figsize=(14, 12))

# Plot corridor buffers
corridors_buffered[corridors_buffered['type'] == 'highway'].plot(
    ax=ax, color='#FED976', alpha=0.5, edgecolor='#FD8D3C', linewidth=1,
    label='Highway Buffer (500m)'
)
corridors_buffered[corridors_buffered['type'] == 'subway'].plot(
    ax=ax, color='#9ECAE1', alpha=0.5, edgecolor='#3182BD', linewidth=1,
    label='Transit Buffer (500m)'
)

# Sample crimes for visualization (too many to plot all)
sample_size = min(20000, len(gdf_vehicle))
sample = gdf_vehicle.sample(sample_size, random_state=42)

# Plot crimes by category
tfv = sample[sample['text_general_code'] == 'Theft from Vehicle']
mvt = sample[sample['text_general_code'] == 'Motor Vehicle Theft']

ax.scatter(tfv.geometry.x, tfv.geometry.y, c='#E63946', s=1, alpha=0.3, label='Theft from Vehicle')
ax.scatter(mvt.geometry.x, mvt.geometry.y, c='#457B9D', s=1, alpha=0.3, label='Motor Vehicle Theft')

# Add corridor centerlines for reference
corridors.plot(ax=ax, color='black', linewidth=1.5, linestyle='--')

ax.set_xlim(config.coordinate_bounds['min_lon'], config.coordinate_bounds['max_lon'])
ax.set_ylim(config.coordinate_bounds['min_lat'], config.coordinate_bounds['max_lat'])

ax.set_xlabel('Longitude')
ax.set_ylabel('Latitude')
ax.set_title(f'Vehicle Crimes and Transit/Highway Corridors\n({pct_any:.1f}% within {buffer_meters}m of corridors)')
ax.legend(loc='upper right')

plt.tight_layout()
plt.savefig(REPORTS_DIR / 'vehicle_crimes_corridors.png', dpi=300, bbox_inches='tight')
artifacts.append(('vehicle_crimes_corridors.png', 'Static map with corridor overlay'))
plt.show()
```

### 6. Interactive Map

**6.1 Create Folium Map**
```python
import folium
from folium.plugins import HeatMap

# Center on Philadelphia
center_lat = gdf_vehicle.geometry.y.mean()
center_lon = gdf_vehicle.geometry.x.mean()

m = folium.Map(location=[center_lat, center_lon], zoom_start=11, tiles='CartoDB positron')

# Add corridor buffers
folium.GeoJson(
    corridors_buffered[corridors_buffered['type'] == 'highway'].__geo_interface__,
    style_function=lambda x: {'fillColor': '#FD8D3C', 'color': '#FD8D3C', 'weight': 1, 'fillOpacity': 0.3},
    name='Highway Corridors'
).add_to(m)

folium.GeoJson(
    corridors_buffered[corridors_buffered['type'] == 'subway'].__geo_interface__,
    style_function=lambda x: {'fillColor': '#3182BD', 'color': '#3182BD', 'weight': 1, 'fillOpacity': 0.3},
    name='Transit Corridors'
).add_to(m)

# Add crime heatmap (sample for performance)
sample = gdf_vehicle.sample(min(15000, len(gdf_vehicle)), random_state=42)
heat_data = [[row.geometry.y, row.geometry.x] for _, row in sample.iterrows()]
HeatMap(heat_data, radius=8, blur=10, name='Vehicle Crime Density').add_to(m)

# Add corridor centerlines
folium.GeoJson(
    corridors.__geo_interface__,
    style_function=lambda x: {'color': 'black', 'weight': 2, 'dashArray': '5,5'},
    name='Corridor Centerlines'
).add_to(m)

folium.LayerControl().add_to(m)

m.save(str(REPORTS_DIR / 'vehicle_crimes_corridors.html'))
artifacts.append(('vehicle_crimes_corridors.html', 'Interactive corridor map'))
```

### 7. Temporal Analysis

**7.1 Time-of-Day Patterns Near Corridors**
```python
# Compare crime patterns inside vs outside corridor buffers
gdf_vehicle['hour'] = pd.to_datetime(gdf_vehicle['dispatch_date_time'], errors='coerce').dt.hour

inside = gdf_vehicle[gdf_vehicle['in_any_corridor']]
outside = gdf_vehicle[~gdf_vehicle['in_any_corridor']]

inside_hourly = inside.groupby('hour').size() / len(inside)
outside_hourly = outside.groupby('hour').size() / len(outside)

fig, ax = plt.subplots(figsize=(12, 5))
hours = range(24)
width = 0.35

ax.bar([h - width/2 for h in hours], inside_hourly.reindex(hours, fill_value=0), 
       width, label='Within Corridors', color='#FD8D3C')
ax.bar([h + width/2 for h in hours], outside_hourly.reindex(hours, fill_value=0),
       width, label='Outside Corridors', color='#457B9D')

ax.set_xlabel('Hour of Day')
ax.set_ylabel('Proportion of Crimes')
ax.set_title('Vehicle Crime Timing: Inside vs Outside Corridor Buffers')
ax.legend()
ax.set_xticks(hours)

plt.tight_layout()
plt.savefig(REPORTS_DIR / 'vehicle_crimes_hourly_corridor.png', dpi=300, bbox_inches='tight')
artifacts.append(('vehicle_crimes_hourly_corridor.png', 'Hourly patterns by corridor proximity'))
plt.show()
```

### 8. Export Summary

**8.1 Create Summary Report**
```python
report_content = f"""# Vehicle Crimes Corridor Analysis Report

## Executive Summary

**{pct_any:.1f}%** of vehicle crimes in Philadelphia occur within {buffer_meters}m (~{buffer_meters//100} blocks) of major transit/highway corridors.

## Key Findings

### Corridor Proximity
| Corridor Type | % of Vehicle Crimes |
|---------------|---------------------|
| Highway corridors | {pct_highway:.1f}% |
| Transit corridors | {pct_transit:.1f}% |
| Any corridor | {pct_any:.1f}% |

### Per-Corridor Breakdown
| Corridor | Incidents | % of Total |
|----------|-----------|------------|
"""

for _, row in per_corridor.head(10).iterrows():
    report_content += f"| {row['name']} | {row['incident_count']:,} | {row['pct_of_total']:.1f}% |\n"

report_content += f"""

### Crime Type Distribution
| Crime Type | Total | Within Corridors |
|------------|-------|------------------|
| Theft from Vehicle | {len(gdf_vehicle[gdf_vehicle['text_general_code'] == 'Theft from Vehicle']):,} | {gdf_vehicle[(gdf_vehicle['text_general_code'] == 'Theft from Vehicle') & gdf_vehicle['in_any_corridor']].shape[0]:,} |
| Motor Vehicle Theft | {len(gdf_vehicle[gdf_vehicle['text_general_code'] == 'Motor Vehicle Theft']):,} | {gdf_vehicle[(gdf_vehicle['text_general_code'] == 'Motor Vehicle Theft') & gdf_vehicle['in_any_corridor']].shape[0]:,} |

## Methodology

- **Buffer distance**: {buffer_meters}m from corridor centerlines
- **Corridors analyzed**: I-95, I-76, I-676, US-1, Market-Frankford Line, Broad Street Line
- **Crime types**: Theft from Vehicle, Motor Vehicle Theft
- **Analysis period**: All available years

## Implications

1. Vehicle crimes show {"strong" if pct_any > 30 else "moderate"} concentration near major corridors
2. {"Highway" if pct_highway > pct_transit else "Transit"} corridors have higher incidence rates
3. Consider enhanced patrols at corridor access points

---
*Generated: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M')}*
*Notebook: vehicle_crimes_corridors.ipynb*
"""

with open(REPORTS_DIR / 'vehicle_crimes_corridor_report.md', 'w') as f:
    f.write(report_content)

artifacts.append(('vehicle_crimes_corridor_report.md', 'Analysis summary report'))
```

**8.2 Export Quantification Data**
```python
# Save corridor statistics
corridor_stats = pd.DataFrame({
    'corridor_type': ['highway', 'transit', 'any'],
    'pct_of_crimes': [pct_highway, pct_transit, pct_any],
    'buffer_meters': buffer_meters,
    'total_crimes': len(gdf_vehicle)
})
corridor_stats.to_csv(REPORTS_DIR / 'vehicle_crimes_corridor_stats.csv', index=False)
artifacts.append(('vehicle_crimes_corridor_stats.csv', 'Corridor statistics'))

# Save per-corridor breakdown
per_corridor.to_csv(REPORTS_DIR / 'vehicle_crimes_per_corridor.csv', index=False)
artifacts.append(('vehicle_crimes_per_corridor.csv', 'Per-corridor breakdown'))
```

### 9. Notebook Completion

**9.1 Artifact Summary Cell**
```python
print("\n" + "="*60)
print("NOTEBOOK COMPLETE: Vehicle Crimes Corridor Analysis (POLICY-02)")
print("="*60)
print(f"\nKey finding: {pct_any:.1f}% of vehicle crimes within {buffer_meters}m of corridors")
print(f"\nArtifacts generated:")
for name, desc in artifacts:
    print(f"  - {name}: {desc}")
print(f"\nRuntime: {time.time() - RUNTIME_START:.1f} seconds")
```

## Validation Criteria

- [ ] Notebook executes end-to-end without errors
- [ ] Reproducibility cell present with version info
- [ ] `reports/vehicle_crimes_corridors.png` shows corridors with crime overlay
- [ ] `reports/vehicle_crimes_corridors.html` opens in browser with layers
- [ ] `reports/vehicle_crimes_corridor_report.md` contains quantification
- [ ] `reports/vehicle_crimes_corridor_stats.csv` contains buffer metrics
- [ ] Buffer analysis produces reasonable percentages (not 0% or 100%)
- [ ] Both crime types (Theft from Vehicle, Motor Vehicle Theft) included

## Dependencies

- geopandas (for spatial operations)
- folium (for interactive map)
- shapely (for buffering)
- matplotlib (for static visualizations)
- 03-01 infrastructure: corridors.geojson, phase3_config_loader.py

## Estimated Time

- Notebook structure: 10 min
- Data loading & filtering: 10 min
- Corridor buffering: 15 min
- Spatial join analysis: 20 min
- Static visualization: 15 min
- Interactive map: 15 min
- Report generation: 10 min
- **Total: ~95 min**

---
*Plan created: 2026-02-03*
