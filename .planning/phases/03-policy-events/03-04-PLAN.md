# Plan 03-04: Crime Composition Analysis

**Phase:** 3 â€” Policy Deep Dives & Event Impacts
**Wave:** 2 (Core Analysis)
**Requirement:** POLICY-03
**Depends on:** 03-01 (Infrastructure & External Data)

## Goal

Create a notebook that analyzes the year-by-year composition of crime types, focusing on the violent/total ratio trend, with a stacked area visualization and interpretation of shifts in crime patterns.

## Context

From 03-01, this plan will use:
- `config/phase3_config.yaml` for UCR band classifications
- `analysis/utils.py` for crime category classification

Implementation decisions from 03-CONTEXT.md:
- Violent = Homicide (100), Rape (200), Robbery (300), Aggravated Assault (400)
- Property = Burglary (500), Theft (600), Motor Vehicle Theft (700)
- Analysis period: 2015-2024
- Interpret trends in context of overall crime volume changes

Data exploration revealed:
- Violent crime ratio: ~8-11% of total crime
- Ratio increased during COVID (2020: 11.4%) vs pre-COVID (2019: 9.5%)
- Recent decline: 2024 ratio ~8.4%

## Tasks

### 1. Create Notebook Structure

**1.1 Create `notebooks/crime_composition.ipynb`**

Standard notebook structure per AGENTS.md:
- Title: "Crime Composition Analysis (POLICY-03)"
- Overview: Analyze year-by-year crime composition and violent/total ratio trends
- Reproducibility cell with version info
- Imports: pandas, numpy, matplotlib, seaborn

### 2. Data Loading and Classification

**2.1 Load and Classify Data**
```python
from analysis.utils import load_data, classify_crime_category
from analysis.phase3_config_loader import Phase3Config

df = load_data(clean=True)
config = Phase3Config()

# Classify crimes
df = classify_crime_category(df)

# Extract year
df['year'] = df['dispatch_date'].dt.year

# Filter to analysis years
analysis_years = config.crime_composition['analysis_years']
df_analysis = df[df['year'].isin(analysis_years)].copy()

print(f"Total incidents in analysis period: {len(df_analysis):,}")
print(f"Category distribution:\n{df_analysis['crime_category'].value_counts()}")
```

### 3. Violent/Total Ratio Analysis

**3.1 Calculate Annual Ratios**
```python
# Aggregate by year and category
annual_counts = df_analysis.groupby(['year', 'crime_category']).size().unstack(fill_value=0)

# Calculate totals and ratios
annual_counts['Total'] = annual_counts.sum(axis=1)
annual_counts['Violent_Ratio'] = annual_counts['Violent'] / annual_counts['Total'] * 100
annual_counts['Property_Ratio'] = annual_counts['Property'] / annual_counts['Total'] * 100
annual_counts['Other_Ratio'] = annual_counts['Other'] / annual_counts['Total'] * 100

print("Violent/Total Ratio by Year:")
print(annual_counts[['Total', 'Violent', 'Violent_Ratio']].to_string())
```

**3.2 Identify Key Trends**
```python
# Calculate trend metrics
early_years = [2015, 2016, 2017]
covid_years = [2020, 2021]
recent_years = [2023, 2024]

early_ratio = annual_counts.loc[early_years, 'Violent_Ratio'].mean()
covid_ratio = annual_counts.loc[covid_years, 'Violent_Ratio'].mean()
recent_ratio = annual_counts.loc[recent_years, 'Violent_Ratio'].mean()

print(f"\nViolent crime ratio trends:")
print(f"  Early period (2015-2017): {early_ratio:.2f}%")
print(f"  COVID period (2020-2021): {covid_ratio:.2f}%")
print(f"  Recent period (2023-2024): {recent_ratio:.2f}%")
print(f"  COVID vs early: {covid_ratio - early_ratio:+.2f} pp")
print(f"  Recent vs COVID: {recent_ratio - covid_ratio:+.2f} pp")
```

### 4. Stacked Area Visualization

**4.1 Create Stacked Area Chart**
```python
import matplotlib.pyplot as plt
from matplotlib.colors import LinearSegmentedColormap

fig, ax = plt.subplots(figsize=(14, 7))

years = annual_counts.index
violent = annual_counts['Violent']
property_crime = annual_counts['Property']
other = annual_counts['Other']

# Stacked area with custom colors
ax.stackplot(years, 
             violent, property_crime, other,
             labels=['Violent', 'Property', 'Other'],
             colors=['#E63946', '#457B9D', '#A8DADC'],
             alpha=0.8)

# Add COVID marker
ax.axvline(x=2020, color='gray', linestyle='--', linewidth=1.5, alpha=0.7)
ax.annotate('COVID-19', (2020.1, annual_counts['Total'].max() * 0.95),
            fontsize=10, color='gray')

ax.set_xlabel('Year', fontsize=12)
ax.set_ylabel('Number of Incidents', fontsize=12)
ax.set_title('Philadelphia Crime Composition by Year', fontsize=14)
ax.legend(loc='upper left')
ax.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{x/1000:.0f}K'))

plt.tight_layout()
plt.savefig(REPORTS_DIR / 'crime_composition_stacked.png', dpi=300, bbox_inches='tight')
artifacts.append(('crime_composition_stacked.png', 'Stacked area composition chart'))
plt.show()
```

**4.2 Create Percentage Stacked Area**
```python
fig, ax = plt.subplots(figsize=(14, 7))

# Normalize to percentages
pct_violent = annual_counts['Violent_Ratio']
pct_property = annual_counts['Property_Ratio']
pct_other = annual_counts['Other_Ratio']

ax.stackplot(years,
             pct_violent, pct_property, pct_other,
             labels=['Violent', 'Property', 'Other'],
             colors=['#E63946', '#457B9D', '#A8DADC'],
             alpha=0.8)

# Add COVID marker
ax.axvline(x=2020, color='white', linestyle='--', linewidth=2)

ax.set_xlabel('Year', fontsize=12)
ax.set_ylabel('Percentage of Total Crime', fontsize=12)
ax.set_title('Philadelphia Crime Composition (% of Total)', fontsize=14)
ax.legend(loc='upper left')
ax.set_ylim(0, 100)

plt.tight_layout()
plt.savefig(REPORTS_DIR / 'crime_composition_pct.png', dpi=300, bbox_inches='tight')
artifacts.append(('crime_composition_pct.png', 'Percentage composition chart'))
plt.show()
```

### 5. Violent Ratio Trend Line

**5.1 Create Violent Ratio Line Chart**
```python
fig, ax1 = plt.subplots(figsize=(12, 6))

# Plot violent ratio as line
color = '#E63946'
ax1.plot(years, annual_counts['Violent_Ratio'], 'o-', color=color, 
         linewidth=2, markersize=8, label='Violent Crime Ratio')
ax1.set_xlabel('Year', fontsize=12)
ax1.set_ylabel('Violent Crime Ratio (%)', fontsize=12, color=color)
ax1.tick_params(axis='y', labelcolor=color)

# Add secondary axis for total crime volume
ax2 = ax1.twinx()
color = '#457B9D'
ax2.bar(years, annual_counts['Total'], alpha=0.3, color=color, label='Total Crimes')
ax2.set_ylabel('Total Incidents', fontsize=12, color=color)
ax2.tick_params(axis='y', labelcolor=color)
ax2.yaxis.set_major_formatter(plt.FuncFormatter(lambda x, p: f'{x/1000:.0f}K'))

# Add COVID shading
ax1.axvspan(2020, 2021, alpha=0.1, color='gray')

# Combine legends
lines1, labels1 = ax1.get_legend_handles_labels()
lines2, labels2 = ax2.get_legend_handles_labels()
ax1.legend(lines1 + lines2, labels1 + labels2, loc='upper right')

ax1.set_title('Violent Crime Ratio vs Total Crime Volume', fontsize=14)

plt.tight_layout()
plt.savefig(REPORTS_DIR / 'violent_ratio_trend.png', dpi=300, bbox_inches='tight')
artifacts.append(('violent_ratio_trend.png', 'Violent ratio trend with volume'))
plt.show()
```

### 6. Detailed Category Breakdown

**6.1 Sub-Category Analysis**
```python
# Get UCR hundred-bands for detailed breakdown
df_analysis['ucr_band'] = pd.to_numeric(df_analysis['ucr_general'], errors='coerce') // 100

# Category labels
ucr_labels = {
    1: 'Homicide',
    2: 'Rape',
    3: 'Robbery',
    4: 'Agg. Assault',
    5: 'Burglary',
    6: 'Theft',
    7: 'Motor Veh. Theft',
    8: 'Arson',
}

df_analysis['ucr_category'] = df_analysis['ucr_band'].map(ucr_labels).fillna('Other')

# Subcategory by year
subcategory_counts = df_analysis.groupby(['year', 'ucr_category']).size().unstack(fill_value=0)

# Violent subcategories only
violent_subcats = ['Homicide', 'Rape', 'Robbery', 'Agg. Assault']
violent_detail = subcategory_counts[violent_subcats]

print("Violent crime breakdown by year:")
print(violent_detail.tail(5))
```

**6.2 Violent Crime Composition Heatmap**
```python
fig, ax = plt.subplots(figsize=(10, 8))

# Normalize within violent crimes
violent_pct = violent_detail.div(violent_detail.sum(axis=1), axis=0) * 100

sns.heatmap(violent_pct.T, annot=True, fmt='.1f', cmap='Reds',
            cbar_kws={'label': '% of Violent Crime'}, ax=ax)

ax.set_xlabel('Year')
ax.set_ylabel('Crime Type')
ax.set_title('Violent Crime Composition by Type')

plt.tight_layout()
plt.savefig(REPORTS_DIR / 'violent_composition_heatmap.png', dpi=300, bbox_inches='tight')
artifacts.append(('violent_composition_heatmap.png', 'Violent crime subcategory heatmap'))
plt.show()
```

### 7. Interpretation and Report

**7.1 Generate Interpretation**
```python
# Determine key interpretations
if covid_ratio > early_ratio + 1:
    covid_impact = "increased"
    covid_explanation = "likely due to decreased property crime reporting during lockdowns"
else:
    covid_impact = "remained stable"
    covid_explanation = "despite overall crime volume changes"

if recent_ratio < covid_ratio:
    recent_trend = "declining"
    recent_explanation = "returning toward pre-pandemic levels"
else:
    recent_trend = "elevated"
    recent_explanation = "remaining above pre-pandemic baseline"

interpretation = f"""
## Key Interpretations

1. **COVID Impact**: The violent crime ratio {covid_impact} during 2020-2021, 
   {covid_explanation}. This does not necessarily mean more violent crime occurred,
   but rather that violent crime comprised a larger share of reported incidents.

2. **Recent Trend**: The violent crime ratio is {recent_trend}, {recent_explanation}.
   Current ratio ({recent_ratio:.1f}%) compared to pre-COVID ({early_ratio:.1f}%).

3. **Volume Context**: Total crime volume {"decreased" if annual_counts['Total'].iloc[-1] < annual_counts['Total'].iloc[0] else "increased"} 
   from {annual_counts['Total'].iloc[0]:,} ({years[0]}) to {annual_counts['Total'].iloc[-1]:,} ({years[-1]}).

4. **Composition Stability**: Despite year-to-year fluctuations, the overall composition
   remains relatively stable, with violent crimes consistently representing 8-11% of 
   total reported incidents.
"""
print(interpretation)
```

**7.2 Create Summary Report**
```python
report_content = f"""# Crime Composition Analysis Report

## Executive Summary

This analysis examines the year-by-year composition of crime in Philadelphia, focusing on the ratio of violent crimes to total crimes.

## Key Findings

### Violent Crime Ratio by Period
| Period | Avg Violent Ratio | Total Violent |
|--------|-------------------|---------------|
| Early (2015-2017) | {early_ratio:.2f}% | {annual_counts.loc[early_years, 'Violent'].sum():,} |
| COVID (2020-2021) | {covid_ratio:.2f}% | {annual_counts.loc[covid_years, 'Violent'].sum():,} |
| Recent (2023-2024) | {recent_ratio:.2f}% | {annual_counts.loc[recent_years, 'Violent'].sum():,} |

### Year-by-Year Data
| Year | Total | Violent | Property | Other | Violent % |
|------|-------|---------|----------|-------|-----------|
"""

for year in years:
    row = annual_counts.loc[year]
    report_content += f"| {year} | {row['Total']:,} | {row['Violent']:,} | {row['Property']:,} | {row['Other']:,} | {row['Violent_Ratio']:.1f}% |\n"

report_content += f"""
{interpretation}

## Methodology

- **Violent crimes**: Homicide (UCR 100), Rape (200), Robbery (300), Aggravated Assault (400)
- **Property crimes**: Burglary (500), Theft (600), Motor Vehicle Theft (700)
- **Other crimes**: All other UCR categories
- **Analysis period**: {analysis_years[0]}-{analysis_years[-1]}

---
*Generated: {pd.Timestamp.now().strftime('%Y-%m-%d %H:%M')}*
*Notebook: crime_composition.ipynb*
"""

with open(REPORTS_DIR / 'crime_composition_report.md', 'w') as f:
    f.write(report_content)

artifacts.append(('crime_composition_report.md', 'Composition analysis report'))
```

### 8. Export Data

**8.1 Save Annual Composition Data**
```python
annual_counts.to_csv(REPORTS_DIR / 'crime_composition_annual.csv')
artifacts.append(('crime_composition_annual.csv', 'Annual composition data'))

violent_detail.to_csv(REPORTS_DIR / 'violent_subcategory_annual.csv')
artifacts.append(('violent_subcategory_annual.csv', 'Violent crime subcategory data'))
```

### 9. Notebook Completion

**9.1 Artifact Summary Cell**
```python
print("\n" + "="*60)
print("NOTEBOOK COMPLETE: Crime Composition Analysis (POLICY-03)")
print("="*60)
print(f"\nKey finding: Violent crime ratio ranged from {annual_counts['Violent_Ratio'].min():.1f}% to {annual_counts['Violent_Ratio'].max():.1f}%")
print(f"\nArtifacts generated:")
for name, desc in artifacts:
    print(f"  - {name}: {desc}")
print(f"\nRuntime: {time.time() - RUNTIME_START:.1f} seconds")
```

## Validation Criteria

- [x] Notebook executes end-to-end without errors
- [x] Reproducibility cell present with version info
- [x] `reports/crime_composition_stacked.png` shows absolute counts
- [x] `reports/crime_composition_pct.png` shows percentage breakdown
- [x] `reports/violent_ratio_trend.png` shows dual-axis visualization
- [x] `reports/crime_composition_analysis.md` contains interpretation
- [x] `reports/crime_composition_annual.csv` contains all years and categories
- [x] Violent ratio values are reasonable (8-12% range) - Actual: 8.4% to 11.4%

## Dependencies

- matplotlib, seaborn (for visualizations)
- pandas (for data manipulation)
- 03-01 infrastructure: phase3_config_loader.py

## Estimated Time

- Notebook structure: 10 min
- Data classification: 10 min
- Ratio calculations: 10 min
- Stacked area charts: 15 min
- Trend visualization: 10 min
- Interpretation & report: 10 min
- **Total: ~65 min**

---
*Plan created: 2026-02-03*
