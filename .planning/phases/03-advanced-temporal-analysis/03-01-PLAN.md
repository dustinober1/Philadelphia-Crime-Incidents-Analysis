---
phase: 03-advanced-temporal-analysis
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - analysis/03-01-holiday_effects.py
autonomous: true

must_haves:
  truths:
    - "User can view holiday effects analysis showing crime patterns during holiday periods"
    - "Analysis includes pre-holiday (3 days before), holiday day, and post-holiday (3 days after) comparisons"
    - "Statistical tests (chi-square, ANOVA) determine if holiday effects are significant"
    - "Results include base64-encoded plots for markdown report embedding"
  artifacts:
    - path: "analysis/03-01-holiday_effects.py"
      provides: "Holiday effects analysis module"
      min_lines: 300
      exports:
        - "identify_holiday_periods"
        - "analyze_holiday_effects"
        - "generate_holiday_markdown_report"
  key_links:
    - from: "analysis/03-01-holiday_effects.py"
      to: "analysis/config.py"
      via: "import STAT_CONFIG, COLORS, FIGURE_SIZES"
      pattern: "from analysis\\.config import"
    - from: "analysis/03-01-holiday_effects.py"
      to: "analysis/stats_utils.py"
      via: "chi_square_test, compare_multiple_samples, apply_fdr_correction"
      pattern: "from analysis\\.stats_utils import"
---

<objective>
Create holiday effects analysis module that identifies crime patterns around major U.S. holidays with statistical rigor.

Purpose: Enable understanding of how crime rates change during holiday periods (pre-holiday, holiday day, post-holiday) compared to baseline. This informs resource allocation decisions for police departments during high-risk periods.

Output: Analysis module `analysis/03-01-holiday_effects.py` with functions for holiday detection, statistical testing, and visualization generation.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

@analysis/robbery_timing.py
@analysis/summer_spike.py
@analysis/config.py
@analysis/stats_utils.py
@analysis/utils.py
</context>

<tasks>

<task type="auto">
  <name>Create holiday effects analysis module</name>
  <files>analysis/03-01-holiday_effects.py</files>
  <action>
Create file `analysis/03-01-holiday_effects.py` following the pattern from `analysis/robbery_timing.py` and `analysis/summer_spike.py`.

Module must include:

1. **HOLIDAY CONSTANTS**:
   - Import workalendar.america.UnitedStates for U.S. federal holidays
   - Define HOLIDAY_WINDOW_DAYS = 3 (days before/after to include)
   - Define BASELINE_WEEKS = 2 (weeks before/after for comparison)

2. **FUNCTION: identify_holiday_periods(df) -> pd.DataFrame**:
   - Get all holidays for each year in the dataset using workalendar
   - Create 'holiday_period' column with values: 'pre_holiday', 'holiday', 'post_holiday', 'baseline'
   - Create 'holiday_name' column for the specific holiday
   - For each holiday: mark days_before as 'pre_holiday', holiday date as 'holiday', days_after as 'post_holiday'
   - All other days are 'baseline'

3. **FUNCTION: analyze_holiday_effects() -> dict**:
   - Load data via load_data(clean=False)
   - Extract temporal features via extract_temporal_features()
   - Call identify_holiday_periods() to add holiday classification
   - Set seed via set_global_seed(STAT_CONFIG["random_seed"])
   - Store metadata via get_analysis_metadata()

   Statistical tests:
   - Chi-square test for holiday vs baseline crime distribution
   - Compare daily counts: holiday period vs baseline (compare_two_samples)
   - Bootstrap 99% CI for holiday effect size (bootstrap_ci)
   - Per-holiday analysis with FDR correction for multiple comparisons (apply_fdr_correction)

   Return dict with:
   - metadata: analysis metadata
   - holiday_baseline_test: chi-square test results
   - effect_size: Cohen's d for holiday vs baseline
   - effect_ci: bootstrap confidence interval
   - by_holiday: dict of per-holiday statistics
   - holiday_calendar_plot: base64-encoded visualization
   - daily_count_plot: base64-encoded visualization

4. **FUNCTION: create_holiday_calendar_plot(df) -> str**:
   - Create visualization showing holiday periods across the calendar year
   - Use heatmap format with crime rates highlighted
   - Return base64-encoded image tag via create_image_tag(image_to_base64(fig))

5. **FUNCTION: create_daily_comparison_plot(holiday_df, baseline_df) -> str**:
   - Create box plot comparing daily crime counts: pre-holiday, holiday, post-holiday, baseline
   - Highlight holiday period with different color
   - Return base64-encoded image tag

6. **FUNCTION: generate_holiday_markdown_report(results) -> str**:
   - Follow pattern from robbery_timing.py generate_markdown_report()
   - Include metadata section via format_metadata_markdown()
   - Executive summary with key findings
   - Statistical test results with p-values and effect sizes
   - Embedded plots (holiday_calendar_plot, daily_count_plot)
   - Per-holiday breakdown table
   - Methodology section
   - Return complete markdown string

7. **IF __name__ == "__main__" block**:
   - Run analyze_holiday_effects()
   - Generate report
   - Save to reports/13_holiday_effects_report.md
   - Print confirmation message

Key implementation notes:
- Exclude 2026 from trend analysis (incomplete year)
- Handle missing hour data gracefully
- Use existing visualization patterns from robbery_timing.py
- All statistical tests use STAT_CONFIG["alpha"] = 0.01
- Bootstrap uses STAT_CONFIG["bootstrap_n_resamples"] = 9999
- Include exact p-values and effect size interpretations in report
</action>
  <verify>
python -c "from analysis.03_01_holiday_effects import analyze_holiday_effects; result = analyze_holiday_effects(); print('Holiday analysis complete:', 'holiday_baseline_test' in result)"
</verify>
  <done>
analyze_holiday_effects() executes without errors and returns dict with:
- 'holiday_baseline_test' containing chi-square test results (statistic, p_value, is_significant)
- 'by_holiday' dict with per-holiday statistics
- 'holiday_calendar_plot' and 'daily_count_plot' as base64 image tags
</done>
</task>

</tasks>

<verification>
Run the analysis module:
```bash
python -c "from analysis.03_01_holiday_effects import analyze_holiday_effects; result = analyze_holiday_effects(); print('Keys:', list(result.keys()))"
```

Verify outputs:
- Chi-square test results include p_value < 0.01 for significance threshold
- At least 10 U.S. federal holidays analyzed
- Plots are valid base64-encoded images (start with 'data:image/png;base64,')
- Report markdown includes metadata section
</verification>

<success_criteria>
- Module identifies 15+ U.S. federal holidays per year
- Statistical tests determine significance of holiday effects
- Visualizations clearly show holiday vs baseline differences
- Report is publication-ready with embedded plots and statistics
- All functions follow existing codebase patterns (robbery_timing.py, summer_spike.py)
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-temporal-analysis/03-01-SUMMARY.md`
</output>
