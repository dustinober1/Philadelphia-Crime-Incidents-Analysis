---
phase: 03-advanced-temporal-analysis
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - analysis/03-02-crime_type_profiles.py
autonomous: true

must_haves:
  truths:
    - "User can view individual analysis for homicide, burglary, theft, vehicle theft, aggravated assault"
    - "Each crime type has temporal trends, spatial distribution, and seasonality analysis"
    - "Statistical tests include Mann-Kendall trend test and chi-square uniformity tests"
    - "Small samples (n < 30) use exact tests, large samples use asymptotic tests"
  artifacts:
    - path: "analysis/03-02-crime_type_profiles.py"
      provides: "Individual crime type analysis module"
      min_lines: 400
      exports:
        - "CRIME_TYPE_FILTERS"
        - "analyze_crime_type_profile"
        - "analyze_all_crime_types"
        - "generate_crime_type_report"
  key_links:
    - from: "analysis/03-02-crime_type_profiles.py"
      to: "analysis/config.py"
      via: "import STAT_CONFIG, COLORS, FIGURE_SIZES, PHILADELPHIA_BBOX"
      pattern: "from analysis\\.config import"
    - from: "analysis/03-02-crime_type_profiles.py"
      to: "analysis/stats_utils.py"
      via: "mann_kendall_test, chi_square_test, bootstrap_ci"
      pattern: "from analysis\\.stats_utils import"
    - from: "analysis/03-02-crime_type_profiles.py"
      to: "analysis/utils.py"
      via: "load_data, validate_coordinates, extract_temporal_features"
      pattern: "from analysis\\.utils import"
---

<objective>
Create individual crime type analysis module for homicide, burglary, theft, vehicle theft, and aggravated assault with full temporal, spatial, and seasonal profiles.

Purpose: Provide detailed crime-specific analysis beyond the existing robbery timing module. Each crime type has distinct patterns that require individual examination for effective policing strategies.

Output: Analysis module `analysis/03-02-crime_type_profiles.py` with functions for filtering by crime type, computing temporal trends, spatial distributions, and generating crime-specific reports.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

@analysis/robbery_timing.py
@analysis/summer_spike.py
@analysis/config.py
@analysis/stats_utils.py
@analysis/utils.py
@analysis/spatial_analysis.py
</context>

<tasks>

<task type="auto">
  <name>Create crime type profiles analysis module</name>
  <files>analysis/03-02-crime_type_profiles.py</files>
  <action>
Create file `analysis/03-02-crime_type_profiles.py` following patterns from `analysis/robbery_timing.py` and `analysis/spatial_analysis.py`.

Module must include:

1. **CRIME TYPE FILTERS**:
```python
CRIME_TYPE_FILTERS = {
    "homicide": ["Homicide - Criminal", "Homicide - Gross Negligence"],
    "burglary": ["Burglary Residential", "Burglary Non-Residential"],
    "theft": ["Thefts", "Theft from Vehicle"],
    "vehicle_theft": ["Motor Vehicle Theft"],
    "aggravated_assault": ["Aggravated Assault Firearm", "Aggravated Assault No Firearm"]
}
```

2. **FUNCTION: filter_crime_type(df, crime_type) -> pd.DataFrame**:
   - Filter df using text_general_code.isin(CRIME_TYPE_FILTERS[crime_type])
   - Validate coordinates via validate_coordinates()
   - Extract temporal features via extract_temporal_features()
   - Return filtered dataframe

3. **FUNCTION: analyze_crime_type_profile(df, crime_type) -> dict**:
   - Call filter_crime_type() to get crime-specific data
   - Set seed via set_global_seed(STAT_CONFIG["random_seed"])
   - Store metadata via get_analysis_metadata()

   Temporal analysis:
   - Calculate yearly counts (exclude 2026 for trend analysis)
   - Run mann_kendall_test() on yearly counts for trend detection
   - Calculate monthly averages for seasonality
   - Calculate day-of-week distribution
   - Run chi_square_test() for temporal uniformity

   Spatial analysis (if valid_coords >= 100):
   - Calculate coordinate statistics (mean, std for lat/lon)
   - Identify top 5 police districts by count
   - If sample >= 500: run dbscan_clustering() for hotspots

   Sample size handling:
   - If n < 30: Note "Small sample - limited statistical power"
   - If n < 100: Use Fisher's exact test for proportions
   - If n >= 30: Use asymptotic tests (chi-square, t-tests)

   Return dict with:
   - crime_type: name
   - total_incidents: count
   - sample_size_category: 'rare' (<100), 'moderate' (100-1000), 'common' (>1000)
   - temporal_trend: mann_kendall_test result
   - seasonal_pattern: monthly stats
   - day_of_week: day-of-week distribution
   - spatial_distribution: coordinate and district stats
   - hotspots: clustering results (if applicable)
   - timeseries_plot: base64 image
   - seasonal_plot: base64 image
   - spatial_plot: base64 image (if applicable)

4. **FUNCTION: analyze_all_crime_types() -> dict**:
   - Load data via load_data(clean=False)
   - Extract temporal features
   - For each crime_type in CRIME_TYPE_FILTERS.keys():
     - Call analyze_crime_type_profile(df, crime_type)
   - Return dict with all crime type results

5. **FUNCTION: create_crime_type_timeseries(crime_df, crime_type) -> str**:
   - Create line plot of yearly incident counts
   - Add trend line if significant Mann-Kendall result
   - Highlight peak and trough years
   - Return base64-encoded image tag

6. **FUNCTION: create_seasonal_pattern_plot(crime_df, crime_type) -> str**:
   - Create bar chart of monthly averages
   - Highlight peak month in danger color
   - Add error bars (std dev) if multiple years
   - Return base64-encoded image tag

7. **FUNCTION: create_spatial_distribution_plot(crime_df, crime_type) -> str**:
   - Create scatter plot of valid coordinates
   - Use Philadelphia bbox for limits
   - Color-code by density
   - Return base64-encoded image tag

8. **FUNCTION: generate_crime_type_report(results) -> str**:
   - Follow pattern from robbery_timing.py
   - Include metadata via format_metadata_markdown()
   - Executive summary with key findings per crime type
   - Individual crime type sections with:
     - Temporal trend (Mann-Kendall tau, p-value, interpretation)
     - Seasonal patterns (peak month, % variation)
     - Spatial distribution (top districts, hotspots)
   - Comparison table across all crime types
   - Methodology section
   - Limitations (especially for rare crimes)
   - Return complete markdown string

9. **IF __name__ == "__main__" block**:
   - Run analyze_all_crime_types()
   - Generate report
   - Save to reports/14_crime_type_profiles_report.md
   - Print confirmation message

Key implementation notes:
- Exclude 2026 from Mann-Kendall trend tests (incomplete year)
- Handle rare crimes gracefully (note limitations in report)
- Use existing coordinate validation from utils.py
- Reuse clustering patterns from red_zones.py for hotspots
- All statistical tests use STAT_CONFIG parameters
</action>
  <verify>
python -c "from analysis.03_02_crime_type_profiles import analyze_all_crime_types; result = analyze_all_crime_types(); print('Crime types analyzed:', list(result.keys()))"
</verify>
  <done>
analyze_all_crime_types() executes without errors and returns dict with:
- Keys for all 5 crime types: 'homicide', 'burglary', 'theft', 'vehicle_theft', 'aggravated_assault'
- Each crime type has 'temporal_trend' with mann_kendall_test results
- Each crime type has 'timeseries_plot' and 'seasonal_plot' as base64 images
</done>
</task>

</tasks>

<verification>
Run the analysis module:
```bash
python -c "from analysis.03_02_crime_type_profiles import analyze_all_crime_types; result = analyze_all_crime_types(); print('Success:', all('temporal_trend' in v for v in result.values()))"
```

Verify outputs:
- All 5 crime types analyzed with > 0 incidents
- Mann-Kendall trend tests include tau, p_value, trend direction
- Seasonal plots show month-to-month variation
- Spatial plots use Philadelphia bbox coordinates
- Report includes comparison table across crime types
</verification>

<success_criteria>
- All 5 required crime types have full profiles
- Statistical tests determine trend significance
- Seasonal patterns identified for each crime type
- Spatial distributions computed (with coordinate limitations noted)
- Report is publication-ready
- Rare crime limitations documented
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-temporal-analysis/03-02-SUMMARY.md`
</output>
