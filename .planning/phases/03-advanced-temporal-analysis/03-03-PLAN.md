---
phase: 03-advanced-temporal-analysis
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - analysis/03-03-shift_analysis.py
autonomous: true

must_haves:
  truths:
    - "User can view shift-by-shift temporal analysis with 4 defined shifts"
    - "Shifts: Morning 6AM-12PM, Afternoon 12PM-6PM, Evening 6PM-12AM, Late Night 12AM-6AM"
    - "Statistical comparisons include ANOVA omnibus test and post-hoc pairwise comparisons"
    - "FDR correction applied to all pairwise shift comparisons"
    - "Full breakdown of crime type by shift (shift x crime type matrix)"
  artifacts:
    - path: "analysis/03-03-shift_analysis.py"
      provides: "Shift-by-shift temporal analysis module"
      min_lines: 350
      exports:
        - "SHIFT_BINS"
        - "SHIFT_LABELS"
        - "analyze_shift_patterns"
        - "analyze_crime_by_shift"
        - "generate_shift_report"
  key_links:
    - from: "analysis/03-03-shift_analysis.py"
      to: "analysis/config.py"
      via: "import STAT_CONFIG, COLORS, FIGURE_SIZES"
      pattern: "from analysis\\.config import"
    - from: "analysis/03-03-shift_analysis.py"
      to: "analysis/stats_utils.py"
      via: "compare_multiple_samples, apply_fdr_correction, bootstrap_ci"
      pattern: "from analysis\\.stats_utils import"
    - from: "analysis/03-03-shift_analysis.py"
      to: "analysis/robbery_timing.py"
      via: "pattern for time period analysis"
      pattern: "TIME_PERIOD_BINS.*TIME_PERIOD_LABELS"
---

<objective>
Create shift-by-shift temporal analysis module with 4 shifts (Morning 6AM-12PM, Afternoon 12PM-6PM, Evening 6PM-12AM, Late Night 12AM-6AM) including statistical comparisons and crime-type-by-shift breakdown.

Purpose: Enable police departments to understand crime distribution across patrol shifts for optimal staffing and resource allocation. This extends beyond the existing robbery timing analysis to all crime types with statistically rigorous comparisons.

Output: Analysis module `analysis/03-03-shift_analysis.py` with functions for shift classification, statistical testing, and shift x crime type matrix visualization.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md

@analysis/robbery_timing.py
@analysis/summer_spike.py
@analysis/config.py
@analysis/stats_utils.py
@analysis/utils.py
</context>

<tasks>

<task type="auto">
  <name>Create shift-by-shift temporal analysis module</name>
  <files>analysis/03-03-shift_analysis.py</files>
  <action>
Create file `analysis/03-03-shift_analysis.py` following pattern from `analysis/robbery_timing.py`.

Module must include:

1. **SHIFT DEFINITIONS**:
```python
SHIFT_BINS = [0, 6, 12, 18, 24]
SHIFT_LABELS = ["Late Night (12AM-6AM)", "Morning (6AM-12PM)",
                "Afternoon (12PM-6PM)", "Evening (6PM-12AM)"]
```

2. **CRIME TYPE GROUPS FOR SHIFT ANALYSIS**:
```python
SHIFT_CRIME_GROUPS = {
    "violent": ["Homicide - Criminal", "Rape", "Robbery Firearm", "Robbery No Firearm",
                "Aggravated Assault Firearm", "Aggravated Assault No Firearm"],
    "property": ["Burglary Residential", "Burglary Non-Residential", "Thefts",
                 "Theft from Vehicle", "Motor Vehicle Theft"],
    "quality_of_life": ["Disorderly Conduct", "Public Drunkenness", "Vandalism/Criminal Mischief"]
}
```

3. **FUNCTION: classify_shifts(df) -> pd.DataFrame**:
   - Use pd.cut() with SHIFT_BINS and SHIFT_LABELS
   - Set right=False, include_lowest=True
   - Handle NaN hour values by assigning to 'Unknown' category
   - Return df with 'shift' column added

4. **FUNCTION: analyze_shift_patterns(df) -> dict**:
   - Load data via load_data(clean=False)
   - Extract temporal features via extract_temporal_features()
   - Call classify_shifts() to add shift column
   - Set seed via set_global_seed(STAT_CONFIG["random_seed"])
   - Store metadata via get_analysis_metadata()

   Statistical tests:
   - Group daily counts by shift: for each shift, compute daily crime counts
   - Run compare_multiple_samples() for omnibus ANOVA/Kruskal-Wallis test
   - Extract post_hoc_results from comparison
   - Apply apply_fdr_correction() to post-hoc p-values
   - Add 'is_significant' column for adjusted p < STAT_CONFIG["alpha"]
   - Compute bootstrap_ci() for each shift's mean daily count

   Return dict with:
   - metadata: analysis metadata
   - omnibus_test: test name, statistic, p_value, is_significant
   - post_hoc_comparisons: DataFrame with shift pairs, mean_diff, p_value, adjusted_p, is_significant
   - shift_cis: dict of confidence intervals per shift
   - shift_counts: total incidents per shift
   - shift_percentages: percentage distribution
   - shift_box_plot: base64 image

5. **FUNCTION: analyze_crime_by_shift(df) -> dict**:
   - Load and prepare data
   - Classify shifts
   - Create shift x crime_type matrix (cross-tabulation)
   - Calculate percentages within each shift
   - Run chi-square test of independence (is crime type distribution independent of shift?)
   - Calculate Cramer's V for effect size

   Return dict with:
   - shift_crime_matrix: DataFrame of counts (shift rows, crime type columns)
   - shift_crime_pct: DataFrame of percentages
   - chi_square_test: independence test results
   - heatmap_plot: base64 image of shift x crime type heatmap
   - stacked_bar_plot: base64 image of stacked bar chart

6. **FUNCTION: create_shift_box_plot(shift_groups) -> str**:
   - Create box plot of daily crime counts by shift
   - Use SHIFT_LABELS for x-axis order
   - Highlight significantly different shifts
   - Return base64-encoded image tag

7. **FUNCTION: create_shift_crime_heatmap(matrix, shift_labels, crime_types) -> str**:
   - Create heatmap showing shift (rows) x crime type (columns)
   - Use COLORS["sequential"] colormap
   - Annotate cells with counts and percentages
   - Return base64-encoded image tag

8. **FUNCTION: create_stacked_bar_plot(shift_crime_pct) -> str**:
   - Create stacked bar chart: 100% per shift, crime types as segments
   - Use distinct colors for each crime type
   - Add legend
   - Return base64-encoded image tag

9. **FUNCTION: generate_shift_report(results) -> str**:
   - Follow pattern from robbery_timing.py generate_markdown_report()
   - Include metadata via format_metadata_markdown()
   - Executive summary with key findings:
     - Which shift has highest/lowest crime
     - Whether shift differences are statistically significant
     - Key crime type patterns by shift
   - Omnibus test results (test name, chi2/kw statistic, p-value)
   - Post-hoc pairwise comparisons table with FDR-adjusted p-values
   - Shift x crime type heatmap
   - Stacked bar plot
   - Recommendations for shift staffing
   - Methodology section
   - Return complete markdown string

10. **IF __name__ == "__main__" block**:
    - Run both analyze_shift_patterns() and analyze_crime_by_shift()
    - Generate combined report
    - Save to reports/15_shift_analysis_report.md
    - Print confirmation message

Key implementation notes:
- Handle weekend/weekday the same (let patterns emerge from data)
- Shift definitions exactly match requirements (Morning 6AM-12PM, Afternoon 12PM-6PM, Evening 6PM-12AM, Late Night 12AM-6AM)
- All statistical tests use STAT_CONFIG["alpha"] = 0.01
- Bootstrap uses STAT_CONFIG["bootstrap_n_resamples"] = 9999
- FDR correction applied to all post-hoc comparisons
- Include exact p-values and effect sizes in report
</action>
  <verify>
python -c "from analysis.03_03_shift_analysis import analyze_shift_patterns; result = analyze_shift_patterns(); print('Shift analysis complete:', 'post_hoc_comparisons' in result)"
</verify>
  <done>
analyze_shift_patterns() executes without errors and returns dict with:
- 'omnibus_test' with statistic, p_value, is_significant
- 'post_hoc_comparisons' DataFrame with adjusted_p values
- 'shift_cis' with bootstrap confidence intervals
- 'shift_box_plot' as base64 image tag

analyze_crime_by_shift() returns dict with:
- 'shift_crime_matrix' DataFrame
- 'chi_square_test' results
- 'heatmap_plot' and 'stacked_bar_plot' as base64 images
</done>
</task>

</tasks>

<verification>
Run the analysis module:
```bash
python -c "from analysis.03_03_shift_analysis import analyze_shift_patterns, analyze_crime_by_shift; s = analyze_shift_patterns(); c = analyze_crime_by_shift(); print('Success:', s['omnibus_test']['is_significant'], 'chi2' in c['chi_square_test'])"
```

Verify outputs:
- 4 shifts defined with correct hour boundaries
- Omnibus test determines significance of shift differences
- Post-hoc comparisons include FDR-adjusted p-values
- Shift x crime type matrix has 4 rows (shifts) x N columns (crime types)
- Heatmap and stacked bar plot are valid base64 images
- Report includes staffing recommendations based on findings
</verification>

<success_criteria>
- All 4 shifts analyzed with statistical testing
- Omnibus ANOVA/Kruskal-Wallis test determines significance
- FDR-adjusted post-hoc comparisons identify specific shift differences
- Shift x crime type heatmap shows clear patterns
- Report provides actionable staffing recommendations
- All visualizations follow existing codebase patterns
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-temporal-analysis/03-03-SUMMARY.md`
</output>
