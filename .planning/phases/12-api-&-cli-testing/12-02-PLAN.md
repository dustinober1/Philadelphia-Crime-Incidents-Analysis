---
phase: 12-api-&-cli-testing
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/test_api_endpoints.py
autonomous: true

must_haves:
  truths:
    - "All 4 spatial API endpoints return valid GeoJSON FeatureCollection"
    - "GeoJSON responses have correct structure (type, features, geometry)"
    - "Spatial endpoints return 200 status code"
    - "Error handling for missing GeoJSON files is tested"
  artifacts:
    - path: "tests/test_api_endpoints.py"
      provides: "Test suite for spatial API endpoints"
      min_lines: 200
  key_links:
    - from: "tests/test_api_endpoints.py"
      to: "api/routers/spatial.py"
      via: "TestClient"
      pattern: "client\.get\('/api/v1/spatial"
---

<objective>
Write integration tests for all 4 spatial GeoJSON endpoints using FastAPI TestClient.

Purpose: Ensure all spatial endpoints (/districts, /tracts, /hotspots, /corridors) return valid GeoJSON with proper structure and error handling.

Output: Extended test_api_endpoints.py with comprehensive tests for all spatial endpoints.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-api-&-cli-testing/12-RESEARCH.md
@.planning/phases/11-core-module-testing/11-04-SUMMARY.md
@tests/test_api_endpoints.py
@api/routers/spatial.py
@api/services/data_loader.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add tests for all 4 spatial GeoJSON endpoints</name>
  <files>tests/test_api_endpoints.py</files>
  <action>
Add integration tests for the 4 spatial endpoints in test_api_endpoints.py:

1. **test_spatial_districts()** - Test GET /api/v1/spatial/districts
   - Verify response status is 200
   - Verify response is a dict (GeoJSON)
   - Verify GeoJSON has "type": "FeatureCollection"
   - Verify "features" key exists and is a list
   - Verify each feature has "geometry" and "properties"

2. **test_spatial_tracts()** - Test GET /api/v1/spatial/tracts
   - Verify response status is 200
   - Verify valid GeoJSON FeatureCollection structure
   - Verify features have Polygon or MultiPolygon geometry

3. **test_spatial_hotspots()** - Test GET /api/v1/spatial/hotspots
   - Verify response status is 200
   - Verify valid GeoJSON FeatureCollection structure
   - Verify features have Point geometry (hotspot centroids)

4. **test_spatial_corridors()** - Test GET /api/v1/spatial/corridors
   - Verify response status is 200
   - Verify valid GeoJSON FeatureCollection structure
   - Verify features have LineString or MultiLineString geometry

Use the existing TestClient pattern. Load real data using setup_module().
Validate GeoJSON structure per GeoJSON spec (RFC 7946).
  </action>
  <verify>Run pytest tests/test_api_endpoints.py -v -k "spatial" and verify all new tests pass</verify>
  <done>All 4 spatial endpoints have passing tests with GeoJSON structure validation</done>
</task>

<task type="auto">
  <name>Task 2: Add spatial endpoint GeoJSON structure validation</name>
  <files>tests/test_api_endpoints.py</files>
  <action>
Add detailed GeoJSON structure validation tests:

1. **test_spatial_geojson_structure()** - Parametrized test for all endpoints
   - Use @pytest.mark.parametrize to test all 4 endpoints
   - Verify "type" == "FeatureCollection"
   - Verify "features" is a list
   - Verify each feature has "type" == "Feature"
   - Verify each feature has "geometry" object with "type" and "coordinates"
   - Verify each feature has "properties" dict

2. **test_spatial_districts_properties()**
   - Verify district features have "dist_num" in properties
   - Verify district names are valid (1-23)

3. **test_spatial_hotspots_centroids()**
   - Verify hotspot features have Point geometry
   - Verify coordinates are within Philadelphia bounds
   - Verify intensity property exists

Add these as separate test functions to test_api_endpoints.py.
Use parametrize to avoid code duplication for common structure checks.
  </action>
  <verify>Run pytest tests/test_api_endpoints.py -v -k "geojson" and verify structure validation passes</verify>
  <done>GeoJSON structure is thoroughly validated including geometry types and coordinate bounds</done>
</task>

<task type="auto">
  <name>Task 3: Add spatial endpoint error handling tests</name>
  <files>tests/test_api_endpoints.py</files>
  <action>
Add error handling tests for spatial endpoints:

1. **test_spatial_endpoint_missing_geojson()**
   - Use monkeypatch to remove "geo/districts.geojson" from _DATA_CACHE
   - Call /api/v1/spatial/districts
   - Verify 500 status is returned (KeyError becomes 500)
   - Verify error response has correct structure

2. **test_spatial_empty_features()**
   - Use monkeypatch to set _DATA_CACHE with empty FeatureCollection
   - Verify endpoint returns 200 with empty features list
   - This tests the empty state edge case

Pattern: Use monkeypatch.setattr("api.services.data_loader._DATA_CACHE", mock_cache).
  </action>
  <verify>Run pytest tests/test_api_endpoints.py -v -k "spatial" and verify error handling tests pass</verify>
  <done>Error paths for spatial endpoints are tested, including missing files and empty data</done>
</task>

</tasks>

<verification>
After completion, verify:
1. Run pytest tests/test_api_endpoints.py -v -k "spatial" and count passing tests
2. All 4 spatial endpoints (/districts, /tracts, /hotspots, /corridors) have tests
3. GeoJSON structure is validated (type, features, geometry, properties)
4. At least 6 new spatial-focused tests pass
5. Coverage includes happy path, structure validation, and error handling
</verification>

<success_criteria>
1. All 4 spatial API endpoints have integration tests
2. Tests validate GeoJSON FeatureCollection structure
3. Geometry types are validated (Point, Polygon, LineString, etc.)
4. Error handling is tested for missing GeoJSON files
5. All tests follow existing TestClient patterns
</success_criteria>

<output>
After completion, create .planning/phases/12-api-&-cli-testing/12-02-SUMMARY.md with:
- Number of tests added for spatial endpoints
- Coverage percentage for api/routers/spatial.py
- GeoJSON structure validation results
</output>
