---
phase: 10-test-infrastructure-&-baseline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Developer can run pytest -n4 and tests execute in parallel across 4 workers"
    - "pytest --cov fails with exit code 2 when coverage falls below 95%"
    - "Coverage report generates XML (for diff-cover), terminal, and HTML formats"
    - "pytest-xdist and diff-cover are installed and importable"
  artifacts:
    - path: "pyproject.toml"
      provides: "pytest-xdist configuration, coverage enforcement, diff-cover integration"
      contains: "[tool.pytest.ini_options] addopts with -nauto, --cov, --cov-report"
    - path: "pyproject.toml"
      provides: "Coverage threshold enforcement"
      contains: "[tool.coverage.report] fail_under = 95.0"
    - path: ".gitignore"
      provides: "Exclusion of coverage artifacts"
      contains: "htmlcov/, .coverage, coverage.xml"
  key_links:
    - from: "pyproject.toml [tool.pytest.ini_options]"
      to: "pytest-xdist"
      via: "addopts = ['-nauto']"
      pattern: "-nauto|-n\\d+"
    - from: "pyproject.toml [tool.coverage.report]"
      to: "coverage.py"
      via: "fail_under = 95.0"
      pattern: "fail_under\\s*=\\s*95"
---

<objective>
Install and configure pytest-xdist for parallel test execution and coverage.py for threshold enforcement. This establishes the foundation for fast, validated test runs before writing new tests.

Purpose: Enable 4-8x faster test execution via parallelization and enforce 95% coverage threshold at the build system level.
Output: Updated pyproject.toml with pytest-xdist and coverage configuration, pytest-xdist and diff-cover installed.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/milestones/v1.3-ROADMAP.md
@.planning/phases/10-test-infrastructure-&-baseline/10-RESEARCH.md
@/Users/dustinober/Projects/Crime Incidents Philadelphia/pyproject.toml
@/Users/dustinober/Projects/Crime Incidents Philadelphia/tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Install pytest-xdist and diff-cover</name>
  <files>pyproject.toml</files>
  <action>
    Add pytest-xdist and diff-cover to project dependencies in pyproject.toml.

    In the [project] dependencies array, add:
    - "pytest-xdist>=3.0"
    - "pytest-cov>=7.0" (if not already present - verify existing)
    - "diff-cover>=9.0"

    These are testing infrastructure dependencies required for parallel execution and diff coverage validation.
  </action>
  <verify>pip list | grep -E "pytest-xdist|diff-cover"</verify>
  <done>pytest-xdist and diff-cover are installed and importable (pip list shows both)</done>
</task>

<task type="auto">
  <name>Configure pytest-xdist parallel execution in pyproject.toml</name>
  <files>pyproject.toml</files>
  <action>
    Update [tool.pytest.ini_options] in pyproject.toml to configure parallel execution and coverage reporting.

    Current addopts has:
    ```toml
    addopts = [
        "--strict-markers",
        "--strict-config",
        "-ra",
    ]
    ```

    Replace with:
    ```toml
    addopts = [
        "-nauto",                      # Auto-detect CPU count for local dev
        "--strict-markers",
        "--strict-config",
        "-ra",
        "--cov=analysis",
        "--cov=api",
        "--cov=pipeline",
        "--cov-report=xml",            # Required for diff-cover
        "--cov-report=term-missing",   # Show missing lines in terminal
        "--cov-report=html",           # Generate HTML report for review
    ]
    ```

    NOTE: -nauto is for local development. CI will override with -n4 via environment variable or separate config.
  </action>
  <verify>pytest --help | grep -A 5 "custom options"</verify>
  <done>pytest -nauto runs successfully (test that parallel execution works)</done>
</task>

<task type="auto">
  <name>Configure coverage threshold enforcement</name>
  <files>pyproject.toml</files>
  <action>
    Add [tool.coverage] section to pyproject.toml for coverage.py configuration.

    Add after [tool.pytest.ini_options]:
    ```toml
    [tool.coverage.run]
    source = ["analysis", "api", "pipeline"]
    branch = true                    # Enable branch coverage (more accurate than line coverage)
    parallel = true                   # Required for pytest-xdist
    omit = [
        "*/tests/*",
        "*/__init__.py",
        "*/cli/__main__.py",          # CLI entry point
    ]

    [tool.coverage.report]
    fail_under = 95.0                # Exit with status 2 if coverage < 95%
    precision = 2                    # Report 2 decimal places
    show_missing = true              # Show missing line numbers
    skip_covered = false             # Show all files, even 100% covered
    exclude_also = [
        # Don't complain about missing debug-only code:
        "def __repr__",
        "if self\\.debug",
        # Don't complain if tests don't hit defensive assertion code:
        "raise AssertionError",
        "raise NotImplementedError",
        # Don't complain if non-runnable code isn't run:
        "if 0:",
        "if __name__ == .__main__.:",
        # Don't complain about abstract methods:
        "@(abc\\.)?abstractmethod",
    ]

    [tool.coverage.html]
    directory = "htmlcov"
    ```

    CRITICAL: fail_under goes in [tool.coverage.report], NOT in pytest addopts. This is the standard approach.
  </action>
  <verify>grep -A 3 "\[tool.coverage.report\]" pyproject.toml | grep "fail_under"</verify>
  <done>pytest --cov fails with exit code 2 when coverage < 95% (will fail now since current coverage is ~60%, this is expected)</done>
</task>

<task type="auto">
  <name>Update .gitignore for coverage artifacts</name>
  <files>.gitignore</files>
  <action>
    Add coverage artifacts to .gitignore to prevent committing generated files.

    If .gitignore exists, add these lines. If not, create it with these entries:
    ```
    # Coverage reports
    htmlcov/
    .coverage
    .coverage.*
    coverage.xml
    coverage.json
    *.cover
    ```
  </action>
  <verify>grep -E "htmlcov|coverage.xml" .gitignore</verify>
  <done>htmlcov/ and coverage.xml are ignored (git status doesn't show them after running tests)</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run `pytest -nauto --cov` to verify parallel execution works
2. Run `pytest --cov --cov-report=xml` to verify XML report generation
3. Run `pytest --cov` and check exit code is 2 (coverage below 95%)
4. Verify htmlcov/ directory was created with HTML coverage report
5. Verify coverage.xml was generated for diff-cover consumption
</verification>

<success_criteria>
1. pytest-xdist installed and configurable via -nauto flag
2. Coverage enforced at 95% threshold in pyproject.toml
3. Coverage generates XML, terminal, and HTML reports
4. Coverage artifacts excluded from git via .gitignore
5. Parallel test execution works (tests run faster with -nauto)
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-infrastructure-&-baseline/10-01-SUMMARY.md`
</output>
