---
phase: 10-test-infrastructure-&-baseline
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - .github/workflows/test.yml
autonomous: true

must_haves:
  truths:
    - "GitHub Actions workflow runs pytest with -n4 for parallel execution"
    - "diff-cover validates coverage on PR diffs against main branch"
    - "Coverage reports uploaded as artifacts for review"
    - "Workflow triggers on push to main and on pull requests"
  artifacts:
    - path: ".github/workflows/test.yml"
      provides: "CI pipeline with parallel tests and diff-cover validation"
      contains: "pytest -n4, diff-cover, fetch-depth: 0"
  key_links:
    - from: ".github/workflows/test.yml"
      to: "pytest-xdist"
      via: "run: pytest -n4"
      pattern: "pytest\\s+-n\\d+"
    - from: ".github/workflows/test.yml"
      to: "diff-cover"
      via: "diff-cover coverage.xml --compare-branch"
      pattern: "diff-cover.*compare-branch"
---

<objective>
Create GitHub Actions workflow that runs tests in parallel and validates coverage on diffs using diff-cover. This prevents coverage backsliding on new code without blocking development until 95% overall coverage is achieved.

Purpose: Establish CI guardrail that enforces coverage standards incrementally via diff coverage rather than total coverage.
Output: GitHub Actions workflow file with pytest-xdist and diff-cover integration.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/REQUIREMENTS.md
@.planning/milestones/v1.3-ROADMAP.md
@.planning/phases/10-test-infrastructure-&-baseline/10-RESEARCH.md
@/Users/dustinober/Projects/Crime Incidents Philadelphia/pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Create GitHub Actions workflow with pytest-xdist</name>
  <files>.github/workflows/test.yml</files>
  <action>
    Create .github/workflows/ directory and test.yml workflow file.

    The workflow should:
    - Trigger on push to main and pull_request to main
    - Use ubuntu-latest with Python 3.14
    - Checkout with fetch-depth: 0 (required for diff-cover)
    - Install dependencies including pytest-xdist and diff-cover
    - Run tests in parallel with pytest -n4 (explicit worker count for CI)
    - Generate coverage.xml for diff-cover
    - Run diff-cover on PRs to validate diff coverage
    - Upload coverage reports as artifacts

    Complete workflow file content:
    ```yaml
    name: Tests

    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      test:
        runs-on: ubuntu-latest
        strategy:
          matrix:
            python-version: ["3.14"]
        steps:
          - name: Checkout repository
            uses: actions/checkout@v4
            with:
              fetch-depth: 0  # Required for diff-cover

          - name: Set up Python ${{ matrix.python-version }}
            uses: actions/setup-python@v5
            with:
              python-version: ${{ matrix.python-version }}
              cache: 'pip'

          - name: Install dependencies
            run: |
              python -m pip install --upgrade pip
              pip install -e .
              pip install pytest pytest-xdist pytest-cov diff-cover

          - name: Run tests in parallel with coverage
            run: |
              pytest -n4 \
                --cov=analysis \
                --cov=api \
                --cov=pipeline \
                --cov-report=xml \
                --cov-report=term-missing \
                --cov-report=html \
                --no-cov-on-fail

          - name: Check coverage on diff (PR only)
            if: github.event_name == 'pull_request'
            run: |
              diff-cover coverage.xml \
                --compare-branch=origin/main \
                --fail-under=90 \
                --coverage-file-name=coverage.xml

          - name: Upload coverage reports
            if: always()
            uses: actions/upload-artifact@v4
            with:
              name: coverage-report
              path: |
                htmlcov/
                coverage.xml
              retention-days: 30
    ```

    IMPORTANT: Use -n4 for CI (not -nauto) for predictable resource usage.
    IMPORTANT: fetch-depth: 0 is required for diff-cover to compare branches.
    IMPORTANT: diff-cover uses --fail-under=90 for diff coverage (lower than 95% total, allows incremental improvement).
  </action>
  <verify>test -f .github/workflows/test.yml && cat .github/workflows/test.yml | grep -E "pytest -n4|diff-cover"</verify>
  <done>.github/workflows/test.yml exists with pytest -n4 and diff-cover configuration</done>
</task>

<task type="auto">
  <name>Verify workflow syntax and structure</name>
  <files>.github/workflows/test.yml</files>
  <action>
    Validate the workflow file is properly formatted YAML with all required sections.

    Verify the workflow contains:
    1. Correct triggers (push to main, pull_request)
    2. fetch-depth: 0 in checkout step (critical for diff-cover)
    3. pytest -n4 command (not -nauto)
    4. diff-cover command with --compare-branch=origin/main
    5. Artifact upload for coverage reports

    No code changes needed - just verification step to ensure quality.
  </action>
  <verify>yq eval '.' .github/workflows/test.yml >/dev/null 2>&1 || python -c "import yaml; yaml.safe_load(open('.github/workflows/test.yml'))"</verify>
  <done>Workflow YAML is valid and contains all required sections</done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Verify .github/workflows/test.yml exists and is valid YAML
2. Confirm workflow has fetch-depth: 0 (required for diff-cover)
3. Confirm pytest uses -n4 (explicit worker count for CI)
4. Confirm diff-cover runs only on PRs (if: github.event_name == 'pull_request')
5. Confirm coverage reports are uploaded as artifacts
</verification>

<success_criteria>
1. GitHub Actions workflow file exists at .github/workflows/test.yml
2. Workflow runs pytest with -n4 for parallel execution
3. diff-cover validates coverage on PR diffs with 90% threshold
4. Coverage reports (HTML, XML) uploaded as artifacts
5. Workflow triggers on push to main and pull requests
</success_criteria>

<output>
After completion, create `.planning/phases/10-test-infrastructure-&-baseline/10-02-SUMMARY.md`
</output>
