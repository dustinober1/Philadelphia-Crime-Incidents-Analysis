---
phase: 02-external-data-integration
plan: 07
type: execute
wave: 4
depends_on: []
files_modified:
  - analysis/external_data.py
  - analysis/config.py
autonomous: true

must_haves:
  truths:
    - "User can view policing data availability assessment in analysis output"
    - "Limitations of Philadelphia policing data access are documented"
    - "CORR-03 requirement is addressed with data availability report"
  artifacts:
    - path: "analysis/external_data.py"
      provides: "Policing data availability assessment"
      contains: "assess_policing_data_availability"
    - path: "analysis/config.py"
      contains: "POLICING_DATA_CONFIG"
  key_links:
    - from: "analysis/external_data.py"
      to: "reports/"
      via: "Documentation of policing data sources"
      pattern: "Philadelphia Controller|DAO|OpenDataPhilly"
---

<objective>
Assess the availability of Philadelphia policing data for correlation analysis (CORR-03). Document data sources, limitations, and provide recommendations for future implementation.

Purpose: Address CORR-03 requirement: "User can view correlation analysis between crime outcomes and policing data if data is available." Since no API exists, this plan documents the limitation and provides a structured assessment.

Output: Extended `analysis/external_data.py` with policing data assessment function, POLICING_DATA_CONFIG in `analysis/config.py`, and documentation of available data sources.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-external-data-integration/02-RESEARCH.md
@analysis/config.py
@analysis/external_data.py
</context>

<tasks>

<task type="auto">
  <name>Add POLICING_DATA_CONFIG to config.py</name>
  <files>analysis/config.py</files>
  <action>
Add policing data configuration to `analysis/config.py` after TEMPORAL_CONFIG:

```python
# =============================================================================
# POLICING DATA CONFIGURATION
# =============================================================================

# Philadelphia policing data sources and availability
# Note: No programmatic API exists for Philadelphia policing data
POLICING_DATA_CONFIG = {
    # Data sources that exist but lack API access
    "sources": {
        "controller_reports": {
            "name": "Philadelphia Controller's Office",
            "url": "https://controller.phila.gov/policing-in-philadelphia/",
            "format": "PDF reports",
            "years_available": [2022, 2024],
            "api": False,
            "notes": "Static PDF reports with some data tables. No bulk CSV download.",
        },
        "dao_dashboard": {
            "name": "District Attorney's Office Data Dashboard",
            "url": "https://dao.phila.gov/data/",
            "format": "Interactive web dashboard",
            "years_available": "Recent years only",
            "api": False,
            "notes": "Limited visual dashboard, no export capability.",
        },
        "opendataphilly": {
            "name": "OpenDataPhilly",
            "url": "https://www.opendataphilly.org/",
            "format": "Varies (CSV, API, shapefile)",
            "years_available": "Varies by dataset",
            "api": "Varies by dataset",
            "notes": "May have historical policing datasets. Requires manual search.",
        },
    },

    # Data variables of interest (if available)
    "variables_of_interest": [
        "police_officer_count_by_district",
        "arrest_rates_by_district",
        "response_times",
        "patrol_hours_by_district",
        "budget_allocation",
    ],

    # Assessment status
    "available_for_correlation": False,
    "limitation": "No programmatic API access. Data exists in static PDFs and dashboards.",
    "recommendation": "Manual data entry from PDF reports or web scraping (fragile).",
}
```
  </action>
  <verify>
```bash
python -c "
from analysis.config import POLICING_DATA_CONFIG
print('Policing data sources:', list(POLICING_DATA_CONFIG['sources'].keys()))
print('Available for correlation:', POLICING_DATA_CONFIG['available_for_correlation'])
print('Limitation:', POLICING_DATA_CONFIG['limitation'])
print('POLICING_DATA_CONFIG verified')
"
```
  </verify>
  <done>
POLICING_DATA_CONFIG exists in config.py with sources, variables_of_interest, available_for_correlation, limitation, and recommendation keys.
  </done>
</task>

<task type="auto">
  <name>Add policing data assessment to external_data.py</name>
  <files>analysis/external_data.py</files>
  <action>
Add policing data assessment function to `analysis/external_data.py`:

```python
def assess_policing_data_availability() -> dict:
    """
    Assess availability of Philadelphia policing data for correlation analysis.

    CORR-03 requires correlation analysis between crime outcomes and policing
    data (resource allocation, arrest rates). This function documents the
    availability of such data.

    Returns:
        Dictionary with:
            - available: Boolean, whether policing data is accessible
            - sources: Dict of known data sources with URLs and limitations
            - variables: List of policing variables of interest
            - recommendation: How to proceed given data limitations
            - manual_options: Potential manual data collection approaches

    Note:
        Philadelphia policing data exists but lacks programmatic access:
            - Controller's Office: Static PDF reports (2022, 2024)
            - DAO Dashboard: Interactive web visualization
            - OpenDataPhilly: May have historical datasets (requires search)

        For automated correlation analysis, consider:
            1. Manual data entry from PDF reports (small dataset, feasible)
            2. Web scraping (fragile, may violate ToS)
            3. Contact data owners directly for CSV access

    Example:
        >>> assessment = assess_policing_data_availability()
        >>> print(assessment['available'])  # False
        >>> print(assessment['recommendation'])
    """
    from analysis.config import POLICING_DATA_CONFIG

    sources = POLICING_DATA_CONFIG['sources']

    # Detailed assessment for each source
    detailed_assessment = {}

    for source_key, source_info in sources.items():
        detailed_assessment[source_key] = {
            'name': source_info['name'],
            'url': source_info['url'],
            'format': source_info['format'],
            'has_api': source_info['api'],
            'notes': source_info['notes'],
            'feasibility_for_automation': _assess_automation_feasibility(source_info),
        }

    # Manual data collection options
    manual_options = {
        "pdf_data_entry": {
            "effort": "Medium (2-4 hours)",
            "feasibility": "High",
            "description": "Manually extract data from Controller's Office PDF reports",
            "variables_possible": [
                "police_officer_count_by_district",
                "arrest_counts_by_district",
                "budget_by_district",
            ],
            "years_covered": [2022, 2024],
        },
        "web_scraping": {
            "effort": "High (8-16 hours)",
            "feasibility": "Low to Medium",
            "description": "Scrape DAO dashboard or Controller's Office website",
            "risks": [
                "Fragile (breaks if website changes)",
                "May violate Terms of Service",
                "Requires maintenance",
            ],
        },
        "direct_request": {
            "effort": "Low (1-2 hours)",
            "feasibility": "Uncertain",
            "description": "Contact agencies directly for CSV/data access",
            "contacts": [
                "Philadelphia Controller's Office: data@controller.phila.gov",
                "OpenDataPhilly: opendata@phila.gov",
            ],
        },
    }

    return {
        'available': POLICING_DATA_CONFIG['available_for_correlation'],
        'sources': detailed_assessment,
        'variables_of_interest': POLICING_DATA_CONFIG['variables_of_interest'],
        'recommendation': POLICING_DATA_CONFIG['recommendation'],
        'manual_options': manual_options,
        'correlation_implications': {
            'status': 'CORR-03 partially addressable',
            'note': 'Automated correlation analysis not possible without API access. '
                    'Manual data entry from PDF reports could enable limited analysis '
                    'for 2022 and 2024 data points only.',
            'alternative': 'Consider district-level crime trend analysis without '
                          'policing data as a control variable.',
        },
    }


def _assess_automation_feasibility(source_info: dict) -> str:
    """
    Assess whether a data source is feasible for automated retrieval.

    Args:
        source_info: Source information dict from POLICING_DATA_CONFIG.

    Returns:
        Feasibility assessment: 'High', 'Medium', 'Low', or 'Not Feasible'.
    """
    if source_info.get('api') is True:
        return 'High'
    elif source_info.get('format') == 'PDF reports':
        return 'Low (requires OCR or manual entry)'
    elif source_info.get('format') == 'Interactive web dashboard':
        return 'Low (requires web scraping)'
    elif 'CSV' in source_info.get('format', ''):
        return 'Medium'
    else:
        return 'Not Feasible'


def generate_policing_data_report() -> str:
    """
    Generate a markdown report on policing data availability.

    Returns:
        Markdown string documenting policing data sources, limitations,
        and recommendations for addressing CORR-03.

    Example:
        >>> report = generate_policing_data_report()
        >>> print(report)
    """
    assessment = assess_policing_data_availability()

    md_lines = [
        "# Philadelphia Policing Data Availability Assessment",
        "",
        "## Summary",
        "",
        f"**Automated correlation analysis (CORR-03):** {'Possible' if assessment['available'] else 'Not Currently Possible'}",
        "",
        f"**Limitation:** {assessment['recommendation']}",
        "",
        "## Known Data Sources",
        "",
    ]

    for source_key, source in assessment['sources'].items():
        md_lines.extend([
            f"### {source['name']}",
            "",
            f"- **URL:** {source['url']}",
            f"- **Format:** {source['format']}",
            f"- **API Access:** {'Yes' if source['has_api'] else 'No'}",
            f"- **Automation Feasibility:** {source['feasibility_for_automation']}",
            f"- **Notes:** {source['notes']}",
            "",
        ])

    md_lines.extend([
        "## Variables of Interest",
        "",
    ])

    for var in assessment['variables_of_interest']:
        md_lines.append(f"- {var}")

    md_lines.extend([
        "",
        "## Manual Data Collection Options",
        "",
    ])

    for option_key, option in assessment['manual_options'].items():
        md_lines.extend([
            f"### {option_key.replace('_', ' ').title()}",
            "",
            f"- **Effort:** {option['effort']}",
            f"- **Feasibility:** {option['feasibility']}",
            f"- **Description:** {option['description']}",
        ])

        if 'risks' in option:
            md_lines.append(f"- **Risks:** {', '.join(option['risks'])}")

        if 'variables_possible' in option:
            md_lines.append(f"- **Variables:** {', '.join(option['variables_possible'])}")

        md_lines.append("")

    md_lines.extend([
        "## Recommendations",
        "",
    ])

    implications = assessment['correlation_implications']
    md_lines.extend([
        f"**Status:** {implications['status']}",
        "",
        implications['note'],
        "",
        implications['alternative'],
        "",
    ])

    return "\n".join(md_lines)
```
  </action>
  <verify>
```bash
python -c "
from analysis.external_data import assess_policing_data_availability, generate_policing_data_report

# Test assessment function
assessment = assess_policing_data_availability()
print('Available:', assessment['available'])
print('Sources:', list(assessment['sources'].keys()))
print('Manual options:', list(assessment['manual_options'].keys()))

# Test report generation
report = generate_policing_data_report()
assert '# Philadelphia Policing Data' in report
assert 'Controller' in report
print('Report generated successfully')
print('Policing data assessment functions work correctly')
"
```
  </verify>
  <done>
assess_policing_data_availability and generate_policing_data_report functions exist in external_data.py. Assessment returns dict with sources, variables, manual_options, and correlation_implications.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run the verify command from task 1 to confirm POLICING_DATA_CONFIG exists
2. Run the verify command from task 2 to confirm assessment functions work
3. Generate and review the policing data report: `python -c "from analysis.external_data import generate_policing_data_report; print(generate_policing_data_report())"`
</verification>

<success_criteria>
1. POLICING_DATA_CONFIG exists in config.py
2. assess_policing_data_availability function exists
3. generate_policing_data_report function exists and returns markdown
4. Assessment includes Controller's Office, DAO Dashboard, and OpenDataPhilly sources
5. Manual data collection options are documented
6. CORR-03 limitation is clearly documented
7. Feasibility assessment is provided for each source
</success_criteria>

<output>
After completion, create `.planning/phases/02-external-data-integration/02-07-SUMMARY.md` with:
- Policing data sources identified (3 sources)
- Automation feasibility assessment
- CORR-03 status (partially addressable with manual data entry)
- Report generated documenting all sources and options
</output>
