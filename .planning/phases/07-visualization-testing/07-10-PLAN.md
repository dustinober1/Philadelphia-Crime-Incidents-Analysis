---
phase: 07-visualization-testing
plan: 10
type: execute
wave: 2
depends_on: ["07-08", "07-09"]
files_modified:
  - analysis/cli/chief.py
  - analysis/cli/patrol.py
  - analysis/cli/policy.py
  - analysis/cli/forecasting.py
  - tests/test_cli_chief.py
  - tests/test_cli_patrol.py
  - tests/test_cli_policy.py
  - tests/test_cli_forecasting.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User can generate figures in PNG, SVG, or PDF format via CLI --output-format argument"
    - "CLI commands create figures using plot_line(), plot_bar(), or plot_heatmap()"
    - "Figures are saved to reports/{version}/{group}/ directory with correct extension"
    - "setup_style() is called before creating figures for consistent styling"
    - "save_figure() is called with output_format parameter to save figures"
    - "CLI tests verify figure files are created with correct format"
  artifacts:
    - path: "analysis/cli/chief.py"
      provides: "Chief commands with figure generation and saving"
      contains: "from analysis.visualization import plot_line, save_figure, setup_style"
    - path: "analysis/cli/patrol.py"
      provides: "Patrol commands with figure generation and saving"
      contains: "from analysis.visualization import plot_bar, save_figure, setup_style"
    - path: "analysis/cli/policy.py"
      provides: "Policy commands with figure generation and saving"
      contains: "from analysis.visualization import plot_bar, save_figure, setup_style"
    - path: "analysis/cli/forecasting.py"
      provides: "Forecasting commands with figure generation and saving"
      contains: "from analysis.visualization import plot_line, save_figure, setup_style"
    - path: "tests/test_cli_chief.py"
      provides: "Tests verifying figure generation"
      contains: "assert figure_file.exists()"
  key_links:
    - from: "CLI commands"
      to: "plot functions (plot_line, plot_bar, plot_heatmap)"
      via: "import from analysis.visualization"
      pattern: "from analysis\.visualization import plot_"
    - from: "CLI commands"
      to: "save_figure()"
      via: "function call with output_format parameter"
      pattern: "save_figure\(fig, output_path, output_format=config\.output_format\)"
    - from: "CLI commands"
      to: "setup_style()"
      via: "implicit call through plot functions"
      pattern: "setup_style\(\)|plot_.*\(.*\)"  # plot functions call setup_style()
---

<objective>
Wire figure generation to all CLI commands and update tests.

This plan connects the visualization utilities (implemented in plan 07-01) to the CLI commands (which now have --output-format from plans 07-08 and 07-09). Each CLI command will generate appropriate figures, save them using save_figure(), and tests will verify figure creation.

Purpose: Close the gap where CLI commands only generate text summaries. Enable users to generate publication-quality figures in multiple formats via CLI.
Output: All 13 CLI commands generate figures; tests verify figure creation with correct format.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/07-visualization-testing/07-VERIFICATION.md
@.planning/phases/07-visualization-testing/07-01-SUMMARY.md
@.planning/phases/07-visualization-testing/07-08-SUMMARY.md
@.planning/phases/07-visualization-testing/07-09-SUMMARY.md
@analysis/visualization/__init__.py
@analysis/cli/chief.py
@analysis/cli/patrol.py
@analysis/cli/policy.py
@analysis/cli/forecasting.py
@tests/test_cli_chief.py

Gap reason from VERIFICATION.md:
- "CLI commands do not have --output-format argument implemented. save_figure() function exists but CLI does not expose it."
- Missing: "Wiring from CLI commands to save_figure() function"
- Missing: "Figure generation in CLI commands (no figures are being created)"
- Partial: "setup_style() and COLORS exist but CLI commands don't generate figures, so styling is not applied in practice"

What exists:
- Visualization module complete (plan 07-01): save_figure(), setup_style(), plot_line(), plot_bar(), plot_heatmap()
- All exports accessible: `from analysis.visualization import ...`
- --output-format added to all CLI commands (plans 07-08, 07-09)
- Testing infrastructure complete (27 CLI tests, all passing)

What needs to be added:
- Import visualization utilities in CLI files
- Generate figures in each CLI command using appropriate plot functions
- Save figures using save_figure() with output_format from config
- Update tests to verify figure files are created with correct extension

Figure generation strategy by command:
- Chief trends: Line plot of annual crime counts
- Chief seasonality: Bar plot of seasonal averages
- Chief covid: Bar plot comparing before/after periods
- Patrol hotspots: Skip (spatial - requires geopandas/folium)
- Patrol robbery-heatmap: Heatmap of hour vs time_bin (if seaborn available)
- Patrol district-severity: Bar plot of district severity scores
- Patrol census-rates: Skip (requires spatial join with census data)
- Policy retail-theft: Line plot of monthly theft trends
- Policy vehicle-crimes: Line plot of monthly vehicle crime trends
- Policy composition: Bar plot of top N crime categories
- Policy events: Skip (requires event data which may not exist)
- Forecasting time-series: Line plot with historical + forecast
- Forecasting classification: Skip (ML model metrics - no obvious figure)

Note: Commands without obvious visualizations will create summary bar/line plots of aggregated data.
</context>

<tasks>

<task type="auto">
  <name>Wire figure generation to Chief CLI commands</name>
  <files>analysis/cli/chief.py</files>
  <action>
    Add figure generation to all three Chief CLI commands:

    1. Add imports at top of file (after existing imports):
       ```python
       from analysis.visualization import plot_bar, plot_line, save_figure
       ```

    2. For trends command (after aggregation, before saving outputs):
       ```python
       # Create figure: annual crime trend line
       fig = plot_line(
           annual_df,
           x_col="dispatch_date",
           y_col="count",
           title=f"Annual Crime Trends ({config.start_year}-{config.end_year})",
           xlabel="Year",
           ylabel="Number of Incidents",
       )

       # Save figure
       figure_path = output_path / f"{config.report_name}_trend.{config.output_format}"
       save_figure(fig, figure_path, output_format=config.output_format)
       ```

    3. For seasonality command (after seasonal calculation, before saving outputs):
       ```python
       # Create figure: seasonal comparison bar plot
       seasonal_df = seasonal_counts.reset_index()
       fig = plot_bar(
           seasonal_df,
           x_col="season",
           y_col="objectid",
           title="Seasonal Crime Comparison",
           xlabel="Season",
           ylabel="Average Incidents",
       )

       # Save figure
       figure_path = output_path / f"{config.report_name}_seasonal.{config.output_format}"
       save_figure(fig, figure_path, output_format=config.output_format)
       ```

    4. For covid command (after comparison, before saving outputs):
       ```python
       # Create figure: before/after comparison bar plot
       comparison_df = pd.DataFrame({
           "Period": ["Before (avg)", "After"],
           "Incidents": [baseline_avg, len(after_df)]
       })
       fig = plot_bar(
           comparison_df,
           x_col="Period",
           y_col="Incidents",
           title="COVID Impact on Crime",
           xlabel="Period",
           ylabel="Number of Incidents",
       )

       # Save figure
       figure_path = output_path / f"{config.report_name}_covid_impact.{config.output_format}"
       save_figure(fig, figure_path, output_format=config.output_format)
       ```

    Note: plot_line() and plot_bar() internally call setup_style() for consistent styling.
  </action>
  <verify>
    Run: python -m analysis.cli chief trends --fast --version test
    Expected: reports/test/chief/annual_trends_report_trend.png is created
    Run: python -m analysis.cli chief trends --output-format svg --fast --version test
    Expected: reports/test/chief/annual_trends_report_trend.svg is created
    Run: python -m analysis.cli chief seasonality --fast --version test
    Expected: reports/test/chief/seasonality_report_seasonal.png is created
    Run: python -m analysis.cli chief covid --fast --version test
    Expected: reports/test/chief/covid_impact_report_covid_impact.png is created
  </verify>
  <done>
    All Chief CLI commands generate figures using visualization utilities.
    Figures are saved with correct format extension from config.output_format.
    setup_style() is applied implicitly via plot functions.
  </done>
</task>

<task type="auto">
  <name>Wire figure generation to Patrol CLI commands</name>
  <files>analysis/cli/patrol.py</files>
  <action>
    Add figure generation to Patrol CLI commands (hotspots, robbery-heatmap, district-severity, census-rates):

    1. Add imports at top of file:
       ```python
       from analysis.visualization import plot_bar, plot_heatmap, save_figure
       import matplotlib.pyplot as plt
       ```

    2. For hotspots command (after clustering, before saving outputs):
       - Create bar plot of cluster sizes
       - Skip if sklearn not available (n_clusters == 0)
       ```python
       if n_clusters > 0:
           cluster_sizes = df[df["cluster"] != -1].groupby("cluster").size()
           cluster_df = cluster_sizes.reset_index()
           cluster_df.columns = ["cluster", "incidents"]

           fig = plot_bar(
               cluster_df,
               x_col="cluster",
               y_col="incidents",
               title="Crime Hotspot Cluster Sizes",
               xlabel="Cluster ID",
               ylabel="Number of Incidents",
           )

           figure_path = output_path / f"{config.report_name}_clusters.{config.output_format}"
           save_figure(fig, figure_path, output_format=config.output_format)
       ```

    3. For robbery-heatmap command (after filtering, before saving outputs):
       - Create heatmap if seaborn available, otherwise skip
       ```python
       try:
           import seaborn as sns

           # Create pivot table for heatmap
           heatmap_data = df.groupby(["time_bin", "hour"]).size().unstack(fill_value=0)

           fig = plot_heatmap(
               heatmap_data,
               title="Robbery Temporal Heatmap",
               figsize=(12, 8),
           )

           figure_path = output_path / f"{config.report_name}_heatmap.{config.output_format}"
           save_figure(fig, figure_path, output_format=config.output_format)
       except ImportError:
           pass  # Skip heatmap if seaborn not available
       ```

    4. For district-severity command (after scoring, before saving outputs):
       ```python
       district_df = district_scores.reset_index()
       district_df.columns = ["district", "severity_score"]

       # Top 10 districts
       top_districts = district_df.head(10)

       fig = plot_bar(
           top_districts,
           x_col="district",
           y_col="severity_score",
           title="District Severity Scores (Top 10)",
           xlabel="Police District",
           ylabel="Severity Score",
       )

       figure_path = output_path / f"{config.report_name}_severity.{config.output_format}"
       save_figure(fig, figure_path, output_format=config.output_format)
       ```

    5. For census-rates command (after analysis, before saving outputs):
       - Skip figure generation (requires spatial join with census boundaries)
       - Only generate text summary (existing behavior)
  </action>
  <verify>
    Run: python -m analysis.cli patrol hotspots --fast --version test
    Expected: reports/test/patrol/hotspots_report_clusters.png is created (if sklearn available)
    Run: python -m analysis.cli patrol robbery-heatmap --fast --version test
    Expected: reports/test/patrol/robbery_heatmap_report_heatmap.png is created (if seaborn available)
    Run: python -m analysis.cli patrol district-severity --fast --version test
    Expected: reports/test/patrol/district_severity_report_severity.png is created
  </verify>
  <done>
    Patrol CLI commands generate appropriate figures where data permits.
    Commands with optional dependencies (sklearn, seaborn) gracefully skip figure generation if unavailable.
  </done>
</task>

<task type="auto">
  <name>Wire figure generation to Policy CLI commands</name>
  <files>analysis/cli/policy.py</files>
  <action>
    Add figure generation to Policy CLI commands (retail-theft, vehicle-crimes, composition, events):

    1. Add imports at top of file:
       ```python
       from analysis.visualization import plot_bar, plot_line, save_figure
       from analysis.utils.temporal import extract_temporal_features
       import pandas as pd
       ```

    2. For retail-theft command (after filtering, before saving outputs):
       ```python
       # Create monthly trend line plot
       theft_df = extract_temporal_features(theft_df)
       monthly_theft = theft_df.groupby(theft_df["dispatch_date"].dt.to_period("M")).size()

       monthly_df = monthly_theft.reset_index()
       monthly_df.columns = ["date", "incidents"]
       monthly_df["date"] = monthly_df["date"].dt.to_timestamp()

       fig = plot_line(
           monthly_df,
           x_col="date",
           y_col="incidents",
           title="Retail Theft Trends",
           xlabel="Date",
           ylabel="Number of Incidents",
       )

       figure_path = output_path / f"{config.report_name}_trend.{config.output_format}"
       save_figure(fig, figure_path, output_format=config.output_format)
       ```

    3. For vehicle-crimes command (after filtering, before saving outputs):
       ```python
       # Create monthly trend line plot
       vehicle_df = extract_temporal_features(vehicle_df)
       monthly_vehicle = vehicle_df.groupby(vehicle_df["dispatch_date"].dt.to_period("M")).size()

       monthly_df = monthly_vehicle.reset_index()
       monthly_df.columns = ["date", "incidents"]
       monthly_df["date"] = monthly_df["date"].dt.to_timestamp()

       fig = plot_line(
           monthly_df,
           x_col="date",
           y_col="incidents",
           title="Vehicle Crime Trends",
           xlabel="Date",
           ylabel="Number of Incidents",
       )

       figure_path = output_path / f"{config.report_name}_trend.{config.output_format}"
       save_figure(fig, figure_path, output_format=config.output_format)
       ```

    4. For composition command (after classification, before saving outputs):
       ```python
       # Create bar plot of top categories
       top_df = top_categories.reset_index()
       top_df.columns = ["ucr_code", "incidents"]

       fig = plot_bar(
           top_df,
           x_col="ucr_code",
           y_col="incidents",
           title=f"Top {config.top_n} Crime Categories",
           xlabel="UCR Code (Hundred-Band)",
           ylabel="Number of Incidents",
       )

       figure_path = output_path / f"{config.report_name}_categories.{config.output_format}"
       save_figure(fig, figure_path, output_format=config.output_format)
       ```

    5. For events command (after analysis, before saving outputs):
       - Skip figure generation (requires event data which may not exist)
       - Only generate text summary (existing behavior)
  </action>
  <verify>
    Run: python -m analysis.cli policy retail-theft --fast --version test
    Expected: reports/test/policy/retail_theft_report_trend.png is created
    Run: python -m analysis.cli policy vehicle-crimes --fast --version test
    Expected: reports/test/policy/vehicle_crimes_report_trend.png is created
    Run: python -m analysis.cli policy composition --fast --version test
    Expected: reports/test/policy/composition_report_categories.png is created
  </verify>
  <done>
    Policy CLI commands generate appropriate figures for trend and composition analyses.
    Commands requiring external data (events) gracefully skip figure generation.
  </done>
</task>

<task type="auto">
  <name>Wire figure generation to Forecasting CLI commands</name>
  <files>analysis/cli/forecasting.py</files>
  <action>
    Add figure generation to Forecasting CLI commands (time-series, classification):

    1. Add imports at top of file:
       ```python
       from analysis.visualization import plot_line, plot_bar, save_figure
       import matplotlib.pyplot as plt
       ```

    2. For time-series command (after forecasting, before saving outputs):
       ```python
       if forecast is not None:
           # Create figure with historical data and forecast
           historical_df = monthly_df.copy()
           historical_df["type"] = "historical"

           forecast_subset = forecast[forecast["ds"] > monthly_df["ds"].max()][["ds", "yhat"]].copy()
           forecast_subset.columns = ["ds", "y"]
           forecast_subset["type"] = "forecast"

           combined_df = pd.concat([historical_df, forecast_subset], ignore_index=True)

           fig = plot_line(
               combined_df,
               x_col="ds",
               y_col="y",
               title=f"Crime Forecast - {config.forecast_horizon} Period Horizon",
               xlabel="Date",
               ylabel="Incidents",
           )

           figure_path = output_path / f"{config.report_name}_forecast.{config.output_format}"
           save_figure(fig, figure_path, output_format=config.output_format)
       ```

    3. For classification command (after training, before saving outputs):
       ```python
       if test_score is not None:
           # Create bar plot comparing train vs test accuracy
           accuracy_df = pd.DataFrame({
               "dataset": ["Train", "Test"],
               "accuracy": [train_score, test_score]
           })

           fig = plot_bar(
               accuracy_df,
               x_col="dataset",
               y_col="accuracy",
               title="Violence Classification Model Performance",
               xlabel="Dataset",
               ylabel="Accuracy",
           )

           figure_path = output_path / f"{config.report_name}_performance.{config.output_format}"
           save_figure(fig, figure_path, output_format=config.output_format)
       ```

    Note: Time-series figure requires prophet; classification figure requires sklearn. Both have fallback logic.
  </action>
  <verify>
    Run: python -m analysis.cli forecasting time-series --fast --version test
    Expected: reports/test/forecasting/time_series_report_forecast.png is created (if prophet available)
    Run: python -m analysis.cli forecasting classification --fast --version test
    Expected: reports/test/forecasting/classification_report_performance.png is created (if sklearn available)
  </verify>
  <done>
    Forecasting CLI commands generate figures when models are available.
    Commands gracefully skip figure generation if optional dependencies are missing.
  </done>
</task>

<task type="auto">
  <name>Update CLI tests to verify figure generation</name>
  <files>tests/test_cli_chief.py, tests/test_cli_patrol.py, tests/test_cli_policy.py, tests/test_cli_forecasting.py</files>
  <action>
    Update all CLI test files to verify figure files are created with correct format:

    For each test file, update the relevant test classes to add figure verification:

    1. tests/test_cli_chief.py - Update TestChiefTrends.test_chief_trends_output_files:
       ```python
       # Check for expected output files
       expected_files = [
           "annual_trends_report_summary.txt",
           "annual_trends_report_trend.png",  # Add this line
       ]
       ```

    2. tests/test_cli_chief.py - Add test for output format variation:
       ```python
       def test_chief_trends_output_format(self, tmp_output_dir: Path) -> None:
           """Test trends command with different output formats."""
           for fmt in ["png", "svg", "pdf"]:
               result = runner.invoke(
                   app,
                   ["chief", "trends", "--output-format", fmt, "--fast", "--version", "test"],
               )
               assert result.exit_code == 0, f"Command failed for format {fmt}: {result.output}"

               # Check that figure file with correct extension exists
               figure_path = Path("reports/test/chief") / f"annual_trends_report_trend.{fmt}"
               assert figure_path.exists(), f"Figure not created for format {fmt}: {figure_path}"
       ```

    3. Apply similar updates to:
       - TestChiefSeasonality.test_chief_seasonality_output_files (add seasonality_report_seasonal.png)
       - TestChiefCovid.test_chief_covid_output_files (add covid_impact_report_covid_impact.png)
       - Patrol tests (add figure checks for hotspots, robbery-heatmap, district-severity)
       - Policy tests (add figure checks for retail-theft, vehicle-crimes, composition)
       - Forecasting tests (add figure checks for time-series, classification)

    4. For commands that may skip figure generation (hotspots without sklearn, etc.):
       - Add conditional checks or separate test methods
       - Use pytest.mark.skipif decorators if needed

    Pattern: Each test should verify both the summary.txt file AND the figure file with correct extension.
  </action>
  <verify>
    Run: pytest tests/test_cli_chief.py -v
    Expected: All tests pass, including new output format tests
    Run: pytest tests/test_cli_patrol.py -v
    Expected: All tests pass, figure files verified
    Run: pytest tests/test_cli_policy.py -v
    Expected: All tests pass, figure files verified
    Run: pytest tests/test_cli_forecasting.py -v
    Expected: All tests pass, figure files verified
    Run: pytest tests/ -k "cli" --cov=analysis/cli --cov-report=term-missing
    Expected: All CLI tests pass, coverage maintained at 90%+
  </verify>
  <done>
    All CLI test files verify figure generation with correct format extension.
    Tests confirm figures are saved to reports/{version}/{group}/ directory.
    Output format variations (png, svg, pdf) are tested.
  </done>
</task>

</tasks>

<verification>
After completing all tasks, verify:

1. All CLI commands generate figures:
   ```bash
   # Chief
   python -m analysis.cli chief trends --fast --version test
   ls reports/test/chief/*.png

   # Patrol
   python -m analysis.cli patrol district-severity --fast --version test
   ls reports/test/patrol/*.png

   # Policy
   python -m analysis.cli policy composition --fast --version test
   ls reports/test/policy/*.png

   # Forecasting
   python -m analysis.cli forecasting time-series --fast --version test
   ls reports/test/forecasting/*.png
   ```

2. All output formats work:
   ```bash
   python -m analysis.cli chief trends --output-format png --fast --version test
   python -m analysis.cli chief trends --output-format svg --fast --version test
   python -m analysis.cli chief trends --output-format pdf --fast --version test
   ls reports/test/chief/*.png reports/test/chief/*.svg reports/test/chief/*.pdf
   ```

3. All CLI tests pass with figure verification:
   ```bash
   pytest tests/test_cli_chief.py -v
   pytest tests/test_cli_patrol.py -v
   pytest tests/test_cli_policy.py -v
   pytest tests/test_cli_forecasting.py -v
   ```

4. Full test suite still passes:
   ```bash
   pytest tests/ --cov=analysis --cov-report=term-missing
   ```
   Expected: 90%+ coverage maintained

5. Verify gap closure truths from VERIFICATION.md:
   - "User can generate figures in PNG, SVG, or PDF format via CLI --output-format argument" - VERIFIED
   - "User can see consistent styling across all figures" - VERIFIED (setup_style() called via plot functions)
   - "All figures are saved at 300 DPI" - VERIFIED (save_figure() uses 300 DPI for PNG)
</verification>

<success_criteria>
- [ ] All Chief CLI commands generate figures using plot functions
- [ ] All Patrol CLI commands generate figures where data permits
- [ ] All Policy CLI commands generate figures for trend/composition analyses
- [ ] All Forecasting CLI commands generate figures when models available
- [ ] Figures are saved with correct extension from --output-format argument
- [ ] Figures are saved to reports/{version}/{group}/ directory
- [ ] setup_style() is applied implicitly via plot functions
- [ ] save_figure() is called with output_format parameter
- [ ] CLI tests verify figure files are created
- [ ] CLI tests verify all output formats (png, svg, pdf)
- [ ] All CLI tests pass
- [ ] Test coverage maintained at 90%+
- [ ] All 13 CLI commands now have complete visualization integration
</success_criteria>

<output>
After completion, create `.planning/phases/07-visualization-testing/07-10-SUMMARY.md`
</output>
