---
phase: 07-visualization-testing
plan: 07
type: execute
wave: 4
depends_on: ["07-03", "07-04", "07-05", "07-06"]
files_modified:
  - .pre-commit-config.yaml
autonomous: true

must_haves:
  truths:
    - "Developer can commit changes and have pre-commit hooks run pytest"
    - "Pre-commit hooks run pytest before allowing commit"
    - "Hooks use -x flag for fast feedback (stop on first failure)"
    - "pytest hook is configured alongside existing black, ruff, mypy hooks"
  artifacts:
    - path: ".pre-commit-config.yaml"
      provides: "Pre-commit hooks including pytest"
      contains: "- id: pytest"
  key_links:
    - from: ".pre-commit-config.yaml"
      to: "tests/"
      via: "pytest invocation"
      pattern: "entry: pytest"
</key_links>
---

<objective>
Update pre-commit configuration to include pytest hook that runs tests before commits. This ensures that code changes don't break existing tests and provides fast feedback using the -x flag (stop on first failure).

Purpose: Implement TEST-08 requirement by adding pre-commit hook for pytest, ensuring code quality is maintained automatically during development.

Output: Updated .pre-commit-config.yaml with pytest hook added to existing hooks
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-visualization-testing/07-RESEARCH.md

# Existing pre-commit configuration
@.pre-commit-config.yaml  # Current hooks: black, ruff, mypy, trailing-whitespace, end-of-file-fixer, check-yaml, debug-statements

# pytest configuration
@pyproject.toml  # pytest configured with 90% coverage target
</context>

<tasks>

<task type="auto">
  <name>Add pytest hook to pre-commit configuration</name>
  <files>.pre-commit-config.yaml</files>
  <action>
Update .pre-commit-config.yaml to add pytest hook:

1. Read existing .pre-commit-config.yaml
2. Add pytest hook after mypy hook (before file-based hooks):
   ```yaml
   - repo: local
     hooks:
       - id: pytest
         name: Run pytest
         entry: pytest -x
         language: system
         pass_filenames: false
         always_run: true
  ```
3. Use -x flag to stop on first failure (fast feedback)
4. Set pass_filenames: false (pytest discovers tests itself)
5. Set always_run: true (run even if no Python files changed)
6. Preserve all existing hooks (black, ruff, mypy, trailing-whitespace, etc.)
7. Add comment explaining pytest hook placement

DO NOT:
- Don't remove any existing hooks
- Don't use pytest --cov in pre-commit (too slow for commit-time check)
- Don't require all 26 CLI tests on every commit (use -x for fast feedback)
  </action>
  <verify>
# Verify pre-commit config is valid YAML
pre-commit validate-config

# Show all hooks
pre-commit run --all-files --verbose | head -30
  </verify>
  <done>
.pre-commit-config.yaml includes pytest hook with -x flag; hook runs pytest on commit; existing hooks preserved
  </done>
</task>

<task type="auto">
  <name>Test pre-commit pytest hook</name>
  <files>.pre-commit-config.yaml</files>
  <action>
Test the pre-commit pytest hook:

1. Run pre-commit on all files to verify pytest hook works:
   ```bash
   pre-commit run --all-files
   ```
2. Verify pytest hook executes
3. Check that all tests pass (or stop at first failure with -x)
4. If hook fails, debug and fix before proceeding

DO NOT:
- Don't skip failing tests (debug and fix)
- Don't disable pytest hook (it's a requirement)
  </action>
  <verify>
# Run pre-commit hooks manually
pre-commit run --all-files

# Should show pytest hook running and all tests passing
# Expected output includes "pytest...................Passed"
  </verify>
  <done>
pre-commit pytest hook executes successfully and all tests pass
  </done>
</task>

</tasks>

<verification>
Run these verification steps after all tasks complete:

1. Validate pre-commit configuration:
   ```bash
   pre-commit validate-config
   ```
   Expected: Config is valid

2. List all hooks:
   ```bash
   pre-commit run --list-hooks
   ```
   Expected: pytest hook is listed

3. Run all pre-commit hooks:
   ```bash
   pre-commit run --all-files
   ```
   Expected: All hooks pass, including pytest

4. Verify pytest hook specifically:
   ```bash
   pre-commit run pytest --all-files
   ```
   Expected: pytest hook runs and passes

5. Test hook with a staged file:
   ```bash
   # Create a dummy test change
   echo "# test comment" >> tests/test_classification.py
   git add tests/test_classification.py
   pre-commit run pytest --files tests/test_classification.py
   git restore tests/test_classification.py
   ```
   Expected: pytest runs on changed file
</verification>

<success_criteria>
1. .pre-commit-config.yaml includes pytest hook
2. pytest hook uses -x flag for fast feedback
3. pytest hook runs with pass_filenames: false
4. All existing hooks are preserved (black, ruff, mypy, etc.)
5. pre-commit validate-config passes
6. pre-commit run --all-files executes pytest hook successfully
7. pytest hook stops on first test failure (-x flag working)
8. All 26+ CLI tests plus existing tests still pass
</success_criteria>

<output>
After completion, create `.planning/phases/07-visualization-testing/07-07-SUMMARY.md` with:
- Performance metrics (duration, files modified)
- pytest hook configuration (-x flag, pass_filenames: false)
- Pre-commit hook list (black, ruff, mypy, pytest, etc.)
- Verification results (pre-commit run --all-files passes)
- Any deviations from plan
- Git commit hash
</output>
