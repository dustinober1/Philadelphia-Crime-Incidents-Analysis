---
phase: 07-visualization-testing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - analysis/visualization/__init__.py
  - analysis/visualization/style.py
  - analysis/visualization/helpers.py
  - analysis/visualization/plots.py
autonomous: true

must_haves:
  truths:
    - "User can generate figures in PNG, SVG, or PDF format via CLI --output-format argument"
    - "User can see consistent styling across all figures using project color palette"
    - "Developer can import save_figure() from analysis.visualization.helpers"
    - "Developer can call setup_style() to apply consistent matplotlib settings"
    - "All figures are saved at 300 DPI for publication quality"
  artifacts:
    - path: "analysis/visualization/style.py"
      provides: "Centralized matplotlib style configuration"
      exports: ["setup_style", "COLORS"]
    - path: "analysis/visualization/helpers.py"
      provides: "Figure saving utilities with multi-format support"
      exports: ["save_figure"]
    - path: "analysis/visualization/plots.py"
      provides: "Common plot functions (line, bar, heatmap)"
      exports: ["plot_line", "plot_bar", "plot_heatmap"]
    - path: "analysis/visualization/__init__.py"
      provides: "Public API exports"
      exports: ["save_figure", "setup_style", "COLORS"]
  key_links:
    - from: "analysis/visualization/style.py"
      to: "analysis/config.COLORS"
      via: "Import existing COLORS palette"
      pattern: "from analysis.config import COLORS"
---

<objective>
Create a reusable visualization module with centralized style configuration, multi-format figure saving, and common plot functions. This establishes consistent styling across all analysis outputs and supports the --output-format CLI argument introduced in Phase 6.

Purpose: Eliminate duplicated styling code, ensure publication-quality output, and provide a unified API for visualization across all CLI commands.

Output: analysis/visualization/ module with style.py, helpers.py, plots.py and updated __init__.py exports
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-visualization-testing/07-RESEARCH.md

# Existing assets to leverage
@analysis/visualization/forecast_plots.py  # Existing pattern (returns Figure objects, save_path param)
@analysis/config.py  # COLORS palette (Violent: #E63946, Property: #457B9D, Other: #A8DADC)
</context>

<tasks>

<task type="auto">
  <name>Create style.py with centralized matplotlib configuration</name>
  <files>analysis/visualization/style.py</files>
  <action>
Create analysis/visualization/style.py with:

1. Import COLORS from analysis.config
2. Define setup_style() function that:
   - Sets seaborn color palette using COLORS
   - Configures matplotlib rcParams:
     - figure.figsize: (12, 6)
     - font.size: 11
     - axes.titlesize: 14, titleweight: bold
     - axes.labelsize: 12, labelweight: bold
     - axes.grid: True, grid.alpha: 0.3
     - savefig.dpi: 300, bbox: tight, facecolor: white
     - legend.framealpha: 0.9, fontsize: 10
3. Export COLORS for convenience
4. Add module docstring

DO NOT:
- Don't hard-code colors (use analysis.config.COLORS)
- Don't call setup_style() at import (let caller invoke)
  </action>
  <verify>
python -c "from analysis.visualization.style import setup_style, COLORS; setup_style(); print('Style configured'); print('COLORS:', COLORS)"
  </verify>
  <done>
setup_style() function configures matplotlib with project COLORS palette and publication-quality settings; COLORS is re-exported for convenience
  </done>
</task>

<task type="auto">
  <name>Create helpers.py with multi-format save_figure function</name>
  <files>analysis/visualization/helpers.py</files>
  <action>
Create analysis/visualization/helpers.py with:

1. Import matplotlib.pyplot as plt, Path from pathlib
2. Define save_figure() function with signature:
   - fig: plt.Figure
   - output_path: str | Path
   - output_format: str = "png"
   - dpi: int = 300
3. Implement format-specific DPI:
   - PNG: dpi=300 (raster, needs resolution)
   - SVG/PDF: dpi=None (vector, no quality loss)
4. Use fig.savefig() with bbox_inches='tight', facecolor='white'
5. Handle output_path extension correctly
6. Add Google-style docstring (Args, Returns, Raises)

DO NOT:
- Don't implement HTML/JSON yet (defer until use case emerges - matplotlib doesn't natively support these)
- Don't create directory if it doesn't exist (caller responsibility)
  </action>
  <verify>
# Create test figure and save in multiple formats
python -c "
import matplotlib.pyplot as plt
from analysis.visualization.helpers import save_figure
from pathlib import Path

fig, ax = plt.subplots()
ax.plot([1, 2, 3], [4, 5, 6])

# Test PNG save
save_figure(fig, 'test_output.png', 'png')
assert Path('test_output.png').exists()

# Test SVG save
save_figure(fig, 'test_output.svg', 'svg')
assert Path('test_output.svg').exists()

print('save_figure() works correctly')

# Cleanup
Path('test_output.png').unlink()
Path('test_output.svg').unlink()
"
  </verify>
  <done>
save_figure() saves figures in PNG (300 DPI), SVG, or PDF format with consistent styling and proper path handling
  </done>
</task>

<task type="auto">
  <name>Create plots.py with common plot functions</name>
  <files>analysis/visualization/plots.py</files>
  <action>
Create analysis/visualization/plots.py with:

1. Import matplotlib.pyplot as plt, pandas as pd
2. Import COLORS, setup_style from .style
3. Define plot_line() function:
   - Args: data (pd.DataFrame), x_col, y_col, title, xlabel, ylabel, color=None
   - Returns: plt.Figure
   - Apply setup_style() at start
   - Use COLORS if color not specified
4. Define plot_bar() function:
   - Same signature pattern as plot_line
   - Create vertical bar chart
5. Define plot_heatmap() function:
   - Args: data (pd.DataFrame), title, figsize=(12, 10)
   - Use seaborn heatmap with correlation
6. All functions return Figure objects (caller handles saving)
7. Add Google-style docstrings

DO NOT:
- Don't save figures in these functions (caller uses save_figure)
- Don't hard-code colors (use COLORS palette)
  </action>
  <verify>
# Test each plot function returns Figure
python -c "
import pandas as pd
from analysis.visualization.plots import plot_line, plot_bar, plot_heatmap

# Create test data
df = pd.DataFrame({'x': [1, 2, 3], 'y': [4, 5, 6]})

# Test plot_line
fig_line = plot_line(df, 'x', 'y', title='Test Line')
assert hasattr(fig_line, 'savefig')

# Test plot_bar
fig_bar = plot_bar(df, 'x', 'y', title='Test Bar')
assert hasattr(fig_bar, 'savefig')

# Test plot_heatmap
df_corr = df.corr()
fig_heatmap = plot_heatmap(df_corr, title='Test Heatmap')
assert hasattr(fig_heatmap, 'savefig')

print('All plot functions return Figure objects')
"
  </verify>
  <done>
plot_line(), plot_bar(), plot_heatmap() functions exist and return matplotlib Figure objects with consistent styling using project COLORS
  </done>
</task>

<task type="auto">
  <name>Update visualization/__init__.py with public API exports</name>
  <files>analysis/visualization/__init__.py</files>
  <action>
Update analysis/visualization/__init__.py to:

1. Export from .style: setup_style, COLORS
2. Export from .helpers: save_figure
3. Export from .plots: plot_line, plot_bar, plot_heatmap
4. Keep existing forecast_plots exports for backward compatibility
5. Add module docstring describing the visualization API

DO NOT:
- Don't remove forecast_plots exports (existing code may use them)
- Don't use relative imports (use from .X import Y pattern)
  </action>
  <verify>
python -c "
from analysis.visualization import save_figure, setup_style, COLORS, plot_line, plot_bar, plot_heatmap
print('All exports accessible')
print('COLORS:', COLORS)
"
  </verify>
  <done>
__init__.py exports save_figure, setup_style, COLORS, plot_line, plot_bar, plot_heatmap from new modules and preserves forecast_plots for backward compatibility
  </done>
</task>

</tasks>

<verification>
Run these verification steps after all tasks complete:

1. Check module structure:
   ```bash
   python -c "from analysis.visualization import save_figure, setup_style, COLORS, plot_line, plot_bar, plot_heatmap; print('All exports OK')"
   ```

2. Verify style configuration:
   ```bash
   python -c "from analysis.visualization.style import setup_style; import matplotlib.pyplot as plt; setup_style(); print('DPI:', plt.rcParams['savefig.dpi'])"
   ```
   Expected: DPI: 300

3. Verify save_figure format support:
   ```bash
   python -c "from analysis.visualization.helpers import save_figure; import matplotlib.pyplot as plt; fig, ax = plt.subplots(); ax.plot([1,2,3]); save_figure(fig, '/tmp/test.png', 'png'); print('PNG save works')"
   ```

4. Run mypy on visualization module:
   ```bash
   mypy analysis/visualization/
   ```
   Expected: No errors (except geopandas/shapely warnings which are ignored)

5. Check docstrings exist:
   ```bash
   python -c "from analysis.visualization import save_figure, setup_style; print(save_figure.__doc__, setup_style.__doc__)"
   ```
   Expected: Non-empty docstrings
</verification>

<success_criteria>
1. Developer can run `from analysis.visualization import save_figure, setup_style, COLORS` without errors
2. save_figure() accepts 'png', 'svg', 'pdf' formats and saves with correct DPI
3. setup_style() applies COLORS palette to matplotlib and sets 300 DPI default
4. plot_line(), plot_bar(), plot_heatmap() functions return Figure objects
5. All functions have Google-style docstrings with Args/Returns sections
6. mypy analysis/visualization/ passes with no new errors
7. Existing forecast_plots functionality is preserved (backward compatibility)
</success_criteria>

<output>
After completion, create `.planning/phases/07-visualization-testing/07-01-SUMMARY.md` with:
- Performance metrics (duration, files modified)
- Key exports added (save_figure, setup_style, COLORS, plot functions)
- Format support (PNG, SVG, PDF with correct DPI)
- Any deviations from plan
- Git commit hashes for each task
</output>
