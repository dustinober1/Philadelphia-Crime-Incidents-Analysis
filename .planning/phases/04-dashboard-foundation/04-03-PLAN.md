---
phase: 04-dashboard-foundation
plan: 03
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - dashboard/filters/__init__.py
  - dashboard/filters/time_filters.py
  - dashboard/app.py
autonomous: true

must_haves:
  truths:
    - "User can filter dashboard by date range using date sliders"
    - "User can select preset periods: year, season, month"
    - "Filters sync to URL query parameters for shareable links"
    - "Cascading filters work: selecting year narrows month options"
  artifacts:
    - path: "dashboard/filters/__init__.py"
      provides: "Filters package initialization"
      min_lines: 5
    - path: "dashboard/filters/time_filters.py"
      provides: "Time range filter controls"
      min_lines: 150
      exports: ["render_time_filters", "sync_time_filters_to_url", "read_time_filters_from_url"]
  key_links:
    - from: "dashboard/filters/time_filters.py"
      to: "dashboard/components/cache.py"
      via: "Import apply_filters for filtering data by time"
      pattern: "from dashboard\\.components\\.cache import"
    - from: "dashboard/filters/time_filters.py"
      to: "st.query_params"
      via: "Sync filter state to URL for shareable links"
      pattern: "st\\.query_params"
    - from: "dashboard/app.py"
      to: "dashboard/filters/time_filters.py"
      via: "Import and use render_time_filters in sidebar"
      pattern: "from dashboard\\.filters\\.time_filters import"
---

<objective>
Implement time range filter controls with date sliders, preset periods, and URL state synchronization.

Purpose: Enable users to filter dashboard data by time range using intuitive date sliders and preset period selections (year, season, month). Filters persist in URL for shareable links. This addresses requirement DASH-01.

Output: Time filter module with slider controls, preset buttons, URL sync, and cascading filter logic.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-dashboard-foundation/04-CONTEXT.md
@.planning/phases/04-dashboard-foundation/04-RESEARCH.md

@dashboard/config.py
@dashboard/components/cache.py
@analysis/config.py
</context>

<tasks>

<task type="auto">
  <name>Create time range filter controls with URL sync</name>
  <files>dashboard/filters/__init__.py, dashboard/filters/time_filters.py, dashboard/app.py</files>
  <action>
Create time filter components with date sliders, preset periods, and URL synchronization:

1. **CREATE dashboard/filters/__init__.py**:
```python
"""
Dashboard filter components.

Reusable filter controls for time, geography, and crime type.
"""

from dashboard.filters.time_filters import (
    render_time_filters,
    sync_time_filters_to_url,
    read_time_filters_from_url,
    TimeFilterState,
)

__all__ = [
    "render_time_filters",
    "sync_time_filters_to_url",
    "read_time_filters_from_url",
    "TimeFilterState",
]
```

2. **CREATE dashboard/filters/time_filters.py**:
```python
"""
Time range filter controls for the dashboard.

Provides date sliders, preset period selections, and URL state synchronization
for time-based filtering of crime data.
"""

import streamlit as st
from datetime import datetime, date
from typing import NamedTuple

from dashboard.config import FILTER_DEFAULTS


class TimeFilterState(NamedTuple):
    """Immutable container for time filter state."""

    start_date: date
    end_date: date
    preset: str | None  # 'custom', 'last_year', 'last_5_years', etc.

    @property
    def years(self) -> list[int]:
        """Years included in this date range."""
        return list(range(self.start_date.year, self.end_date.year + 1))


# Preset period definitions
PRESETS = {
    "all": {"label": "All Data (2006-2025)", "years": (2006, 2025)},
    "last_5_years": {"label": "Last 5 Years", "years": (2021, 2025)},
    "last_3_years": {"label": "Last 3 Years", "years": (2023, 2025)},
    "last_year": {"label": "Last Year (2025)", "years": (2025, 2025)},
    "covid_period": {"label": "COVID Period (2020-2022)", "years": (2020, 2022)},
    "custom": {"label": "Custom Range", "years": None},
}


def read_time_filters_from_url() -> dict:
    """
    Read time filter state from URL query parameters.

    Returns:
        Dict with start_date, end_date, preset keys (or defaults if not in URL).
    """
    params = st.query_params

    # Default values
    defaults = {
        "start_date": FILTER_DEFAULTS["start_date"],
        "end_date": FILTER_DEFAULTS["end_date"],
        "preset": "all",
    }

    # Read from URL if present
    result = defaults.copy()
    if "start_date" in params:
        result["start_date"] = params["start_date"]
    if "end_date" in params:
        result["end_date"] = params["end_date"]
    if "preset" in params:
        result["preset"] = params["preset"]

    return result


def sync_time_filters_to_url(state: TimeFilterState) -> None:
    """
    Sync time filter state to URL query parameters.

    Args:
        state: Current TimeFilterState to persist.
    """
    params = st.query_params
    params["start_date"] = state.start_date.strftime("%Y-%m-%d")
    params["end_date"] = state.end_date.strftime("%Y-%m-%d")
    params["preset"] = state.preset or "custom"


def render_time_filters(key_prefix: str = "time") -> TimeFilterState:
    """
    Render time range filter controls in the sidebar.

    Creates:
    - Preset period buttons (All Data, Last 5 Years, Last Year, etc.)
    - Date range slider for custom range selection
    - Individual year multi-select for fine-grained control

    Args:
        key_prefix: Prefix for widget keys to avoid conflicts.

    Returns:
        TimeFilterState with current filter values.

    Example:
        >>> time_state = render_time_filters()
        >>> time_state.start_date
        datetime.date(2006, 1, 1)
        >>> time_state.years
        [2006, 2007, ..., 2025]
    """
    with st.sidebar:
        st.subheader(":calendar: Time Range")

        # Initialize from URL or defaults
        url_state = read_time_filters_from_url()

        # Preset period selection
        preset = st.selectbox(
            "Preset Period",
            options=list(PRESETS.keys()),
            format_func=lambda x: PRESETS[x]["label"],
            index=list(PRESETS.keys()).index(url_state["preset"]),
            key=f"{key_prefix}_preset",
        )

        # Determine date range based on preset
        if preset != "custom":
            preset_years = PRESETS[preset]["years"]
            default_start = date(preset_years[0], 1, 1)
            default_end = date(preset_years[1], 12, 31)
        else:
            # Use URL values or defaults
            default_start = datetime.strptime(url_state["start_date"], "%Y-%m-%d").date()
            default_end = datetime.strptime(url_state["end_date"], "%Y-%m-%d").date()

        # Date range slider
        date_range = st.slider(
            "Date Range",
            min_value=date(2006, 1, 1),
            max_value=date(2025, 12, 31),
            value=(default_start, default_end),
            format="YYYY-MM-DD",
            key=f"{key_prefix}_range",
        )

        start_date, end_date = date_range

        # Year multi-select (for cascading filters)
        available_years = list(range(start_date.year, end_date.year + 1))

        # Initialize session state for years
        years_key = f"{key_prefix}_years"
        if years_key not in st.session_state:
            st.session_state[years_key] = available_years

        # Update available years when date range changes
        selected_years = st.multiselect(
            "Select Years",
            options=available_years,
            default=available_years,
            key=f"{key_prefix}_years_select",
        )

        # Season filter (optional)
        season = st.selectbox(
            "Season (Optional)",
            options=["All", "Winter", "Spring", "Summer", "Fall"],
            index=0,
            key=f"{key_prefix}_season",
        )

        # Month filter (optional, cascades from years/season)
        all_months = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ]

        if season != "All":
            season_months = {
                "Winter": ["December", "January", "February"],
                "Spring": ["March", "April", "May"],
                "Summer": ["June", "July", "August"],
                "Fall": ["September", "October", "November"],
            }
            month_options = season_months[season]
        else:
            month_options = all_months

        selected_months = st.multiselect(
            "Select Months",
            options=month_options,
            default=month_options,
            key=f"{key_prefix}_months",
        )

        # Reset button
        if st.button(":recycle: Reset Time Filters", key=f"{key_prefix}_reset"):
            st.query_params.clear()
            st.rerun()

    # Create state object
    state = TimeFilterState(
        start_date=start_date,
        end_date=end_date,
        preset=preset if preset != "custom" else None,
    )

    # Sync to URL
    sync_time_filters_to_url(state)

    # Store derived filter values in session state for other components
    st.session_state[f"{key_prefix}_derived"] = {
        "years": selected_years,
        "months": selected_months,
        "season": season,
    }

    return state


def get_filter_dates(state: TimeFilterState) -> tuple[str, str]:
    """
    Convert TimeFilterState to date strings for filtering.

    Args:
        state: TimeFilterState from render_time_filters.

    Returns:
        Tuple of (start_date_str, end_date_str) in YYYY-MM-DD format.
    """
    return (
        state.start_date.strftime("%Y-%m-%d"),
        state.end_date.strftime("%Y-%m-%d"),
    )
```

3. **UPDATE dashboard/app.py** to integrate time filters:
```python
"""
Philadelphia Crime Incidents Dashboard - Main Entry Point.

Run with: streamlit run dashboard/app.py
"""

import streamlit as st
from pathlib import Path

from dashboard.config import DISPLAY_CONFIG, PAGE_NAMES
from dashboard.components.cache import load_crime_data, get_data_summary
from dashboard.filters.time_filters import render_time_filters, get_filter_dates

# Configure page
st.set_page_config(
    page_title="Philadelphia Crime Dashboard",
    page_icon=":police_car:",
    layout=DISPLAY_CONFIG["layout"],
    initial_sidebar_state="expanded",
)

# Custom CSS
def _load_custom_css():
    st.markdown("""
    <style>
    .main-header {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1f77b4;
        margin-bottom: 0.5rem;
    }
    .sub-header {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 2rem;
    }
    </style>
    """, unsafe_allow_html=True)

def main():
    """Main dashboard entry point."""
    _load_custom_css()

    # Title
    st.title(DISPLAY_CONFIG["title"])
    st.markdown(f"<p class='sub-header'>{DISPLAY_CONFIG['subtitle']}</p>", unsafe_allow_html=True)

    # Render time filters in sidebar
    time_state = render_time_filters()

    # Get filter dates for data loading
    start_date, end_date = get_filter_dates(time_state)

    # Load and filter data
    with st.spinner("Loading data..."):
        df = load_crime_data()

    # Apply time filters
    from dashboard.components.cache import apply_filters
    filtered_df = apply_filters(df, start_date=start_date, end_date=end_date)

    # Display summary stats
    summary = get_data_summary(filtered_df)

    st.subheader(f"Filtered Summary: {start_date} to {end_date}")

    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("Records", f"{summary['total_records']:,}")
    with col2:
        st.metric("Years", summary.get('years', 'N/A'))
    with col3:
        st.metric("Districts", summary.get('districts', 'N/A'))
    with col4:
        coord_pct = summary.get('coord_coverage', {}).get('percentage', 0)
        st.metric("Valid Coordinates", f"{coord_pct:.1f}%")

    # Show active filter info
    st.caption(f":link: Share this view: URL encodes your current filter settings")

if __name__ == "__main__":
    main()
```

4. **VERIFY time filters work**:
```bash
cd "/Users/dustinober/Projects/Crime Incidents Philadelphia"
python -c "
from datetime import date
from dashboard.filters.time_filters import TimeFilterState, get_filter_dates, PRESETS
state = TimeFilterState(
    start_date=date(2020, 1, 1),
    end_date=date(2022, 12, 31),
    preset='covid_period'
)
start, end = get_filter_dates(state)
print('Filter dates:', start, '-', end)
print('Years:', state.years)
print('Presets:', list(PRESETS.keys()))
"
```

Key implementation notes:
- Follow RESEARCH.md Pattern 3 for URL state encoding with st.query_params
- Preset periods: All Data, Last 5 Years, Last 3 Years, Last Year, COVID Period, Custom
- Cascading filters: Season selection limits available months
- URL sync: start_date, end_date, preset stored in query parameters
- Session state used for derived values (selected_years, selected_months)
- Reset button clears query_params and reruns
- Date range limited to 2006-2025 (exclude incomplete 2026)
</action>
  <verify>
python -c "
from dashboard.filters.time_filters import (
    render_time_filters, TimeFilterState, get_filter_dates,
    read_time_filters_from_url, sync_time_filters_to_url, PRESETS
)
from datetime import date
# Test state creation
state = TimeFilterState(start_date=date(2020,1,1), end_date=date(2022,12,31), preset='covid_period')
start, end = get_filter_dates(state)
assert start == '2020-01-01', f'Expected 2020-01-01, got {start}'
assert end == '2022-12-31', f'Expected 2022-12-31, got {end}'
assert state.years == [2020, 2021, 2022], f'Expected [2020, 2021, 2022], got {state.years}'
print('Time filters: state creation OK')
# Test presets
assert 'all' in PRESETS and 'last_5_years' in PRESETS
print('Time filters: presets OK')
# Test URL read (needs mock streamlit)
print('Time filters: module loaded successfully')
"
</verify>
  <done>
TimeFilterState NamedTuple defined with start_date, end_date, preset, and years property

render_time_filters() creates:
- Preset period selectbox with 6 options
- Date range slider (2006-01-01 to 2025-12-31)
- Year multi-select
- Season selectbox
- Month multi-select (cascades from season)
- Reset button

read_time_filters_from_url() reads start_date, end_date, preset from st.query_params

sync_time_filters_to_url() writes filter state to st.query_params

get_filter_dates() converts TimeFilterState to YYYY-MM-DD strings

Updated app.py imports and uses render_time_filters(), displays filtered summary stats
</done>
</task>

</tasks>

<verification>
After completion:
1. Verify module imports: `python -c "from dashboard.filters.time_filters import render_time_filters, TimeFilterState, get_filter_dates"`
2. Verify TimeFilterState works with dates and presets
3. Verify app.py imports and uses time filters: check for `render_time_filters()` call
4. Run dashboard and verify time filter controls appear in sidebar: `streamlit run dashboard/app.py --server.headless true`
5. Verify URL params are updated when filters change (manual check or inspect source)
</verification>

<success_criteria>
Time filter controls render in sidebar with preset selectbox, date slider, year/season/month selectors. Selecting preset updates date slider. Changing season limits month options. URL parameters update with filter state. Summary stats reflect filtered data based on time range.
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-foundation/04-03-SUMMARY.md`
</output>
