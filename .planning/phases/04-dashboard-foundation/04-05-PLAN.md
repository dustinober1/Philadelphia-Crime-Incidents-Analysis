---
phase: 04-dashboard-foundation
plan: 05
type: execute
wave: 2
depends_on: [04-01, 04-02]
files_modified:
  - dashboard/filters/crime_filters.py
  - dashboard/app.py
autonomous: true

must_haves:
  truths:
    - "User can filter dashboard by UCR crime category (Violent, Property, Other)"
    - "User can filter by specific crime type using multi-select"
    - "Crime type options are limited to those in selected categories"
    - "Filters sync to URL query parameters"
  artifacts:
    - path: "dashboard/filters/crime_filters.py"
      provides: "Crime type filter controls"
      min_lines: 120
      exports: ["render_crime_filters", "get_crime_categories_from_data"]
  key_links:
    - from: "dashboard/filters/crime_filters.py"
      to: "dashboard/components/cache.py"
      via: "Use apply_filters for filtering data by crime type"
      pattern: "from dashboard\\.components\\.cache import"
    - from: "dashboard/filters/crime_filters.py"
      to: "st.query_params"
      via: "Sync crime filter state to URL"
      pattern: "st\\.query_params"
    - from: "dashboard/app.py"
      to: "dashboard/filters/crime_filters.py"
      via: "Import and use render_crime_filters in sidebar"
      pattern: "from dashboard\\.filters\\.crime_filters import"
    - from: "dashboard/filters/crime_filters.py"
      to: "analysis/utils.py"
      via: "Import UCR crime category definitions"
      pattern: "from analysis\\.utils import"
---

<objective>
Implement crime type filter controls for UCR category and specific crime type selection with URL state synchronization.

Purpose: Enable users to filter dashboard data by UCR crime category (Violent, Property, Other) and specific crime types. Filters persist in URL for shareable links. This addresses requirement DASH-03.

Output: Crime type filter module with category selectbox, crime type multi-select, and URL sync.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-dashboard-foundation/04-CONTEXT.md
@.planning/phases/04-dashboard-foundation/04-RESEARCH.md

@dashboard/config.py
@dashboard/components/cache.py
@dashboard/filters/time_filters.py
@analysis/utils.py
@analysis/categorical_analysis.py
</context>

<tasks>

<task type="auto">
  <name>Create crime type filter controls for category and crime type selection</name>
  <files>dashboard/filters/crime_filters.py, dashboard/app.py</files>
  <action>
Create crime type filter components for UCR category and specific crime type selection:

1. **CREATE dashboard/filters/crime_filters.py**:
```python
"""
Crime type filter controls for the dashboard.

Provides UCR category and specific crime type selection with URL state
synchronization.
"""

import streamlit as st
from typing import NamedTuple

from analysis.utils import VIOLENT_CRIME_UCR, PROPERTY_CRIME_UCR
from dashboard.config import FILTER_DEFAULTS


# UCR category definitions
UCR_CATEGORIES = {
    "Violent": VIOLENT_CRIME_UCR,  # [100, 200, 300, 400]
    "Property": PROPERTY_CRIME_UCR,  # [500, 600, 700]
    "Other": None,  # Everything else
}

# Category to UCR code mapping for filtering
CATEGORY_UCR_MAP = {
    "Violent": VIOLENT_CRIME_UCR,
    "Property": PROPERTY_CRIME_UCR,
    "Other": "other",  # Special marker for non-violent/property
}


class CrimeFilterState(NamedTuple):
    """Immutable container for crime type filter state."""

    categories: list[str]  # ["Violent", "Property", "Other"] or subset
    crime_types: list[str] | None  # None = all types in selected categories
    select_all_types: bool


def read_crime_filters_from_url() -> dict:
    """
    Read crime filter state from URL query parameters.

    Returns:
        Dict with categories (comma-separated) and crime_types keys.
    """
    params = st.query_params

    result = {
        "categories": None,  # None = all categories
        "crime_types": None,  # None = all crime types
    }

    if "categories" in params:
        categories_str = params["categories"]
        result["categories"] = categories_str.split(",")

    if "crime_types" in params:
        crime_types_str = params["crime_types"]
        result["crime_types"] = crime_types_str.split(",")

    return result


def sync_crime_filters_to_url(state: CrimeFilterState) -> None:
    """
    Sync crime filter state to URL query parameters.

    Args:
        state: Current CrimeFilterState to persist.
    """
    params = st.query_params

    # Encode categories
    if state.select_all_types or len(state.categories) == 3:
        # All categories selected - cleaner URL
        if "categories" in params:
            del params["categories"]
    else:
        params["categories"] = ",".join(state.categories)

    # Encode specific crime types (only if not select all)
    if not state.select_all_types and state.crime_types:
        params["crime_types"] = ",".join(state.crime_types)
    elif "crime_types" in params:
        del params["crime_types"]


def get_crime_categories_from_data(df) -> list[str]:
    """
    Get list of crime categories present in the current DataFrame.

    Args:
        df: Filtered DataFrame.

    Returns:
        List of category names present in data.
    """
    if "crime_category" not in df.columns:
        return ["Violent", "Property", "Other"]

    return sorted(df["crime_category"].unique().tolist())


def get_crime_types_from_data(df, categories: list[str] | None = None) -> list[str]:
    """
    Get list of specific crime types for the selected categories.

    Args:
        df: Filtered DataFrame.
        categories: List of categories to include (None = all).

    Returns:
        Sorted list of crime type names (text_general_code values).
    """
    if "text_general_code" not in df.columns:
        return []

    result_df = df.copy()

    # Filter by categories if specified
    if categories is not None and "crime_category" in df.columns:
        result_df = result_df[result_df["crime_category"].isin(categories)]

    # Get unique crime types
    crime_types = result_df["text_general_code"].dropna().unique().tolist()

    return sorted(crime_types)


def render_crime_filters(df, key_prefix: str = "crime") -> CrimeFilterState:
    """
    Render crime type filter controls in the sidebar.

    Creates:
    - Category multi-select (Violent, Property, Other)
    - Select all crime types toggle
    - Crime type multi-select (when not select all)

    Args:
        df: Filtered DataFrame (used to limit crime type options).
        key_prefix: Prefix for widget keys to avoid conflicts.

    Returns:
        CrimeFilterState with current filter values.

    Example:
        >>> crime_state = render_crime_filters(filtered_df)
        >>> crime_state.categories
        ['Violent', 'Property']
        >>> crime_state.crime_types
        ['Homicide - Criminal', 'Aggravated Assault Firearm', ...]
    """
    with st.sidebar:
        st.subheader(":mag: Crime Type")

        # Read from URL or default to all categories
        url_state = read_crime_filters_from_url()

        # Get available categories from data
        available_categories = get_crime_categories_from_data(df)

        # Category multi-select
        if url_state["categories"] is None:
            default_categories = available_categories
        else:
            # Filter to available categories
            default_categories = [c for c in url_state["categories"] if c in available_categories]
            if not default_categories:
                default_categories = available_categories

        selected_categories = st.multiselect(
            "UCR Categories",
            options=["Violent", "Property", "Other"],
            default=default_categories,
            key=f"{key_prefix}_categories",
        )

        if not selected_categories:
            st.warning("No categories selected. Showing all categories.")
            selected_categories = available_categories

        # Get crime types for selected categories
        available_crime_types = get_crime_types_from_data(df, selected_categories)

        # Select all toggle
        select_all_types = st.checkbox(
            "Select All Crime Types",
            value=(url_state["crime_types"] is None),
            key=f"{key_prefix}_select_all",
        )

        if select_all_types:
            selected_crime_types = None
        else:
            # Default to URL state or available types
            if url_state["crime_types"] is not None:
                default_types = [t for t in url_state["crime_types"] if t in available_crime_types]
                if not default_types:
                    default_types = available_crime_types[:10]  # First 10 as default
            else:
                default_types = available_crime_types[:10] if len(available_crime_types) > 10 else available_crime_types

            selected_crime_types = st.multiselect(
                "Specific Crime Types",
                options=available_crime_types,
                default=default_types,
                key=f"{key_prefix}_types",
            )

            if not selected_crime_types:
                st.info("All crime types in selected categories will be shown.")
                selected_crime_types = None

        # Reset button
        if st.button(":recycle: Reset Crime Filters", key=f"{key_prefix}_reset"):
            if "categories" in st.query_params:
                del st.query_params["categories"]
            if "crime_types" in st.query_params:
                del st.query_params["crime_types"]
            st.rerun()

    # Create state object
    state = CrimeFilterState(
        categories=selected_categories,
        crime_types=selected_crime_types,
        select_all_types=select_all_types,
    )

    # Sync to URL
    sync_crime_filters_to_url(state)

    return state


def get_filter_categories(state: CrimeFilterState) -> list[str]:
    """
    Convert CrimeFilterState to category list for filtering.

    Args:
        state: CrimeFilterState from render_crime_filters.

    Returns:
        List of category names.
    """
    return state.categories


def get_filter_crime_types(state: CrimeFilterState) -> list[str] | None:
    """
    Convert CrimeFilterState to crime type list for filtering.

    Args:
        state: CrimeFilterState from render_crime_filters.

    Returns:
        List of crime type names or None for all.
    """
    return state.crime_types
```

2. **UPDATE dashboard/app.py** to integrate crime filters:
```python
"""
Philadelphia Crime Incidents Dashboard - Main Entry Point.

Run with: streamlit run dashboard/app.py
"""

import streamlit as st
from pathlib import Path

from dashboard.config import DISPLAY_CONFIG, PAGE_NAMES
from dashboard.components.cache import load_crime_data, get_data_summary, apply_filters
from dashboard.filters.time_filters import render_time_filters, get_filter_dates
from dashboard.filters.geo_filters import render_geo_filters, get_filter_districts
from dashboard.filters.crime_filters import render_crime_filters, get_filter_categories

# Configure page
st.set_page_config(
    page_title="Philadelphia Crime Dashboard",
    page_icon=":police_car:",
    layout=DISPLAY_CONFIG["layout"],
    initial_sidebar_state="expanded",
)

# Custom CSS
def _load_custom_css():
    st.markdown("""
    <style>
    .main-header {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1f77b4;
        margin-bottom: 0.5rem;
    }
    .sub-header {
        font-size: 1.2rem;
        color: #666;
        margin-bottom: 2rem;
    }
    </style>
    """, unsafe_allow_html=True)

def main():
    """Main dashboard entry point."""
    _load_custom_css()

    # Title
    st.title(DISPLAY_CONFIG["title"])
    st.markdown(f"<p class='sub-header'>{DISPLAY_CONFIG['subtitle']}</p>", unsafe_allow_html=True)

    # Load data (cached)
    with st.spinner("Loading data..."):
        df = load_crime_data()

    # Render time filters in sidebar
    time_state = render_time_filters()
    start_date, end_date = get_filter_dates(time_state)

    # Apply time filters first (to limit other filter options)
    df_time_filtered = apply_filters(df, start_date=start_date, end_date=end_date)

    # Render geo filters
    geo_state = render_geo_filters(df_time_filtered)
    selected_districts = get_filter_districts(geo_state)

    # Apply time + geo filters
    df_tg_filtered = apply_filters(
        df,
        start_date=start_date,
        end_date=end_date,
        districts=selected_districts,
    )

    # Render crime filters
    crime_state = render_crime_filters(df_tg_filtered)
    selected_categories = get_filter_categories(crime_state)

    # Apply all filters
    filtered_df = apply_filters(
        df,
        start_date=start_date,
        end_date=end_date,
        districts=selected_districts,
        crime_categories=selected_categories,
    )

    # Display summary stats
    summary = get_data_summary(filtered_df)

    st.subheader(f"Filtered Summary: {start_date} to {end_date}")

    col1, col2, col3, col4 = st.columns(4)
    with col1:
        st.metric("Records", f"{summary['total_records']:,}")
    with col2:
        st.metric("Years", summary.get('years', 'N/A'))
    with col3:
        district_count = len(selected_districts)
        total_districts = summary.get('districts', 23)
        st.metric("Districts", f"{district_count}/{total_districts}")
    with col4:
        coord_pct = summary.get('coord_coverage', {}).get('percentage', 0)
        st.metric("Valid Coordinates", f"{coord_pct:.1f}%")

    # Show active filters
    filter_info = []

    if len(selected_districts) < 23:
        filter_info.append(f"Districts: {', '.join(f'D{d}' for d in sorted(selected_districts))}")

    if len(selected_categories) < 3:
        filter_info.append(f"Categories: {', '.join(selected_categories)}")

    if filter_info:
        st.caption(" | ".join(filter_info))
    else:
        st.caption(":map: All districts, :mag: All categories")

    st.caption(f":link: Share this view: URL encodes your current filter settings")

if __name__ == "__main__":
    main()
```

3. **VERIFY crime filters work**:
```bash
cd "/Users/dustinober/Projects/Crime Incidents Philadelphia"
python -c "
from dashboard.filters.crime_filters import (
    render_crime_filters, CrimeFilterState, get_filter_categories,
    get_crime_categories_from_data, read_crime_filters_from_url
)
# Test state creation
state = CrimeFilterState(
    categories=['Violent', 'Property'],
    crime_types=['Homicide - Criminal', 'Aggravated Assault Firearm'],
    select_all_types=False
)
cats = get_filter_categories(state)
assert cats == ['Violent', 'Property'], f'Expected [Violent, Property], got {cats}'
print('Crime filters: state creation OK')
# Test all categories
all_state = CrimeFilterState(
    categories=['Violent', 'Property', 'Other'],
    crime_types=None,
    select_all_types=True
)
assert len(all_state.categories) == 3
print('Crime filters: all categories OK')
print('Crime filters: module loaded successfully')
"
</verify>
```

Key implementation notes:
- UCR Categories: Violent (UCR 100-499), Property (UCR 500-799), Other (800+)
- Category selection cascades to crime type options
- Crime types from text_general_code column in source data
- Select all types toggle simplifies selecting all crime types in categories
- URL encoding: categories as comma-separated, crime_types as comma-separated
- When all categories selected or select_all_types=true, don't encode in URL (cleaner)
- Crime type options limited to those in selected categories and current data
- Reset button clears categories and crime_types from URL params
</action>
  <verify>
python -c "
from dashboard.filters.crime_filters import (
    CrimeFilterState, get_filter_categories, get_filter_crime_types,
    read_crime_filters_from_url, sync_crime_filters_to_url
)
import streamlit as st
class MockQP(dict):
    def __init__(self):
        super().__init__()
        self._data = {}
    def __getitem__(self, key):
        return self._data.get(key)
    def __setitem__(self, key, value):
        self._data[key] = value
    def __contains__(self, key):
        return key in self._data
    def __delitem__(self, key):
        if key in self._data:
            del self._data[key]
st.query_params = MockQP()
# Test state
state = CrimeFilterState(
    categories=['Violent'],
    crime_types=['Homicide - Criminal', 'Robbery Firearm'],
    select_all_types=False
)
cats = get_filter_categories(state)
assert cats == ['Violent'], f'Expected [Violent], got {cats}'
types = get_filter_crime_types(state)
assert types == ['Homicide - Criminal', 'Robbery Firearm'], f'Expected specific types, got {types}'
print('Crime filters verified')
"
</verify>
  <done>
CrimeFilterState NamedTuple defined with categories list, crime_types list, and select_all_types boolean

render_crime_filters() creates:
- Category multi-select (Violent, Property, Other)
- Select all crime types checkbox
- Crime type multi-select (when not select all)
- Reset button

read_crime_filters_from_url() parses comma-separated categories and crime_types from st.query_params

sync_crime_filters_to_url() writes crime filter state to st.query_params

get_crime_categories_from_data() extracts unique crime categories from DataFrame

get_crime_types_from_data() extracts unique crime types for selected categories

get_filter_categories() and get_filter_crime_types() convert state to filter values

Updated app.py imports and uses render_crime_filters(), displays active filter info
</done>
</task>

</tasks>

<verification>
After completion:
1. Verify module imports: `python -c "from dashboard.filters.crime_filters import render_crime_filters, CrimeFilterState, get_filter_categories"`
2. Verify CrimeFilterState works with categories and crime types
3. Verify app.py imports and uses crime filters: check for `render_crime_filters()` call
4. Test category extraction: `python -c "from dashboard.components.cache import load_crime_data; from dashboard.filters.crime_filters import get_crime_categories_from_data; df = load_crime_data(); print(get_crime_categories_from_data(df))"`
5. Verify URL params are updated when filters change
</verification>

<success_criteria>
Crime type filter controls render in sidebar with category multi-select and crime type multi-select. Selecting category updates available crime types. Select all types toggle shows/hides crime type selector. URL parameters update with filter selections. Summary info displays active category filters. Crime type options limited to selected categories.
</success_criteria>

<output>
After completion, create `.planning/phases/04-dashboard-foundation/04-05-SUMMARY.md`
</output>
