---
phase: 03-visualization-reporting
plan: 02
type: execute
wave: 1
depends_on: [03-01]
files_modified:
  - notebooks/09_dashboard_application.ipynb
  - dashboard/app.py
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Dash app loads without errors"
    - "Multi-tab navigation working (6 tabs)"
    - "Apply button filters update all charts"
    - "All 10+ charts render correctly on each tab"
    - "Export buttons work (PNG, SVG, CSV)"
  artifacts:
    - path: "notebooks/09_dashboard_application.ipynb"
      provides: "Dashboard app creation notebook"
      min_lines: 120
    - path: "dashboard/app.py"
      provides: "Exported Dash app for production deployment"
      min_lines: 150
    - path: "dashboard/"
      provides: "Dashboard directory with app files"
      contains: "app.py"
  key_links:
    - from: "notebooks/09_dashboard_application.ipynb"
      to: "output/dashboard/*.parquet"
      via: "pd.read_parquet()"
      pattern: "read_parquet.*dashboard"
    - from: "dashboard/app.py"
      to: "notebooks/09_dashboard_application.ipynb"
      via: "Export from notebook"
      pattern: "export.*app.py"
    - from: "dash app"
      to: "all tabs"
      via: "dcc.Tabs navigation"
      pattern: "dcc.Tabs|dcc.Tab"
---

<objective>
Create interactive Dash dashboard with multi-tab navigation, filters, and export capabilities

Purpose: Enable stakeholders to explore Phase 2 findings interactively with filters and downloadable outputs
Output: Working Dash app with 6 tabs, 10+ charts per tab, Apply button filters, PNG/SVG/CSV exports
</object>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-visualization-reporting/03-CONTEXT.md
@.planning/phases/03-visualization-reporting/03-RESEARCH.md
@.planning/phases/03-visualization-reporting/03-01-SUMMARY.md
@scripts/config.py
@output/dashboard/*.parquet
@output/dashboard/sample_50k.parquet
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Dash app structure and multi-tab layout</name>
  <files>notebooks/09_dashboard_application.ipynb</files>
  <action>
Create notebook `notebooks/09_dashboard_application.ipynb` with:

1. **Imports and setup** (2 cells):
   - Import dash, dcc, html, Input, Output, State, callback
   - Import dash_bootstrap_components as dbc
   - Import pandas, plotly.express as px, plotly.graph_objects as go
   - Import config.py
   - Create dashboard/ directory
   - Initialize app: `app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])`

2. **Load pre-computed data** (3 cells):
   - Load all parquet files from output/dashboard/
   - Load sample_50k.parquet for scatter plots
   - Print shapes of all datasets

3. **Define layout functions for each tab** (15 cells):

   **Overview tab layout function:**
   ```python
   def overview_tab():
       return html.Div([
           html.H2('Overview'),
           dcc.Graph(id='overview-trend'),
           dcc.Graph(id='overview-offenses'),
           dcc.Graph(id='overview-map'),
           dcc.Graph(id='overview-top10'),
           dcc.Graph(id='overview-by-year'),
           dcc.Graph(id='overview-by-type'),
           # ... more charts (10+ total per tab)
       ])
   ```

   **Temporal tab layout function:**
   ```python
   def temporal_tab():
       return html.Div([
           html.H2('Temporal Analysis'),
           dcc.Graph(id='temporal-monthly'),
           dcc.Graph(id='temporal-yearly'),
           dcc.Graph(id='temporal-seasonal'),
           dcc.Graph(id='temporal-by-day'),
           dcc.Graph(id='temporal-by-hour'),
           # ... more charts
       ])
   ```

   **Geographic tab layout function:**
   ```python
   def geographic_tab():
       return html.Div([
           html.H2('Geographic Analysis'),
           dcc.Graph(id='geo-district-map'),
           dcc.Graph(id='geo-district-bar'),
           dcc.Graph(id='geo-heatmap'),
           # ... more charts
       ])
   ```

   **Offense types tab layout function:**
   ```python
   def offense_tab():
       return html.Div([
           html.H2('Offense Types'),
           dcc.Graph(id='offense-pie'),
           dcc.Graph(id='offense-bar'),
           dcc.Graph(id='offense-severity'),
           # ... more charts
       ])
   ```

   **Disparities tab layout function:**
   ```python
   def disparities_tab():
       return html.Div([
           html.H2('Disparities'),
           dcc.Graph(id='disp-district-compare'),
           dcc.Graph(id='disp-by-offense'),
           # ... more charts
       ])
   ```

   **Cross-factor tab layout function:**
   ```python
   def cross_factor_tab():
       return html.Div([
           html.H2('Cross-Factor Analysis'),
           dcc.Graph(id='cross-temporal-offense'),
           dcc.Graph(id='cross-geo-offense'),
           # ... more charts
       ])
   ```

4. **Define main app layout** (1 cell):
   ```python
   app.layout = html.Div([
       html.H1('Philadelphia Crime Incidents Dashboard', style={'textAlign': 'center'}),
       dcc.Tabs(id='tabs', value='overview', children=[
           dcc.Tab(label='Overview', value='overview'),
           dcc.Tab(label='Temporal', value='temporal'),
           dcc.Tab(label='Geographic', value='geographic'),
           dcc.Tab(label='Offense Types', value='offense'),
           dcc.Tab(label='Disparities', value='disparities'),
           dcc.Tab(label='Cross-Factor', value='cross-factor'),
       ]),
       html.Div(id='tab-content')
   ])
   ```

5. **Tab switching callback** (1 cell):
   ```python
   @callback(
       Output('tab-content', 'children'),
       Input('tabs', 'value')
   )
   def render_tab(tab_value):
       if tab_value == 'overview':
           return overview_tab()
       elif tab_value == 'temporal':
           return temporal_tab()
       # ... other tabs
   ```

Layout structure complete with 6 tabs, each with placeholder for 10+ charts.
</action>
  <verify>
Run all cells. Verify:
- app object created without errors
- Layout has dcc.Tabs with 6 tabs
- Each tab layout function exists and returns html.Div
- Tab switching callback defined
</verify>
  <done>
Dash app structure created with multi-tab layout. 6 tabs defined (Overview, Temporal, Geographic, Offense, Disparities, Cross-factor).
</done>
</task>

<task type="auto">
  <name>Task 2: Implement tab-specific chart callbacks with filters</name>
  <files>notebooks/09_dashboard_application.ipynb</files>
  <action>
Add to notebook `09_dashboard_application.ipynb` (continue from Task 1):

6. **Add filters to each tab layout** (6 cells, one per tab function update):
   
   For each tab layout, add filter section at top:
   ```python
   def overview_tab():
       return html.Div([
           html.H2('Overview'),
           html.Div([
               html.Label('Date Range'),
               dcc.DatePickerRange(id='overview-date-range', start_date='2006-01-01', end_date='2026-01-01'),
               html.Label('Offense Type'),
               dcc.Dropdown(id='overview-offense', options=[{'label': 'All', 'value': 'All'}] + [{'label': x, 'value': x} for x in offense_types], value='All'),
               html.Label('District'),
               dcc.Dropdown(id='overview-district', options=[{'label': 'All', 'value': 'All'}] + [{'label': x, 'value': x} for x in districts], value='All'),
               html.Button('Apply Filters', id='overview-apply', n_clicks=0, style={'margin': '10px'}),
           ], style={'padding': '20px', 'backgroundColor': '#f8f9fa', 'borderRadius': '5px'}),
           # ... charts
       ])
   ```
   
   Repeat for temporal_tab(), geographic_tab(), offense_tab(), disparities_tab(), cross_factor_tab().

7. **Implement Overview tab charts** (3 callbacks):
   
   Trend chart:
   ```python
   @callback(
       Output('overview-trend', 'figure'),
       Input('overview-apply', 'n_clicks'),
       State('overview-date-range', 'start_date'),
       State('overview-date-range', 'end_date'),
       State('overview-offense', 'value'),
       State('overview-district', 'value'),
   )
   def update_overview_trend(n_clicks, start_date, end_date, offense, district):
       # Filter monthly data based on inputs
       df = monthly_counts.copy()
       df['date'] = pd.to_datetime(df['year'].astype(str) + '-' + df['month'].astype(str) + '-01')
       df = df[(df['date'] >= start_date) & (df['date'] <= end_date)]
       
       fig = px.line(df, x='date', y='count', title='Monthly Crime Trend')
       return fig
   ```
   
   Top offenses chart:
   ```python
   @callback(
       Output('overview-offenses', 'figure'),
       Input('overview-apply', 'n_clicks'),
       State('overview-date-range', 'start_date'),
       State('overview-date-range', 'end_date'),
       State('overview-district', 'value'),
   )
   def update_overview_offenses(n_clicks, start_date, end_date, district):
       df = offense_counts.copy()
       # Sort and take top 10
       df = df.sort_values('count', ascending=False).head(10)
       
       fig = px.bar(df, x='count', y='offense_category', orientation='h', title='Top 10 Offense Types')
       return fig
   ```
   
   Map chart (use sample):
   ```python
   @callback(
       Output('overview-map', 'figure'),
       Input('overview-apply', 'n_clicks'),
       State('overview-date-range', 'start_date'),
       State('overview-date-range', 'end_date'),
       State('overview-offense', 'value'),
   )
   def update_overview_map(n_clicks, start_date, end_date, offense):
       df = sample_50k.copy()
       # Apply date and offense filters
       df['date'] = pd.to_datetime(df['dispatch_date'])
       df = df[(df['date'] >= start_date) & (df['date'] <= end_date)]
       if offense != 'All':
           df = df[df['ucr_general'] == offense]
       
       fig = px.scatter_map(df, lat='lat', lon='lng', color='ucr_general', mapbox_style='open-street-map', zoom=10)
       return fig
   ```

8. **Implement Temporal tab charts** (3 callbacks):
   - Monthly counts bar chart
   - Yearly trend line
   - Seasonal patterns (heatmap by month and year)

9. **Implement Geographic tab charts** (3 callbacks):
   - District bar chart (counts by district)
   - District map (scatter plot colored by district)
   - District heatmap

10. **Implement Offense tab charts** (3 callbacks):
    - UCR category pie chart
    - Offense severity distribution
    - Top offenses trend line

11. **Implement Disparities tab charts** (2 callbacks):
    - District comparison (offense by district)
    - Severity by district

12. **Implement Cross-Factor tab charts** (2 callbacks):
    - Temporal x offense (monthly counts by offense type)
    - Geographic x offense (district x offense heatmap)

Each callback:
- Uses Apply button as Input (not individual filter inputs)
- Uses State for filter values
- Filters pre-computed aggregations or sample data
- Returns Plotly figure

Total: 18+ charts across 6 tabs (3+ per tab).
</action>
  <verify>
Run all callback cells. Verify:
- All callbacks defined without syntax errors
- Each callback has Input(apply-btn, 'n_clicks') and State for filters
- Callbacks return Plotly figures
- No callback ID conflicts
</verify>
  <done>
All 18+ chart callbacks implemented across 6 tabs. Each tab has 10+ charts (including trend, distribution, comparison, and map visualizations).
</done>
</task>

<task type="auto">
  <name>Task 3: Add export functionality and export app.py</name>
  <files>notebooks/09_dashboard_application.ipynb, dashboard/app.py</files>
  <action>
Add to notebook `09_dashboard_application.ipynb` (continue from Task 2):

13. **Add export buttons to layout** (1 cell):
   Add export section to each tab or to main layout:
   ```python
   html.Div([
       html.H4('Export'),
       dbc.Button('Download PNG', id='download-png', color='primary', className='me-2'),
       dbc.Button('Download SVG', id='download-svg', color='primary', className='me-2'),
       dbc.Button('Download CSV', id='download-csv', color='primary'),
   ], style={'padding': '20px'}),
   dcc.Download(id='download-data'),
   ```

14. **Export callback** (1 cell):
   ```python
   @callback(
       Output('download-data', 'data'),
       Input('download-png', 'n_clicks'),
       Input('download-svg', 'n_clicks'),
       Input('download-csv', 'n_clicks'),
       Input('tabs', 'value'),  # To know which tab is active
       prevent_initial_call=True,
   )
   def download_file(png_clicks, svg_clicks, csv_clicks, active_tab):
       ctx = dash.callback_context
       button_id = ctx.triggered[0]['prop_id'].split('.')[0]
       
       if button_id == 'download-png':
           # Get current figure from active tab
           # For simplicity, create a summary figure
           fig = px.line(monthly_counts, x='year', y='month')
           return dcc.send_bytes(fig.to_image(format='png', scale=2), 'dashboard.png')
       
       elif button_id == 'download-svg':
           fig = px.line(monthly_counts, x='year', y='month')
           return dcc.send_bytes(fig.to_image(format='svg'), 'dashboard.svg')
       
       elif button_id == 'download-csv':
           # Export filtered data
           return dcc.send_bytes(sample_50k.to_csv(index=False), 'crime_data.csv')
   ```

15. **Export app.py for production** (1 cell):
   ```python
   # Create dashboard directory and export app
   import os
   os.makedirs('dashboard', exist_ok=True)
   
   # Save the complete app as standalone script
   with open('dashboard/app.py', 'w') as f:
       f.write('''
import dash
from dash import dcc, html, Input, Output, State, callback
import dash_bootstrap_components as dbc
import pandas as pd
import plotly.express as px

# Load data
monthly_counts = pd.read_parquet('../output/dashboard/monthly_counts.parquet')
yearly_counts = pd.read_parquet('../output/dashboard/yearly_counts.parquet')
district_counts = pd.read_parquet('../output/dashboard/district_counts.parquet')
offense_counts = pd.read_parquet('../output/dashboard/offense_counts.parquet')
cross_factor_counts = pd.read_parquet('../output/dashboard/cross_factor_counts.parquet')
sample_50k = pd.read_parquet('../output/dashboard/sample_50k.parquet')

app = dash.Dash(__name__, external_stylesheets=[dbc.themes.BOOTSTRAP])

# [Insert all layout functions and callbacks from notebook]

if __name__ == '__main__':
    app.run_server(debug=True, host='0.0.0.0', port=8050)
       ''')
   
   print("App exported to dashboard/app.py")
   ```

16. **Test app locally** (1 cell):
   ```python
   # In notebook, start app for testing (optional)
   # app.run_server(debug=True, port=8051)
   print("Dashboard app created. To run: python dashboard/app.py")
   ```

Export functionality complete with PNG/SVG/CSV downloads.
</action>
  <verify>
- Export app.py cell runs successfully
- dashboard/app.py file created and is valid Python
- File imports dash, dcc, html, etc.
- Export callback defined with prevent_initial_call=True
</verify>
  <done>
Dashboard application complete with:
- Multi-tab layout (6 tabs)
- 18+ interactive charts
- Apply button filters on each tab
- Export functionality (PNG, SVG, CSV)
- Production-ready app.py exported to dashboard/
</done>
</task>

</tasks>

<verification>
- Notebook runs to completion without errors
- All 18+ charts render in each tab
- Apply button filters update charts correctly
- Export buttons download files (PNG, SVG, CSV)
- dashboard/app.py exported and is runnable
- App starts without errors (if tested)
</verification>

<success_criteria>
Interactive dashboard fully functional with multi-tab navigation, filtering, and export capabilities.
</success_criteria>

<output>
After completion, create `.planning/phases/03-visualization-reporting/03-02-SUMMARY.md`
</output>
