# Plan 02-01: Infrastructure & Boundary Data

**Phase:** 2 â€” Spatial & Socioeconomic Analysis
**Wave:** 1 (Infrastructure)
**Requirement:** Foundation for PATROL-01, PATROL-02, PATROL-03, HYP-SOCIO

## Goal

Set up spatial infrastructure: boundary data, config extensions, and utility functions for Phase 2 notebooks.

## Context

Phase 2 requires:
- Police district boundaries for choropleth maps (PATROL-03)
- Census tract boundaries with population data (HYP-SOCIO)
- Spatial utility functions for coordinate cleaning and joins
- Config extension for clustering parameters and severity weights

## Tasks

### 1. Download & Cache Boundary Data

**1.1 Police District Boundaries**
- Source: OpenDataPhilly Police Districts GeoJSON
- Primary URL: `https://opendata.arcgis.com/datasets/62ec63afb8824a15953399b1fa819df2_0.geojson`
- Fallback URL: `https://phl.carto.com/api/v2/sql?q=SELECT+*+FROM+police_districts&format=geojson`
- Save to: `data/boundaries/police_districts.geojson`
- Validate: 25 districts match `dc_dist` values in crime data
- Error handling: Try primary URL first, on failure (HTTP 4xx/5xx or timeout) try fallback, log which source used

**1.2 Census Tract Boundaries with Population**
- Source: Census Bureau TIGER/Line + ACS 2020 population
- Primary: Census Bureau API for ACS 2020 5-year estimates
- Fallback: Census Reporter pre-joined GeoJSON
- Option A: Pre-joined GeoJSON from Census Reporter
- Option B: Download tracts + join ACS B01003_001E (total population)
- Save to: `data/boundaries/census_tracts_pop.geojson`
- Validate:
  - Tracts cover Philadelphia county (FIPS 42101)
  - Expected tract count: ~384 tracts (Philadelphia has 384 census tracts per 2020 Census)
  - Population range: Each tract should have 0-15,000 residents (typical range)
  - Total population sum: Should be ~1.6M (Philadelphia 2020 Census population)
- Error handling: Try Census API first, on failure try Census Reporter, log source used

### 2. Extend Configuration

**2.1 Create `config/phase2_config.yaml`**
```yaml
# Phase 2: Spatial & Socioeconomic Analysis
version: "1.0"

clustering:
  eps_degrees: 0.002  # ~220m at Philadelphia latitude
  min_samples: 50
  algorithm: "DBSCAN"

severity_weights:
  # UCR code -> weight (FBI severity-based)
  100: 10.0  # Homicide
  200: 8.0   # Rape
  300: 6.0   # Robbery
  400: 5.0   # Aggravated Assault
  500: 3.0   # Burglary
  600: 1.0   # Theft
  700: 2.0   # Vehicle Theft
  800: 4.0   # Arson
  900: 0.5   # Other

heatmap:
  robbery_ucr_range: [300, 400]  # UCR codes for robbery
  hours: [0, 23]
  days: ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"]

census:
  population_column: "total_pop"
  rate_per: 100000  # FBI UCR convention (per 100,000 residents)
  min_population: 100  # Tracts below this flagged as unreliable
```

**2.2 Create `analysis/phase2_config_loader.py`**
- Load phase2_config.yaml
- Expose Phase2Config dataclass

### 3. Create Spatial Utilities

**3.1 Create `analysis/spatial_utils.py`**
```python
def clean_coordinates(df, x_col='point_x', y_col='point_y'):
    """Filter to valid WGS84 coordinates for Philadelphia."""
    pass

def load_boundaries(name: str) -> gpd.GeoDataFrame:
    """Load cached boundary file by name (police_districts, census_tracts)."""
    pass

def spatial_join_districts(df, district_gdf):
    """Join crime points to district polygons."""
    pass

def spatial_join_tracts(df, tract_gdf):
    """Join crime points to census tract polygons."""
    pass

def calculate_severity_score(df, weights: dict) -> pd.Series:
    """Calculate weighted severity score per record."""
    pass
```

### 4. Download Script

**4.1 Create `scripts/download_boundaries.py`**
- Download police districts GeoJSON
- Download census tracts with population
- Validate and cache to `data/boundaries/`
- Idempotent: skip if already exists

## Validation Criteria

- [ ] `data/boundaries/police_districts.geojson` exists with 25 districts
- [ ] `data/boundaries/census_tracts_pop.geojson` exists with ~384 Philadelphia census tracts (FIPS 42101)
- [ ] Census tract population column present with sum ~1.6M (Philadelphia 2020 Census)
- [ ] Census tract population values in valid range (0-15,000 per tract)
- [ ] `config/phase2_config.yaml` loads without error
- [ ] `analysis/spatial_utils.py` functions work on sample data
- [ ] Unit tests pass for coordinate cleaning
- [ ] Download script logs which URL source was used (primary vs fallback)

## Dependencies

- geopandas (installed)
- requests (for downloads)
- Phase 1 infrastructure (analysis/config.py, analysis/utils.py)

## Estimated Time

- Boundary downloads: 10 min
- Config extension: 15 min
- Spatial utilities: 30 min
- Testing: 15 min
- **Total: ~70 min**

---
*Plan created: 2026-02-03*
