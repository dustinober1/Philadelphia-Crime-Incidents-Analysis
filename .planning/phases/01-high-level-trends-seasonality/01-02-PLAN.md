---
wave: 2
depends_on: ["01-01"]
files_modified:
  - notebooks/philadelphia_safety_trend_analysis.ipynb
autonomous: true
---

# Plan 01-02: Annual Trends Notebook (CHIEF-01)

<objective>
Refactor the Annual Crime Trends notebook (CHIEF-01) to use external configuration, generate versioned artifacts, and produce academic-style reports.

This notebook answers: "Is Philadelphia actually getting safer?" by analyzing annual crime aggregation for the last 10 years (2015-2024) with Violent vs Property crime comparison.

Requirement Coverage: CHIEF-01 - Annual aggregation of crime counts for the last 10 years and trend line comparing Violent vs Property crimes
</objective>

<tasks>

<task id="1" type="code">
<name>Refactor Data Loading and Configuration</name>
<what>Replace hardcoded parameters with config-driven approach and update data loading to use shared utilities.</what>
<how>
1. Add config loading cell at notebook top:
   ```python
   from analysis.config_loader import Phase1Config
   from analysis.utils import load_data, classify_crime_category, extract_temporal_features

   config = Phase1Config()
   params = config.get_notebook_params('annual_trend')
   START_YEAR = params['start_year']  # 2015
   END_YEAR = params['end_year']      # 2024
   VERSION = config.version           # v1.0
   ```
2. Add papermill parameter cell with tag "parameters":
   ```python
   # Parameters (injected by papermill)
   VERSION = "v1.0"
   START_YEAR = 2015
   END_YEAR = 2024
   FAST_MODE = False
   ```
3. Replace all hardcoded data loading with `load_data()` from utils
4. Filter to exclude 2026 data explicitly: `df = df[df['year'] <= END_YEAR]`
5. Add reproducibility cell documenting Python version, key packages, execution date
6. If FAST_MODE, sample data to 10%: `df = df.sample(frac=0.1, random_state=42)`
</how>
<files>
- notebooks/philadelphia_safety_trend_analysis.ipynb
</files>
<verify>
```bash
cd notebooks && python -c "
import nbformat
nb = nbformat.read('philadelphia_safety_trend_analysis.ipynb', as_version=4)
code = ' '.join([c.source for c in nb.cells if c.cell_type == 'code'])
assert 'Phase1Config' in code or 'config_loader' in code, 'Missing config import'
assert 'load_data' in code, 'Missing load_data import'
print('Config integration verified')
"
```
</verify>
</task>

<task id="2" type="code">
<name>Restructure to Academic Report Format</name>
<what>Reorganize notebook sections to match academic style: Summary, Methods, Findings, Limitations.</what>
<how>
1. Add "Summary" markdown cell at top (after setup):
   - Brief executive summary (1-2 paragraphs) answering "Is Philadelphia getting safer?"
   - Key findings preview: peak year, current trend, percent change
2. Create "Methods" section with markdown cells documenting:
   - Data source: Philadelphia Police Department crime incidents
   - Date range: 2015-2024 (10 complete years)
   - Classification logic: UCR codes -> Violent/Property/Other
   - Statistical approach: Linear regression for trend analysis
3. Add "Assumptions" subsection:
   - Assumption 1: UCR codes consistently applied across years
   - Assumption 2: Reporting completeness stable over time
   - Assumption 3: Crime classification follows FBI UCR definitions
4. Organize existing analysis cells under "Findings" section headers
5. Add "Limitations" section at end:
   - 2026 data excluded (only 20 days available)
   - Reporting delays may affect recent months
   - Classification changes over time not captured
6. Add "Data Quality Summary" section with quality table
7. Include generation timestamp in title: `# Annual Crime Trends Analysis\n*Generated: {datetime.now()}*`
</how>
<files>
- notebooks/philadelphia_safety_trend_analysis.ipynb
</files>
<verify>
```bash
cd notebooks && python -c "
import nbformat
nb = nbformat.read('philadelphia_safety_trend_analysis.ipynb', as_version=4)
md = ' '.join([c.source for c in nb.cells if c.cell_type == 'markdown'])
assert 'Summary' in md, 'Missing Summary section'
assert 'Methods' in md, 'Missing Methods section'
assert 'Limitations' in md, 'Missing Limitations section'
print('Academic format verified')
"
```
</verify>
</task>

<task id="3" type="code">
<name>Enhance Visualizations</name>
<what>Upgrade visualizations to publication quality with heavy annotations, colorblind-safe palette, and 300 DPI.</what>
<how>
1. Import colors from config: `from analysis.config import COLORS`
2. Update color palette in all plots to use `COLORS['violent']`, `COLORS['property']`, `COLORS['other']`
3. Enhance annual trend chart with annotations:
   - Peak year marker with value: "Peak: 182,543 (2017)"
   - Recent minimum with value: "2024: 145,231"
   - Trend line with slope and p-value: "Trend: -2,500 crimes/year (p < 0.001)"
   - COVID lockdown vertical line at March 2020
4. Add consistent styling:
   - `fig.savefig(..., dpi=300, bbox_inches='tight')`
   - Title font size: 16, labels: 12, annotations: 10
   - Add timestamp to figure subtitles
5. Enhance Violent vs Property comparison chart:
   - Dual y-axis or stacked area chart
   - Clear legend with crime counts
   - Annotate divergence points
</how>
<files>
- notebooks/philadelphia_safety_trend_analysis.ipynb
</files>
<verify>
```bash
cd notebooks && python -c "
import nbformat
nb = nbformat.read('philadelphia_safety_trend_analysis.ipynb', as_version=4)
code = ' '.join([c.source for c in nb.cells if c.cell_type == 'code'])
assert 'dpi=300' in code or 'dpi = 300' in code, 'Missing 300 DPI setting'
assert 'COLORS' in code, 'Missing COLORS import'
print('Visualization settings verified')
"
```
</verify>
</task>

<task id="4" type="code">
<name>Implement Versioned Artifact Generation</name>
<what>Update all save operations to use versioned filenames and generate manifest.</what>
<how>
1. Import artifact functions:
   ```python
   from analysis.artifact_manager import get_versioned_path, create_version_manifest, save_manifest
   from analysis.config import REPORTS_DIR
   ```
2. Update figure saves to use versioned paths:
   ```python
   fig_path = REPORTS_DIR / get_versioned_path('annual_trend_{version}.png', VERSION)
   fig.savefig(fig_path, dpi=300, bbox_inches='tight')
   artifacts.append(fig_path)
   ```
3. Generate markdown report using template:
   ```python
   from analysis.report_utils import render_report_template
   context = {
       'title': 'Annual Crime Trends Analysis',
       'summary': summary_text,
       'findings': findings_text,
       ...
   }
   report = render_report_template(template_path, context)
   report_path = REPORTS_DIR / f'annual_trend_report_{VERSION}.md'
   report_path.write_text(report)
   ```
4. Final cell: create and save manifest
   ```python
   manifest = create_version_manifest(VERSION, artifacts, params, runtime)
   save_manifest(manifest, REPORTS_DIR / f'annual_trend_manifest_{VERSION}.json')
   ```
</how>
<files>
- notebooks/philadelphia_safety_trend_analysis.ipynb
</files>
<verify>
```bash
ls reports/annual_trend_*.png 2>/dev/null && echo "PNG artifacts exist"
ls reports/annual_trend_*.md 2>/dev/null && echo "Report exists"
```
</verify>
</task>

<task id="5" type="code">
<name>Add Data Quality Analysis Cell</name>
<what>Create explicit data quality summary using shared utilities.</what>
<how>
1. Add cell that generates quality summary:
   ```python
   from analysis.report_utils import generate_data_quality_summary, format_data_quality_table

   quality = generate_data_quality_summary(df)
   print("### Data Quality Summary")
   print(format_data_quality_table(quality))
   ```
2. Display key metrics:
   - Total records analyzed
   - Date range covered
   - Missing dispatch_date count
   - Records excluded (2026, nulls)
   - Year distribution (verify no gaps)
3. Add interpretation notes:
   - "2026 excluded: only 7,543 records (partial year)"
   - "No missing years in analysis range"
4. Store quality dict for inclusion in final report
</how>
<files>
- notebooks/philadelphia_safety_trend_analysis.ipynb
</files>
<verify>
```bash
cd notebooks && python -c "
import nbformat
nb = nbformat.read('philadelphia_safety_trend_analysis.ipynb', as_version=4)
code = ' '.join([c.source for c in nb.cells if c.cell_type == 'code'])
assert 'generate_data_quality_summary' in code or 'data quality' in code.lower(), 'Missing data quality analysis'
print('Data quality cell verified')
"
```
</verify>
</task>

<task id="6" type="code">
<name>Test Headless Execution</name>
<what>Verify notebook runs successfully via papermill with parameter injection.</what>
<how>
1. Add try/except blocks around critical operations (file loading, saving)
2. Test papermill execution:
   ```bash
   cd notebooks
   papermill philadelphia_safety_trend_analysis.ipynb /tmp/output.ipynb \
     -p VERSION "v1.0" \
     -p START_YEAR 2015 \
     -p END_YEAR 2024 \
     --timeout 600
   ```
3. Verify parameters are properly injected
4. Check all artifacts generated in reports/
5. Test fast mode:
   ```bash
   papermill philadelphia_safety_trend_analysis.ipynb /tmp/output.ipynb \
     -p FAST_MODE true \
     --timeout 120
   ```
6. Ensure fast mode completes in < 30 seconds
</how>
<files>
- notebooks/philadelphia_safety_trend_analysis.ipynb
</files>
<verify>
```bash
cd notebooks && papermill philadelphia_safety_trend_analysis.ipynb /tmp/test_annual.ipynb -p FAST_MODE true --timeout 120 && echo "Headless execution successful"
```
</verify>
</task>

</tasks>

<must_haves>
- [ ] No hardcoded years/dates in code cells (all from config or parameters)
- [ ] Parameter cell has `parameters` tag for papermill injection
- [ ] Notebook has Summary, Methods, Findings, Limitations sections
- [ ] All figures saved at 300 DPI with versioned filenames
- [ ] Color palette uses colorblind-safe COLORS from config
- [ ] Annual trend chart has annotations: peak year, minimum, trend line stats, COVID marker
- [ ] Markdown report generated with version in filename
- [ ] Manifest JSON created with artifact hashes
- [ ] Data quality summary table included
- [ ] Papermill headless execution completes without errors
</must_haves>

<deliverables>
- Refactored notebooks/philadelphia_safety_trend_analysis.ipynb
- reports/annual_trend_v1.0.png
- reports/violent_vs_property_v1.0.png (if separate)
- reports/annual_trend_report_v1.0.md
- reports/annual_trend_manifest_v1.0.json
</deliverables>
