---
phase: 13-pipeline-and-supporting-tests
plan: 07
type: execute
wave: 3
depends_on: [13-01, 13-02, 13-03, 13-04, 13-05, 13-06]
files_modified:
  - .planning/phases/13-pipeline-and-supporting-tests/13-07-SUMMARY.md
autonomous: true

must_haves:
  truths:
    - Overall coverage reaches 95%+ across entire Python codebase
    - Coverage report generated in HTML and JSON formats
    - All pipeline modules tested (export, refresh)
    - All configuration modules tested (settings, schemas)
    - All visualization modules tested (plots, helpers, style)
  artifacts:
    - path: coverage.json
      provides: Machine-readable coverage data
    - path: htmlcov/
      provides: HTML coverage report
    - path: .planning/phases/13-pipeline-and-supporting-tests/13-07-SUMMARY.md
      provides: Phase 13 completion summary
  key_links:
    - from: pytest coverage run
      to: coverage.json, htmlcov/
      via: pytest-cov plugin
      pattern: "pytest --cov.*--cov-report"
---

<objective>
Generate final coverage report for Phase 13 and verify 95%+ overall coverage milestone is achieved. Produce HTML and JSON coverage reports and document remaining gaps.

Purpose: Validate SUPP-04 requirement (95%+ overall coverage) and close Phase 13.

Output: Comprehensive coverage report and Phase 13 summary documenting achievement of 95% milestone.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-pipeline-and-supporting-tests/13-RESEARCH.md
@.planning/milestones/v1.3-ROADMAP.md
@.planning/REQUIREMENTS.md

# Prior Phase Decisions
- Use pytest --cov for coverage measurement
- Generate both HTML (htmlcov/) and JSON (coverage.json) reports
- Run with -o addopts='' to disable xdist during coverage measurement
</context>

<tasks>

<task type="auto">
  <name>Task 1: Run full test suite with coverage</name>
  <files>coverage.json, htmlcov/</files>
  <action>Run complete test suite with coverage measurement:
  1. Clean previous coverage: rm -f coverage.json .coverage && rm -rf htmlcov/
  2. Run tests with coverage: pytest -o addopts='' --cov=analysis --cov=api --cov=pipeline --cov-report=term-missing --cov-report=html --cov-report=json
  3. Capture terminal output showing overall coverage percentage

This runs all tests without xdist (which can cause coverage issues) and generates terminal, HTML, and JSON reports. The --cov flags cover analysis/, api/, and pipeline/ directories.</action>
  <verify>cat coverage.json | jq '.totals.percent_covered'</verify>
  <done>Coverage report generated with overall percentage. HTML report available in htmlcov/ directory.</done>
</task>

<task type="auto">
  <name>Task 2: Verify pipeline module coverage</name>
  <files>coverage.json</files>
  <action>Check coverage for pipeline modules:
  1. Parse coverage.json for pipeline/export_data.py percentage
  2. Parse coverage.json for pipeline/refresh_data.py percentage
  3. Verify both exceed 90% coverage

Use jq or Python to extract coverage percentages from coverage.json. Document any uncovered lines.</action>
  <verify>jq '.files."pipeline/export_data.py".summary.percent_covered' coverage.json</verify>
  <done>Pipeline module coverage documented. Both modules exceed 90% target.</done>
</task>

<task type="auto">
  <name>Task 3: Verify configuration module coverage</name>
  <files>coverage.json</files>
  <action>Check coverage for configuration modules:
  1. Parse coverage.json for analysis/config/settings.py percentage
  2. Parse coverage.json for analysis/config/schemas/ combined percentage
  3. Verify both exceed 90% coverage

Extract per-file coverage from coverage.json. Check chief.py, patrol.py, policy.py, forecasting.py individually if needed.</action>
  <verify>jq '.files | keys | map(select(startswith("analysis/config")))' coverage.json</verify>
  <done>Configuration module coverage documented. All modules exceed 90% target.</done>
</task>

<task type="auto">
  <name>Task 4: Verify visualization module coverage</name>
  <files>coverage.json</files>
  <action>Check coverage for visualization modules:
  1. Parse coverage.json for analysis/visualization/plots.py percentage
  2. Parse coverage.json for analysis/visualization/helpers.py percentage
  3. Parse coverage.json for analysis/visualization/style.py percentage
  4. Parse coverage.json for analysis/visualization/forecast_plots.py percentage
  5. Verify most exceed 85% (forecast_plots may have lower coverage due to optional dependencies)

Extract coverage percentages and document any gaps. Note that shap-dependent functions may be excluded.</action>
  <verify>jq '.files | keys | map(select(startswith("analysis/visualization")))' coverage.json</verify>
  <done>Visualization module coverage documented. Most modules exceed 85% target.</done>
</task>

<task type="auto">
  <name>Task 5: Calculate overall coverage percentage</name>
  <files>coverage.json</files>
  <action>Calculate and verify overall coverage:
  1. Extract totals.percent_covered from coverage.json
  2. Verify coverage exceeds 95% threshold
  3. If below 95%, identify modules needing additional tests

Use jq '.totals.percent_covered' to get overall percentage. Compare against 95% target.</action>
  <verify>jq '.totals.percent_covered' coverage.json | awk '{print $1 >= 95}'</verify>
  <done>Overall coverage calculated and verified against 95% target.</done>
</task>

<task type="auto">
  <name>Task 6: Identify and document any remaining gaps</name>
  <files>.planning/phases/13-pipeline-and-supporting-tests/13-07-SUMMARY.md</files>
  <action>Analyze coverage report for remaining gaps:
  1. List modules below 95% coverage
  2. Identify uncovered lines and rationale for exclusion
  3. Document any truly uncovered code paths requiring future work
  4. Check if missing lines are in:
      - Optional dependency branches (HAS_GEOPANDAS, HAS_PROPHET)
      - Defensive error handling unlikely to trigger
      - Debug/development code
      - CLI entry points excluded by coverage.omit

Generate a gap analysis table showing module, coverage %, and notes on exclusions.</action>
  <verify>cat .planning/phases/13-pipeline-and-supporting-tests/13-07-SUMMARY.md</verify>
  <done>Gap analysis complete. Remaining uncovered lines documented with rationale.</done>
</task>

<task type="auto">
  <name>Task 7: Generate Phase 13 summary document</name>
  <files>.planning/phases/13-pipeline-and-supporting-tests/13-07-SUMMARY.md</files>
  <action>Create comprehensive Phase 13 summary:
  1. Document total tests added across all plans
  2. Report coverage achieved for each module category
  3. List all new test files created
  4. Document execution time for full test suite
  5. Record overall coverage percentage
  6. Note any modules excluded from coverage targets
  7. List any remaining work for future phases

Create markdown summary with sections for Test Statistics, Coverage Breakdown, Remaining Gaps, and Next Steps.</action>
  <verify>head -50 .planning/phases/13-pipeline-and-supporting-tests/13-07-SUMMARY.md</verify>
  <done>Phase 13 summary created with all test statistics and coverage data.</done>
</task>

</tasks>

<verification>
Run complete coverage report: pytest -o addopts='' --cov=analysis --cov=api --cov=pipeline --cov-report=term-missing --cov-report=html --cov-report=json -v

Verify:
1. Overall coverage exceeds 95%
2. All Phase 13 modules tested
3. HTML report generated in htmlcov/
4. JSON report at coverage.json
5. Summary document created
</verification>

<success_criteria>
1. Overall coverage: 95%+ across analysis/, api/, pipeline/
2. Pipeline modules: 90%+ coverage
3. Configuration modules: 90%+ coverage
4. Visualization modules: 85%+ coverage
5. HTML coverage report generated
6. JSON coverage report generated
7. Phase 13 summary document complete
</success_criteria>

<output>
After completion, create `.planning/phases/13-pipeline-and-supporting-tests/13-07-SUMMARY.md` with:
- Total tests added in Phase 13
- Coverage achieved per module category
- Overall coverage percentage
- List of new test files
- Remaining gaps and rationale
- Recommendation for Phase 14 (Cleanup)
</output>
