---
phase: 13-pipeline-and-supporting-tests
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - tests/test_config_settings.py
autonomous: true

must_haves:
  truths:
    - GlobalConfig loads with correct defaults
    - GlobalConfig loads from YAML configuration files
    - Environment variables override YAML and defaults
    - Configuration validation enforces constraints (DPI range, output_format pattern)
  artifacts:
    - path: tests/test_config_settings.py
      provides: Configuration settings tests
      min_lines: 150
    - path: analysis/config/settings.py
      provides: GlobalConfig and BaseConfig classes under test
  key_links:
    - from: tests/test_config_settings.py
      to: analysis/config/settings.py
      via: Direct imports and tmp_path for isolated YAML files
      pattern: "from analysis.config.settings import"
---

<objective>
Create tests for analysis/config/settings.py validating GlobalConfig and BaseConfig classes. Test default values, YAML loading, environment variable overrides, and field validation.

Purpose: Achieve comprehensive coverage of configuration settings module (SUPP-01 requirement).

Output: New test_config_settings.py with 15+ tests covering pydantic-settings configuration.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/13-pipeline-and-supporting-tests/13-RESEARCH.md
@.planning/milestones/v1.3-ROADMAP.md
@.planning/REQUIREMENTS.md

# Prior Phase Decisions
- Use tmp_path and monkeypatch.chdir for isolated config file testing
- Mock environment variables with monkeypatch.setenv
- Test pydantic validation with pytest.raises(Exception) for ValidationError
</context>

<tasks>

<task type="auto">
  <name>Task 1: Test GlobalConfig default values</name>
  <files>tests/test_config_settings.py</files>
  <action>Create tests/test_config_settings.py and add default value tests:
  1. test_global_config_defaults_output_dir - Verify output_dir defaults to repo_root/"reports"
  2. test_global_config_defaults_dpi - Verify dpi defaults to 300
  3. test_global_config_defaults_output_format - Verify output_format defaults to "png"
  4. test_global_config_defaults_fast_sample_frac - Verify fast_sample_frac defaults to 0.1
  5. test_global_config_defaults_cache_enabled - Verify cache_enabled defaults to True
  6. test_global_config_defaults_log_level - Verify log_level defaults to "INFO"
  7. test_global_config_defaults_crime_data_path - Verify crime_data_path points to data/crime_incidents_combined.parquet
  8. test_global_config_defaults_boundaries_dir - Verify boundaries_dir points to data/boundaries

Import GlobalConfig from analysis.config.settings. Instantiate without arguments and verify all defaults match expected values. Use Path object comparison for paths.</action>
  <verify>pytest tests/test_config_settings.py -k "global_config_defaults" -v</verify>
  <done>All 8 default value tests pass, validating GlobalConfig initial state.</done>
</task>

<task type="auto">
  <name>Task 2: Test BaseConfig default values</name>
  <files>tests/test_config_settings.py</files>
  <action>Add BaseConfig default value tests:
  1. test_base_config_defaults_output_dir - Verify output_dir defaults correctly
  2. test_base_config_defaults_dpi - Verify dpi defaults to 300
  3. test_base_config_defaults_output_format - Verify output_format defaults to "png"
  4. test_base_config_defaults_fast_sample_frac - Verify fast_sample_frac defaults to 0.1
  5. test_base_config_defaults_cache_enabled - Verify cache_enabled defaults to True
  6. test_base_config_defaults_log_level - Verify log_level defaults to "INFO"
  7. test_base_config_defaults_version - Verify version defaults to "v1.0"

Import BaseConfig from analysis.config.settings. Instantiate without arguments and verify defaults.</action>
  <verify>pytest tests/test_config_settings.py -k "base_config_defaults" -v</verify>
  <done>All 7 BaseConfig default tests pass, validating inherited configuration.</done>
</task>

<task type="auto">
  <name>Task 3: Test GlobalConfig from YAML file</name>
  <files>tests/test_config_settings.py</files>
  <action>Add YAML loading tests:
  1. test_global_config_loads_from_yaml - Create global.yaml in tmp_path, verify values loaded
  2. test_global_config_yaml_overrides_defaults - Verify YAML values override defaults
  3. test_global_config_missing_yaml_uses_defaults - Verify no error when YAML missing (uses defaults)
  4. test_global_config_yaml_partial_config - Verify partial YAML uses defaults for unspecified fields

Use tmp_path and monkeypatch.chdir to isolate config files. Create YAML files with yaml.dump() containing config values. Instantiate GlobalConfig and verify loaded values.</action>
  <verify>pytest tests/test_config_settings.py -k "yaml" -v</verify>
  <done>All 4 YAML loading tests pass, validating configuration file parsing.</done>
</task>

<task type="auto">
  <name>Task 4: Test environment variable overrides</name>
  <files>tests/test_config_settings.py</files>
  <action>Add environment variable override tests:
  1. test_global_config_env_override_output_dir - Verify CRIME_OUTPUT_DIR overrides YAML and default
  2. test_global_config_env_override_dpi - Verify CRIME_DPI overrides other sources
  3. test_global_config_env_override_output_format - Verify CRIME_OUTPUT_FORMAT overrides
  4. test_global_config_env_override_fast_sample_frac - Verify CRIME_FAST_SAMPLE_FRAC overrides
  5. test_global_config_env_override_cache_enabled - Verify CRIME_CACHE_ENABLED overrides (boolean parsing)
  6. test_global_config_env_override_log_level - Verify CRIME_LOG_LEVEL overrides
  7. test_base_config_env_overrides_work - Verify env vars work for BaseConfig too

Use monkeypatch.setenv to set environment variables before instantiating config. Verify env vars take highest priority (override YAML and defaults). Note: pydantic-settings handles boolean parsing for cache_enabled.</action>
  <verify>pytest tests/test_config_settings.py -k "env_override" -v</verify>
  <done>All 7 environment override tests pass, validating configuration priority.</done>
</task>

<task type="auto">
  <name>Task 5: Test field validation constraints</name>
  <files>tests/test_config_settings.py</files>
  <action>Add validation constraint tests:
  1. test_global_config_dpi_validation_too_low - Verify validation error when DPI < 72
  2. test_global_config_dpi_validation_too_high - Verify validation error when DPI > 600
  3. test_global_config_dpi_validation_boundary_accepts - Verify DPI = 72 and DPI = 600 are accepted
  4. test_global_config_output_format_validation_invalid - Verify error for invalid format ("jpg", "gif")
  5. test_global_config_output_format_validation_valid - Verify "png", "svg", "pdf" all accepted
  6. test_global_config_fast_sample_frac_validation - Verify validation error when < 0.01 or > 1.0
  7. test_global_config_log_level_validation_invalid - Verify error for invalid log level ("TRACE", "FATAL")
  8. test_global_config_log_level_validation_valid - Verify "DEBUG", "INFO", "WARNING", "ERROR" accepted

Use monkeypatch.setenv to set invalid values and instantiate config. Use pytest.raises(Exception) or pytest.raises(ValidationError) to catch validation errors. Verify error messages are informative.</action>
  <verify>pytest tests/test_config_settings.py -k "validation" -v</verify>
  <done>All 8 validation tests pass, enforcing configuration constraints.</done>
</task>

<task type="auto">
  <name>Task 6: Test nested configuration access</name>
  <files>tests/test_config_settings.py</files>
  <action>Add nested configuration tests:
  1. test_global_config_nested_env_vars - Verify CRIME__OUTPUT__DIR nested delimiter works
  2. test_global_config_env_nested_delimiter - Verify double underscore notation for nested values

Note: pydantic-settings uses env_nested_delimiter for nested values. Test that nested environment variables work if configured.</action>
  <verify>pytest tests/test_config_settings.py -k "nested" -v</verify>
  <done>Nested configuration tests pass, validating complex env var structures.</done>
</task>

</tasks>

<verification>
Run all config settings tests: pytest tests/test_config_settings.py -v

Run with coverage: pytest tests/test_config_settings.py --cov=analysis/config/settings --cov-report=term-missing

Verify:
1. All tests pass (target: 25+ tests)
2. Coverage of analysis/config/settings.py exceeds 90%
3. All validation branches tested
4. YAML loading and env override paths covered
</verification>

<success_criteria>
1. analysis/config/settings.py has 90%+ test coverage
2. Default values validated
3. YAML loading tested
4. Environment variable overrides tested
5. Field validation constraints enforced
6. Configuration source priority verified
</success_criteria>

<output>
After completion, create `.planning/phases/13-pipeline-and-supporting-tests/13-04-SUMMARY.md` with:
- Number of tests added
- Coverage achieved for analysis/config/settings.py
- Validation coverage summary
</output>
