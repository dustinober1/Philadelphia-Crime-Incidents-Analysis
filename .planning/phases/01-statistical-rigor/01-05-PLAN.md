---
phase: 01-statistical-rigor
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - analysis/reproducibility.py
autonomous: true

must_haves:
  truths:
    - "User can track data version via SHA256 hash and metadata snapshot"
    - "User can set global random seed for reproducible analysis"
    - "User can retrieve data version info (hash, row count, date range, columns)"
    - "User can document analysis parameters in markdown reports"
  artifacts:
    - path: "analysis/reproducibility.py"
      provides: "Data versioning and seed management infrastructure"
      min_lines: 100
      exports: ["DataVersion", "set_global_seed", "get_analysis_metadata"]
  key_links:
    - from: "analysis/temporal_analysis.py"
      to: "analysis/reproducibility.py"
      via: "from analysis.reproducibility import set_global_seed, get_analysis_metadata"
      pattern: "from analysis.reproducibility import"
    - from: "analysis/data_quality.py"
      to: "analysis/reproducibility.py"
      via: "from analysis.reproducibility import DataVersion"
      pattern: "from analysis.reproducibility import"
---

<objective>
Create reproducibility infrastructure for data version tracking, random seed management, and analysis parameter documentation. This ensures all analyses can be reproduced exactly through documented seeds, data versioning (SHA256 hash), and explicit parameter documentation in outputs.

Purpose: Meet PUB-04 requirement for reproducible analyses through documented random seeds, data version tracking, and parameter documentation.

Output: New `analysis/reproducibility.py` module with DataVersion class and seed management functions, ready to be imported by all analysis modules.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-statistical-rigor/01-CONTEXT.md
@.planning/phases/01-statistical-rigor/01-RESEARCH.md
@analysis/config.py
@analysis/utils.py
</context>

<tasks>

<task type="auto">
  <name>Create reproducibility.py module with DataVersion class</name>
  <files>analysis/reproducibility.py</files>
  <action>
Create `analysis/reproducibility.py` with:

1. **DataVersion class** - Track data version for reproducibility
   ```python
   class DataVersion:
       def __init__(self, data_path: Path | str):
           # Compute SHA256 hash of data file
           # Load metadata: row_count, column_count, columns, date_range
           # Store timestamp of version computation

       def _compute_metadata(self) -> Dict[str, Any]:
           # Read file in chunks for SHA256 (handle large files)
           # Load pandas for metadata snapshot
           # Return dict with all metadata

       def to_dict(self) -> Dict[str, Any]:
           # Return metadata as dict for report generation

       def __repr__(self) -> str:
           # Human-readable version info
   ```

2. **set_global_seed(seed: int | None = None)** - Set random seeds for all libraries
   - Uses STAT_CONFIG["random_seed"] if seed is None
   - Calls np.random.seed(seed)
   - Optionally add random.seed(seed) for Python stdlib
   - Returns the seed used

3. **get_analysis_metadata(**params)** - Capture analysis parameters for documentation
   - Takes keyword arguments of analysis parameters
   - Adds timestamp, data version info (if provided)
   - Returns formatted dict for markdown report generation
   - Output format: {"timestamp": str, "parameters": dict, "data_version": dict | None}

4. **format_metadata_markdown(metadata: dict)** - Format metadata for markdown reports
   - Returns markdown string with "Analysis Configuration" section
   - Includes: timestamp, parameters, data version (SHA256, row count, date range)
   - Format suitable for inclusion in all generated reports

Add type hints using `from typing import Dict, Any, Optional`.

All functions must have complete docstrings with Args, Returns, and Examples.

Implementation notes:
- SHA256 hashing: Read file in 4KB chunks to handle large parquet files
- For date range: use dispatch_date column if available, else None
- Handle both Path and str inputs for DataVersion
  </action>
  <verify>
```bash
python -c "
from analysis.reproducibility import DataVersion, set_global_seed, get_analysis_metadata, format_metadata_markdown
from pathlib import Path

# Test DataVersion
data_path = Path('data/crime_incidents_combined.parquet')
dv = DataVersion(data_path)
print('DataVersion created')
print(f'SHA256: {dv.to_dict()[\"sha256\"][:16]}...')
print(f'Rows: {dv.to_dict()[\"row_count\"]}')

# Test set_global_seed
seed = set_global_seed()
print(f'Global seed set to: {seed}')

# Test get_analysis_metadata
metadata = get_analysis_metadata(test_param=42, alpha=0.01)
print(f'Metadata: {metadata}')

# Test format_metadata_markdown
md = format_metadata_markdown(metadata)
print('Markdown output:')
print(md[:200])
"
```
  </verify>
  <done>
DataVersion class successfully reads data file and computes SHA256 hash, set_global_seed returns the seed used, get_analysis_metadata captures parameters, and format_metadata_markdown produces valid markdown.
  </done>
</task>

<task type="auto">
  <name>Add __init__.py exports for reproducibility module</name>
  <files>analysis/__init__.py</files>
  <action>
Update `analysis/__init__.py` to export reproducibility functions for easy import:

Add to the existing exports (or create if minimal):
```python
# Reproducibility infrastructure
from analysis.reproducibility import DataVersion, set_global_seed, get_analysis_metadata, format_metadata_markdown

__all__ = [
    # ... existing exports ...
    "DataVersion",
    "set_global_seed",
    "get_analysis_metadata",
    "format_metadata_markdown",
]
```
  </action>
  <verify>
```bash
python -c "
from analysis import DataVersion, set_global_seed, get_analysis_metadata, format_metadata_markdown
print('All reproducibility exports accessible from analysis package')
"
```
  </verify>
  <done>
DataVersion, set_global_seed, get_analysis_metadata, and format_metadata_markdown are importable from the analysis package.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run the verify command from task 1 - all components should work
2. Run the verify command from task 2 - exports should be accessible
3. Check that SHA256 hash is consistent (run twice, should get same hash)
4. Verify markdown output is valid: `echo "$md_output" | head -20`
</verification>

<success_criteria>
1. analysis/reproducibility.py exists with DataVersion class and 3 functions
2. DataVersion successfully computes SHA256 hash of data file
3. set_global_seed sets numpy random seed and returns the seed value
4. get_analysis_metadata captures parameters and timestamp
5. format_metadata_markdown produces valid markdown with "Analysis Configuration" header
6. All functions are exported from analysis package
7. All verify commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-statistical-rigor/01-05-SUMMARY.md` with:
- DataVersion hash (first 16 chars for reference)
- Functions implemented
- Export summary
- Any deviations from plan
</output>
