---
phase: 01-statistical-rigor
plan: 06
type: execute
wave: 3
depends_on: [01-01, 01-05, 01-02, 01-03]
files_modified:
  - analysis/data_quality.py
  - reports/01_data_quality_audit.md
autonomous: true

must_haves:
  truths:
    - "User can view comprehensive data quality audit report"
    - "User can view missing data patterns by column and by crime type/district"
    - "User can view coordinate coverage statistics by crime type and district"
    - "User can view duplicate detection results"
    - "User can view distribution summaries and outlier detection"
    - "User can view temporal gaps analysis"
    - "User can view quality scores and analysis limitations recommendations"
  artifacts:
    - path: "analysis/data_quality.py"
      contains: "generate_data_quality_audit", "analyze_missing_patterns", "coordinate_coverage_analysis"
      min_lines: 300
      exports: ["generate_data_quality_audit", "analyze_missing_patterns", "coordinate_coverage_analysis"]
    - path: "reports/01_data_quality_audit.md"
      provides: "Comprehensive data quality audit report"
      min_lines: 200
  key_links:
    - from: "analysis/data_quality.py"
      to: "analysis/stats_utils.py"
      via: "from analysis.stats_utils import"
    - from: "analysis/data_quality.py"
      to: "analysis/reproducibility.py"
      via: "from analysis.reproducibility import DataVersion"
    - from: "reports/01_data_quality_audit.md"
      to: "analysis/data_quality.py"
      via: "Generated by generate_data_quality_audit()"
---

<objective>
Generate a comprehensive data quality audit report documenting missing data patterns, coordinate coverage by crime type/district, duplicate detection, outlier detection, distribution summaries, temporal gaps, quality scores, and recommendations for analysis limitations. This addresses the PUB-03 requirement for a data quality audit.

Purpose: Meet PUB-03 requirement for comprehensive data quality audit documenting missing data, coordinate coverage, and analysis limitations.

Output: Enhanced data_quality.py with audit generation functions and new reports/01_data_quality_audit.md with comprehensive quality assessment.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-statistical-rigor/01-01-SUMMARY.md
@.planning/phases/01-statistical-rigor/01-05-SUMMARY.md
@analysis/data_quality.py
@analysis/config.py
@analysis/utils.py
</context>

<tasks>

<task type="auto">
  <name>Add audit functions to data_quality.py</name>
  <files>analysis/data_quality.py</files>
  <action>
Update `analysis/data_quality.py` to add comprehensive audit functions:

1. **Add imports**:
   ```python
   from analysis.reproducibility import set_global_seed, DataVersion, get_analysis_metadata, format_metadata_markdown
   from analysis.config import STAT_CONFIG
   ```

2. **Add analyze_missing_patterns(df)** function:
   - Missing data by column (count, percentage)
   - Missing data by crime type (text_general_code)
   - Missing data by district (dc_dist)
   - Missing data by year (temporal pattern)
   - Missingness correlation (which columns tend to be missing together)
   - Returns: dict with all missing data analyses

3. **Add coordinate_coverage_analysis(df)** function:
   - Overall coordinate coverage (valid_coord flag)
   - Coordinate coverage by crime type
   - Coordinate coverage by district
   - Coordinate coverage by year (any temporal bias?)
   - Invalid coordinate breakdown (missing, invalid_lon, invalid_lat)
   - Returns: dict with all coverage analyses

4. **Add detect_duplicates(df)** function:
   - Exact duplicate detection (all columns)
   - Near-duplicate detection (same coordinates + time)
   - Duplicate reporting patterns (same incident, multiple charges)
   - Returns: dict with duplicate counts, examples, percent affected

5. **Add detect_outliers(df)** function:
   - Outlier detection for numerical columns
   - IQR method for count data
   - Coordinate outliers (outside bbox)
   - Temporal outliers (gaps in dates)
   - Returns: dict with outlier summaries

6. **Add temporal_gaps_analysis(df)** function:
   - Daily count histogram (identify gaps)
   - Dates with zero incidents
   - Longest gap without data
   - Consistency checks (any months missing?)
   - Returns: dict with gap analysis

7. **Add calculate_quality_scores(df)** function:
   - Overall quality score (0-100)
   - Component scores: completeness, accuracy, consistency, validity
   - Weighted average with rationale
   - Returns: dict with quality scores

8. **Add generate_data_quality_audit()** main function:
   - Load data with validate_coordinates and extract_temporal_features
   - Call all analysis functions above
   - Generate markdown report with all findings
   - Include Analysis Configuration section
   - Include DataVersion info
   - Include recommendations for analysis limitations
   - Save to reports/01_data_quality_audit.md
   - Returns: results dict

Report structure:
```markdown
# Data Quality Audit

## Analysis Configuration
[metadata]

## Data Version
[SHA256, row count, date range]

## Missing Data Analysis
### By Column
[table]

### By Crime Type
[table]

### By District
[table]

## Coordinate Coverage
### Overall Statistics
[summary]

### By Crime Type
[table]

### By District
[table]

## Duplicate Detection
[counts, examples]

## Outlier Detection
[summaries]

## Temporal Gaps
[gap analysis]

## Quality Scores
[overall and component scores]

## Analysis Limitations & Recommendations
[guidance for users]
```
  </action>
  <verify>
```bash
python -c "
from analysis.data_quality import generate_data_quality_audit
results = generate_data_quality_audit()
print('Audit generated')
print('Results keys:', list(results.keys()))
print('Quality score:', results.get('quality_score', 'NOT FOUND'))
print('Report saved to:', results.get('report_path', 'NOT FOUND'))
"
```
  </verify>
  <done>
data_quality.py includes all 8 analysis functions (missing patterns, coordinate coverage, duplicates, outliers, temporal gaps, quality scores, generate_audit), and report is generated at reports/01_data_quality_audit.md.
  </done>
</task>

<task type="auto">
  <name>Generate comprehensive data quality audit report</name>
  <files>reports/01_data_quality_audit.md</files>
  <action>
Run the audit generation to create the comprehensive report:

1. The generate_data_quality_audit() function from task 1 will create the report

2. Verify the report includes all sections:
   - Analysis Configuration (seed, data version)
   - Data Version (SHA256 hash, metadata)
   - Missing Data Analysis (by column, crime type, district)
   - Coordinate Coverage (overall, by crime type, by district)
   - Duplicate Detection (counts, examples)
   - Outlier Detection (summaries)
   - Temporal Gaps (gap analysis)
   - Quality Scores (overall + components)
   - Analysis Limitations & Recommendations

3. Ensure report includes visualizations:
   - Missing data heatmap (columns vs indicators)
   - Coordinate coverage by district (bar chart)
   - Temporal gap visualization
   - Quality score gauge/radar

4. Recommendations should include:
   - Which analyses are safe (good data coverage)
   - Which analyses need caution (missing data bias)
   - Districts/crime types to exclude if needed
   - Coordinate missingness impact statement

5. Statistical summaries should include:
   - Missing data percentages with confidence intervals
   - Coverage comparisons across groups with significance tests
   - Quality score justification with component breakdown
  </action>
  <verify>
```bash
# Check report exists and has required sections
REPORT="reports/01_data_quality_audit.md"
if [ -f "$REPORT" ]; then
    echo "Report exists"
    echo "Section count:"
    grep -c "^##" "$REPORT" || echo "0"
    echo "Has Analysis Configuration:"
    grep -c "Analysis Configuration" "$REPORT" || echo "0"
    echo "Has Missing Data:"
    grep -c "Missing Data" "$REPORT" || echo "0"
    echo "Has Coordinate Coverage:"
    grep -c "Coordinate Coverage" "$REPORT" || echo "0"
    echo "Has Quality Scores:"
    grep -c "Quality Score" "$REPORT" || echo "0"
    echo "Has Recommendations:"
    grep -c "Recommendations" "$REPORT" || echo "0"
else
    echo "Report not found at $REPORT"
fi
```
  </verify>
  <done>
reports/01_data_quality_audit.md exists with all 8 required sections (Analysis Configuration, Data Version, Missing Data, Coordinate Coverage, Duplicates, Outliers, Temporal Gaps, Quality Scores, Recommendations), includes at least 2 data visualizations, and provides actionable analysis guidance.
  </done>
</task>

<task type="auto">
  <name>Add statistical tests to data quality audit</name>
  <files>analysis/data_quality.py</files>
  <action>
Add statistical testing to the data quality audit:

1. **Test missing data bias**:
   - Chi-square test: Is missingness independent of crime type?
   - Chi-square test: Is missingness independent of district?
   - Report p-values for missingness pattern tests

2. **Test coordinate coverage bias**:
   - Chi-square test: Is coordinate coverage independent of crime type?
   - Chi-square test: Is coordinate coverage independent of district?
   - Report which crime types/districts have significantly different coverage

3. **Compare quality scores**:
   - Bootstrap 99% CI for overall quality score
   - Compare quality across districts with ANOVA
   - Report significant differences

4. **Update report** to include:
   - Statistical test results for missingness bias
   - Statistical test results for coordinate coverage bias
   - Statements like "Missing data is NOT independent of crime type (chi2=XXX, p<0.01)"
   - Implications for analysis validity

Import required functions:
```python
from analysis.stats_utils import chi_square_test, compare_multiple_samples, bootstrap_ci, apply_fdr_correction
```
  </action>
  <verify>
```bash
python -c "
from analysis.data_quality import analyze_missing_patterns, coordinate_coverage_analysis
from analysis.utils import load_data, validate_coordinates

df = load_data()
df = validate_coordinates(df)

missing_results = analyze_missing_patterns(df)
print('Missing results keys:', list(missing_results.keys()))
print('Missingness bias test:', missing_results.get('missingness_bias_test', 'NOT FOUND'))

coverage_results = coordinate_coverage_analysis(df)
print('Coverage results keys:', list(coverage_results.keys()))
print('Coverage bias test:', coverage_results.get('coverage_bias_test', 'NOT FOUND'))
"
```
  </verify>
  <done>
data_quality.py includes statistical tests for missingness bias (chi-square tests by crime type and district), coordinate coverage bias tests, bootstrap CIs for quality scores, and reports p-values in the audit.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Run verify command from task 1 - audit generates successfully
2. Run verify command from task 2 - report has all sections
3. Run verify command from task 3 - statistical tests work
4. Read the generated report and verify:
   - Analysis Configuration section exists
   - Data Version with SHA256 is included
   - Missing data analysis has tables by column/crime type/district
   - Coordinate coverage has breakdowns
   - Statistical tests report p-values
   - Recommendations are actionable
</verification>

<success_criteria>
1. data_quality.py has 8 analysis functions (missing_patterns, coordinate_coverage, duplicates, outliers, temporal_gaps, quality_scores, generate_audit)
2. generate_data_quality_audit() runs without errors
3. reports/01_data_quality_audit.md is generated with all 8 sections
4. Report includes statistical tests (chi-square for missingness/coverage bias)
5. Report includes visualizations (heatmaps, bar charts)
6. Report includes Analysis Configuration with data version
7. Report includes actionable recommendations for analysis limitations
8. All verify commands pass
</success_criteria>

<output>
After completion, create `.planning/phases/01-statistical-rigor/01-06-SUMMARY.md` with:
- Data quality audit summary (overall score, key findings)
- Missing data statistics (percentages, biased columns)
- Coordinate coverage statistics
- Statistical test results (missingness bias, coverage bias)
- Key recommendations for analysis limitations
- Report path and size
- Any deviations from plan
</output>
