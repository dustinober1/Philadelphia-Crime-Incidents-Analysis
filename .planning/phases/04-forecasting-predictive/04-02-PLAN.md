---
phase: 04-forecasting-predictive
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - notebooks/04_forecasting_crime_ts.ipynb
autonomous: true

must_haves:
  truths:
    - Crime incidents can be aggregated by time for forecasting
    - Prophet model produces 30-60 day forecasts with confidence intervals
    - Anomaly detection thresholds are defined based on prediction intervals
    - Forecast notebook runs end-to-end without errors
  artifacts:
    - 04_forecasting_crime_ts.ipynb with complete forecasting pipeline
    - Exported forecast visualization showing historical data and 60-day projection
    - Anomaly detection definition with statistical thresholds
    - Reproducible model with fixed random seed
  key_links:
    - notebook imports from analysis.models.time_series
    - crime data properly aggregated by date (ds, y format for Prophet)
    - future dataframe extends 60 days beyond last observation
    - prediction intervals calculated with 95% confidence
---

<objective>
Create a time series forecasting notebook that uses Prophet to predict crime incidents with a 30-60 day horizon, confidence intervals, and anomaly detection thresholds as required by FORECAST-01.

Purpose: Build and validate a time series model to forecast crime incidents for operational planning
Output: Prophet-based forecasting notebook with 60-day horizon and anomaly detection capabilities
</objective>

<execution_context>
@/Users/dustinober/.config/opencode/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-forecasting-predictive-modeling/04-RESEARCH.md
@data/crime_incidents_combined.parquet
</context>

<tasks>

<task type="auto">
  <name>Create time series data preparation</name>
  <files>notebooks/04_forecasting_crime_ts.ipynb</files>
  <action>
Create the initial notebook structure that:
1. Loads crime incidents data from data/crime_incidents_combined.parquet
2. Aggregates incidents by date to create a time series suitable for Prophet
3. Prepares the data in Prophet format (ds, y columns where ds is date and y is count)
4. Performs any necessary data cleaning or preprocessing
5. Shows summary statistics and basic visualization of the time series

Follow the reproducibility pattern from previous notebooks with proper metadata capture.
</action>
  <verify>jupyter nbconvert --to notebook --execute --ExecutePreprocessor.timeout=600 notebooks/04_forecasting_crime_ts.ipynb</verify>
  <done>Crime data loaded and aggregated by date in Prophet format with basic visualization</done>
</task>

<task type="auto">
  <name>Implement Prophet forecasting model</name>
  <files>notebooks/04_forecasting_crime_ts.ipynb</files>
  <action>
Build the Prophet forecasting model following the Pattern 1 from research:
1. Use Prophet with appropriate seasonality settings (yearly, weekly)
2. Configure changepoint settings to handle trend changes in crime data
3. Set prediction interval width to 95%
4. Split data into train/validation sets temporally
5. Fit the model on training data
6. Generate 60-day forecast with prediction intervals

Use the code examples from research as a foundation, but adapt for crime data characteristics.
</action>
  <verify>Prophet model trains successfully and generates 60-day forecast with confidence intervals</verify>
  <done>Prophet model fitted with 60-day forecast horizon and prediction intervals</done>
</task>

<task type="auto">
  <name>Add anomaly detection and export visualization</name>
  <files>notebooks/04_forecasting_crime_ts.ipynb</files>
  <action>
Complete the notebook with:
1. Definition of anomaly detection thresholds based on prediction intervals
2. Logic to identify anomalous periods (actual values outside prediction intervals)
3. Export of forecast visualization showing historical data, forecast, and confidence bands
4. Calculation of model performance metrics on validation set
5. Summary of findings and operational recommendations

Define clear thresholds for operational alerts as requested in the requirements.
</action>
  <verify>Exported forecast plot shows historical data, forecast, and confidence intervals clearly</verify>
  <done>Anomaly detection thresholds defined and forecast visualization exported to reports/</done>
</task>

</tasks>

<verification>
- Run notebook completely to ensure end-to-end execution
- Verify forecast extends 60 days into future
- Check that prediction intervals are properly calculated
- Confirm anomaly detection logic is implemented
</verification>

<success_criteria>
- Time series forecasting notebook runs successfully end-to-end
- Prophet model produces 60-day forecast with 95% confidence intervals
- Anomaly detection thresholds clearly defined and implemented
- Forecast visualization exported to reports/ directory
- Model includes reproducible training seed
</success_criteria>

<output>
After completion, create `.planning/phases/04-forecasting-predictive/04-02-SUMMARY.md`
</output>