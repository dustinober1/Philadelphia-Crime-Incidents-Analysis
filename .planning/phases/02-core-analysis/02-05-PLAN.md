---
phase: 02-core-analysis
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - notebooks/06_disparity_analysis.ipynb
  - output/figures/disparity/
  - output/tables/disparity/
autonomous: true

must_haves:
  truths:
    - "District disparities are quantified with effect sizes"
    - "Statistical comparisons use Bonferroni correction"
    - "Disparities documented without ecological fallacy"
    - "District profiles include comprehensive metrics"
    - "Confidence intervals included for all comparisons"
  artifacts:
    - path: "notebooks/06_disparity_analysis.ipynb"
      provides: "Complete disparity analysis with statistical testing"
      min_lines: 250
    - path: "output/figures/disparity/"
      provides: "Disparity visualizations"
      count: 8
    - path: "output/tables/disparity/district_comparison_stats.csv"
      provides: "Statistical comparison results"
    - path: "output/tables/disparity/district_profiles_detailed.csv"
      provides: "Comprehensive district profiles"
  key_links:
    - from: "notebooks/06_disparity_analysis.ipynb"
      to: "data/processed/crime_incidents_cleaned.parquet"
      via: "pd.read_parquet()"
      pattern: "read_parquet.*cleaned"
    - from: "notebooks/06_disparity_analysis.ipynb"
      to: "statsmodels.stats.multitest.multipletests"
      via: "Bonferroni correction"
      pattern: "multipletests.*bonferroni"
---

<objective>
Conduct comprehensive disparity analysis comparing crime patterns across Philadelphia's 22 police districts with statistical rigor and appropriate caveats.

Purpose: Answer DISP-01 through DISP-03 requirements; quantify district-level differences; document disparities without ecological fallacy; provide district profiles for dashboard and report.
Output: Notebook 06 with statistical comparisons, effect sizes, district profiles, and 8+ publication-quality figures.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@.planning/phases/02-core-analysis/02-CONTEXT.md
@scripts/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: District Data Aggregation and Profiling</name>
  <files>notebooks/06_disparity_analysis.ipynb</files>
  <action>
    Create notebook 06_disparity_analysis.ipynb with district data preparation:
    
    1. Import required libraries:
       - pandas, numpy, matplotlib, seaborn
       - scipy.stats for statistical tests
       - statsmodels.stats.multitest for Bonferroni correction
       - scripts/config.py
    
    2. Load cleaned data from data/processed/crime_incidents_cleaned.parquet
    
    3. **Comprehensive district aggregation:**
       For each of the 22 districts (dc_dist), calculate:
       - Total incidents (overall and by year)
       - Incidents per year (annual average)
       - Violent crime count and rate
       - Property crime count and rate
       - Quality-of-life crime count and rate
       - Top 5 offense types
       - Temporal trend slope (annual change)
       - Seasonal coefficient of variation
       - Geocoding coverage percentage
       - Peak hour and peak day-of-week
    
    4. **District profiles DataFrame:**
       - Create comprehensive district_profiles_detailed.csv
       - Include all metrics from aggregation
       - Add rank columns (1-22) for key metrics
       - Calculate percentile ranks
    
    5. **Data quality flags:**
       - Identify districts with low geocoding coverage (<80%)
       - Identify districts with sparse data (<1000 incidents)
       - Flag for interpretation caution
    
    6. **Initial visualization:**
       - Bar chart: total incidents by district (sorted)
       - Bar chart: crime rate by district (if population data available)
       - Heatmap: district × offense type (normalized)
    
    7. Save intermediate outputs:
       - district_profiles_detailed.csv
       - district_metrics_raw.csv
    
    Document aggregation methodology and any data quality concerns.
  </action>
  <verify>District profiles created with 22 districts; all metrics calculated; data quality flags identified; initial visualizations created</verify>
  <done>District data aggregated into comprehensive profiles ready for statistical comparison</done>
</task>

<task type="auto">
  <name>Task 2: Statistical Comparisons with Multiple Testing Correction</name>
  <files>notebooks/06_disparity_analysis.ipynb</files>
  <action>
    Implement statistical comparisons between districts with proper multiple testing correction per 02-RESEARCH.md Pattern 4:
    
    1. **Pairwise comparisons (overall crime):**
       - Compare each district to city-wide average
       - Use t-test for district vs. others
       - Calculate effect size (Cohen's d)
       - Generate 21 tests (one per district vs. city)
    
    2. **Bonferroni correction:**
       - Apply multipletests(method='bonferroni') to p-values
       - Report both raw and corrected p-values
       - Identify districts significantly different from city average (after correction)
    
    3. **Violent crime comparisons:**
       - Repeat pairwise comparisons for violent crime rates
       - Apply Bonferroni correction
       - Identify districts with significantly higher/lower violent crime
    
    4. **Property crime comparisons:**
       - Repeat pairwise comparisons for property crime rates
       - Apply Bonferroni correction
    
    5. **Top vs. bottom district comparisons:**
       - Identify top 5 and bottom 5 districts by overall crime
       - Compare top 5 vs. bottom 5 (t-test)
       - Calculate effect size
       - Document magnitude of disparity
    
    6. **Effect size interpretation:**
       - Small: d = 0.2, Medium: d = 0.5, Large: d = 0.8
       - Report effect sizes for all significant comparisons
       - Create effect size visualization
    
    7. **Save outputs:**
       - district_comparison_stats.csv with columns:
         * district_id
         * comparison_type (vs_city, vs_top5, vs_bottom5)
         * metric (overall, violent, property)
         * mean_district, mean_comparison
         * p_value_raw, p_value_corrected
         * significant (True/False after correction)
         * effect_size_cohens_d
         * effect_size_interpretation
    
    8. **Visualizations:**
       - Forest plot: effect sizes with 95% CIs by district
       - Bar chart: districts significantly above/below city average
       - Heatmap: statistical significance matrix
    
    Ensure all comparisons use proper statistical language and avoid causal claims.
  </action>
  <verify>Statistical comparisons complete; Bonferroni correction applied; effect sizes calculated; district_comparison_stats.csv saved</verify>
  <done>Statistical comparisons complete with multiple testing correction and effect size quantification</done>
</task>

<task type="auto">
  <name>Task 3: Disparity Documentation and Ecological Fallacy Warnings</name>
  <files>notebooks/06_disparity_analysis.ipynb</files>
  <action>
    Document disparities with appropriate caveats and create final visualizations:
    
    1. **Disparity summary statistics:**
       - Range: highest vs. lowest district (ratio)
       - Coefficient of variation across districts
       - Gini coefficient for crime distribution inequality
       - Document concentration: what % of crime in top 20% of districts?
    
    2. **District categorization:**
       - Cluster districts into high/medium/low crime categories
       - Use natural breaks or k-means clustering
       - Document characteristics of each category
       - Create category profiles
    
    3. **Temporal disparity analysis:**
       - Have disparities increased or decreased over time?
       - Calculate disparity trends (coefficient of variation by year)
       - Create disparity trend visualization
    
    4. **Offense-specific disparities:**
       - Which districts have unusual offense mixes?
       - Chi-square test for offense distribution homogeneity
       - Document districts with specialized crime profiles
    
    5. **Ecological fallacy documentation:**
       - Add prominent warning section about ecological inference
       - Explain: district-level patterns ≠ individual-level behavior
       - Note: crime reporting ≠ victimization (reporting bias)
       - Use cautious language throughout: "District X has higher reported crime rates" not "District X is more dangerous"
    
    6. **Limitations section:**
       - Population data limitations (if using raw counts)
       - Reporting bias (some districts may have higher reporting rates)
       - Enforcement intensity variations
       - Boundary changes over 20 years
       - MAUP (Modifiable Areal Unit Problem)
    
    7. **Final visualizations:**
       - district_comparison_total.png (bar chart with CIs)
       - district_comparison_violent.png (bar chart with CIs)
       - effect_sizes_forest_plot.png
       - disparity_trends_over_time.png
       - district_categories_map.png (if geographic data available)
       - disparity_summary_dashboard.png (multi-panel summary)
    
    8. **Notebook conclusion:**
       - Executive summary of disparities
       - Key findings: which districts differ significantly
       - Effect sizes: magnitude of differences
       - Temporal trends: are disparities changing?
       - Strong limitations statement
       - Recommendations for dashboard disparity visualizations
       - Guidance for report writing (how to discuss disparities responsibly)
    
    9. **Save all outputs:**
       - district_comparison_stats.csv (final version)
       - district_profiles_detailed.csv (final version)
       - disparity_summary.csv (key statistics)
       - All figures to output/figures/disparity/
    
    Ensure every finding is paired with appropriate caveats about interpretation.
  </action>
  <verify>Disparities documented with effect sizes; ecological fallacy warnings prominent; limitations section comprehensive; 8+ figures saved; notebook runs end-to-end</verify>
  <done>Complete disparity analysis with statistical rigor, proper caveats, and comprehensive documentation; all DISP requirements addressed</done>
</task>

</tasks>

<verification>
- [ ] Notebook 06 runs without errors from top to bottom
- [ ] District profiles created for all 22 districts
- [ ] Statistical comparisons use Bonferroni correction
- [ ] Effect sizes (Cohen's d) calculated for all comparisons
- [ ] Confidence intervals included for all estimates
- [ ] 8+ publication-quality figures saved to output/figures/disparity/
- [ ] Ecological fallacy warning prominently displayed
- [ ] Limitations section comprehensive (MAUP, reporting bias, etc.)
- [ ] Language is cautious: "higher reported crime rates" not "more dangerous"
</verification>

<success_criteria>
- Notebook 06 complete with comprehensive disparity analysis
- District profiles with 10+ metrics per district
- Statistical comparisons with Bonferroni-corrected p-values
- Effect sizes quantified for all significant differences
- Disparity trends analyzed over 20 years
- 8+ publication-quality figures generated
- Ecological fallacy explicitly warned against
- Limitations comprehensively documented
- All disparity requirements (DISP-01 to DISP-03) addressed
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-05-SUMMARY.md`
</output>
