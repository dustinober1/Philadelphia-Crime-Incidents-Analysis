---
phase: 02-core-analysis
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - notebooks/05_offense_breakdown.ipynb
  - output/figures/offense/
  - output/tables/offense/
autonomous: true

must_haves:
  truths:
    - "UCR code distribution is documented with hierarchy"
    - "Offense severity classification is validated"
    - "Trends by offense category show differential patterns"
    - "Offense distributions are reasonable (match expected UCR hierarchy)"
    - "Cross-temporal offense patterns are analyzed"
  artifacts:
    - path: "notebooks/05_offense_breakdown.ipynb"
      provides: "Complete offense breakdown analysis"
      min_lines: 250
    - path: "output/figures/offense/"
      provides: "Offense visualizations"
      count: 8
    - path: "output/tables/offense/ucr_distribution.csv"
      provides: "UCR code frequencies and percentages"
    - path: "output/tables/offense/offense_trends.csv"
      provides: "Trend statistics by offense category"
  key_links:
    - from: "notebooks/05_offense_breakdown.ipynb"
      to: "data/processed/crime_incidents_cleaned.parquet"
      via: "pd.read_parquet()"
      pattern: "read_parquet.*cleaned"
    - from: "notebooks/05_offense_breakdown.ipynb"
      to: "scripts/config.py"
      via: "UCR classification constants"
      pattern: "UCR_VIOLENT|UCR_PROPERTY"
---

<objective>
Conduct comprehensive offense breakdown analysis including UCR distribution, severity classification, trends by offense category, and cross-temporal offense patterns.

Purpose: Answer OFF-01 through OFF-05 requirements; establish offense classification scheme; validate against expected UCR hierarchy; document how offense patterns have changed over 20 years.
Output: Notebook 05 with UCR analysis, severity breakdown, offense trends, and 8+ publication-quality figures.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@.planning/phases/02-core-analysis/02-CONTEXT.md
@scripts/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: UCR Code Mapping and Distribution Analysis</name>
  <files>notebooks/05_offense_breakdown.ipynb</files>
  <action>
    Create notebook 05_offense_breakdown.ipynb with UCR code analysis:
    
    1. Import required libraries:
       - pandas, numpy, matplotlib, seaborn
       - scripts/config.py (for UCR constants)
    
    2. Load cleaned data from data/processed/crime_incidents_cleaned.parquet
    
    3. **UCR code inventory:**
       - List all unique ucr_general codes in the dataset
       - Calculate frequency and percentage for each code
       - Create ucr_code_mapping based on observed values
       - Cross-reference with standard FBI UCR categories
       - Document any codes that don't match standard UCR
    
    4. **UCR distribution analysis:**
       - Bar chart of top 20 UCR codes by frequency
       - Pie chart of UCR category distribution
       - Calculate cumulative percentage (Pareto analysis)
       - Save ucr_distribution.csv to output/tables/offense/
    
    5. **Text general code analysis:**
       - Analyze text_general_code descriptions
       - Map text codes to UCR codes (many-to-one relationships)
       - Identify most common offense descriptions
       - Create text_to_ucr_mapping.csv
    
    6. **Offense hierarchy validation:**
       - Compare observed distribution to expected UCR hierarchy
       - Expected: Violent ~10%, Property ~20%, Quality-of-life ~70%
       - Document deviations from expected distribution
       - Validate that hierarchy makes sense for Philadelphia
    
    7. Save initial figures:
       - ucr_distribution_top20.png
       - ucr_category_pie.png
       - text_general_code_top20.png
    
    Document methodology for UCR classification and any data quality issues with offense coding.
  </action>
  <verify>UCR codes inventoried and mapped; distribution calculated; hierarchy validated against expected proportions; 3+ figures saved</verify>
  <done>UCR code mapping complete with distribution analysis and hierarchy validation</done>
</task>

<task type="auto">
  <name>Task 2: Severity Classification and Cross-Cutting Analysis</name>
  <files>notebooks/05_offense_breakdown.ipynb</files>
  <action>
    Implement offense severity classification and cross-cutting analysis:
    
    1. **Severity classification scheme:**
       - Define severity levels using config.py UCR constants:
         * Violent: Homicide, Rape, Robbery, Aggravated Assault (UCR 100-400)
         * Property: Burglary, Larceny, Motor Vehicle Theft, Arson (UCR 500-700)
         * Quality-of-life: All other offenses
       - Create severity column in dataframe
       - Calculate distribution: % violent, % property, % other
       - Validate against known Philadelphia crime composition
    
    2. **Severity by geographic context:**
       - Calculate severity distribution by district
       - Identify districts with higher violent crime proportions
       - Create stacked bar chart: district × severity
       - Statistical test: chi-square for independence
       - Save severity_by_district.csv
    
    3. **Severity by temporal context:**
       - Calculate severity distribution by year
       - Has violent crime proportion changed over time?
       - Calculate severity distribution by hour of day
       - Are violent crimes more common at certain times?
       - Create line plot: severity proportions over 20 years
       - Create heatmap: hour × severity
    
    4. **Offense diversity analysis:**
       - Calculate Shannon diversity index by district
       - Are some districts more "specialized" in certain crime types?
       - Calculate offense concentration (Herfindahl index)
       - Document findings
    
    5. **Cross-cutting analysis:**
       - Violent crime rate by district and year
       - Property crime trends by district
       - Quality-of-life offense patterns
       - Create multi-panel visualization
    
    6. **Save outputs:**
       - severity_classification.csv (overall distribution)
       - severity_by_district.csv
       - severity_by_year.csv
       - severity_by_hour.csv
       - offense_diversity_by_district.csv
       - severity_distribution.png (pie chart)
       - severity_by_district_stacked.png
       - severity_trends_20yr.png
       - severity_by_hour_heatmap.png
       - offense_diversity_map.png
    
    Document severity classification rationale and any limitations.
  </action>
  <verify>Severity classification applied; geographic and temporal patterns analyzed; diversity indices calculated; 5+ figures saved</verify>
  <done>Severity classification complete with cross-cutting geographic and temporal analysis</done>
</task>

<task type="auto">
  <name>Task 3: Offense Trends and Evolution Analysis</name>
  <files>notebooks/05_offense_breakdown.ipynb</files>
  <action>
    Analyze offense trends over 20 years and offense evolution patterns:
    
    1. **Overall offense trends:**
       - Time series for each major UCR category (violent, property, other)
       - Calculate trend slopes with confidence intervals
       - Identify which categories are increasing vs. decreasing
       - Statistical significance testing for trends
    
    2. **Specific offense trends:**
       - Top 10 most common offenses: trend over time
       - Are certain offenses becoming more/less common?
       - Create small multiples line chart for top offenses
       - Save offense_trends.csv with slopes and significance
    
    3. **Offense composition changes:**
       - Calculate offense mix by year (% of total for each category)
       - Has the crime portfolio shifted over time?
       - Create stacked area chart: year × offense category
       - Document structural shifts (e.g., decline in property crime, rise in quality-of-life)
    
    4. **Emerging and declining offenses:**
       - Calculate percent change 2006-2010 vs. 2021-2025
       - Identify fastest growing offense types
       - Identify fastest declining offense types
       - Create diverging bar chart: change by offense type
    
    5. **Seasonality by offense type:**
       - Do violent crimes have stronger seasonality than property crimes?
       - Calculate seasonal amplitude by offense category
       - Compare summer vs. winter by offense type
       - Create seasonal comparison chart
    
    6. **Offense co-occurrence analysis:**
       - Which offenses tend to occur in the same districts?
       - Correlation matrix of offense types by district
       - Identify offense clusters
    
    7. **Save outputs:**
       - offense_trends.csv (trend statistics with CIs)
       - offense_composition_by_year.csv
       - offense_change_2006_2025.csv
       - seasonality_by_offense.csv
       - offense_correlation_matrix.csv
       - offense_trends_by_category.png
       - top_offenses_trends.png
       - offense_composition_stacked_area.png
       - offense_change_diverging.png
       - seasonality_by_offense.png
       - offense_correlation_heatmap.png
    
    8. **Notebook conclusion:**
       - Executive summary of offense findings
       - Key trends: which offenses are up/down
       - Severity distribution insights
       - Validation against expected patterns
       - Recommendations for dashboard offense visualizations
       - Data quality notes (UCR coding changes over time?)
    
    Ensure all trends include confidence intervals and statistical significance.
  </action>
  <verify>Offense trends calculated with CIs; composition changes documented; seasonality analyzed; 6+ figures saved; notebook runs end-to-end</verify>
  <done>Complete offense breakdown with 20-year trends, severity analysis, and evolution patterns; all OFF requirements addressed</done>
</task>

</tasks>

<verification>
- [ ] Notebook 05 runs without errors from top to bottom
- [ ] UCR codes mapped and documented
- [ ] Offense distribution matches expected hierarchy (violent ~10%, property ~20%)
- [ ] Severity classification applied (violent/property/other)
- [ ] Trends by offense category calculated with CIs
- [ ] 8+ publication-quality figures saved to output/figures/offense/
- [ ] Offense trends include statistical significance
- [ ] Seasonality analyzed by offense type
- [ ] Data quality issues with UCR coding documented
</verification>

<success_criteria>
- Notebook 05 complete with comprehensive offense breakdown
- UCR code mapping validated against standard FBI categories
- Offense distribution reasonable (matches expected hierarchy)
- Severity classification (violent/property/other) with geographic/temporal patterns
- 20-year trends by offense category with confidence intervals
- Offense composition changes documented (structural shifts)
- Seasonality patterns by offense type
- 8+ publication-quality figures generated
- All offense requirements (OFF-01 to OFF-05) addressed
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-04-SUMMARY.md`
</output>
