---
phase: 02-core-analysis
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - notebooks/03_temporal_analysis.ipynb
  - output/figures/temporal/
  - output/tables/temporal/
autonomous: true

must_haves:
  truths:
    - "20-year trend is quantified with confidence intervals"
    - "Seasonal patterns are decomposed and visualized (STL)"
    - "Day-of-week and hour-of-day patterns are documented"
    - "Trends by crime type show differential patterns"
    - "All temporal figures are publication-quality"
  artifacts:
    - path: "notebooks/03_temporal_analysis.ipynb"
      provides: "Complete temporal analysis with STL decomposition"
      min_lines: 250
    - path: "output/figures/temporal/"
      provides: "Temporal visualizations"
      count: 10
    - path: "output/tables/temporal/seasonal_factors.csv"
      provides: "Monthly seasonal factors from STL"
    - path: "output/tables/temporal/trend_statistics.csv"
      provides: "Trend slopes and significance by crime type"
  key_links:
    - from: "notebooks/03_temporal_analysis.ipynb"
      to: "data/processed/crime_incidents_cleaned.parquet"
      via: "pd.read_parquet()"
      pattern: "read_parquet.*cleaned"
    - from: "notebooks/03_temporal_analysis.ipynb"
      to: "statsmodels.tsa.seasonal.STL"
      via: "STL decomposition"
      pattern: "STL.*period.*12"
---

<objective>
Conduct comprehensive temporal analysis of Philadelphia crime data (2006-2026) including 20-year trends, seasonal decomposition, day/hour patterns, and crime-type-specific trends.

Purpose: Answer TEMP-01 through TEMP-07 requirements; establish temporal baseline for dashboard and report; validate against known Philadelphia patterns (summer peaks, weekday variation).
Output: Notebook 03 with STL decomposition, trend analysis, seasonal factors, and 10+ publication-quality temporal figures.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@.planning/phases/02-core-analysis/02-CONTEXT.md
@scripts/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data Preparation and Time Series Construction</name>
  <files>notebooks/03_temporal_analysis.ipynb</files>
  <action>
    Create notebook 03_temporal_analysis.ipynb with temporal data preparation:
    
    1. Import required libraries:
       - pandas, numpy, matplotlib, seaborn
       - statsmodels.tsa.seasonal.STL
       - scipy.stats for trend significance testing
       - scripts/config.py
    
    2. Load cleaned data from data/processed/crime_incidents_cleaned.parquet
    
    3. Ensure datetime format and exclude last 30 days (reporting lag)
    
    4. Create multiple time series aggregations:
       - Monthly counts (for STL decomposition)
       - Annual counts (for long-term trends)
       - Weekly counts (for medium-term patterns)
    
    5. Handle missing dates:
       - Use reindex() with fill_value=0 for complete time series
       - Document any gaps in the data
    
    6. Create crime-type-specific time series:
       - Violent crimes (UCR codes per config)
       - Property crimes (UCR codes per config)
       - Other/quality-of-life crimes
    
    7. Configure matplotlib for publication quality (300 DPI, viridis palette)
    
    Save intermediate time series to output/tables/temporal/ for potential reuse.
  </action>
  <verify>Time series created with no missing months; monthly, annual, and weekly aggregations complete; crime-type splits validated</verify>
  <done>Notebook created with complete time series data ready for STL decomposition and trend analysis</done>
</task>

<task type="auto">
  <name>Task 2: STL Decomposition and Seasonal Analysis</name>
  <files>notebooks/03_temporal_analysis.ipynb</files>
  <action>
    Implement STL decomposition and seasonal analysis per 02-RESEARCH.md Pattern 1:
    
    1. **STL Decomposition (overall crime):**
       - Use STL(monthly_counts, period=12, robust=True)
       - Extract trend, seasonal, and residual components
       - Create 4-panel decomposition plot (original, trend, seasonal, residual)
    
    2. **Seasonal factor calculation:**
       - Group seasonal component by month
       - Calculate mean seasonal factor for each month
       - Compute seasonality magnitude: (summer peak - winter low) / overall mean * 100
       - Save seasonal_factors.csv to output/tables/temporal/
    
    3. **Crime-type-specific decomposition:**
       - Repeat STL for violent, property, and other crime categories
       - Compare seasonal patterns across crime types
       - Create comparative seasonal plot
    
    4. **Trend quantification:**
       - Fit linear regression to trend component
       - Calculate annual change rate
       - Compute 95% confidence intervals for trend slope
       - Test trend significance (p-value)
       - Save trend_statistics.csv to output/tables/temporal/
    
    5. **Save figures:**
       - stl_decomposition_overall.png (4-panel plot)
       - seasonal_factors_by_type.png (comparative seasonal)
       - trend_comparison_by_type.png
    
    6. Document findings:
       - Seasonality magnitude (e.g., "Summer sees X% more incidents than winter")
       - Trend direction and significance
       - Comparison to known Philadelphia patterns
  </action>
  <verify>STL decomposition runs successfully; seasonal factors calculated; trend statistics include CIs and p-values; 3+ figures saved</verify>
  <done>STL decomposition complete; seasonal patterns quantified; trends documented with statistical significance</done>
</task>

<task type="auto">
  <name>Task 3: Day/Hour Patterns and Crime-Type Trends</name>
  <files>notebooks/03_temporal_analysis.ipynb</files>
  <action>
    Analyze day-of-week and hour-of-day patterns plus detailed crime-type trends:
    
    1. **Day-of-week analysis:**
       - Aggregate incidents by day of week
       - Calculate weekend vs. weekday difference
       - Create bar chart with error bars (95% CI)
       - Test significance of weekend effect
    
    2. **Hour-of-day analysis:**
       - Aggregate incidents by hour (0-23)
       - Identify peak hours by crime type
       - Create line plot with multiple series (overall, violent, property)
    
    3. **Day × Hour heatmap:**
       - Create 7×24 heatmap (day of week × hour)
       - Use YlOrRd or viridis colormap
       - Annotate peak periods
       - Save as hour_day_heatmap.png
    
    4. **Crime-type-specific trends:**
       - 20-year trend for each major UCR category
       - Rate of change comparison (which types increasing/decreasing)
       - Statistical significance for each trend
       - Create multi-line trend plot
    
    5. **Recent trend analysis (last 5 years):**
       - Focus on 2020-2025 to identify recent patterns
       - Compare pre/post COVID if data permits
       - Document any structural breaks
    
    6. **Save outputs:**
       - day_of_week_patterns.png
       - hour_of_day_patterns.png
       - crime_type_trends_20yr.png
       - recent_trends_5yr.png
       - temporal_summary_stats.csv (all calculated statistics)
    
    7. **Notebook conclusion:**
       - Executive summary of temporal findings
       - Key statistics table (trend slopes, seasonal magnitudes, peak hours)
       - Validation against expected patterns
       - Recommendations for dashboard temporal visualizations
    
    Ensure all statistics include confidence intervals or p-values per STAT-04.
  </action>
  <verify>All temporal patterns analyzed; 10+ figures saved; summary statistics include CIs; notebook runs end-to-end</verify>
  <done>Complete temporal analysis with trends, seasonality, day/hour patterns, and crime-type breakdowns; all findings statistically validated</done>
</task>

</tasks>

<verification>
- [ ] Notebook 03 runs without errors from top to bottom
- [ ] STL decomposition implemented with period=12, robust=True
- [ ] Seasonal factors calculated and saved to CSV
- [ ] Trend statistics include 95% CIs and p-values
- [ ] Day-of-week and hour-of-day patterns documented
- [ ] Crime-type trends show differential patterns
- [ ] 10+ publication-quality figures saved to output/figures/temporal/
- [ ] Findings align with known Philadelphia patterns (summer peaks confirmed)
</verification>

<success_criteria>
- Notebook 03 complete with comprehensive temporal analysis
- STL decomposition showing trend, seasonal, and residual components
- Seasonality magnitude quantified (summer vs winter difference)
- 20-year trend with annual change rate and confidence intervals
- Day/hour heatmap showing peak crime periods
- Crime-type-specific trends with statistical significance
- 10+ publication-quality figures generated
- All temporal requirements (TEMP-01 to TEMP-07) addressed
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-02-SUMMARY.md`
</output>
