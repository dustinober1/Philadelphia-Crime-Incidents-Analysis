---
phase: 02-core-analysis
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - notebooks/07_cross_factor_analysis.ipynb
  - output/figures/cross_factor/
  - output/tables/cross_factor/
autonomous: true

must_haves:
  truths:
    - "Temporal×offense interactions are analyzed and visualized"
    - "Geographic×offense patterns are tested for independence"
    - "Temporal×geographic interactions are documented"
    - "Chi-square tests with effect sizes for all categorical interactions"
    - "Correlation matrices for continuous variables"
  artifacts:
    - path: "notebooks/07_cross_factor_analysis.ipynb"
      provides: "Complete cross-factor interaction analysis"
      min_lines: 300
    - path: "output/figures/cross_factor/"
      provides: "Cross-factor visualizations"
      count: 10
    - path: "output/tables/cross_factor/interaction_tests.csv"
      provides: "Statistical test results for all interactions"
    - path: "output/tables/cross_factor/correlation_matrix.csv"
      provides: "Variable correlation matrix"
  key_links:
    - from: "notebooks/07_cross_factor_analysis.ipynb"
      to: "data/processed/crime_incidents_cleaned.parquet"
      via: "pd.read_parquet()"
      pattern: "read_parquet.*cleaned"
    - from: "notebooks/07_cross_factor_analysis.ipynb"
      to: "scipy.stats.chi2_contingency"
      via: "chi-square tests for independence"
      pattern: "chi2_contingency"
    - from: "notebooks/07_cross_factor_analysis.ipynb"
      to: "statsmodels.stats.multitest.multipletests"
      via: "multiple comparison correction"
      pattern: "multipletests"
---

<objective>
Conduct comprehensive cross-factor analysis examining interactions between temporal, geographic, and offense dimensions with rigorous statistical testing.

Purpose: Answer CROSS-01 through CROSS-05 requirements; identify how crime patterns vary across multiple dimensions simultaneously; test for statistical independence; generate interaction visualizations for dashboard and report.
Output: Notebook 07 with chi-square tests, correlation analyses, interaction heatmaps, and 10+ publication-quality figures.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@.planning/phases/02-core-analysis/02-CONTEXT.md
@scripts/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data Preparation and Cross-Factor Framework</name>
  <files>notebooks/07_cross_factor_analysis.ipynb</files>
  <action>
    Create notebook 07_cross_factor_analysis.ipynb with cross-factor analysis framework:
    
    1. Import required libraries:
       - pandas, numpy, matplotlib, seaborn
       - scipy.stats (chi2_contingency, pearsonr, spearmanr)
       - statsmodels.stats.multitest (multipletests)
       - scripts/config.py
    
    2. Load cleaned data from data/processed/crime_incidents_cleaned.parquet
    
    3. **Create factor variables:**
       - Temporal factors: year, month, season, day_of_week, hour, is_weekend, is_night (22h-06h)
       - Geographic factors: district, district_category (high/medium/low from disparity analysis)
       - Offense factors: ucr_category (violent/property/other), severity_score
    
    4. **Cross-factor design matrix:**
       - Document all pairwise combinations to test
       - Temporal × Offense: 6 combinations
       - Geographic × Offense: 4 combinations
       - Temporal × Geographic: 6 combinations
       - Total: 16 primary interaction tests
    
    5. **Statistical testing framework:**
       - Chi-square test for independence (categorical × categorical)
       - ANOVA F-test (categorical × continuous)
       - Correlation analysis (continuous × continuous)
       - Effect sizes: Cramer's V, eta-squared, Pearson r
       - Bonferroni correction for multiple tests (16 tests)
    
    6. **Output structure setup:**
       - Create output/tables/cross_factor/ directory
       - Create output/figures/cross_factor/ directory
       - Initialize results DataFrame for tracking all tests
    
    7. Configure matplotlib for publication quality
    
    Document the cross-factor testing framework and hypotheses.
  </action>
  <verify>Factor variables created; testing framework defined; 16+ interaction tests planned; output directories ready</verify>
  <done>Notebook created with cross-factor framework and statistical testing plan</done>
</task>

<task type="auto">
  <name>Task 2: Temporal×Offense and Geographic×Offense Interactions</name>
  <files>notebooks/07_cross_factor_analysis.ipynb</files>
  <action>
    Implement temporal×offense and geographic×offense interaction analyses per 02-RESEARCH.md Example 4:
    
    1. **Temporal × Offense interactions:**
       
       a. **Season × Offense type:**
          - Contingency table: season (4) × offense category (3)
          - Chi-square test for independence
          - Calculate Cramer's V (effect size)
          - Standardized residuals to identify specific associations
          - Heatmap visualization
       
       b. **Day of week × Offense type:**
          - Contingency table: day (7) × offense category (3)
          - Chi-square test, Cramer's V, standardized residuals
          - Heatmap visualization
       
       c. **Hour × Offense type:**
          - Contingency table: hour (24) × offense category (3)
          - Chi-square test, Cramer's V
          - Heatmap visualization (24×3)
       
       d. **Year × Offense type (trend interaction):**
          - Test if offense composition changed over time
          - Chi-square test for homogeneity
          - Line plot: offense proportions by year
    
    2. **Geographic × Offense interactions:**
       
       a. **District × Offense type:**
          - Contingency table: district (22) × offense category (3)
          - Chi-square test (large table, expect significance)
          - Cramer's V
          - Stacked bar chart by district
       
       b. **District category × Offense type:**
          - Contingency table: district_cat (3) × offense category (3)
          - Chi-square test, Cramer's V
          - Do high-crime districts have different offense mixes?
       
       c. **Hotspot vs. non-hotspot × Offense type:**
          - Define hotspot areas from geographic analysis
          - Compare offense distributions
          - Chi-square test, Cramer's V
    
    3. **Save test results:**
       - interaction_tests.csv with columns:
         * test_name
         * factor1, factor2
         * test_type (chi2, anova, correlation)
         * statistic, p_value
         * effect_size_metric, effect_size_value
         * significant (after Bonferroni correction)
         * interpretation
    
    4. **Save visualizations:**
       - season_offense_heatmap.png
       - day_offense_heatmap.png
       - hour_offense_heatmap.png
       - year_offense_trends.png
       - district_offense_stacked.png
       - district_category_offense.png
       - hotspot_offense_comparison.png
    
    Document findings: which interactions are significant and what they mean.
  </action>
  <verify>Temporal×offense interactions tested (4 tests); geographic×offense interactions tested (3 tests); chi-square statistics and effect sizes calculated; 7+ figures saved</verify>
  <done>Temporal×offense and geographic×offense interactions analyzed with statistical tests and visualizations</done>
</task>

<task type="auto">
  <name>Task 3: Temporal×Geographic Interactions and Correlation Analysis</name>
  <files>notebooks/07_cross_factor_analysis.ipynb</files>
  <action>
    Implement temporal×geographic interactions and comprehensive correlation analysis:
    
    1. **Temporal × Geographic interactions:**
       
       a. **District × Season:**
          - Contingency table: district (22) × season (4)
          - Chi-square test: do districts have different seasonal patterns?
          - Cramer's V
          - Heatmap: district × season
       
       b. **District × Year (trend differences):**
          - Test if districts have different temporal trends
          - ANOVA: crime rate ~ district × year
          - Line plot: trends by district category
       
       c. **District × Day of week:**
          - Contingency table: district (22) × day (7)
          - Chi-square test: do districts have different weekly patterns?
          - Heatmap visualization
       
       d. **District × Hour:**
          - Aggregate to district × hour patterns
          - Heatmap: top 10 districts × hour
          - Identify districts with unusual hourly patterns
    
    2. **Correlation analysis:**
       
       a. **Variable correlation matrix:**
          - Create numeric variables: year, month, hour, day_of_week, district_crime_rate
          - Calculate Pearson correlation matrix
          - Calculate Spearman rank correlation (for non-linear relationships)
          - Save correlation_matrix.csv
          - Create correlation heatmap with annotations
       
       b. **Temporal autocorrelation:**
          - Test for serial correlation in time series
          - ACF/PACF plots for monthly crime counts
          - Document temporal dependence
       
       c. **Spatial correlation:**
          - Reference geographic analysis Moran's I results
          - Document spatial autocorrelation findings
    
    3. **Multi-factor analysis:**
       
       a. **Three-way interactions:**
          - District × Season × Offense type (subset to top 5 districts)
          - Visualize as faceted heatmaps
       
       b. **Regression analysis (exploratory):**
          - Predict crime count ~ district + month + offense_type
          - Document R-squared and significant predictors
          - Note: This is descriptive, not causal
    
    4. **Multiple comparison correction:**
       - Collect all p-values from interaction tests
       - Apply Bonferroni correction (family-wise error rate)
       - Update interaction_tests.csv with corrected p-values
       - Identify truly significant interactions
    
    5. **Save outputs:**
       - district_season_heatmap.png
       - district_trends_comparison.png
       - district_day_heatmap.png
       - district_hour_heatmap.png
       - correlation_matrix_pearson.png
       - correlation_matrix_spearman.png
       - temporal_acf_pacf.png
       - three_way_interaction_faceted.png
       - interaction_tests.csv (final with corrections)
       - correlation_matrix.csv
    
    6. **Notebook conclusion:**
       - Executive summary of cross-factor findings
       - Significant interactions table (after correction)
       - Effect sizes interpretation
       - Key insights: which factors interact most strongly?
       - Recommendations for dashboard (which interactions to visualize)
       - Limitations: multiple testing, ecological fallacy, correlation ≠ causation
       - Synthesis: how do temporal, geographic, and offense factors combine?
    
    Ensure all findings are properly caveated and avoid causal language.
  </action>
  <verify>Temporal×geographic interactions tested (4 tests); correlation matrices calculated; multiple comparison correction applied; 8+ figures saved; notebook runs end-to-end</verify>
  <done>Complete cross-factor analysis with all interactions tested, correlations analyzed, and multiple comparison correction applied; all CROSS requirements addressed</done>
</task>

</tasks>

<verification>
- [ ] Notebook 07 runs without errors from top to bottom
- [ ] Temporal×offense interactions analyzed (season, day, hour, year)
- [ ] Geographic×offense interactions analyzed (district, category, hotspot)
- [ ] Temporal×geographic interactions analyzed (district×season, district×year, etc.)
- [ ] Chi-square tests with Cramer's V effect sizes for all categorical interactions
- [ ] Correlation matrices (Pearson and Spearman) calculated
- [ ] Bonferroni correction applied to all interaction tests
- [ ] 10+ publication-quality figures saved to output/figures/cross_factor/
- [ ] interaction_tests.csv with all test results and corrected p-values
- [ ] Findings interpretable and align with domain knowledge
</verification>

<success_criteria>
- Notebook 07 complete with comprehensive cross-factor analysis
- 16+ interaction tests performed (temporal×offense, geographic×offense, temporal×geographic)
- Chi-square tests with Cramer's V effect sizes
- Correlation matrices for continuous variables
- Multiple comparison correction (Bonferroni) applied
- 10+ publication-quality figures generated
- interaction_tests.csv documenting all statistical tests
- Cross-factor interactions are interpretable and align with criminology knowledge
- All cross-factor requirements (CROSS-01 to CROSS-05) addressed
- No contradictions with findings from other notebooks
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-06-SUMMARY.md`
</output>
