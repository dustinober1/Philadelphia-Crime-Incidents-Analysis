---
phase: 02-core-analysis
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - notebooks/04_geographic_analysis.ipynb
  - output/figures/geographic/
  - output/tables/geographic/
  - data/processed/philly_police_districts.shp (if downloaded)
autonomous: true

must_haves:
  truths:
    - "Crime hotspots are identified using KDE heatmaps"
    - "District-level crime rates are calculated and mapped"
    - "Spatial autocorrelation is tested with Moran's I"
    - "Geographic patterns are stable across sensitivity tests"
    - "All maps use proper projections (EPSG:2272 for analysis)"
  artifacts:
    - path: "notebooks/04_geographic_analysis.ipynb"
      provides: "Complete geographic analysis with spatial statistics"
      min_lines: 300
    - path: "output/figures/geographic/"
      provides: "Geographic visualizations"
      count: 10
    - path: "output/tables/geographic/district_profiles.csv"
      provides: "Crime statistics by district"
    - path: "output/tables/geographic/spatial_autocorrelation.csv"
      provides: "Moran's I results by crime type"
  key_links:
    - from: "notebooks/04_geographic_analysis.ipynb"
      to: "data/processed/crime_incidents_cleaned.parquet"
      via: "pd.read_parquet()"
      pattern: "read_parquet.*cleaned"
    - from: "notebooks/04_geographic_analysis.ipynb"
      to: "esda.Moran"
      via: "spatial autocorrelation test"
      pattern: "Moran.*weights"
    - from: "notebooks/04_geographic_analysis.ipynb"
      to: "scipy.stats.gaussian_kde"
      via: "KDE heatmap generation"
      pattern: "gaussian_kde"
---

<objective>
Conduct comprehensive geographic analysis of Philadelphia crime data including hotspot identification, district profiles, KDE heatmaps, and spatial autocorrelation testing.

Purpose: Answer GEO-01 through GEO-07 requirements; identify geographic crime patterns; establish spatial foundation for dashboard maps; validate hotspot stability.
Output: Notebook 04 with KDE heatmaps, district choropleths, Moran's I analysis, and 10+ publication-quality geographic figures.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-analysis/02-RESEARCH.md
@.planning/phases/02-core-analysis/02-CONTEXT.md
@scripts/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Data Preparation and District Boundaries</name>
  <files>notebooks/04_geographic_analysis.ipynb</files>
  <action>
    Create notebook 04_geographic_analysis.ipynb with geographic data preparation:
    
    1. Import required libraries:
       - pandas, numpy, matplotlib, seaborn
       - geopandas for spatial operations
       - scipy.stats.gaussian_kde for KDE
       - esda, libpysal for spatial statistics
       - scripts/config.py
    
    2. Load cleaned data from data/processed/crime_incidents_cleaned.parquet
    
    3. Filter to records with valid coordinates (lat/lng not null)
    
    4. **Acquire Philadelphia police district boundaries:**
       - Attempt to download from OpenDataPhilly or similar source
       - If unavailable, create placeholder note for manual acquisition
       - Document source and date of boundary file
       - Save to data/processed/philly_police_districts.shp (or note need for manual download)
    
    5. **Create GeoDataFrame:**
       - Convert lat/lng to GeoDataFrame with CRS EPSG:4326
       - Project to EPSG:2272 (PA South State Plane) for accurate distance calculations
       - Document projection rationale (02-RESEARCH.md anti-pattern: KDE on raw lat/lon)
    
    6. **District-level aggregation:**
       - Group by dc_dist to calculate crime counts per district
       - Calculate crime rates (per 100k population if population data available, else note limitation)
       - Create district statistics DataFrame
    
    7. Configure matplotlib for publication quality
    
    Document data coverage: % of records with valid coordinates by crime type.
  </action>
  <verify>GeoDataFrame created with proper CRS; district boundaries loaded or documented for manual acquisition; coordinate coverage calculated</verify>
  <done>Notebook created with geographic data prepared, district boundaries handled, and spatial data structures ready</done>
</task>

<task type="auto">
  <name>Task 2: Hotspot Analysis and KDE Heatmaps</name>
  <files>notebooks/04_geographic_analysis.ipynb</files>
  <action>
    Implement hotspot identification using Kernel Density Estimation per 02-RESEARCH.md Pattern 3:
    
    1. **Overall crime KDE:**
       - Sample 50,000 points for performance (per 02-RESEARCH.md)
       - Use scipy.stats.gaussian_kde with bw_method='scott'
       - Project coordinates to EPSG:2272 before KDE (accurate distances)
       - Create evaluation grid (200Ã—200 resolution)
       - Generate contour plot with filled contours
       - Overlay sample points with low alpha
       - Save as kde_hotspot_overall.png
    
    2. **Crime-type-specific KDEs:**
       - Repeat KDE for violent crimes
       - Repeat KDE for property crimes
       - Create comparative visualization (side-by-side or overlay)
       - Save as kde_hotspot_by_type.png
    
    3. **Hexbin alternative:**
       - Create hexbin plot for full dataset (more scalable than KDE for 3.5M points)
       - Use geopandas/matplotlib hexbin
       - Save as hexbin_density.png
    
    4. **Hotspot identification:**
       - Define hotspot threshold (e.g., top 5% density values)
       - Identify hotspot coordinates
       - Cross-reference with known Philadelphia neighborhoods
       - Document stability: do hotspots persist across random samples?
    
    5. **Sensitivity analysis:**
       - Test hotspot stability with different sample sizes (25k, 50k, 100k)
       - Test with different bandwidth methods (scott vs silverman)
       - Document that hotspots are stable across variations
    
    6. **Save outputs:**
       - kde_hotspot_overall.png
       - kde_hotspot_violent.png
       - kde_hotspot_property.png
       - hexbin_density.png
       - hotspot_coordinates.csv (top hotspot locations)
    
    Document methodology and limitations (sampling, bandwidth selection).
  </action>
  <verify>KDE heatmaps generated for overall and crime-type-specific data; hexbin created; hotspot stability tested; 4+ figures saved</verify>
  <done>Hotspot analysis complete with KDE heatmaps, hexbin density, and stability validation</done>
</task>

<task type="auto">
  <name>Task 3: District Profiles and Spatial Autocorrelation</name>
  <files>notebooks/04_geographic_analysis.ipynb</files>
  <action>
    Implement district-level analysis and spatial autocorrelation testing per 02-RESEARCH.md Pattern 2:
    
    1. **District crime profiles:**
       - Calculate total crimes per district
       - Calculate crime rate per district (if population data available)
       - Identify top offense types per district
       - Calculate temporal trend per district (slope from linear regression)
       - Create district_profiles.csv with all metrics
    
    2. **District choropleth maps:**
       - Join district statistics to boundary GeoDataFrame
       - Create choropleth of crime counts by district
       - Create choropleth of crime rates by district (if rates available)
       - Add district labels and annotations
       - Save as district_choropleth_counts.png and district_choropleth_rates.png
    
    3. **Spatial autocorrelation (Moran's I):**
       - Create Queen contiguity weights (libpysal.weights.Queen)
       - Row-standardize weights (w.transform = 'r')
       - Calculate Moran's I for overall crime counts
       - Calculate Moran's I for crime rates (if available)
       - Report: Moran's I, expected I, z-score, p-value (norm and sim)
       - Create Moran scatter plot
       - Save spatial_autocorrelation.csv with results
       - Save moran_scatter_plot.png
    
    4. **Crime-type-specific spatial analysis:**
       - Calculate Moran's I for violent crime counts/rates
       - Calculate Moran's I for property crime counts/rates
       - Compare spatial clustering across crime types
    
    5. **District comparison analysis:**
       - Identify highest/lowest crime districts
       - Statistical comparison (t-tests with Bonferroni correction if comparing multiple districts)
       - Document disparities without ecological fallacy (use cautious language)
    
    6. **Save outputs:**
       - district_profiles.csv (comprehensive district statistics)
       - spatial_autocorrelation.csv (Moran's I results by crime type)
       - district_choropleth_counts.png
       - district_choropleth_rates.png (if applicable)
       - moran_scatter_plot.png
       - district_comparison.png (bar chart of top/bottom districts)
    
    7. **Notebook conclusion:**
       - Executive summary of geographic findings
       - Key hotspot locations documented
       - Spatial autocorrelation interpretation
       - District disparity summary (with ecological fallacy warning)
       - Recommendations for dashboard geographic visualizations
       - Limitations section (MAUP, population data, boundary changes)
    
    Ensure all findings reference specific figures/tables and include statistical significance where applicable.
  </action>
  <verify>District profiles saved; Moran's I calculated with significance tests; choropleth maps created; spatial autocorrelation results documented; notebook runs end-to-end</verify>
  <done>Complete geographic analysis with district profiles, spatial autocorrelation testing, and comprehensive visualization; all GEO requirements addressed</done>
</task>

</tasks>

<verification>
- [ ] Notebook 04 runs without errors from top to bottom
- [ ] KDE heatmaps generated with proper projection (EPSG:2272)
- [ ] Hotspot stability tested across sample sizes
- [ ] District choropleth maps created
- [ ] Moran's I calculated with Queen contiguity weights
- [ ] Spatial autocorrelation results include z-scores and p-values
- [ ] District profiles saved to CSV with comprehensive metrics
- [ ] 10+ publication-quality figures saved to output/figures/geographic/
- [ ] Ecological fallacy warning included in findings
- [ ] MAUP limitations documented
</verification>

<success_criteria>
- Notebook 04 complete with comprehensive geographic analysis
- KDE heatmaps showing crime hotspots (overall and by type)
- Hexbin density plot for full dataset
- District-level crime statistics and profiles
- Moran's I spatial autocorrelation testing with significance
- District choropleth maps (counts and rates)
- Hotspot stability validated across sensitivity tests
- 10+ publication-quality figures generated
- All geographic requirements (GEO-01 to GEO-07) addressed
- Limitations explicitly documented (MAUP, ecological fallacy, population data)
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-analysis/02-03-SUMMARY.md`
</output>
