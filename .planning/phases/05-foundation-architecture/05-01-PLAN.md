---
phase: 05-foundation-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - analysis/utils/__init__.py
  - analysis/utils/classification.py
  - analysis/utils/temporal.py
  - analysis/utils/spatial.py
  - analysis/__init__.py
autonomous: true

must_haves:
  truths:
    - "Developer can import from analysis.utils.classification, analysis.utils.temporal, analysis.utils.spatial"
    - "Developer can run mypy on analysis.utils modules with zero violations"
    - "All functions have type hints (mypy compatible)"
    - "All functions have Google-style docstrings"
  artifacts:
    - path: "analysis/utils/classification.py"
      provides: "Crime category classification functions"
      exports: ["classify_crime_category", "CRIME_CATEGORY_MAP"]
      min_lines: 40
    - path: "analysis/utils/temporal.py"
      provides: "Temporal feature extraction utilities"
      exports: ["extract_temporal_features"]
      min_lines: 30
    - path: "analysis/utils/spatial.py"
      provides: "Spatial utilities (moved from spatial_utils.py)"
      exports: ["clean_coordinates", "df_to_geodataframe"]
      min_lines: 200
  key_links:
    - from: "analysis/utils/__init__.py"
      to: "analysis/utils/classification.py"
      via: "from .classification import classify_crime_category"
      pattern: "from \\.classification import"
    - from: "analysis/utils/classification.py"
      to: "analysis/utils.py"
      via: "copied classify_crime_category function with type hints added"
      pattern: "def classify_crime_category"
---

<objective>
Extract and modularize utility functions from existing analysis files into a proper module structure with type hints and docstrings.

Purpose: Establish the foundation for script-based architecture by separating concerns into focused modules. The current utils.py and spatial_utils.py mix multiple concerns; extracting them into focused modules makes the codebase more maintainable and testable.

Output: Modular utils structure under analysis/utils/ with classification.py, temporal.py, and spatial.py modules, each with proper type hints and docstrings.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-foundation-architecture/05-RESEARCH.md

@analysis/utils.py
@analysis/spatial_utils.py
@analysis/config.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create utils module structure</name>
  <files>analysis/utils/__init__.py, analysis/utils/classification.py, analysis/utils/temporal.py</files>
  <action>
    Create the modular utils structure:

    1. Create `analysis/utils/` directory
    2. Create `analysis/utils/__init__.py` that exports:
       - classify_crime_category
       - extract_temporal_features
       - clean_coordinates (from spatial)
       - df_to_geodataframe (from spatial)
    3. Extract `classify_crime_category()` and `CRIME_CATEGORY_MAP` from `analysis/utils.py` into `analysis/utils/classification.py`
    4. Extract `extract_temporal_features()` from `analysis/utils.py` into `analysis/utils/temporal.py`
    5. Add type hints to all function signatures (use `|` for union types with Python 3.14)
    6. Add Google-style docstrings to all functions (Args, Returns, Raises sections)
    7. Keep original `analysis/utils.py` unchanged for now (will be deprecated in Phase 6)

    Type hint requirements:
    - Use `pd.DataFrame` for DataFrame parameters (with `from typing import Any` if needed for mypy)
    - Use `str | None` for optional string (Python 3.14 syntax, not `Optional[str]`)
    - Return types must be explicit

    Docstring format (Google style):
    ```python
    def classify_crime_category(df: pd.DataFrame) -> pd.DataFrame:
        \"\"\"Classify crimes into Violent, Property, or Other.

        Args:
            df: Dataset containing a ucr_general column.

        Returns:
            DataFrame with a crime_category column added.

        Raises:
            ValueError: If ucr_general column is not found.
        \"\"\"
    ```
  </action>
  <verify>
    Run: `python -c "from analysis.utils import classify_crime_category, extract_temporal_features; print('Imports work')"` and verify no import errors. Run: `mypy analysis/utils/classification.py analysis/utils/temporal.py` and verify zero type errors.
  </verify>
  <done>
    - analysis/utils/classification.py exists with classify_crime_category function
    - analysis/utils/temporal.py exists with extract_temporal_features function
    - analysis/utils/__init__.py exports both functions
    - All functions have type hints and Google-style docstrings
    - mypy passes with zero errors on new modules
  </done>
</task>

<task type="auto">
  <name>Task 2: Move spatial utilities to utils module</name>
  <files>analysis/utils/spatial.py, analysis/utils/__init__.py</files>
  <action>
    Move spatial utilities into the utils module structure:

    1. Create `analysis/utils/spatial.py` by copying content from `analysis/spatial_utils.py`
    2. Update imports in the new file to remove dependency on `analysis.phase2_config_loader` (replace with direct config import from analysis.config)
    3. Add type hints to all function signatures
    4. Add Google-style docstrings to all functions
    5. Update `analysis/utils/__init__.py` to export key spatial functions:
       - clean_coordinates
       - df_to_geodataframe
       - spatial_join_districts
       - spatial_join_tracts
       - load_boundaries
       - calculate_severity_score
    6. Keep original `analysis/spatial_utils.py` unchanged for now (will be deprecated in Phase 6)

    Important: When adding type hints for geopandas:
    - Use `gpd.GeoDataFrame` for GeoDataFrame parameters
    - Use `from typing import Any` if mypy complains about pandas operations
    - Use `# type: ignore` comments sparingly for geopandas-specific issues

    Coordinate bounds should be defined as constants in analysis/config.py (not loaded from phase2_config_loader):
    - PHILLY_LON_MIN = -75.3
    - PHILLY_LON_MAX = -74.95
    - PHILLY_LAT_MIN = 39.85
    - PHILLY_LAT_MAX = 40.15
  </action>
  <verify>
    Run: `python -c "from analysis.utils.spatial import clean_coordinates, df_to_geodataframe; print('Spatial imports work')"` and verify no import errors. Run: `mypy analysis/utils/spatial.py` and verify zero type errors (geopandas issues are OK with type: ignore).
  </verify>
  <done>
    - analysis/utils/spatial.py exists with all spatial functions from spatial_utils.py
    - analysis/utils/__init__.py exports spatial functions
    - All functions have type hints and Google-style docstrings
    - Coordinate bounds are constants in analysis/config.py
    - mypy passes with zero errors (excluding geopandas with type: ignore)
  </done>
</task>

<task type="auto">
  <name>Task 3: Update package exports</name>
  <files>analysis/__init__.py</files>
  <action>
    Update the main analysis package to export key utilities:

    1. Update `analysis/__init__.py` to export:
       - From analysis.utils.classification: classify_crime_category, CRIME_CATEGORY_MAP
       - From analysis.utils.temporal: extract_temporal_features
       - From analysis.utils.spatial: clean_coordinates, df_to_geodataframe
       - From analysis.config: CRIME_DATA_PATH, REPORTS_DIR, COLORS

    2. Add `__all__` list to explicitly define public API

    3. Add module docstring explaining the package structure

    Format:
    ```python
    \"\"\"Crime incidents analysis package.

    This package provides utilities for:
    - Data loading and validation (analysis.data)
    - Crime classification and temporal features (analysis.utils)
    - Spatial analysis and joins (analysis.utils.spatial)
    - Visualization (analysis.visualization)
    - ML models (analysis.models)

    Example:
        >>> from analysis import classify_crime_category, extract_temporal_features
        >>> from analysis.data import load_crime_data
    \"\"\"

    __version__ = "1.1.0"

    # Export key utilities
    from analysis.utils.classification import classify_crime_category, CRIME_CATEGORY_MAP
    from analysis.utils.temporal import extract_temporal_features
    from analysis.utils.spatial import clean_coordinates, df_to_geodataframe
    from analysis.config import CRIME_DATA_PATH, REPORTS_DIR, COLORS

    __all__ = [
        "classify_crime_category",
        "CRIME_CATEGORY_MAP",
        "extract_temporal_features",
        "clean_coordinates",
        "df_to_geodataframe",
        "CRIME_DATA_PATH",
        "REPORTS_DIR",
        "COLORS",
    ]
    ```
  </action>
  <verify>
    Run: `python -c "from analysis import classify_crime_category, clean_coordinates; print('Package exports work')"` and verify no import errors. Run: `python -c "import analysis; print(analysis.__all__)"` and verify __all__ list contains expected exports.
  </verify>
  <done>
    - analysis/__init__.py exports key utilities from utils modules
    - __all__ list defines public API
    - Package docstring explains module structure
    - Imports work from top-level analysis package
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify module structure:
   ```bash
   ls -la analysis/utils/
   # Should show: __init__.py, classification.py, temporal.py, spatial.py
   ```

2. Verify all imports work:
   ```bash
   python -c "from analysis.utils import classify_crime_category, extract_temporal_features, clean_coordinates; print('Success')"
   python -c "from analysis import classify_crime_category, clean_coordinates; print('Success')"
   ```

3. Verify type checking:
   ```bash
   mypy analysis/utils/
   # Should pass with zero errors (or only geopandas-related issues with type: ignore)
   ```
</verification>

<success_criteria>
1. Developer can import utilities from analysis.utils with type hints
2. All functions have Google-style docstrings
3. mypy type checking passes on new modules
4. Original utils.py and spatial_utils.py unchanged (backward compatible)
</success_criteria>

<output>
After completion, create `.planning/phases/05-foundation-architecture/05-01-SUMMARY.md`
</output>
