---
phase: 05-foundation-architecture
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - analysis/data/loading.py
  - analysis/data/validation.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Developer can run 'mypy analysis/data/' and see zero errors"
    - "mypy strict type checking passes for loading.py and validation.py"
  artifacts:
    - path: "analysis/data/loading.py"
      provides: "Data loading with caching"
      mypy_errors: 0
    - path: "analysis/data/validation.py"
      provides: "Pydantic data validation"
      mypy_errors: 0
  key_links:
    - from: "analysis/data/loading.py"
      to: "mypy strict mode"
      via: "Fixed type annotations, removed unused 'type: ignore'"
      pattern: "no mypy errors"
    - from: "analysis/data/validation.py"
      to: "mypy strict mode"
      via: "Fixed dict unpacking syntax"
      pattern: "no mypy errors"
---

<objective>
Fix mypy errors in data layer modules to enable strict type checking.

Purpose: The verification report identified 3 mypy errors blocking type checking from passing (loading.py:31 unused 'type: ignore', loading.py:92 no-any-return, validation.py:151 keywords must be strings). These errors prevent mypy from enforcing type safety and must be fixed for QUAL-04 compliance.

Output: analysis/data/loading.py and analysis/data/validation.py with zero mypy errors, passing strict type checking.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-foundation-architecture/05-VERIFICATION.md
@.planning/phases/05-foundation-architecture/05-02-SUMMARY.md

@analysis/data/loading.py
@analysis/data/validation.py
@pyproject.toml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix mypy error in loading.py line 31 (unused 'type: ignore')</name>
  <files>analysis/data/loading.py</files>
  <action>
    Fix the unused 'type: ignore' comment error at line 31:

    Current code (line 31):
    ```python
    if TYPE_CHECKING:
        import geopandas as gpd  # type: ignore
    ```

    Issue: The 'type: ignore' comment is unnecessary because TYPE_CHECKING imports are already conditionally compiled and mypy understands this pattern. The comment triggers warn_unused_ignores in strict mode.

    Fix: Remove the '# type: ignore' comment from line 31:
    ```python
    if TYPE_CHECKING:
        import geopandas as gpd
    ```

    Reference: This pattern is documented in mypy documentation - TYPE_CHECKING imports don't need 'type: ignore' because they're only evaluated during type checking, not runtime.
  </action>
  <verify>
    Run: `mypy analysis/data/loading.py --config-file pyproject.toml` and verify line 31 no longer produces "unused 'type: ignore' comment" error.
  </verify>
  <done>
    - Line 31 no longer has '# type: ignore' comment
    - mypy no longer reports unused ignore error for loading.py:31
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix mypy error in loading.py line 92 (no-any-return)</name>
  <files>analysis/data/loading.py</files>
  <action>
    Fix the "no-any-return" error at line 92 in the load_crime_data function:

    Current code (lines 34-92):
    ```python
    @memory.cache
    def _load_crime_data_parquet(clean: bool = True) -> pd.DataFrame:
        # ... implementation ...

    def load_crime_data(clean: bool = True) -> pd.DataFrame:
        """Load crime data from parquet with caching.

        Args:
            clean: If True, return cleaned data with invalid coordinates removed.

        Returns:
            DataFrame with crime incident data.
        """
        return _load_crime_data_parquet(clean=clean)
    ```

    Issue: The joblib @memory.cache decorator causes mypy to infer return type as Any instead of pd.DataFrame because joblib doesn't have type stubs.

    Fix: Add explicit type annotation to the internal cached function:
    ```python
    from typing import cast

    @memory.cache
    def _load_crime_data_parquet(clean: bool = True) -> Any:
        # ... implementation ...

    def load_crime_data(clean: bool = True) -> pd.DataFrame:
        """Load crime data from parquet with caching.

        Args:
            clean: If True, return cleaned data with invalid coordinates removed.

        Returns:
            DataFrame with crime incident data.
        """
        return cast(pd.DataFrame, _load_crime_data_parquet(clean=clean))
    ```

    Alternative: If cast doesn't resolve the issue, add '# type: ignore[no-any-return]' to suppress the specific error:
    ```python
    def load_crime_data(clean: bool = True) -> pd.DataFrame:  # type: ignore[no-any-return]
    ```

    Reference from 05-02-SUMMARY: The data layer uses joblib.Memory for caching with @memory.cache decorator. This is a known mypy limitation with decorators that don't have proper type stubs.
  </action>
  <verify>
    Run: `mypy analysis/data/loading.py --config-file pyproject.toml` and verify line 92 no longer produces "no-any-return" error.
  </verify>
  <done>
    - load_crime_data has explicit return type handling (cast or type ignore)
    - mypy no longer reports no-any-return error for loading.py:92
  </done>
</task>

<task type="auto">
  <name>Task 3: Fix mypy error in validation.py line 151 (keywords must be strings)</name>
  <files>analysis/data/validation.py</files>
  <action>
    Fix the "keywords must be strings" error at line 151 in the validate_crime_data function:

    Current code (lines 145-151):
    ```python
            # Convert row to dict and validate
            row_dict = row.to_dict()
            # Handle NaN values for optional fields
            for key, value in row_dict.items():
                if pd.isna(value):
                    row_dict[key] = None
            CrimeIncidentValidator(**row_dict)
    ```

    Issue: The `**row_dict` unpacking causes mypy to complain because row_dict has type dict[str, Any] (inferred from to_dict()), and Pydantic models require keyword arguments to be strings (which they are, but mypy can't verify this).

    Fix: Add explicit type annotation to row_dict:
    ```python
            # Convert row to dict and validate
            row_dict: dict[str, Any] = row.to_dict()
            # Handle NaN values for optional fields
            for key, value in row_dict.items():
                if pd.isna(value):
                    row_dict[key] = None
            CrimeIncidentValidator(**row_dict)
    ```

    If the explicit annotation doesn't resolve it, use a dict comprehension to ensure string keys:
    ```python
            # Convert row to dict and validate
            row_dict = {str(k): v for k, v in row.to_dict().items()}
            # Handle NaN values for optional fields
            for key, value in row_dict.items():
                if pd.isna(value):
                    row_dict[key] = None
            CrimeIncidentValidator(**row_dict)
    ```

    Reference from 05-02-SUMMARY: The validation module uses Pydantic for data validation with field-level validators. The validate_crime_data function processes DataFrames row by row.
  </action>
  <verify>
    Run: `mypy analysis/data/validation.py --config-file pyproject.toml` and verify line 151 no longer produces "keywords must be strings" error.
  </verify>
  <done>
    - row_dict has explicit type or string keys guaranteed
    - mypy no longer reports keywords error for validation.py:151
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify mypy passes on data layer:
   ```bash
   mypy analysis/data/loading.py analysis/data/validation.py --config-file pyproject.toml
   ```
   Expected: "Success: no issues found in 2 source files"

2. Verify mypy passes on entire analysis package:
   ```bash
   mypy analysis/ --config-file pyproject.toml
   ```
   Expected: No errors in loading.py or validation.py (other modules may have external package issues)

3. Verify imports still work:
   ```bash
   python -c "from analysis.data import load_crime_data, validate_crime_data; print('Imports work')"
   ```
   Expected: "Imports work"
</verification>

<success_criteria>
1. mypy analysis/data/loading.py passes with zero errors
2. mypy analysis/data/validation.py passes with zero errors
3. All imports continue to work after fixes
4. No new mypy errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/05-foundation-architecture/05-04-SUMMARY.md`
</output>
