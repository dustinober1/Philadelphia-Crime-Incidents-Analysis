---
phase: 05-foundation-architecture
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - requirements-dev.txt
  - pre-commit-config.yaml
  - .gitignore
autonomous: true

must_haves:
  truths:
    - "Developer can run 'black analysis/' and code is formatted consistently"
    - "Developer can run 'ruff check analysis/' and see linting errors"
    - "Developer can run 'mypy analysis/' and see type checking results"
    - "Developer can run 'pytest tests/' and tests execute with coverage report"
    - "Developer commits code and pre-commit hooks run automatically"
  artifacts:
    - path: "pyproject.toml"
      provides: "Centralized configuration for pytest, mypy, black, ruff"
      contains: "[tool.pytest.ini_options], [tool.mypy], [tool.black], [tool.ruff]"
      min_lines: 80
    - path: "requirements-dev.txt"
      provides: "Development dependencies for installation"
      contains: "pytest, pytest-cov, black, ruff, mypy, pre-commit, pydantic, joblib"
      min_lines: 20
    - path: "pre-commit-config.yaml"
      provides: "Pre-commit hooks configuration"
      contains: "repos for black, ruff, mypy, pytest"
      min_lines: 40
    - path: ".gitignore"
      provides: "Git ignore patterns for cache and build artifacts"
      contains: ".cache/, .mypy_cache/, .ruff_cache/, .pytest_cache/"
      min_lines: 10
  key_links:
    - from: "pyproject.toml"
      to: "pytest"
      via: "[tool.pytest.ini_options] section with testpaths and addopts"
      pattern: "\\[tool\\.pytest\\.ini_options\\]"
    - from: "pyproject.toml"
      to: "mypy"
      via: "[tool.mypy] section with strict type checking"
      pattern: "\\[tool\\.mypy\\]"
    - from: "pyproject.toml"
      to: "black"
      via: "[tool.black] section with line-length=100"
      pattern: "\\[tool\\.black\\]"
    - from: "pyproject.toml"
      to: "ruff"
      via: "[tool.ruff] section with lint rules"
      pattern: "\\[tool\\.ruff\\]"
---

<objective>
Set up development tooling configuration for pytest, mypy, black, ruff, and pre-commit hooks to establish code quality standards.

Purpose: Establish quality standards early in Phase 5 so all new code follows consistent formatting, linting, and type checking rules. This configuration will be used throughout the v1.1 refactor and beyond.

Output: pyproject.toml with tool configurations, requirements-dev.txt for dependencies, pre-commit-config.yaml for git hooks, and updated .gitignore.
</objective>

<execution_context>
@/Users/dustinober/.claude/get-shit-done/workflows/execute-plan.md
@/Users/dustinober/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-foundation-architecture/05-RESEARCH.md

@environment.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pyproject.toml with tool configurations</name>
  <files>pyproject.toml</files>
  <action>
    Create pyproject.toml with centralized configuration for all quality tools:

    1. Create pyproject.toml at project root
    2. Add [tool.pytest.ini_options] section:
       - minversion = "8.0"
       - testpaths = ["tests"]
       - python_files = ["test_*.py"]
       - python_classes = ["Test*"]
       - python_functions = ["test_*"]
       - addopts = ["--cov=analysis", "--cov-report=term-missing", "--cov-report=html", "--cov-fail-under=90", "-ra"]
       - markers = ["slow: marks tests as slow", "integration: marks tests as integration tests"]
       - filterwarnings = ["error", "ignore::DeprecationWarning"]

    3. Add [tool.mypy] section:
       - python_version = "3.14"
       - warn_return_any = true
       - warn_unused_configs = true
       - disallow_untyped_defs = true
       - disallow_any_generics = true
       - check_untyped_defs = true
       - no_implicit_optional = true
       - warn_redundant_casts = true
       - warn_unused_ignores = true
       - warn_no_return = true
       - follow_imports = "normal"
       - ignore_missing_imports = false
       - strict_equality = true
       - Add [[tool.mypy.overrides]] for geopandas, prophet, shap, lightgbm, pingouin, streamlit with ignore_missing_imports = true

    4. Add [tool.black] section:
       - line-length = 100
       - target-version = ["py314"]
       - include = '\.pyi?$'
       - exclude = '''/(\.git|\.mypy_cache|\.ruff_cache|\.venv|build|dist|notebooks)/'''

    5. Add [tool.ruff] section:
       - line-length = 100
       - target-version = "py314"
       - src = ["analysis", "tests"]
       - Add [tool.ruff.lint] with select = ["E", "W", "F", "I", "B", "C4", "UP", "ARG", "SIM"]
       - ignore = ["E501", "B008", "B904"]
       - unfixable = ["B"]
       - Add [tool.ruff.lint.per-file-ignores] for "__init__.py" = ["F401"] and "tests/*" = ["ARG"]
       - Add [tool.ruff.lint.isort] with known-first-party = ["analysis"]

    6. Add [project] section with metadata:
       - name = "crime-incidents-philadelphia"
       - version = "1.1.0"
       - requires-python = ">=3.14"
       - description = "Crime incidents analysis for Philadelphia"

    Configuration:
    ```toml
    [project]
    name = "crime-incidents-philadelphia"
    version = "1.1.0"
    description = "Crime incidents analysis for Philadelphia"
    requires-python = ">=3.14"
    dependencies = [
        "pandas>=2.0",
        "geopandas>=0.14",
        "pyarrow>=21.0",
        "matplotlib>=3.8",
        "seaborn>=0.13",
        "scikit-learn>=1.3",
        "statsmodels>=0.14",
    ]

    [tool.pytest.ini_options]
    minversion = "8.0"
    testpaths = ["tests"]
    python_files = ["test_*.py"]
    python_classes = ["Test*"]
    python_functions = ["test_*"]
    addopts = [
        "--cov=analysis",
        "--cov-report=term-missing",
        "--cov-report=html",
        "--cov-fail-under=90",
        "--strict-markers",
        "--strict-config",
        "-ra",
    ]
    markers = [
        "slow: marks tests as slow (deselect with '-m \"not slow\"')",
        "integration: marks tests as integration tests",
    ]
    filterwarnings = [
        "error",
        "ignore::DeprecationWarning",
        "ignore::PendingDeprecationWarning",
    ]

    [tool.mypy]
    python_version = "3.14"
    warn_return_any = true
    warn_unused_configs = true
    disallow_untyped_defs = true
    disallow_any_generics = true
    check_untyped_defs = true
    no_implicit_optional = true
    warn_redundant_casts = true
    warn_unused_ignores = true
    warn_no_return = true
    follow_imports = "normal"
    ignore_missing_imports = false
    strict_equality = true

    [[tool.mypy.overrides]]
    module = [
        "streamlit.*",
        "prophet.*",
        "shap.*",
        "lightgbm.*",
        "pingouin.*",
    ]
    ignore_missing_imports = true

    [tool.black]
    line-length = 100
    target-version = ["py314"]
    include = '\.pyi?$'
    exclude = '''
    /(
        \.git
      | \.mypy_cache
      | \.ruff_cache
      | \.venv
      | build
      | dist
      | notebooks
    )/
    '''

    [tool.ruff]
    line-length = 100
    target-version = "py314"
    src = ["analysis", "tests"]

    [tool.ruff.lint]
    select = [
        "E",   # pycodestyle errors
        "W",   # pycodestyle warnings
        "F",   # pyflakes
        "I",   # isort
        "B",   # flake8-bugbear
        "C4",  # flake8-comprehensions
        "UP",  # pyupgrade
        "ARG", # flake8-unused-arguments
        "SIM", # flake8-simplify
    ]
    ignore = [
        "E501",  # line too long (handled by black)
        "B008",  # do not perform function calls in argument defaults
        "B904",  # raise without from inside except
    ]
    unfixable = ["B"]

    [tool.ruff.lint.per-file-ignores]
    "__init__.py" = ["F401"]  # Allow unused imports in __init__.py
    "tests/*" = ["ARG"]       # Allow unused arguments in tests

    [tool.ruff.lint.isort]
    known-first-party = ["analysis"]
    ```
  </action>
  <verify>
    Run: `pytest --version` and verify it reads config from pyproject.toml (should show "using pyproject.toml"). Run: `mypy --version` and verify mypy runs. Run: `black --version` and verify black runs. Run: `ruff --version` and verify ruff runs.
  </verify>
  <done>
    - pyproject.toml exists at project root
    - [tool.pytest.ini_options] configured with 90% coverage target
    - [tool.mypy] configured with strict type checking
    - [tool.black] configured with 100 char line length
    - [tool.ruff] configured with lint rules
    - [project] section with package metadata
    - All tools read configuration correctly
  </done>
</task>

<task type="auto">
  <name>Task 2: Create requirements-dev.txt with development dependencies</name>
  <files>requirements-dev.txt</files>
  <action>
    Create requirements-dev.txt with all development dependencies:

    1. Create requirements-dev.txt at project root
    2. Add pytest and pytest-cov (testing framework with coverage)
    3. Add black (code formatter)
    4. Add ruff (linter, replaces flake8+isort)
    5. Add mypy (type checker)
    6. Add pre-commit (git hooks framework)
    7. Add pydantic (data validation, via pip if not in conda)
    8. Add joblib (caching, via pip if not in conda)
    9. Add pandas-stubs and geopandas-stubs (type stubs for mypy)
    10. Add types-requests and types-PyYAML (type stubs for external libs)

    File content:
    ```
    # Development dependencies for Crime Incidents Philadelphia
    # Install with: pip install -r requirements-dev.txt
    # Or add to conda environment: conda install --file requirements-dev.txt

    # Testing
    pytest>=8.0
    pytest-cov>=6.0

    # Code quality
    black>=25.0
    ruff>=0.9
    mypy>=1.15

    # Type stubs for mypy
    pandas-stubs>=2.0
    geopandas-stubs>=1.0
    types-requests>=2.32
    types-PyYAML>=6.0

    # Git hooks
    pre-commit>=4.0

    # Data validation and caching (if not in conda)
    pydantic>=2.12
    joblib>=1.4
    ```

    Note: pydantic and joblib should be installed via conda if possible (conda install -c conda-forge pydantic joblib), but include in requirements-dev.txt for pip-only installations.
  </action>
  <verify>
    Run: `pip install -r requirements-dev.txt` and verify all packages install successfully. Run: `python -c "import pytest, black, ruff, mypy, pre_commit, pydantic, joblib; print('All imports work')"` and verify all imports work.
  </verify>
  <done>
    - requirements-dev.txt exists at project root
    - Contains pytest, pytest-cov, black, ruff, mypy, pre-commit
    - Contains type stubs for pandas, geopandas, requests, PyYAML
    - Contains pydantic and joblib
    - All packages install successfully via pip
  </done>
</task>

<task type="auto">
  <name>Task 3: Create pre-commit-config.yaml and update .gitignore</name>
  <files>pre-commit-config.yaml, .gitignore</files>
  <action>
    Create pre-commit hooks configuration and update .gitignore:

    1. Create pre-commit-config.yaml at project root
    2. Add pre-commit-hooks repo with:
       - trailing-whitespace
       - end-of-file-fixer
       - check-yaml
       - check-added-large-files
       - check-merge-conflict
       - debug-statements
    3. Add black repo with black hook
    4. Add ruff-pre-commit repo with ruff hook (args: --fix, --exit-non-zero-on-fix)
    5. Add mypy mirror repo with mypy hook
       - additional_dependencies: pandas-stubs, geopandas-stubs, types-requests, types-PyYAML, pydantic
    6. Add local pytest hook

    Pre-commit config:
    ```yaml
    repos:
      - repo: https://github.com/pre-commit/pre-commit-hooks
        rev: v5.0.0
        hooks:
          - id: trailing-whitespace
          - id: end-of-file-fixer
          - id: check-yaml
          - id: check-added-large-files
          - id: check-merge-conflict
          - id: debug-statements

      - repo: https://github.com/psf/black
        rev: 25.9.0
        hooks:
          - id: black
            language_version: python3.14

      - repo: https://github.com/astral-sh/ruff-pre-commit
        rev: v0.9.0
        hooks:
          - id: ruff
            args: [--fix, --exit-non-zero-on-fix]

      - repo: https://github.com/pre-commit/mirrors-mypy
        rev: v1.15.0
        hooks:
          - id: mypy
            additional_dependencies:
              - pandas-stubs>=2.0
              - geopandas-stubs>=1.0
              - types-requests
              - types-PyYAML
              - pydantic>=2.0
            args: [--config-file=pyproject.toml]

      - repo: local
        hooks:
          - id: pytest
            name: pytest
            entry: pytest
            language: system
            pass_filenames: false
            always_run: true
            args: [-x, -q, tests/]
    ```

    7. Update .gitignore to add:
       - .cache/
       - .mypy_cache/
       - .ruff_cache/
       - .pytest_cache/
       - htmlcov/ (coverage HTML reports)
       - .coverage (coverage data file)
       - .pre-commit-config.yaml (if not already tracked)
  </action>
  <verify>
    Run: `pre-commit install` and verify pre-commit hooks are installed. Run: `pre-commit run --all-files` and verify all hooks run (may fail on existing code, which is OK). Run: `git status` and verify .gitignore patterns work.
  </verify>
  <done>
    - pre-commit-config.yaml exists with black, ruff, mypy, pytest hooks
    - .gitignore updated with cache and build directories
    - pre-commit hooks install successfully
    - pre-commit run --all-files executes all hooks
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Verify pyproject.toml:
   ```bash
   cat pyproject.toml
   # Should have [tool.pytest.ini_options], [tool.mypy], [tool.black], [tool.ruff]
   ```

2. Verify tools read config:
   ```bash
   pytest --version | grep "pyproject.toml"
   mypy analysis/utils/ --config-file pyproject.toml
   black --check analysis/ --config pyproject.toml
   ruff check analysis/ --config pyproject.toml
   ```

3. Verify pre-commit:
   ```bash
   pre-commit install
   pre-commit run --all-files
   ```

4. Verify gitignore:
   ```bash
   cat .gitignore | grep -E "cache|mypy|ruff|pytest|coverage"
   ```
</verification>

<success_criteria>
1. pyproject.toml configures pytest, mypy, black, ruff
2. requirements-dev.txt lists all development dependencies
3. pre-commit-config.yaml sets up black, ruff, mypy, pytest hooks
4. .gitignore ignores cache and build artifacts
5. All tools can be installed and configured correctly
</success_criteria>

<output>
After completion, create `.planning/phases/05-foundation-architecture/05-03-SUMMARY.md`
</output>
