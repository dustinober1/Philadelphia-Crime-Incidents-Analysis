---
phase: 02-data-presentation
plan: "03"
type: execute
wave: 2
depends_on:
  - "02-01"
files_modified:
  - web/src/components/maps/MapPopup.tsx
  - web/src/components/maps/ChoroplethLayer.tsx
  - web/src/components/HeatmapLayer.tsx
  - web/src/components/MapContainer.tsx
  - web/src/app/map/page.tsx
autonomous: true
must_haves:
  truths:
    - User can click on map features (districts, tracts, hotspots) and see detailed popup with statistics
    - User can toggle between different map layers (districts, tracts, hotspots, corridors)
    - Map initializes zoomed out to show all of Philadelphia
    - Popup displays label, count, rate, trend indicators, and links to related data
  artifacts:
    - path: web/src/components/maps/MapPopup.tsx
      provides: Interactive popup with formatted statistics and trend indicators
      min_lines: 40
    - path: web/src/components/maps/ChoroplethLayer.tsx
      provides: Reusable choropleth fill layer with data-driven styling
      min_lines: 30
    - path: web/src/components/HeatmapLayer.tsx
      provides: Heatmap visualization using circle layer with radius interpolation
      min_lines: 25
    - path: web/src/components/MapContainer.tsx
      provides: Enhanced map container with improved popup interactions
      contains: "MapContainer|onClick|Popup"
  key_links:
    - from: web/src/app/map/page.tsx
      to: web/src/components/MapContainer.tsx
      via: Dynamic import with ssr: false
      pattern: "DynamicMap|MapContainer"
    - from: web/src/components/MapContainer.tsx
      to: web/src/components/maps/MapPopup.tsx
      via: Popup rendering on feature click
      pattern: "MapPopup"
    - from: web/src/components/MapContainer.tsx
      to: web/src/components/maps/ChoroplethLayer.tsx
      via: Source/Layer composition for district/tract polygons
      pattern: "ChoroplethLayer"
    - from: web/src/components/MapContainer.tsx
      to: react-map-gl
      via: Map component with interactiveLayerIds
      pattern: "react-map-gl/mapbox"
---

<objective>
Enhance interactive map experience with rich popups, layer controls, and spatial visualization types.

Purpose: Enable users to explore spatial crime patterns through interactive map navigation (pan, zoom, click) with informative popups showing statistics and trends.
Output: Enhanced map container with modular layers, rich popup content, and smooth user interactions.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-data-presentation-/02-RESEARCH.md
@.planning/phases/02-data-presentation-/02-CONTEXT.md
@web/src/components/MapContainer.tsx
@web/src/app/map/page.tsx
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MapPopup component with rich statistics display</name>
  <files>web/src/components/maps/MapPopup.tsx</files>
  <action>Create a map popup component that displays:
  - Feature label (district name, tract ID, etc.)
  - Incident count with proper formatting
  - Crime rate (if available)
  - Trend indicator with arrow (up/down) and percent change
  - Comparison to city average
  - Link to view details (anchor to #details or similar section)

Use react-map-gl Popup component as base. Accept `feature`, `longitude`, `latitude`, `onClose` props. Format numbers with toLocaleString.

Calculate trend indicator if trend data available in properties (previous_count vs current_count).

DO NOT: Create complex animations or external state management.</action>
  <verify>cd web && npm run typecheck</verify>
  <done>MapPopup component displays formatted statistics with trend indicators and proper positioning.</done>
</task>

<task type="auto">
  <name>Task 2: Create ChoroplethLayer component for district/tract visualization</name>
  <files>web/src/components/maps/ChoroplethLayer.tsx</files>
  <action>Create a reusable choropleth layer component using react-map-gl Source and Layer. Component should:
  - Accept `id`, `data` (GeoJSON), `valueProperty`, `colorScheme` props
  - Use Mapbox expressions for data-driven fill color interpolation
  - Include outline layer for polygon borders
  - Support color schemes: "blue" (default), "red", "green"

Use `["interpolate", ["linear"], ["coalesce", ["get", valueProperty], 0], ...]` for smooth color transitions.

Export as named export `ChoroplethLayer`.

DO NOT: Hand-roll GeoJSON parsing or coordinate transformations (Mapbox handles this).</action>
  <verify>cd web && npm run lint</verify>
  <done>ChoroplethLayer renders polygons with data-driven fill colors and proper borders.</done>
</task>

<task type="auto">
  <name>Task 3: Create HeatmapLayer component for hotspot visualization</name>
  <files>web/src/components/HeatmapLayer.tsx</files>
  <action>Create a heatmap layer component for visualizing incident density. Component should:
  - Accept `id`, `data` (GeoJSON Point features), `countProperty` props
  - Use circle layer with radius interpolation based on count
  - Apply semi-transparent fill for overlap visualization
  - Support color prop (default: red)

Use `["interpolate", ["linear"], ["coalesce", ["get", countProperty], 0], ...]` for circle radius.

Export as named export `HeatmapLayer`.

DO NOT: Use Mapbox heatmap layer (less performant); use circle layer instead.</action>
  <verify>cd web && npm run typecheck</verify>
  <done>HeatmapLayer renders point features with size-based circles for density visualization.</done>
</task>

<task type="auto">
  <name>Task 4: Refactor MapContainer to use new modular layers and MapPopup</name>
  <files>web/src/components/MapContainer.tsx</files>
  <action>Refactor MapContainer to:
  - Import and use ChoroplethLayer for districts/tracts
  - Import and use HeatmapLayer for hotspots
  - Replace inline popup JSX with MapPopup component
  - Pass relevant feature properties to MapPopup (label, count, rate, trend)
  - Ensure interactiveLayerIds includes all clickable layers
  - Keep existing layer toggle controls (districts/tracts/hotspots/corridors)

Maintain existing state management (activePolygon, showHotspots, showCorridors, popup).

DO NOT: Change the initial view state or map style.</action>
  <verify>cd web && npm run build</verify>
  <done>MapContainer uses modular layer components and displays rich popups on feature click.</done>
</task>

<task type="auto">
  <name>Task 5: Add layer control improvements to map page</name>
  <files>web/src/app/map/page.tsx</files>
  <action>Enhance the map page with:
  - Improved loading states during data fetch
  - Error handling for failed API requests
  - Better description text explaining map layers

Keep existing SWR data fetching for districts, tracts, hotspots, corridors. Maintain existing layout structure.

DO NOT: Add new API endpoints or change data fetching logic.</action>
  <verify>cd web && npm run build</verify>
  <done>Map page has improved loading/error states and clear layer descriptions.</done>
</task>

</tasks>

<verification>
- Run `cd web && npm run lint`
- Run `cd web && npm run typecheck`
- Run `cd web && npm run build`
- Manual QA: Visit /map, test clicking on districts/tracts, verify popup displays with statistics, test layer toggles, verify map zoom/pan works smoothly
- Verify popups close properly and don't cause map interaction issues
</verification>

<success_criteria>
- DATA-03 complete: Interactive maps with pan, zoom, and click interactions
- DATA-04 partial: Choropleth and heatmap visualization types implemented
- Popups display rich statistics with trend indicators
- Layer controls work smoothly without map rendering issues
- Map remains responsive and usable on mobile devices
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-presentation-/02-03-SUMMARY.md`.
</output>
