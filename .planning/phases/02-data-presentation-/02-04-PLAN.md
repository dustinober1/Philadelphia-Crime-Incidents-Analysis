---
phase: 02-data-presentation
plan: "04"
type: execute
wave: 2
depends_on: []
files_modified:
  - web/src/lib/csv-export.ts
  - web/src/components/DownloadButton.tsx
  - web/src/app/trends/page.tsx
  - web/src/app/policy/page.tsx
  - web/src/app/map/page.tsx
autonomous: true
must_haves:
  truths:
    - User can download data as JSON file with properly formatted content
    - User can download data as CSV file with UTF-8 BOM for Excel compatibility
    - Download button displays appropriate icon and format label
    - Downloaded files include metadata (timestamp, data version, processing notes)
  artifacts:
    - path: web/src/lib/csv-export.ts
      provides: CSV and JSON download utilities with proper encoding
      min_lines: 40
    - path: web/src/components/DownloadButton.tsx
      provides: Reusable download button component
      min_lines: 25
    - path: web/src/app/trends/page.tsx
      contains: "DownloadButton"
    - path: web/src/app/policy/page.tsx
      contains: "DownloadButton"
  key_links:
    - from: web/src/components/DownloadButton.tsx
      to: web/src/lib/csv-export.ts
      via: Import of downloadAsJson and downloadAsCsv functions
      pattern: "downloadAs(Json|Csv)"
    - from: web/src/app/trends/page.tsx
      to: web/src/components/DownloadButton.tsx
      via: Component import for annual/monthly data downloads
      pattern: "DownloadButton"
    - from: web/src/app/trends/page.tsx
      to: web/src/lib/csv-export.ts
      via: Direct import for embedding metadata in downloads
      pattern: "csv-export"
---

<objective>
Implement data download functionality for JSON and CSV export with proper metadata.

Purpose: Enable users to download crime data in JSON and CSV formats for external analysis, with proper encoding and metadata for reproducibility.
Output: Download utilities and reusable DownloadButton component integrated across analysis pages.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-data-presentation-/02-RESEARCH.md
@.planning/phases/02-data-presentation-/02-CONTEXT.md
@web/src/app/trends/page.tsx
@web/src/app/policy/page.tsx
@web/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV export utilities with proper encoding</name>
  <files>web/src/lib/csv-export.ts</files>
  <action>Create a utility module for CSV and JSON downloads. Implement:

1. `downloadAsJson(data: unknown[], filename: string): void`
   - Creates Blob with `application/json` content type
   - Uses `JSON.stringify(data, null, 2)` for pretty formatting
   - Triggers download via temporary anchor element

2. `downloadAsCsv(data: Record<string, unknown>[], filename: string): void`
   - Extracts headers from first object keys
   - Properly escapes values containing commas or quotes (wrap in quotes, double internal quotes)
   - Adds UTF-8 BOM (`\uFEFF`) for Excel compatibility
   - Creates Blob with `text/csv;charset=utf-8` content type
   - Handles empty arrays gracefully

Both functions should:
- Clean up temporary elements and revoke object URLs
- Use current date prefix in filename if not provided

DO NOT: Use external CSV libraries (handle escaping manually with proper algorithm).</action>
  <verify>cd web && npm run typecheck</verify>
  <done>csv-export.ts exports downloadAsJson and downloadAsCsv functions with proper types and encoding.</done>
</task>

<task type="auto">
  <name>Task 2: Create DownloadButton component with format selection</name>
  <files>web/src/components/DownloadButton.tsx</files>
  <action>Create a reusable download button component. Component should:
  - Accept `data`, `filename`, `format` props
  - Use lucide-react Download icon
  - Display label "Download JSON" or "Download CSV"
  - Apply Tailwind classes: rounded, px-3 py-2, text-sm, text-blue-700, hover:bg-blue-50
  - Handle click event by calling appropriate download utility

Accept optional `metadata` prop for including export info (timestamp, version).

Export as named export `DownloadButton`. Use "use client" directive.

DO NOT: Create complex dropdown menus (keep simple single-format buttons).</action>
  <verify>cd web && npm run lint</verify>
  <done>DownloadButton component renders with icon, label, and proper click handling.</done>
</task>

<task type="auto">
  <name>Task 3: Add download buttons to trends page</name>
  <files>web/src/app/trends/page.tsx</files>
  <action>Add DownloadButton components to the trends page:
  - Annual trends chart: Add JSON and CSV download buttons for annualSeries data
  - Monthly trends chart: Add JSON and CSV download buttons for monthlySeries data
  - COVID comparison: Add JSON and CSV download buttons for covid data
  - Seasonality: Add JSON download for raw seasonality data
  - Robbery heatmap: Add CSV download for heatmap data

Place download buttons below each chart insight text. Include metadata object with:
  - export_timestamp: new Date().toISOString()
  - data_version: "v1.0"
  - processing_notes: "Aggregated from Philadelphia Police Department data"

Replace existing direct API download links with DownloadButton components.

DO NOT: Change existing chart visualizations or data fetching logic.</action>
  <verify>cd web && npm run build</verify>
  <done>Trends page includes download buttons for all chart data with proper metadata.</done>
</task>

<task type="auto">
  <name>Task 4: Add download buttons to policy and map pages</name>
  <files>web/src/app/policy/page.tsx
  web/src/app/map/page.tsx</files>
  <action>Add DownloadButton components to:

Policy page:
  - Retail theft trends: JSON and CSV downloads
  - Vehicle crime trends: JSON and CSV downloads
  - Crime composition: JSON and CSV downloads
  - Event impact: JSON download only (complex nested structure)

Map page:
  - Districts: JSON download of GeoJSON (add note about GeoJSON format)
  - Tracts: JSON download of GeoJSON
  - Hotspots: JSON download of GeoJSON

Include same metadata structure as trends page (timestamp, version, notes).

For GeoJSON downloads, note that the format is standard GeoJSON for GIS applications.

DO NOT: Modify existing chart rendering or map interactions.</action>
  <verify>cd web && npm run build</verify>
  <done>Policy and map pages include download buttons for all relevant datasets.</done>
</task>

</tasks>

<verification>
- Run `cd web && npm run lint`
- Run `cd web && npm run typecheck`
- Run `cd web && npm run build`
- Manual QA: Visit trends, policy, and map pages; click download buttons; verify files download with correct content
- Test CSV opening in Excel or Google Sheets to verify UTF-8 encoding
- Verify JSON files are properly formatted and include metadata
</verification>

<success_criteria>
- DATA-05 complete: Data download links for JSON/CSV export on all analysis pages
- Downloads include proper metadata (timestamp, version, processing notes)
- CSV files open correctly in Excel with proper character encoding
- Download buttons are clearly visible and properly labeled
</success_criteria>

<output>
After completion, create `.planning/phases/02-data-presentation-/02-04-SUMMARY.md`.
</output>
